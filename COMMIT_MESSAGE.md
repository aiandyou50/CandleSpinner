# Git 커밋 메시지 제안

## 커밋 메시지 (Primary)

```
아키텍처: 인출 로직을 RPC 직접 전송에서 스마트컨트랙트 Permit 방식으로 변경

- 아키텍처 패러다임 변경:
  - 기존: 백엔드 중앙화 (RPC 직접 전송)
  - 신규: 스마트컨트랙트 기반 탈중앙화 (사용자 주도)

- API 엔드포인트 변경:
  - /api/initiate-withdrawal: Permit 생성 & 서명 (RPC 직접 전송 삭제)
  - /api/confirm-withdrawal: 블록체인 확인 후 KV 차감 (신규)

- 스마트컨트랙트 메시지:
  - WithdrawWithPermit: 사용자 주도 인출용 (신규)
  - WithdrawalRequest: 백엔드 호출용 (기존, 유지)

- 사용자 경험 개선:
  - 블록체인 트랜잭션 투명성 제공
  - 가스비 백엔드 부담 → 사용자 부담 (0.05 TON)
  - TonConnect 지갑 통합

- SSOT 문서 업데이트:
  - [산출물2]기술-스택-및-아키텍처-설계.md: 다이어그램 + API + 스마트컨트랙트
  - [산출물3]MVP핵심-로직-의사코드.md: Permit 의사코드 + A.6.1 신규 엔드포인트
  - README.md: 시스템 플로우 + 게임 인출 플로우
  - [산출물1]프로젝트-정의서.md: 게임 플레이 흐름

- 변경 통계: +1505줄 (신규 섹션 + 개선)
```

## 상세 설명 (Extended Description)

### 개요
인출 기능의 아키텍처를 백엔드 중앙화 방식에서 스마트컨트랙트 기반 탈중앙화 방식으로 전환합니다. 이는 사용자 투명성, 보안, 비용 효율성을 모두 개선하는 중요한 변경입니다.

### 변경 전후 비교

#### 기존 흐름
```
사용자 (프론트엔드) 
  → /api/initiate-withdrawal 
  → 백엔드 RPC 직접 호출 
  → WithdrawalManager 스마트컨트랙트 
  → 크레딧 차감 (서버 동기화)
```

**문제점**:
- 중앙화된 구조 (백엔드가 크레딧 조작)
- 가스비 백엔드 부담
- 트랜잭션 투명성 부족

#### 신규 흐름
```
사용자 (프론트엔드)
  → [1] /api/initiate-withdrawal (Permit 생성)
  → [2] TonConnect (스마트컨트랙트 직접 호출)
  → [3] 블록체인 기록
  → [4] /api/confirm-withdrawal (KV 차감)
```

**개선점**:
- 탈중앙화 (사용자가 스마트컨트랙트 직접 호출)
- 가스비 사용자 부담 (0.05 TON)
- 블록체인에서 투명하게 확인 가능

### 기술 세부사항

#### API 변경

| 엔드포인트 | 변경 | 설명 |
|-----------|------|------|
| `/api/initiate-withdrawal` | 변경 | Permit 메시지 생성 & 백엔드 서명 |
| `/api/confirm-withdrawal` | 신규 | 블록체인 확인 후 KV 크레딧 차감 |

#### 스마트컨트랙트

**신규 메시지 타입**: `WithdrawWithPermit`
- 필드: `amount`, `destination`, `nonce`, `expiration`, `signature`
- 기능: 사용자 주도 인출 (서명 검증 후 처리)

**기존 메시지 유지**: `WithdrawalRequest`
- 용도: 백엔드 호출 (관리자 기능, 예비)

### SSOT 문서 업데이트 (총 4개)

1. **[산출물2]기술-스택-및-아키텍처-설계.md**
   - 시스템 아키텍처 다이어그램 갱신 (Withdrawal Smart Contract + TonConnect 추가)
   - API 엔드포인트 테이블 재구성
   - 5.1~5.2 상세 설명 추가 (요청/응답 예시)
   - 8. 스마트컨트랙트 연동 섹션 신규 추가 (1100줄)

2. **[산출물3]MVP핵심-로직-의사코드.md**
   - A.6 `/api/initiate-withdrawal` 의사코드 전면 변경 (Permit 방식)
   - A.6.1 `/api/confirm-withdrawal` 신규 의사코드 추가
   - B.4 "상금 인출" 기능 6Step으로 상세화

3. **README.md**
   - 3.1 시스템 다이어그램 갱신
   - 3.2 인출 흐름 신규 섹션 추가
   - 7.2 인출 플로우 신규 섹션 추가 (예상 시간 명시)

4. **[산출물1]프로젝트-정의서.md**
   - 3.1 게임 플레이 흐름 4단계 변경 (사용자 주도 방식 추가)

### 배포 일정

- **테스트넷**: 2025-10-26 (스마트컨트랙트 배포 + API 배포)
- **메인넷**: 테스트넷 검증 완료 후 (예정: 2025-10-27 이후)

### 테스트 시나리오

- [ ] 정상 인출 (Permit 생성 → TonConnect 호출 → KV 차감)
- [ ] 만료된 Permit 거부
- [ ] 중복 Nonce 거부
- [ ] 서명 검증 실패
- [ ] 블록체인 확인 실패 (재시도)

### Breaking Changes

**없음** - 기존 기능 유지:
- `WithdrawalRequest` 메시지 타입 유지
- 기타 게임 기능 영향 없음
- 점진적 마이그레이션 가능 (필요 시)

### 다음 작업

1. **스마트컨트랙트 구현** (담당자: @dev-team)
   - `receive(msg: WithdrawWithPermit)` 구현
   - 서명 검증 로직 추가
   - 테스트 케이스 작성

2. **백엔드 API 구현** (담당자: @backend-team)
   - `/api/initiate-withdrawal` 신규 로직
   - `/api/confirm-withdrawal` 엔드포인트
   - 트랜잭션 모니터링 로직

3. **프론트엔드 구현** (담당자: @frontend-team)
   - TonConnect 통합
   - Permit 메시지 송신
   - 트랜잭션 상태 UI

---

## 실행 명령어

```bash
git add [산출물1]프로젝트-정의서.md \
        [산출물2]기술-스택-및-아키텍처-설계.md \
        [산출물3]MVP핵심-로직-의사코드.md \
        README.md \
        kanban.md \
        docs/solutions/[솔루션]_인출-아키텍처-Permit기반-변경_20251026_solution.md

git commit -m "아키텍처: 인출 로직을 RPC 직접 전송에서 스마트컨트랙트 Permit 방식으로 변경

- 아키텍처 패러다임 변경:
  - 기존: 백엔드 중앙화 (RPC 직접 전송)
  - 신규: 스마트컨트랙트 기반 탈중앙화 (사용자 주도)

- API 엔드포인트 변경:
  - /api/initiate-withdrawal: Permit 생성 & 서명 (RPC 직접 전송 삭제)
  - /api/confirm-withdrawal: 블록체인 확인 후 KV 차감 (신규)

- 스마트컨트랙트 메시지:
  - WithdrawWithPermit: 사용자 주도 인출용 (신규)
  - WithdrawalRequest: 백엔드 호출용 (기존, 유지)

- 사용자 경험 개선:
  - 블록체인 트랜잭션 투명성 제공
  - 가스비 백엔드 부담 → 사용자 부담 (0.05 TON)
  - TonConnect 지갑 통합

- SSOT 문서 업데이트:
  - [산출물2]기술-스택-및-아키텍처-설계.md: 다이어그램 + API + 스마트컨트랙트
  - [산출물3]MVP핵심-로직-의사코드.md: Permit 의사코드 + A.6.1 신규 엔드포인트
  - README.md: 시스템 플로우 + 게임 인출 플로우
  - [산출물1]프로젝트-정의서.md: 게임 플레이 흐름

- 변경 통계: +1505줄 (신규 섹션 + 개선)"

git push origin main
```

---

## 커밋 메타데이터

- **작성일**: 2025-10-26
- **파일 수**: 6개 (4개 SSOT + 1개 칸반 + 1개 해결기록)
- **변경 줄**: +1505줄
- **태그 제안**: `v2.2.0-beta` (아키텍처 주요 변경)
- **우선순위**: 🔴 높음 (배포 필수)

---

## 리뷰 체크리스트

### 코드 검토
- [ ] SSOT 문서 일관성 확인
- [ ] API 명세 정확성 확인
- [ ] 의사코드 구현 가능성 확인
- [ ] 스마트컨트랙트 메시지 정확성 확인

### 테스트
- [ ] 단위 테스트 (Permit 생성)
- [ ] 통합 테스트 (e2e 플로우)
- [ ] 블록체인 테스트 (테스트넷)

### 배포
- [ ] 테스트넷 배포 완료
- [ ] 메인넷 배포 준비
- [ ] 롤백 계획 수립

---

**최종 승인**: 🔄 대기 중 (리뷰 예정)  
**배포 예정**: 2025-10-26 (테스트넷)
