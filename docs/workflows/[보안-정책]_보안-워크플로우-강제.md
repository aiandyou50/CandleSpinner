# 🔐 보안 정책 워크플로우 (Security Policy Workflow)

**버전:** v1.0  
**작성일:** 2025-10-23  
**대상:** 모든 AI 코딩 에이전트 & 개발자

---

## 📋 개요

이 문서는 CandleSpinner 프로젝트에서 **민감한 정보(개인키, 니모닉, 인증토큰)**를 다루는 모든 AI 에이전트와 개발자가 **반드시 준수해야 할 보안 정책**을 정의합니다.

---

## 🚨 절대 금지 사항 (CRITICAL - 위반 시 즉시 중단)

### ❌ 1. 개인키 절대 하드코딩 금지
```typescript
// ❌ 절대 금지 (위반 시 즉시 커밋 거부)
const privateKey = "4e6568d1990bff34...";
[vars]
GAME_WALLET_PRIVATE_KEY = "4e6568d1990bff34...";
```

**위반 시 조치:**
- 즉시 커밋 거부
- 해당 커밋 히스토리 제거 (git-filter-branch)
- 새 개인키 생성 및 환경변수 교체

---

### ❌ 2. 니모닉 절대 파일에 기록 금지
```bash
# ❌ 절대 금지
echo "tornado run casual carbon..." > mnemonic.txt

# ❌ 절대 금지
node script.mjs "tornado run casual carbon..."  # 터미널에 히스토리 남음
```

**위반 시 조치:**
- 로컬 히스토리 즉시 삭제
- `.gitignore` 재점검
- 해당 파일 삭제 후 git rm --cached 처리

---

### ❌ 3. 채팅/문서에 민감한 정보 절대 입력 금지
```
❌ 금지: "제 개인키는 4e6568d1...입니다"
❌ 금지: "니모닉은 tornado run casual carbon..."
✅ 허용: "wallet-tools/mnemonic-to-key.mjs 스크립트로 생성"
```

**위반 시 조치:**
- 즉시 문서에서 마스킹으로 교체
- 채팅 기록 검토 및 정제
- AI에 경고 및 재교육

---

## ✅ 올바른 절차 (MANDATORY)

### 1️⃣ 개인키 생성 (로컬 전용)

**단계 1: 안전한 명령 실행**
```bash
# PowerShell에서만 실행 (Git Bash 금지)
node wallet-tools/mnemonic-to-key.mjs "your-24-word-mnemonic"

# 출력 예시:
# privateKey: 4e6568d1990bff34c3fc...ef7978fc
# publicKey: 3a59677f67586df6a530...
# walletAddress: UQBFPDdSlPgqPrn2Xwh...
```

**단계 2: 복사 & 즉시 삭제**
```bash
# 1. 출력된 privateKey만 복사
# 2. Cloudflare 대시보드에 즉시 입력
# 3. 파일이나 메모에 저장 금지
```

**단계 3: 히스토리 정리**
```powershell
# PowerShell에서 즉시 실행
Clear-History
Remove-Item (Get-PSReadlineOption).HistorySavePath -Force
```

---

### 2️⃣ Cloudflare 환경변수 설정 (안전한 위치)

**URL:** https://dash.cloudflare.com/Pages/candlespinner/Settings/Environment-variables

**절차:**
1. **Production 환경 선택**
2. **변수명:** `GAME_WALLET_PRIVATE_KEY`
3. **값:** 위의 privateKey (복사-붙여넣기)
4. **Save** 클릭
5. **배포 후 5분 대기** (적용 대기)

**검증:**
```bash
curl https://aiandyou.me/api/debug-private-key
# 응답: addressMatches: true
```

---

### 3️⃣ 코드에서의 사용 (환경변수만)

**✅ 올바른 방법**
```typescript
// functions/api/initiate-withdrawal.ts
const gameWalletPrivateKey = env.GAME_WALLET_PRIVATE_KEY;
const keyPair = keyPairFromSecretKey(Buffer.from(gameWalletPrivateKey, 'hex'));
```

**❌ 절대 금지**
```typescript
// 절대 금지
const gameWalletPrivateKey = "4e6568d1990...";
const gameWalletPrivateKey = process.env.MNEMONIC; // mnemonic 저장 금지
```

---

## 🔄 AI 에이전트 필수 실행 규칙

### [Rule 1] 코드 리뷰 시 민감한 정보 감시

**모든 커밋 전, AI는 다음을 확인해야 합니다:**

```bash
# Step 1: 파일에 "4e6568" (개인키 프리픽스) 있는지 확인
git diff --name-only --staged | while read file; do
  if grep -q "4e6568\|tornado run casual" "$file"; then
    echo "❌ 경고: 민감한 정보 발견! 커밋 거부"
    exit 1
  fi
done

# Step 2: wrangler.toml 검증
if grep -q "GAME_WALLET_PRIVATE_KEY = \"4e6568" wrangler.toml; then
  echo "❌ 경고: wrangler.toml에 개인키 있음! 커밋 거부"
  exit 1
fi

# Step 3: 히스토리 파일 확인
if grep -q "mnemonic-to-key.mjs" ~/.bash_history 2>/dev/null; then
  echo "⚠️ 경고: 터미널 히스토리에 명령 남아있음. 즉시 정리"
fi
```

**AI 응답:**
```
❌ 커밋 거부
이유: wrangler.toml에 개인키가 발견되었습니다.
조치: GAME_WALLET_PRIVATE_KEY = "4e6568d1..."를 제거하고 주석으로 변경하세요.

정정 후 재커밋 하세요.
```

---

### [Rule 2] 채팅/문서 작성 시 마스킹

**AI가 민감한 정보를 언급해야 할 때:**

```
✅ 올바른 예시:
"생성된 개인키는 128자 hex 형식입니다: 4e6568...ef7978fc"
"니모닉은 24개의 BIP39 단어입니다"

❌ 위험한 예시:
"생성된 개인키: [full-128-char-hex-key]"
"니모닉: [complete-24-word-phrase]"
```

---

### [Rule 3] 보안 정책 위반 감지 및 보고

**AI가 감지할 사항:**

1. **하드코딩된 개인키 발견**
   - 즉시 중단
   - 사용자에게 경고
   - 수정 방법 제시

2. **터미널 히스토리에 민감한 정보**
   - `Clear-History` 명령 제시
   - 정리 지침 제공

3. **문서에 전체 개인키/니모닉**
   - 즉시 마스킹
   - 수정 사항 설명

---

## 📝 AI가 매 세션마다 확인할 체크리스트

**세션 시작 시, 다음을 먼저 확인하세요:**

```markdown
## 🔐 보안 체크리스트

- [ ] wrangler.toml에 개인키 없음 (주석만 있는가?)
- [ ] .gitignore에 .env.local 포함되어 있는가?
- [ ] Cloudflare 환경변수에 GAME_WALLET_PRIVATE_KEY 설정됨
- [ ] 로컬 터미널 히스토리 비워졌는가?
- [ ] docs/solutions/ 보안 문서 있는가?

❌ 하나라도 위반하면, 즉시 수정 후 진행
```

---

## 🚨 보안 사건 발생 시 응급 처치

### Case 1: 개인키가 GitHub에 커밋된 경우

```bash
# Step 1: 즉시 중단 (배포 금지)
# Step 2: git-filter-branch로 히스토리 제거
git filter-branch --tree-filter 'rm -f wrangler.toml' HEAD

# Step 3: 강제 푸시 (주의: 협업 중이면 확인)
git push origin -f main

# Step 4: 새 개인키 생성 및 환경변수 변경
# Step 5: Tonscan에서 지갑 활동 모니터링
```

### Case 2: 니모닉이 채팅에 노출된 경우

```
1. 이 가이드 최상단의 "AI 학습 데이터 보안 평가" 읽기
2. 채팅 기록 최소화 (필요시 삭제 요청)
3. 향후 정책: 절대 터미널에서 출력 금지
4. 새 지갑 생성 권장 (프로덕션의 경우)
```

---

## 📞 정기 보안 감사

**매월 1회 (권장):**

```bash
# 1. Git 히스토리에서 민감한 정보 스캔
git log --all --grep="4e6568\|tornado run"

# 2. wrangler.toml 검증
grep -i "private.*key\|mnemonic" wrangler.toml

# 3. 로컬 환경 파일 확인
ls -la .env* | grep -v ".gitignore"

# 4. Tonscan에서 지갑 활동 확인
# https://tonscan.org/address/UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
```

---

## 🎓 AI 에이전트 교육 체크리스트

**신입 AI 에이전트 온보딩:**

- [ ] 이 문서 전체 읽음
- [ ] 절대 금지 사항 3개 숙지
- [ ] 올바른 절차 3가지 이해
- [ ] 테스트: wrangler.toml에서 개인키 감지 능력 확인
- [ ] 테스트: 마스킹 능력 확인 (4e6568...ef7978fc)

---

## 📚 참고 문서

- `docs/solutions/[보안가이드]_20251023_개인키-환경변수-관리.md` - 상세 가이드
- `docs/solutions/[보안-긴급]_20251023_터미널-채팅-기록-삭제-가이드.md` - 히스토리 정리
- `docs/solutions/Cloudflare-Pages-환경변수-설정_20251023_000000.md` - 환경변수 설정

---

**⚠️ 마지막 주의:**

이 정책을 위반하는 커밋은 **즉시 Revert**됩니다.  
개인키/니모닉 노출 시 **프로젝트 전체 차단**될 수 있습니다.

**보안은 모두의 책임입니다. 🔐**

