# 지시서: Task 2 - 보안 인출 로직 (seqno 원자성 포함)

> **작성일:** 2025년 10월 24일  
> **작업:** Task 2 계속 진행 + 문서 작업  
> **요청자:** 사용자  
> **담당:** GitHub Copilot  

---

## 1. 작업 요청 내용

### 1.1 Task 2 진행 상황 검토
- **이전 상태:** MVP 테스트 중 (검증 대기)
- **현재 요청:** 
  1. Task 2 코드 검증 (완전성 확인)
  2. MVP 테스트 케이스 작성 및 검증 문서
  3. SSoT 문서 동기화 (docs/ssot/README.md)
  4. 지시서 및 해결기록 작성
  5. kanban.md 업데이트 ([Done]으로 변경)

### 1.2 핵심 기능
- ✅ seqno 원자적 관리 (KV 기반)
- ✅ Jetton 트랜잭션 생성 (TEP-74 표준)
- ✅ TonAPI 통합 (BOC 전송)
- ✅ 크레딧 차감 (성공 후)
- ✅ 거래 로그 저장 (7일 보관)

---

## 2. 검증 체크리스트

### 2.1 코드 완전성
```
□ buildJettonTransferPayload() 구현 확인
□ getAndIncrementSeqno() - 원자성 확인
□ sendBocViaTonAPI() - TonAPI 연동 확인
□ getJettonWalletAddress() - Jetton 지갑 조회
□ getGameWalletTonBalance() - 잔액 확인 (경고)
□ onRequestPost() - 메인 핸들러 완성도 확인
```

### 2.2 보안 검증
```
□ 개인키 환경변수만 사용 (하드코딩 없음)
□ seqno 경합 조건 없음 (원자성)
□ 트랜잭션 실패 시 크레딧 원상복구 아니 (일반적)
□ 거래 로그 TTL 설정 (7일)
```

### 2.3 에러 처리
```
□ 크레딧 부족 체크
□ 환경변수 누락 체크
□ TonAPI 오류 처리 (retry 로직)
□ KV 저장 실패 시 로그 기록
```

---

## 3. 예상 테스트 케이스

### 3.1 정상 케이스
```javascript
POST /api/initiate-withdrawal
{
  "walletAddress": "UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd",
  "withdrawalAmount": 100
}

응답 (성공):
{
  "success": true,
  "message": "인출 완료",
  "txHash": "ABC123...",
  "newCredit": 900,
  "withdrawalAmount": 100
}
```

### 3.2 오류 케이스
```javascript
// 케이스 1: 크레딧 부족
POST /api/initiate-withdrawal
{
  "walletAddress": "UQ...",
  "withdrawalAmount": 10000
}
응답: { success: false, error: "인출할 크레딧이 부족합니다." }

// 케이스 2: 환경변수 누락
응답: { success: false, error: "서버 설정 오류" }

// 케이스 3: 잘못된 주소 형식
응답: { success: false, error: "[TonAPI] 주소 파싱 오류" }
```

---

## 4. 작업 단계

### Step 1: 코드 검증 ✅
- initiate-withdrawal.ts 전체 확인
- 로직 흐름: 
  1. 요청 검증 (지갑 주소, 인출액)
  2. KV 조회 (사용자 상태)
  3. 크레딧 확인
  4. 게임 지갑 생성
  5. seqno 증가 (원자적)
  6. TON 잔액 확인 (경고)
  7. Jetton 지갑 주소 조회
  8. Payload 생성 (TEP-74)
  9. BOC 생성 및 TonAPI 전송
  10. KV 크레딧 차감
  11. 거래 로그 저장

### Step 2: SSoT 문서 동기화 📝
- docs/ssot/README.md 인출 API 섹션 업데이트
- "현재 구현 현황" 섹션에서 Task 2 상태 변경 (In Progress → Done)

### Step 3: 해결기록 작성 📋
- docs/solutions/Task2-보안인출로직_*_solution.md 생성
- 핵심 코드 변경 사항 정리
- 테스트 결과 및 배포 준비 상태 기록

### Step 4: kanban.md 업데이트 🎯
- Task 2 상태: [In Progress] → [Done]
- 완료일: 2025년 10월 24일
- 최종 버전: v2.5.0

---

## 5. 관련 파일

- `functions/api/initiate-withdrawal.ts` - 메인 코드
- `src/components/GameComplete.tsx` - 인출 UI
- `docs/ssot/README.md` - 기술 사양 (SSoT)
- `kanban.md` - 작업 현황판

---

## 6. 승인 기준

✅ 모든 단계 완료 시 작업 종료:
- [ ] 코드 검증 완료
- [ ] SSoT 문서 동기화 완료
- [ ] 해결기록 작성 완료
- [ ] kanban.md 업데이트 완료
- [ ] Git 커밋 완료

---

**상태:** 📌 작업 진행 중  
**예상 종료:** 2025년 10월 24일
