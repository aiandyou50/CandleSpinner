# Rate Limiting μ μ© μ§€μ‹μ„
## λ©ν‘: API μ—”λ“ν¬μΈνΈ λ³΄νΈ λ° DDoS λ°©μ§€
### μ™„λ£ λ‚ μ§: 2025-10-21

---

## π“‹ μ‘μ—… κ°μ”

**λ©μ **: Cloudflare Workers + KVλ¥Ό ν™μ©ν• ν¨μ¨μ μΈ Rate Limiting μ‹μ¤ν… κµ¬μ¶•

**μ μ© λ²”μ„**:
- CSPIN Jetton μ „μ†΅ (λ§¤μ° μ ν•μ : 10 req/min)
- μΌλ° API (ν‘μ¤€: 100 req/min)
- κ²μ„ API (μ¤‘κ°„: 50 req/min)
- κΈ΄κΈ‰ λ¨λ“ (DDoS λ°©μ–΄: 1 req/10s)

---

## π›  κµ¬ν„ λ‚΄μ©

### 1. Rate Limit Middleware μƒμ„±
**νμΌ**: `functions/_rateLimit.ts`

**μ£Όμ” ν•¨μ**:
- `getClientIP()`: Cloudflare ν—¤λ”μ—μ„ μ‹¤μ  ν΄λΌμ΄μ–ΈνΈ IP μ¶”μ¶
- `generateRateLimitKey()`: KV μ €μ¥μ†μ© ν‚¤ μƒμ„±
- `checkRateLimit()`: Rate limit ν™•μΈ λ° μΉ΄μ΄ν„° μ—…λ°μ΄νΈ
- `createRateLimitResponse()`: 429 μ‘λ‹µ μƒμ„±

**μ„¤μ • κµ¬μ΅°**:
```typescript
interface RateLimitConfig {
  limit: number;        // μµλ€ μ”μ²­ μ
  window: number;       // μ‹κ°„ μλ„μ° (μ΄)
  keyPrefix?: string;   // KV ν‚¤ ν”„λ¦¬ν”½μ¤
}
```

### 2. Rate Limit Presets
```typescript
CSPIN_TRANSFER: { limit: 10, window: 60 }      // 1λ¶„λ‹Ή 10 μ”μ²­
GENERAL_API:    { limit: 100, window: 60 }     // 1λ¶„λ‹Ή 100 μ”μ²­
GAME_API:       { limit: 50, window: 60 }      // 1λ¶„λ‹Ή 50 μ”μ²­
EMERGENCY:      { limit: 1, window: 10 }       // 10μ΄λ‹Ή 1 μ”μ²­
```

### 3. API μ—”λ“ν¬μΈνΈ ν†µν•©
**μμ‹** (functions/api/deposit.tsμ— μ μ©):
```typescript
const clientIP = getClientIP(request);
const rateLimitResult = await checkRateLimit(
  kv,
  clientIP,
  '/api/deposit',
  RATE_LIMIT_PRESETS.CSPIN_TRANSFER
);

if (!rateLimitResult.allowed) {
  return createRateLimitResponse(
    rateLimitResult.remaining,
    rateLimitResult.resetIn
  );
}
```

---

## β… κ²€μ¦ μ²΄ν¬λ¦¬μ¤νΈ

### μ½”λ“ ν’μ§
- β… TypeScript νƒ€μ… μ•μ •μ„±
- β… KV μ €μ¥μ† TTL μ„¤μ •
- β… μ—λ¬ ν•Έλ“¤λ§ κµ¬ν„
- β… ν΄λΌμ΄μ–ΈνΈ IP μ¶”μ¶ λ΅μ§

### κΈ°λ¥ κ²€μ¦
- [ ] Deposit μ—”λ“ν¬μΈνΈ ν†µν•©
- [ ] Withdraw μ—”λ“ν¬μΈνΈ ν†µν•©
- [ ] Game API ν†µν•©
- [ ] Rate limit μ„λ° μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ

### λ°°ν¬ μ¤€λΉ„
- [ ] Sentryμ— rate limit μ„λ° λ΅κΉ…
- [ ] λ¨λ‹ν„°λ§ λ€μ‹λ³΄λ“ μ„¤μ •
- [ ] μ•λ¦Ό κ·μΉ™ κµ¬μ„±
- [ ] KV μ €μ¥μ† μ©λ‰ λ¨λ‹ν„°λ§

---

## π“ κΈ°λ€ ν¨κ³Ό

### λ³΄μ• κ°μ„ 
- **λ΄‡ κ³µκ²© μ°¨λ‹¨**: λΉ„μ •μƒ ν¨ν„΄ κ°μ§€
- **ν† ν° λ„μ© λ°©μ§€**: μ§§μ€ μ‹κ°„ λ‚΄ λ€λ‰ κ±°λ μ°¨λ‹¨
- **DDoS μ™„ν™”**: λΉ„μƒ λ¨λ“λ΅ μ„λ²„ λ³΄νΈ

### μ΄μ μ•μ •μ„±
- **λΉ„μ© μ κ°**: λ¶ν•„μ”ν• μ”μ²­ μ°¨λ‹¨
- **μ„±λ¥ κ°μ„ **: κ³Όλ¶€ν• λ°©μ§€
- **μμΈ΅ κ°€λ¥ν• μ©λ‰**: λ¦¬μ†μ¤ μ‚¬μ©λ‰ μ μ–΄

### μ‚¬μ©μ κ²½ν—
- **λ…ν™•ν• μ¤λ¥ λ©”μ‹μ§€**: Rate limit μ•λ‚΄
- **Retry-After ν—¤λ”**: ν΄λΌμ΄μ–ΈνΈ μ¬μ‹λ„ μ§€μ›
- **ν¬λ…ν• μ •μ±…**: μ ν• μ‚¬ν•­ λ…μ‹

---

## π”‘ κµ¬ν„ μƒνƒ

| ν•­λ© | μƒνƒ | λΉ„κ³  |
|------|------|------|
| Middleware μ‘μ„± | β… | functions/_rateLimit.ts |
| ν•¨μ κµ¬ν„ | β… | getClientIP, checkRateLimit λ“± |
| Preset μ •μ | β… | 4κ°€μ§€ μ •μ±… μμ¤€ |
| TypeScript νƒ€μ… | β… | RateLimitConfig interface |
| KV TTL κ΄€λ¦¬ | β… | μλ™ λ§λ£ μ„¤μ • |
| κ°€μ΄λ“ λ¬Έμ„ | β… | RATE_LIMITING_GUIDE.md |

---

## π€ λ‹¤μ λ‹¨κ³„

### μ¦‰μ‹ μ‘μ—… (Phase 1-3)
- [ ] Deposit APIμ— Rate Limiting μ μ©
- [ ] Withdraw APIμ— Rate Limiting μ μ©
- [ ] Game APIμ— Rate Limiting μ μ©

### λ¨λ‹ν„°λ§ (Phase 1-4)
- [ ] Sentryμ— rate limit μ„λ° μ¶”μ 
- [ ] KV μ €μ¥μ† μ‚¬μ©λ‰ λ¨λ‹ν„°λ§
- [ ] μƒμ„ μ°¨λ‹¨λ IP μ¶”μ 

### μµμ ν™” (Phase 2)
- [ ] λ™μ  Rate Limit μ΅°μ •
- [ ] IP ν™”μ΄νΈλ¦¬μ¤νΈ/λΈ”λ™λ¦¬μ¤νΈ
- [ ] μ‚¬μ©μ ν‹°μ–΄λ³„ μ°¨λ“± μ ν•

---

## π“ μ»¤λ°‹ μ •λ³΄

**νμΌ μƒμ„±**:
- `functions/_rateLimit.ts` (Rate limit middleware)
- `functions/api/RATE_LIMITING_GUIDE.md` (κµ¬ν„ κ°€μ΄λ“)

**μ΄ λ³€κ²½**:
- 1κ° νμΌ μμ •
- 2κ° νμΌ μƒμ„±
- ~200μ¤„ μ½”λ“ μ¶”κ°€

---

## π”— μ°Έκ³  μλ£

- [Cloudflare Workers KV](https://developers.cloudflare.com/workers/runtime-apis/kv/)
- [HTTP 429 Too Many Requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429)
- [Rate Limiting Best Practices](https://cloud.google.com/solutions/rate-limiting-strategies-techniques)

---

## β οΈ μ£Όμμ‚¬ν•­

1. **IP μ¶”μ¶**: CF-Connecting-IP ν—¤λ”λ” Cloudflareλ¥Ό ν†µν•  λ•λ§ μ‹ λΆ°μ„± λ†’μ
2. **KV λΉ„μ©**: Rate limit λ°μ΄ν„°λ΅ KV μ“°κΈ° λΉ„μ© λ°μƒ (λ¨λ‹ν„°λ§ ν•„μ”)
3. **μ‹κ°„ λ™κΈ°ν™”**: μ„λ²„ μ‹κ°„κ³Ό ν΄λΌμ΄μ–ΈνΈ μ‹κ°„ μ°¨μ΄ κ³ λ ¤
4. **ν…μ¤νΈ**: μ‹¤ λ°°ν¬ μ „ μ¤ν…μ΄μ§• ν™κ²½μ—μ„ μ¶©λ¶„ν ν…μ¤νΈ

---

**Status**: β… Phase 1-3 μ™„λ£ (Vitest β…, Sentry β…, Rate Limiting β…)  
**λ‹¤μ μ‘μ—…**: ν™κ²½λ³€μ ν™•λ€ (Phase 1-4)
