# 명령 지시서: Phase 3-2 중복 코드 제거 및 커스텀 Hooks 추출

**작업 ID**: Phase 3-2  
**타임스탬프**: 2025-10-21 19:45:00  
**요청자**: User  
**담당**: AI Agent

---

## 📋 요청 사항

**프로젝트의 기술 부채를 해결**하고 **코드 재사용성을 극대화**합니다.

### 목표
- 20%+ 중복 코드 제거
- 4개 이상 커스텀 hooks 추출
- 상태 관리 로직 통일
- 컴포넌트 크기 40% 감소

---

## 🎯 식별된 중복 코드 & 해결책

### 1. Telegram WebApp 초기화 중복

**현재 문제**:
- `src/components/Game.tsx`, `src/components/Deposit.tsx`, `src/utils/telegram.ts`에서 중복

**해결책**:
```typescript
// src/hooks/useTelegramWebApp.ts 생성
export function useTelegramWebApp() {
  const [webApp, setWebApp] = useState<TelegramWebApp | undefined>();
  
  useEffect(() => {
    const tma = getTelegramWebApp();
    if (tma) {
      initializeTelegramWebApp();
      setWebApp(tma);
    }
  }, []);
  
  return webApp;
}
```

### 2. 게임 상태 관리 중복

**현재 문제**:
- `Game.tsx`: Zustand 스토어 + useState 혼용
- `Deposit.tsx`: 비슷한 상태 패턴 반복

**해결책**:
```typescript
// src/hooks/useGameState.ts 생성
export function useGameState() {
  const [userCredit, setUserCredit] = useState(1000);
  const [betAmount, setBetAmount] = useState(100);
  const [isSpinning, setIsSpinning] = useState(false);
  
  const updateCredit = useCallback((amount: number) => {
    setUserCredit(prev => Math.max(0, prev + amount));
  }, []);
  
  return { userCredit, betAmount, isSpinning, updateCredit, setBetAmount, setIsSpinning };
}
```

### 3. 입금 상태 관리 중복

**현재 문제**:
- `Deposit.tsx`의 입금 방식 선택, 로딩, 에러 상태가 분산

**해결책**:
```typescript
// src/hooks/useDepositState.ts 생성
export function useDepositState() {
  const [depositMethod, setDepositMethod] = useState<DepositMethod>('tonconnect');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const handleError = useCallback((err: unknown) => {
    const message = getErrorMessage(err);
    setError(message);
  }, []);
  
  return { depositMethod, setDepositMethod, loading, setLoading, error, handleError };
}
```

### 4. 메시지/토스트 상태 중복

**현재 문제**:
- `message`, `messageType` 분리된 상태 (불일치 위험)
- 여러 컴포넌트에서 유사 패턴

**해결책**:
```typescript
// src/hooks/useToast.ts 생성
export function useToast() {
  const [toast, setToast] = useState<ToastMessage | null>(null);
  
  const showToast = useCallback((
    message: string,
    type: 'success' | 'error' | 'warning' | 'info' = 'info',
    duration = 3000
  ) => {
    const id = Math.random().toString(36).slice(2);
    setToast({ id, message, type, duration });
    setTimeout(() => setToast(null), duration);
  }, []);
  
  return { toast, showToast };
}
```

### 5. 에러 처리 패턴 중복

**현재 문제**:
- 각 컴포넌트에서 try-catch 로직 반복
- Sentry 보고와 UI 피드백이 분리

**해결책**:
```typescript
// src/hooks/useAsyncHandler.ts 생성
export function useAsyncHandler() {
  const { showToast } = useToast();
  
  return useCallback(async <T,>(
    asyncFn: () => Promise<T>,
    options?: { onSuccess?: (data: T) => void; onError?: (err: Error) => void }
  ) => {
    try {
      const result = await asyncFn();
      options?.onSuccess?.(result);
      return result;
    } catch (err) {
      const error = err instanceof Error ? err : new Error(String(err));
      const message = getErrorMessage(error);
      showToast(message, 'error');
      Sentry.captureException(error);
      options?.onError?.(error);
      throw error;
    }
  }, [showToast]);
}
```

---

## 📝 구현 계획

| 단계 | 파일 | 작업 | 상태 |
|------|------|------|------|
| 1 | `src/hooks/useTelegramWebApp.ts` | TMA 초기화 hook | ⏳ |
| 2 | `src/hooks/useGameState.ts` | 게임 상태 hook | ⏳ |
| 3 | `src/hooks/useDepositState.ts` | 입금 상태 hook | ⏳ |
| 4 | `src/hooks/useToast.ts` | 토스트 알림 hook | ⏳ |
| 5 | `src/hooks/useAsyncHandler.ts` | 비동기 핸들러 hook | ⏳ |
| 6 | `src/components/Game.tsx` | hook 적용 | ⏳ |
| 7 | `src/components/Deposit.tsx` | hook 적용 | ⏳ |
| 8 | 테스트 & 빌드 | 검증 | ⏳ |

---

## ✅ 완료 기준

- [ ] 5개 커스텀 hooks 생성
- [ ] 중복 코드 20% 이상 제거
- [ ] Game.tsx 코드 라인 40% 감소
- [ ] Deposit.tsx 코드 라인 30% 감소
- [ ] TypeScript 타입 검사: 0 errors
- [ ] npm test 통과 (12/12)
- [ ] npm run build 성공
- [ ] Git 커밋 완료 (version bump: v2.4.0)

---

## 📊 예상 개선 효과

### Before (현재)
```
Game.tsx: ~150 라인 (중복 상태 관리)
Deposit.tsx: ~200 라인 (입금 로직 혼합)
컴포넌트 복잡도: 높음
재사용성: 낮음
```

### After (개선 후)
```
Game.tsx: ~90 라인 (40% 감소)
Deposit.tsx: ~140 라인 (30% 감소)
hooks/: 200+ 라인 (재사용 가능)
컴포넌트 복잡도: 중간
재사용성: 높음
```

---

**Status**: 📋 지시서 생성 완료  
**다음 단계**: Step 3 - 커스텀 hooks 구현
