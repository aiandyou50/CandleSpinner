# MVP v2 재구축 계획

**작성일**: 2025-11-01  
**버전**: v2.0.0  
**상태**: 설계 단계

---

## 1. 배경 및 목적

### 문제점 (MVP v1)
- ❌ 여러 RPC 방식이 혼재 (Ankr, TonCenter v2, v3)
- ❌ 스마트 컨트랙트 방식과 RPC 방식이 공존하여 혼란
- ❌ 복잡한 의존성 (TON SDK 여러 버전)
- ❌ 디버깅 어려움 (`LITE_SERVER_UNKNOWN` 오류)
- ❌ 코드 구조 불명확

### 목적
- ✅ **단순성**: 단일 방식, 명확한 아키텍처
- ✅ **안정성**: 검증된 TON Connect 사용
- ✅ **유지보수성**: 깨끗한 코드, 명확한 문서
- ✅ **확장성**: 향후 기능 추가 용이

---

## 2. 핵심 아키텍처 결정

### 2.1 인출 방식 선택

**최종 결정: TON Connect 방식 (사용자 직접 서명)**

| 방식 | 장점 | 단점 | 선택 |
|------|------|------|------|
| **TON Connect** | • 보안 최상 (사용자 직접 서명)<br>• 서버 부담 없음<br>• 개인키 관리 불필요 | • UX 복잡도 증가 | ✅ **채택** |
| RPC (서버 서명) | • UX 간단 | • 서버에 개인키 저장 (보안 위험)<br>• seqno 관리 복잡 | ❌ 기각 |
| 스마트 컨트랙트 | • 탈중앙화 | • 개발 복잡도 높음<br>• 가스비 부담 | ❌ 보류 (Phase 2) |

### 2.2 기술 스택

```
Frontend (클라이언트)
├── React 18
├── TypeScript
├── TonConnect UI React
├── @tonconnect/sdk
└── Vite (빌드 도구)

Backend (서버)
├── Cloudflare Workers (Serverless)
├── Cloudflare KV (크레딧 저장)
└── 최소한의 API (입금 확인, 게임 로직)

Blockchain
├── TON Connect (지갑 연결)
└── TON Center API v2 (블록체인 조회만)
```

---

## 3. 기능 범위 (MVP v2)

### Phase 1: 핵심 기능 (2주)

#### 3.1 지갑 연결
- [ ] TON Connect UI 통합
- [ ] 지갑 주소 표시
- [ ] 연결/해제 기능

#### 3.2 입금 (Deposit)
- [ ] TON Connect로 Jetton Transfer 트랜잭션 생성
- [ ] 사용자가 지갑에서 승인
- [ ] 백엔드에서 입금 확인 (TonCenter API 조회)
- [ ] 크레딧 증가 (1 CSPIN = 1 Credit)

#### 3.3 게임 (Slot Machine)
- [ ] 간단한 3x3 슬롯 UI
- [ ] Spin 버튼 (1 Credit 차감)
- [ ] 랜덤 결과 생성 (백엔드 API)
- [ ] 당첨 시 크레딧 증가

#### 3.4 인출 (Withdraw)
- [ ] 인출 버튼 클릭
- [ ] TON Connect로 Jetton Transfer 트랜잭션 생성
  - From: 게임 지갑
  - To: 사용자 지갑
  - Amount: 인출 크레딧
- [ ] 사용자가 지갑에서 승인 (게임 지갑이 아닌 사용자 지갑!)
- [ ] ❗ **문제**: 사용자는 게임 지갑의 개인키가 없음
- [ ] ✅ **해결**: 백엔드 API가 트랜잭션 전송 (서버에서 게임 지갑 서명)

**인출 플로우 수정안:**
```
1. 사용자: 인출 요청 (프론트엔드)
2. 백엔드: 크레딧 확인 → Jetton Transfer 생성 → 게임 지갑으로 서명 → 블록체인 전송
3. 프론트엔드: 완료 메시지 표시
```

#### 3.5 크레딧 관리
- [ ] Cloudflare KV에 저장
- [ ] Key: `credit:{walletAddress}`
- [ ] Value: `{ credit: number, lastUpdated: timestamp }`

---

## 4. 프로젝트 구조

```
CandleSpinner/
├── docs/                    # 문서 (기존 유지)
├── PoC/                     # 개념 증명 (기존 유지)
├── archive/                 # 아카이브 (기존 유지)
│   └── legacy-code/
│       └── mvp-v1-backup-20251101/  # 이전 코드
│
├── src/                     # 🆕 프론트엔드 (새로 생성)
│   ├── main.tsx
│   ├── App.tsx
│   ├── components/
│   │   ├── WalletConnect.tsx
│   │   ├── Deposit.tsx
│   │   ├── SlotMachine.tsx
│   │   └── Withdraw.tsx
│   ├── hooks/
│   │   └── useTonConnect.ts
│   ├── api/
│   │   └── client.ts
│   └── types/
│       └── index.ts
│
├── functions/               # 🆕 백엔드 (새로 생성)
│   ├── api/
│   │   ├── verify-deposit.ts
│   │   ├── spin.ts
│   │   └── withdraw.ts
│   └── lib/
│       ├── ton-client.ts    # TonCenter API v2 클라이언트
│       └── credit-manager.ts
│
├── public/
│   └── tonconnect-manifest.json
│
├── package.json             # 🆕 새 의존성
├── tsconfig.json
├── vite.config.ts
├── wrangler.toml            # 🆕 Cloudflare 설정
└── README.md

```

---

## 5. 구현 순서

### Week 1: 기반 구축
1. **Day 1-2**: 프로젝트 초기화
   - 새 package.json 생성
   - 필수 의존성 설치
   - Vite + React 설정

2. **Day 3-4**: 지갑 연결
   - TON Connect UI 통합
   - 기본 레이아웃

3. **Day 5**: 백엔드 기초
   - Cloudflare Workers 설정
   - KV 연결

### Week 2: 핵심 기능
1. **Day 1-2**: 입금 기능
   - 프론트엔드: Jetton Transfer UI
   - 백엔드: 입금 확인 API

2. **Day 3**: 게임 로직
   - 슬롯 UI (간단한 버전)
   - Spin API

3. **Day 4-5**: 인출 기능
   - 백엔드: 인출 API (서버 서명)
   - 프론트엔드: 인출 UI

---

## 6. 환경 변수

```env
# .env.local (프론트엔드)
VITE_CSPIN_TOKEN_ADDRESS=EQCsBJHqi3TtqOFiEP2c...
VITE_TON_NETWORK=testnet

# .env (백엔드 - Cloudflare)
GAME_WALLET_MNEMONIC=word1 word2 ... word24
GAME_WALLET_ADDRESS=UQ...
CSPIN_TOKEN_ADDRESS=EQCsBJHqi3TtqOFiEP2c...
TONCENTER_API_KEY=your-api-key
```

---

## 7. 다음 단계

### Immediate (오늘)
- [x] 아카이빙 완료
- [ ] 이 문서 검토
- [ ] 프로젝트 구조 생성
- [ ] package.json 초기화

### Next (내일)
- [ ] 프론트엔드 기본 설정
- [ ] TON Connect 통합
- [ ] 백엔드 API 골격 작성

---

## 8. 참고 자료

- TON Connect Docs: https://docs.ton.org/develop/dapps/ton-connect/overview
- TonCenter API v2: https://toncenter.com/api/v2/
- Cloudflare Workers: https://developers.cloudflare.com/workers/

---

**작성자**: GitHub Copilot  
**최종 수정**: 2025-11-01
