# MVP v2 아키텍처 설계 문서

**작성일**: 2025-11-01  
**버전**: v2.0.0  
**상태**: 검토 단계

---

## 1. 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자 (브라우저)                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           React App (Vite + TypeScript)                   │  │
│  │  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐  │  │
│  │  │ TON Connect │  │ Slot Machine │  │ Credit Manager  │  │  │
│  │  │     UI      │  │      UI      │  │       UI        │  │  │
│  │  └──────┬──────┘  └──────┬───────┘  └────────┬────────┘  │  │
│  │         │                 │                    │           │  │
│  │         └─────────────────┼────────────────────┘           │  │
│  │                           │                                │  │
│  └───────────────────────────┼────────────────────────────────┘  │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               │ HTTPS
┌──────────────────────────────┼───────────────────────────────────┐
│            Cloudflare Workers (Serverless Backend)               │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │         API Routes                                       │    │
│  │  /api/verify-deposit    (입금 확인)                     │    │
│  │  /api/spin             (게임 실행)                      │    │
│  │  /api/withdraw         (인출 처리)                      │    │
│  └───────────────────┬────────────────────┬─────────────────┘    │
│                      │                    │                      │
│  ┌───────────────────┴──────┐  ┌─────────┴──────────────┐       │
│  │   TonCenter v2 Client    │  │  Cloudflare KV         │       │
│  │  (블록체인 조회만)        │  │  (크레딧 저장)         │       │
│  └──────────┬───────────────┘  └────────────────────────┘       │
└─────────────┼────────────────────────────────────────────────────┘
              │ HTTP
┌─────────────┴────────────────────────────────────────────────────┐
│                    TON Blockchain                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   게임 지갑      │  │   사용자 지갑    │  │  CSPIN Jetton   │  │
│  │   (서버 관리)    │  │ (사용자 소유)    │  │   Smart Contract│  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. 데이터 흐름

### 2.1 입금 플로우 (Deposit)

```
1. [사용자] 지갑 연결 (TON Connect)
2. [프론트엔드] "Deposit" 버튼 클릭
3. [프론트엔드] Jetton Transfer 트랜잭션 생성
   - From: 사용자 지갑
   - To: 게임 지갑
   - Amount: N CSPIN
4. [사용자] 지갑에서 트랜잭션 승인 및 서명
5. [프론트엔드] 트랜잭션 해시 획득
6. [프론트엔드] /api/verify-deposit 호출 (txHash 전달)
7. [백엔드] TonCenter API로 트랜잭션 조회
8. [백엔드] 입금 확인 → KV에 크레딧 증가
9. [프론트엔드] 크레딧 업데이트 표시
```

### 2.2 게임 플로우 (Spin)

```
1. [사용자] "SPIN" 버튼 클릭
2. [프론트엔드] /api/spin 호출
   - walletAddress
   - spinCost (1 Credit)
3. [백엔드] KV에서 크레딧 확인
4. [백엔드] 크레딧 차감 (1 Credit)
5. [백엔드] 랜덤 슬롯 결과 생성
6. [백엔드] 당첨 시 크레딧 증가
7. [백엔드] 결과 반환
8. [프론트엔드] 슬롯 애니메이션 + 결과 표시
```

### 2.3 인출 플로우 (Withdraw) ⭐ 핵심 변경

```
1. [사용자] "Withdraw" 버튼 클릭
2. [프론트엔드] /api/withdraw 호출
   - walletAddress
   - amount (인출할 CSPIN 수량)
3. [백엔드] KV에서 크레딧 확인
4. [백엔드] 크레딧 차감
5. [백엔드] Jetton Transfer 트랜잭션 생성
   - From: 게임 지갑
   - To: 사용자 Jetton 지갑
   - Amount: N CSPIN
6. [백엔드] 게임 지갑 개인키로 서명
7. [백엔드] TonCenter v2로 BOC 전송
8. [백엔드] 트랜잭션 해시 반환
9. [프론트엔드] 성공 메시지 + 크레딧 업데이트
```

**핵심 차이점 (MVP v1 vs v2):**
- ❌ v1: 복잡한 seqno 관리, 여러 RPC 클라이언트 혼재
- ✅ v2: 단순한 서버 서명 방식, TonCenter v2만 사용

---

## 3. 기술 스택

### 3.1 프론트엔드

| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| React | ^18.3.1 | UI 프레임워크 |
| TypeScript | ^5.9.3 | 타입 안전성 |
| @tonconnect/ui-react | ^2.3.1 | 지갑 연결 UI |
| @ton/ton | ^15.4.0 | TON SDK |
| @ton/crypto | ^3.3.0 | 암호화 |
| Tailwind CSS | ^3.4.18 | 스타일링 |
| Vite | ^5.4.21 | 빌드 도구 |

### 3.2 백엔드

| 기술 | 용도 |
|------|------|
| Cloudflare Workers | Serverless 함수 |
| Cloudflare KV | 크레딧 저장소 |
| TonCenter API v2 | 블록체인 조회 |
| @ton/ton | 트랜잭션 생성 |

---

## 4. 파일 구조

```
CandleSpinner/
├── src/                              # 프론트엔드
│   ├── main.tsx                      # 엔트리 포인트
│   ├── App.tsx                       # 메인 앱
│   ├── vite-env.d.ts                 # Vite 타입 선언
│   ├── constants.ts                  # 상수
│   ├── components/                   # UI 컴포넌트
│   │   ├── WalletConnect.tsx         # 지갑 연결 (TON Connect)
│   │   ├── Deposit.tsx               # 입금 UI
│   │   ├── SlotMachine.tsx           # 슬롯 머신
│   │   └── Withdraw.tsx              # 인출 UI
│   ├── hooks/                        # React Hooks
│   │   ├── useTonConnect.ts          # TON Connect 훅
│   │   └── useCredit.ts              # 크레딧 관리 훅
│   ├── api/                          # API 클라이언트
│   │   └── client.ts                 # Fetch wrapper
│   ├── types/                        # TypeScript 타입
│   │   └── index.ts
│   └── styles/                       # 스타일
│       └── index.css                 # Tailwind + 전역 스타일
│
├── functions/                        # 백엔드 (Cloudflare Workers)
│   ├── api/                          # API 핸들러
│   │   ├── verify-deposit.ts         # 입금 확인
│   │   ├── spin.ts                   # 게임 실행
│   │   └── withdraw.ts               # 인출 처리
│   └── lib/                          # 유틸리티
│       ├── ton-client.ts             # TonCenter v2 클라이언트
│       ├── credit-manager.ts         # 크레딧 관리
│       └── game-logic.ts             # 게임 로직
│
├── public/                           # 정적 파일
│   ├── tonconnect-manifest.json      # TON Connect 매니페스트
│   └── icon.png                      # 아이콘
│
├── docs/                             # 문서 (기존)
├── PoC/                              # 개념 증명 (기존)
├── archive/                          # 아카이브 (기존)
│
├── package.json                      # 의존성
├── tsconfig.json                     # TypeScript 설정
├── vite.config.ts                    # Vite 설정
├── tailwind.config.js                # Tailwind 설정
├── wrangler.toml                     # Cloudflare 설정
└── .env.example                      # 환경 변수 예시
```

---

## 5. 상태 관리

### 5.1 클라이언트 상태 (React State)

```typescript
// App.tsx
const [credit, setCredit] = useState<number>(0);
const [isLoading, setIsLoading] = useState<boolean>(false);
const [walletAddress, setWalletAddress] = useState<string | null>(null);
```

### 5.2 서버 상태 (Cloudflare KV)

```typescript
// Key 형식
const CREDIT_KEY = `credit:${walletAddress}`;

// Value 형식
interface CreditData {
  credit: number;
  lastUpdated: string; // ISO timestamp
}
```

---

## 6. 보안 고려사항

### 6.1 크레딧 위변조 방지

```typescript
// 백엔드에서만 크레딧 수정 가능
// 클라이언트는 읽기만 가능
```

### 6.2 게임 지갑 보안

```typescript
// 환경 변수 (Cloudflare Secrets)
GAME_WALLET_MNEMONIC=word1 word2 ... word24
// ⚠️ 절대 Git에 커밋하지 않음
// ⚠️ Cloudflare Dashboard에서만 설정
```

### 6.3 API 레이트 리밋

```typescript
// _rateLimit.ts (향후 구현)
// IP당 분당 10 요청 제한
```

---

## 7. 에러 처리

### 7.1 프론트엔드

```typescript
try {
  const response = await fetch('/api/spin', { ... });
  if (!response.ok) throw new Error('API Error');
  const data = await response.json();
  // ...
} catch (error) {
  console.error('Spin failed:', error);
  alert('게임 실행 실패. 다시 시도해주세요.');
}
```

### 7.2 백엔드

```typescript
export async function onRequestPost(context: any) {
  try {
    // ... 로직
    return new Response(JSON.stringify({ success: true, data }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('[API Error]', error);
    return new Response(JSON.stringify({
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
```

---

## 8. 배포 전략

### 8.1 프론트엔드 (Cloudflare Pages)

```bash
# 빌드
npm run build

# 배포
npm run deploy
# 또는
npx wrangler pages deploy dist
```

### 8.2 백엔드 (Cloudflare Workers)

```bash
# 배포
npm run wrangler:deploy
# 또는
npx wrangler deploy
```

### 8.3 환경 변수 설정

**Cloudflare Dashboard:**
1. Workers & Pages → candlespinner-api
2. Settings → Environment Variables
3. 추가:
   - `GAME_WALLET_MNEMONIC`
   - `GAME_WALLET_ADDRESS`
   - `CSPIN_TOKEN_ADDRESS`
   - `TONCENTER_API_KEY`

---

## 9. 테스트 계획

### Phase 1: 단위 테스트 (향후)
- [ ] 게임 로직 (슬롯 결과 생성)
- [ ] 크레딧 관리 (증가/차감)
- [ ] API 클라이언트

### Phase 2: 통합 테스트
- [ ] 입금 → 크레딧 증가
- [ ] 게임 → 크레딧 차감
- [ ] 인출 → 트랜잭션 전송

### Phase 3: E2E 테스트 (수동)
- [ ] 전체 플로우 (입금 → 게임 → 인출)

---

## 10. 성능 최적화 (향후)

- [ ] React.memo로 컴포넌트 메모이제이션
- [ ] KV 읽기 캐싱
- [ ] 이미지 최적화 (WebP)
- [ ] Code Splitting

---

## 11. 확장성 (Phase 2)

- [ ] 다중 게임 모드 (더블업, 잭팟)
- [ ] 리더보드
- [ ] 애니메이션 (PixiJS)
- [ ] 스마트 컨트랙트 기반 인출
- [ ] NFT 리워드

---

**작성자**: GitHub Copilot  
**최종 검토**: 대기 중 (사용자)
