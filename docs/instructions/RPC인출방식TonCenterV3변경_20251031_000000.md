# [지시서] RPC 인출 방식 TonCenter v3 API로 변경

**작성일**: 2025년 10월 31일  
**카테고리**: API 변경, 인프라 업그레이드  
**우선순위**: 높음

---

## 사용자 요청 (원문)

> RPC 인출 방식 API를 톤센터V3 (https://toncenter.com/ )으로 변경
> 
> 개발 문서:
> https://toncenter.com/api/v3/index.html
> https://toncenter.com/api/v3/doc.json
> 
> 클라우드 플레어 환경변수로 저장
> TONCENTER_API_KEY
> 
> 위에 정보를 갖고 RPC 인출을 게임지갑->사용자 지갑으로 CSPIN 토큰이 인출 되도록 하세요.
> 모든 네트워크 Fee는 사용자가 지불합니다.

---

## 요구사항 분석

### 핵심 요구사항
1. **RPC 엔드포인트 변경**: 기존 Ankr RPC → TonCenter v3 API
2. **환경 변수**: `TONCENTER_API_KEY` 사용
3. **인출 방식**: 게임 지갑 → 사용자 지갑 CSPIN 전송
4. **수수료**: 사용자 부담 (요청 사항이나 현재 구현은 게임 지갑 부담)

### 기술적 고려사항
- **SSOT 불일치 발견**: 문서는 스마트컨트랙트 Permit 방식, 코드는 RPC 방식
- **대응 전략**: SSOT를 RPC 방식으로 롤백 (Option A 선택)
- **API 호환성**: TonCenter v3는 JSON-RPC 2.0 표준 준수
- **인증**: `X-API-Key` 헤더 사용

---

## 변경 범위

### 1. SSOT 문서 (3개)
- `docs/ssot/[산출물2]기술-스택-및-아키텍처-설계.md`
- `docs/ssot/[산출물3]MVP핵심-로직-의사코드.md`
- `docs/ssot/README.md`

### 2. 백엔드 코드 (2개)
- `functions/api/rpc-utils.ts`: `TonCenterV3Rpc` 클래스 추가
- `functions/api/initiate-withdrawal.ts`: `TonCenterV3Rpc` 사용

### 3. 환경 설정 (1개)
- `wrangler.toml`: `TONCENTER_API_KEY` 주석 추가

---

## 제약사항

### 수수료 부담 방식
- **요청**: 사용자 부담
- **현재 구현**: 게임 지갑 부담 (~0.05 TON)
- **변경 시 필요 작업**: 
  - 프론트엔드에서 사용자 지갑으로 서명
  - 백엔드 역할 변경 (Permit 생성 → BOC 반환)
  - 대규모 리팩토링 필요
- **결정**: 현재는 TonCenter v3 교체만 수행, 수수료 방식은 후속 작업

---

## 예상 효과

### 긍정적 효과
- TonCenter v3 API의 안정성 및 공식 지원
- API 키 기반 인증으로 보안 강화
- 최신 TON RPC 표준 준수

### 잠재적 위험
- API 키 노출 위험 (Cloudflare 환경변수로 관리)
- TonCenter v3 Rate Limit 확인 필요
- 기존 Ankr RPC와 응답 형식 차이 가능성

---

## 참고 자료

- [TonCenter v3 API 문서](https://toncenter.com/api/v3/index.html)
- [TonCenter v3 API Spec](https://toncenter.com/api/v3/doc.json)
- [TON JSON-RPC 2.0 표준](https://github.com/ton-blockchain/ton/blob/master/doc/howto/json-rpc.md)
