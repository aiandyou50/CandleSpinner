# [지시서] RPC 인출 `window is not defined` 오류 수정

**작성일**: 2025년 11월 1일  
**카테고리**: 버그 수정, 인프라 안정화  
**우선순위**: 높음

---

## 사용자 요청 (원문)

> 1. 현재 RPC 방식 인출 시 오류가 발생함. 오류 코드 수정 후 해결 요청
>    - 로그: 인출 요청 시 Cloudflare Functions 500 (`window is not defined`)
> 2. 문서화 드리프트가 심함. 현재 칸반 문서에 해당 버그 수정을 진행 중으로 표시

---

## 요구사항 분석

1. **오류 재현**: `/api/initiate-withdrawal` RPC 모드 호출 시 서버 측 번들에서 `window` 전역을 참조하여 Cloudflare 런타임에서 실패.
2. **근본 원인**: Ton 관련 라이브러리 또는 번들 상단이 브라우저 환경을 가정. 워커 환경에는 `window`가 존재하지 않음.
3. **해결 방향**:
   - 공용 폴리필에서 `globalThis.window`(및 필요한 경우 `self`)를 안전하게 정의.
   - API 핸들러 로깅을 보강해 재발 시 추적 용이하게 함.
4. **문서 동기화**: RPC 인출 플로우가 런타임 폴리필을 요구하므로 SSOT 문서에 해당 의존성을 추가.
5. **칸반 반영**: `[In Progress]` 섹션에 버그 수정 항목 추가.

---

## 변경 범위 (예상)

- `functions/_bufferPolyfill.ts` 등 공용 초기화 파일에 전역 폴리필 추가.
- 필요 시 RPC 유틸/인출 핸들러 콘솔 로그 보강.
- SSOT 문서 2종 (`[산출물2]`, `[산출물3]`)에 런타임 요구사항 업데이트.
- `kanban.md`에 버그 작업 추가.

---

## 확인 사항 / 주의점

- Cloudflare Workers에서 `window`를 정의해도 전역 루프 참조가 다른 객체를 요구하지 않는지 확인.
- 기존 `_bufferPolyfill.ts`가 모든 함수 엔트리에서 실행되는지 검증.
- SSOT 문서 수정 시 기존 TonCenter v3 설명과 충돌하지 않도록 문맥 위치 지정.
