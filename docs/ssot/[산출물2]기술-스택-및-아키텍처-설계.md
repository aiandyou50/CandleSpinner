# [산출물 2] 기술 스택 및 아키텍처 (v2.3.0)

**프로젝트명**: CandleSpinner  
**버전**: 2.3.0 (TonCenter v3 RPC 인출)  
**마지막 업데이트**: 2025년 10월 31일  
**상태**: ✅ 프로덕션 배포 중 (RPC 인출 방식 적용)

> **📌 참고**: 이 문서는 상세한 아키텍처 정보를 제공합니다.  
> 최신 정보는 `/docs/ssot/README.md` 섹션 2-3을 참고하세요.

---

## 1. 시스템 아키텍처

### 1.1 전체 흐름도 (RPC 직접 인출 방식)

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 (웹/TMA)                           │
└─────────────────────────────────────────────────────────────┘
                              ▼
        ┌─────────────────────────────────────┐
        │   App.tsx (game/deposit 모드 전환)  │
        └─────────────────────────────────────┘
                     ▼                    ▼
        ┌──────────────────┐    ┌──────────────────┐
        │  Game 모드       │    │  Deposit 모드    │
        │  ┌────────────┐  │    │  ┌────────────┐  │
        │  │ 게임 플레이 │  │    │  │ 입금하기   │  │
        │  │ 스핀/인출   │  │    │  │ TonConnect │  │
        │  └────────────┘  │    │  └────────────┘  │
        └──────────────────┘    └──────────────────┘
                 │                        │
    ┌────────────┼───────────┬────────────┴──────────┐
    ▼            ▼           ▼                       ▼
┌─────────────┐ ┌──────────────────┐ ┌────────────┐ ┌──────────────┐
│ /api/spin   │ │ /api/initiate-   │ │ /api/double│ │ /api/deposit │
│ /api/double-│ │ withdrawal       │ │ -up        │ │              │
│ up          │ │ (RPC 직접 전송)  │ │            │ │ (KV 크레딧   │
└─────────────┘ │                  │ └────────────┘ │  저장)       │
    │           └──────────────────┘       │        └──────────────┘
    │                     │                │              │
    └─────────────┬───────┴────────────────┴──────────────┘
                  ▼
        ┌───────────────────────┐
        │  Cloudflare KV        │
        │  (게임 상태/크레딧)    │
        └───────────────────────┘
                  │
                  ▼
        ┌───────────────────────────────────────┐
        │        TON 블록체인                   │
        │ ┌───────────────────────────────────┐ │
        │ │ TonCenter v3 RPC API              │ │
        │ │ (게임 지갑 → 사용자 지갑)         │ │
        │ └───────────────────────────────────┘ │
        │            ▼                          │
        │ ┌───────────────────────────────────┐ │
        │ │ CSPIN Jetton Master               │ │
        │ │ (사용자 지갑으로 토큰 전송)       │ │
        │ └───────────────────────────────────┘ │
        └───────────────────────────────────────┘
```

---

## 2. 프론트엔드 기술 스택

| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| **React** | 19.2.0 | UI 프레임워크 |
| **TypeScript** | 5.6.2 | 정적 타입 |
| **Vite** | 5.4.8 | 빌드 도구 |
| **Tailwind CSS** | 4.0.0 | 스타일링 |
| **PixiJS** | 8.5.1 | 2D 렌더링 (릴) |
| **Zustand** | 4.5.5 | 상태 관리 |
| **@tonconnect/ui-react** | 2.3.1 | 지갑 연결 UI |
| **@ton/core** | 0.62.0 | TON 트랜잭션 |
| **@ton/ton** | 16.0.0 | TON 클라이언트 |
| **@twa-dev/sdk** | 8.0.2 | Telegram Mini App |

---

## 3. 백엔드 기술 스택

| 항목 | 정보 |
|------|------|
| **배포 플랫폼** | Cloudflare Pages |
| **런타임** | Cloudflare Workers |
| **언어** | TypeScript |
| **데이터 저장소** | Cloudflare KV |

---

## 4. 핵심 컴포넌트

| 컴포넌트 | 파일 | 역할 |
|---------|------|------|
| **App.tsx** | src/App.tsx | 게임/입금 모드 전환 |
| **Game.tsx** | src/components/Game.tsx | 메인 게임 (스핀/출금) |
| **Deposit.tsx** | src/components/Deposit.tsx | TonConnect 입금 |
| **ReelPixi.tsx** | src/components/ReelPixi.tsx | 3릴 애니메이션 |

---

## 5. API 엔드포인트

| 경로 | 기능 | 상태 | 변경 사항 |
|------|------|------|----------|
| `/api/spin` | 스핀 실행 | ✅ 구현 | 유지 |
| `/api/double-up` | 더블업 미니게임 | ✅ 구현 | 유지 |
| `/api/initiate-withdrawal` | **RPC 직접 인출** | ✅ 구현 (v2.3.0) | **TonCenter v3 API 사용** |
| **`/api/deposit`** | **입금 기록** | **✅ 구현** | **유지** |
| **`/api/deposit-rpc`** | **RPC 직접 입금** | **🆕 신규** | **A/B 테스트용** |
| **`/api/get-credit`** | **크레딧 조회** | **✅ 구현** | **유지** |

---

## 5.1 `/api/initiate-withdrawal` 상세 (v2.3.0 - RPC 방식)

**목적**: 게임 지갑에서 사용자 지갑으로 CSPIN 토큰 RPC 직접 인출

**요청**:
```json
{
  "userId": "user123",
  "amount": 1000,
  "userWallet": "0QB_yGkO...xxxxx",
  "userJettonWalletAddress": "EQA...xxxxx"
}
```

**응답**:
```json
{
  "success": true,
  "txHash": "E3...abc",
  "message": "RPC 방식 인출 완료: 1000 CSPIN",
  "newCredit": 5000
}
```

**역할**: 
- ✅ KV에서 크레딧 확인 및 즉시 차감
- ✅ 게임 지갑 프라이빗 키로 Jetton Transfer 메시지 서명
- ✅ TonCenter v3 API(`https://toncenter.com/api/v3/`)로 BOC 전송
- ✅ 트랜잭션 해시 반환
- ✅ 가스비는 게임 지갑이 부담 (~0.05 TON)

**환경 변수**:
- `TONCENTER_API_KEY`: TonCenter API 키 (필수)
- `GAME_WALLET_PRIVATE_KEY`: 게임 지갑 개인키
- `GAME_WALLET_ADDRESS`: 게임 지갑 주소
- `CSPIN_TOKEN_ADDRESS`: CSPIN Jetton Master 주소

**런타임 요구사항**:
- Cloudflare Functions 실행 환경에는 브라우저 전역(`window`, `self`)이 없으므로 `functions/_bufferPolyfill.ts`에서 최소 폴리필을 주입해 Ton SDK 번들이 정상 동작하도록 유지한다.

---

## 6. 데이터 저장소 (Cloudflare KV)

### KV Key 구조

```typescript
// 사용자 잔액
balance:{walletAddress} → string (숫자)

// 게임 상태
state:{walletAddress} → JSON {
  credit: number,
  canDoubleUp: boolean,
  pendingWinnings: number
}

// 트랜잭션 로그
tx:{walletAddress}:{timestamp} → JSON {
  type: 'deposit' | 'withdrawal',
  amount: number,
  method: string,
  txHash: string,
  timestamp: string,
  status: 'confirmed' | 'pending'
}
```

---

## 7. 입금 흐름

### v2.0.0 (TonConnect)
```
1. 게임 화면 → [CSPIN 입금] 버튼 클릭
2. Deposit 컴포넌트 렌더링
3. 입금액 입력
4. TonConnect로 서명
5. /api/deposit 호출
6. KV에 크레딧 저장
7. 게임 복귀 + 크레딧 반영
```

### v2.1.0 (A/B Test 추가)
```
┌────────────────────────────┐
│  [CSPIN 입금] 버튼 클릭    │
└─────────────┬──────────────┘
              │
       ┌──────┴──────┐
       │             │
       ▼             ▼
┌─────────────┐ ┌──────────────┐
│  방법 선택  │ │              │
├─────────────┤ │              │
│ [RPC 입금]  │ │ [TonConnect] │
│ (직접)      │ │ (지갑 중계)  │
└─────────────┘ └──────────────┘
       │             │
       ▼             ▼
  /api/deposit-rpc  /api/deposit
       │             │
       └──────┬──────┘
              │
         KV 저장
              │
         ▼ 게임 복귀
```

**Network Fee**: 모든 방식에서 0.03 TON 고정 (사용자 동의 화면에서 명시)
**A/B 메트릭**: 각 방식별 성공률, 실패율, 평균 시간 추적

---

## 8. 입금 방식 비교 (v2.1.0 A/B Test)

| 항목 | RPC 직접 입금 | TonConnect 입금 |
|------|--------------|-----------------|
| **방식** | ankr.com RPC 직접 호출 | TonConnect 지갑 UI |
| **구현** | 백엔드에서 트랜잭션 생성 및 서명 | 사용자 지갑에서 서명 |
| **보안도** | 🔴 낮음 (프라이빗 키 노출 위험) | 🟢 높음 (사용자만 서명) |
| **속도** | 🟢 빠름 (직접 전송) | 🟡 중간 (확인 필요) |
| **사용자 경험** | ⚠️ 한 버튼 (백엔드 자동 처리) | ✅ 안전 (사용자 확인) |
| **실패율** | 🟡 중간 (RPC 의존) | 🟢 낮음 (사용자 제어) |
| **권장** | ❌ 프로덕션 미권장 | ✅ 프로덕션 권장 |

**목적**: A/B 테스트를 통해 두 방식의 UX/안정성 비교
**결론**: v2.2.0에서 최적 방식 결정

---

## 9. 보안 특징

✅ **프라이빗 키 관리**:
- 사용자 키는 지갑에만 존재
- 백엔드에서 키 관리 없음
- TonConnect 사용자 직접 서명

✅ **입금 검증**:
- TxHash 저장 (추적용)
- KV에 크레딧 바로 추가
- 블록체인 검증 불필요

---

## 10. 배포 프로세스

```
git push → GitHub Actions → Cloudflare Pages → aiandyou.me (배포)
```

---

**작성**: GitHub Copilot  
**라이센스**: MIT

┌──────────────────┐      ┌──────────────────────────────┐      ┌────────────────────────┐
│   User's Device  │      │   Cloudflare Pages Network   │      │      TON Blockchain    │
│ (Web Browser)    ├──────▶ (Full Stack Platform)       ├──────▶ (Smart Contracts &   │
└──────────────────┘      │  - Frontend (React UI)     │      │   User's TON Wallet)   │
         ▲                │  - Backend (Functions)     │      └────────────────────────┘
         │                └───────────┬────────────────┘
         │                            │
         │                            │
         └────────────────────────────┘
(User Interaction)      (Off-chain Logic & API)         (On-chain Transactions)

 * User's Device: 사용자가 모바일 또는 PC 브라우저를 통해 게임에 접속합니다.
 * Cloudflare Network:
   * Cloudflare Pages (Full Stack Platform): 깃허브 레포지토리와 연결된 단일 플랫폼입니다. 사용자의 React 프론트엔드(정적 에셋)와 백엔드 서버리스 함수(Workers 로직)를 함께 빌드하고 전 세계 엣지 네트워크에 배포합니다.
 * TON Blockchain: 실제 자산(CSPIN 토큰)의 입금 및 인출을 처리하는 탈중앙화 네트워크입니다.
2. 프론트엔드 (Frontend)
사용자 인터페이스와 경험을 담당하는 영역입니다. (Cloudflare Pages가 정적 에셋으로 빌드하여 제공)
 * 개발 프레임워크: React (with Vite)
   * 선택 이유: 가장 큰 개발자 생태계를 보유하고 있어 라이브러리 및 레퍼런스 확보가 용이합니다. Vite를 빌드 도구로 사용하여 매우 빠른 개발 서버 속도와 최적화된 빌드 결과를 보장합니다.
 * 그래픽 및 애니메이션: PixiJS
   * 선택 이유: WebGL 기반의 고성능 2D 렌더링 라이브러리로, 슬롯머신의 부드러운 릴(Reel) 회전 및 화려한 당첨 효과를 구현하는 데 최적화되어 있습니다.
 * UI 컴포넌트 및 스타일링: Tailwind CSS & shadcn/ui
   * 선택 이유: 유틸리티 우선(Utility-first) 접근 방식으로 신속하게 UI를 구축할 수 있습니다. shadcn/ui를 통해 미리 디자인된 고품질 컴포넌트(버튼, 입력 필드 등)를 손쉽게 커스터마이징하여 네온사인 컨셉을 구현합니다.
 * 상태 관리: Zustand
   * 선택 이유: 매우 가볍고 간단한 API를 제공하여 React의 상태 관리를 쉽게 만들어 줍니다. 사용자의 게임 크레딧, 베팅 금액 등 전역적으로 관리되어야 할 상태를 효율적으로 처리합니다.
 * 다국어 지원(i18n): i18next
   * 선택 이유: React 환경에서 가장 널리 사용되는 국제화 라이브러리로, 정의서에 명시된 7개 언어를 체계적으로 관리하고 동적으로 변경하는 기능을 제공합니다.
3. 백엔드 (Serverless Functions on Pages)
오프체인 게임 로직을 처리하는 서버 영역입니다. 이 로직은 Cloudflare의 Workers 기술을 기반으로 하며, 프론트엔드와 동일한 Cloudflare Pages 플랫폼을 통해 배포됩니다.
 * 플랫폼: Cloudflare Pages (Functions)
   * 선택 이유: 별도의 백엔드 서버나 Workers 플랫폼 설정 없이, React 앱과 동일한 프로젝트 내 functions/ 디렉토리에 API 코드를 작성하면(Pages Full Stack) 자동으로 배포됩니다. 이는 글로벌 엣지에서 실행되어 빠른 응답 속도를 보장합니다.
 * 언어: TypeScript
   * 선택 이유: 정적 타입을 지원하여 코드의 안정성을 높이고, 프론트엔드와 동일한 언어를 사용하여 개발 생산성을 극대화합니다.
 * 환경 변수 (Environment Variables):
   * GAME_WALLET_PRIVATE_KEY: 게임 지갑의 프라이빗 키 (16진수 형식). 니모닉에서 wallet-tools/mnemonic-to-key.mjs를 통해 변환하여 설정.
   * **TON_RPC_HTTPS_ENDPOINT**: Ankr RPC 엔드포인트 (https://mainnet-v4.akka.tonwhales.com 또는 ankr.com)
   * **TON_RPC_API_KEY**: Ankr API 키 (RPC 직접 호출용)
   * **NETWORK_FEE_TON**: 명시적 네트워크 Fee (0.03 TON 고정)
   * 선택 이유: CSPIN 인출 트랜잭션 서명을 위해 필요하며, Cloudflare 대시보드에서 암호화된 환경변수로 안전하게 관리.
 * 핵심 API 엔드포인트:
   * (Pages는 functions/api/spin.ts 파일을 /api/spin으로 자동 라우팅합니다.)
   * /api/spin: 사용자의 베팅 요청을 받아 Provably Fair 알고리즘으로 스핀 결과를 생성하고 반환합니다.
   * /api/double-up: 미니게임 요청을 받아 50% 확률의 성공/실패 결과를 반환합니다.
   * /api/state: 사용자의 현재 게임 크레딧 상태를 조회합니다.
 * 오프체인 데이터 저장소: Cloudflare KV
   * 선택 이유: Cloudflare Pages Functions(Workers 로직)에 최적화된 초저지연 Key-Value 저장소입니다. 사용자의 지갑 주소를 Key로, 현재 보유 크레딧을 Value로 저장하여 오프체인 잔액을 관리하는 데 가장 이상적입니다. (예: {'UQBF...R8Mtd': { credit: 5000 }})
4. 블록체인 연동 (Blockchain Integration)
웹 애플리케이션과 TON 블록체인을 연결하는 영역입니다.
 * 지갑 연결 UI: @tonconnect/ui-react
   * 선택 이유: TON 공식 라이브러리로, 'Wallet 연결' 버튼과 QR 코드 모달 등 TON Connect 표준 UI를 단 몇 줄의 코드로 손쉽게 구현할 수 있습니다.
   * **v2.0.x 개선사항**:
     - v2.0.1: 웹 환경에서 TonConnect 버튼 표시
     - v2.0.2: TMA 환경에서도 TonConnect 버튼 표시
       - `App.tsx`: TMA 환경 `<header>` 추가
       - 모든 사용자가 지갑 연결 가능 (TMA/웹 통일)
   * **v2.0.2 주소 형식 수정**:
     - 문제: `address: CSPIN_JETTON_WALLET` (문자열) → TonConnect 거부
     - 해결: `address: Address.parse(CSPIN_JETTON_WALLET).toString()` 적용
     - 결과: 정식 Address 형식 준수
 * 트랜잭션 생성 및 전송: ton-core, ton-crypto
   * 선택 이유: TON 블록체인의 트랜잭션을 구성하고 서명을 요청하는 핵심 라이브러리입니다. 프론트엔드에서 이 라이브러리들을 사용하여 CSPIN 토큰의 입금(Deposit) 및 인출(Withdraw) 트랜잭션 메시지를 생성하고, 사용자의 지갑에 전송하여 서명을 요청하게 됩니다.
5. 개발 및 배포 (CI/CD Pipeline)
 * 소스 코드 관리: GitHub
   * 역할: 모든 프론트엔드(React) 및 백엔드(Functions) 코드를 단일 저장소에서 관리.
 * 자동 빌드 및 배포: Cloudflare Pages GitHub Integration
   * 작동 방식:
     * 개발자가 main 브랜치에 코드를 git push 합니다.
     * GitHub이 변경 사항을 Cloudflare Pages에 자동으로 알립니다.
     * Cloudflare Pages는 최신 코드를 가져와 React 앱을 빌드(정적 파일 생성)하고, functions/ 디렉토리의 백엔드 코드(Workers 로직)를 함께 패키징합니다.
     * 빌드가 성공하면, 새로운 버전이 전 세계 Cloudflare 엣지 네트워크에 수 분 내로 배포 완료됩니다.

---

## 8. 스마트컨트랙트 연동 (신규: v2.2.0+)

### 8.1 Withdrawal Smart Contract (인출 계약)

**개요**: 사용자가 백엔드의 서명된 허가증(Permit)을 사용하여 CSPIN 토큰을 자신의 지갑으로 직접 인출

**기술 사양**:
| 항목 | 내용 |
|------|------|
| **언어** | Tact v4.0 (TON 네이티브 언어) |
| **표준** | TEP-74 (Jetton 토큰 표준) |
| **배포 위치** | `contracts/sources/WithdrawalManager.tact` |
| **상태** | ✅ 코드 작성 완료 (v2.2.0) |

**핵심 메시지 타입**:

```typescript
// 사용자 인출 요청 (기존)
message WithdrawalRequest {
    queryId: UInt64;
    amount: Coins;
    destination: Address;
}

// 허가증 기반 인출 (신규 v2.2.0+)
message WithdrawWithPermit {
    queryId: UInt64;
    signature: Slice;          // 백엔드 서명 (Secp256k1)
    message: Cell;             // 허가증 메시지
    nonce: Int;                // 중복 방지
    deadline: Int;             // 유효 기한
    destination: Address;      // 수신자 지갑
}
```

**Getter 함수**:
| 함수 | 반환값 | 용도 |
|------|--------|------|
| `stats()` | (processedRequests, totalWithdrawn, totalGasCollected, isPaused) | 계약 통계 조회 |
| `isPaused()` | Bool | 정지 상태 조회 |
| `getProcessedRequests()` | Int | 처리된 요청 수 |
| `getTotalWithdrawn()` | Int | 총 출금액 |
| `getTotalGasCollected()` | Int | 징수한 총 가스비 |

**배포 정보**:
- **테스트넷**: EQA...xxxxx (배포 예정 - 2025-10-26)
- **메인넷**: EQB...yyyyy (배포 예정 - 이후)

### 8.2 프론트엔드 스마트컨트랙트 호출

**프로세스**:

```typescript
// Step 1: Permit 데이터 수령 (백엔드)
const permitData = await fetch('/api/initiate-withdrawal', {
  method: 'POST',
  body: JSON.stringify({ userId, amount, userWallet })
});

// Step 2: TonConnect로 스마트컨트랙트 호출 (프론트엔드)
const transaction = {
  valid_until: Math.floor(Date.now() / 1000) + 600,
  messages: [{
    address: WITHDRAWAL_CONTRACT_ADDRESS,
    amount: toNano('0.1'),  // 가스비
    payload: createWithdrawalPayload(permitData)  // WithdrawWithPermit 메시지
  }]
};

const txHash = await tonConnectUI.sendTransaction(transaction);

// Step 3: 트랜잭션 확인 후 백엔드에 알림 (프론트엔드)
await fetch('/api/confirm-withdrawal', {
  method: 'POST',
  body: JSON.stringify({ txHash, userId, amount })
});
```

**보안 특징**:
- ✅ **백엔드 서명**: `GAME_WALLET_PRIVATE_KEY`로 허가증 서명
- ✅ **공개키 검증**: 스마트컨트랙트가 공개키로 서명 검증
- ✅ **타임스탐프 검증**: deadline으로 재생 공격(replay attack) 방지
- ✅ **Nonce 관리**: 중복 인출 방지

