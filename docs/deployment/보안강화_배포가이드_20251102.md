# ë°°í¬ ê°€ì´ë“œ - ë³´ì•ˆ ê°•í™” ë²„ì „

**ì‘ì„±ì¼**: 2025-11-02  
**ë²„ì „**: v2.1 (ë³´ì•ˆ ê°•í™”)

---

## ğŸ¯ ì´ë²ˆ ë°°í¬ ë‚´ìš©

### 1. `/admin` ì ‘ì† ë¬¸ì œ í•´ê²° âœ…
- **ë¬¸ì œ**: dist/_routes.json ëˆ„ë½
- **í•´ê²°**: vite.config.tsì— ìë™ ìƒì„± í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€
- **ê²°ê³¼**: ë¹Œë“œ ì‹œ ìë™ìœ¼ë¡œ _routes.json ìƒì„±

### 2. ë³´ì•ˆ ê°•í™” (ë¦¬í”Œë ˆì´ ê³µê²© ë°©ì§€) âœ…
- **ì¶”ê°€**: íƒ€ì„ìŠ¤íƒ¬í”„ + ë…¼ìŠ¤(nonce) ê²€ì¦
- **íš¨ê³¼**: ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨, ë§Œë£Œëœ ìš”ì²­ ê±°ë¶€ (5ë¶„)
- **ë³€ê²½ íŒŒì¼**:
  - `src/components/Withdraw.tsx`
  - `src/index.ts`

### 3. TON ì„ ì§€ë¶ˆ ë°©ì‹ ë¶„ì„ âœ…
- **ê²°ë¡ **: ê¸°ìˆ ì ìœ¼ë¡œ ê°€ëŠ¥í•˜ë‚˜ UX ë¬¸ì œë¡œ ë¹„ì¶”ì²œ
- **ëŒ€ì•ˆ**: í¬ë ˆë”§ ìˆ˜ìˆ˜ë£Œ ë°©ì‹ ê¶Œì¥
- **ë¬¸ì„œ**: `docs/analysis/TONì„ ì§€ë¶ˆ_ì¸ì¶œì‹œìŠ¤í…œ_ë¶„ì„_20251102.md`

---

## ğŸš€ ë°°í¬ ë°©ë²•

### ë°©ë²• 1: Git ìë™ ë°°í¬ (ê¶Œì¥)
```powershell
# 1. ë³€ê²½ì‚¬í•­ ì»¤ë°‹
git add .
git commit -m "feat: /admin ë¼ìš°íŒ… ìˆ˜ì • + ë³´ì•ˆ ê°•í™” (íƒ€ì„ìŠ¤íƒ¬í”„+ë…¼ìŠ¤)"

# 2. GitHub í‘¸ì‹œ
git push origin main

# 3. Cloudflare Pages ìë™ ë°°í¬ (2-3ë¶„)
# â†’ https://dash.cloudflare.com/pages
```

### ë°©ë²• 2: ìˆ˜ë™ ë°°í¬
```powershell
# Wrangler CLI ì‚¬ìš©
npx wrangler deploy
```

---

## âœ… ë°°í¬ í›„ í…ŒìŠ¤íŠ¸

### 1. ê´€ë¦¬ì í˜ì´ì§€ ì ‘ì† í…ŒìŠ¤íŠ¸
```
URL: https://aiandyou.me/admin

ê¸°ëŒ€ ê²°ê³¼:
âœ… í˜ì´ì§€ ë¡œë“œ ì„±ê³µ
âœ… "ğŸ” ê´€ë¦¬ì ì¸ì¦ í•„ìš”" ë©”ì‹œì§€ í‘œì‹œ
âœ… ì§€ê°‘ ì—°ê²° UI í‘œì‹œ
```

### 2. ê´€ë¦¬ì ì¸ì¦ í…ŒìŠ¤íŠ¸
```
1. TON Connect ì§€ê°‘ ì—°ê²°
2. ê²Œì„ ìš´ì˜ì ì§€ê°‘ ì—°ê²° ì‹œ:
   âœ… "ëŒ€ê¸° ì¤‘ì¸ ì¸ì¶œ" ëª©ë¡ í‘œì‹œ
   âœ… [ìƒˆë¡œê³ ì¹¨] [âœ… ì²˜ë¦¬] ë²„íŠ¼ í‘œì‹œ
3. ë‹¤ë¥¸ ì§€ê°‘ ì—°ê²° ì‹œ:
   âŒ "ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ" ë©”ì‹œì§€
   âŒ í˜„ì¬/í•„ìš” ì£¼ì†Œ í‘œì‹œ
```

### 3. ë³´ì•ˆ ê°•í™” í…ŒìŠ¤íŠ¸
```
ì¸ì¶œ ìš”ì²­ ì‹œ:
âœ… ë…¼ìŠ¤ ìë™ ìƒì„± (UUID)
âœ… íƒ€ì„ìŠ¤íƒ¬í”„ ìë™ ìƒì„±
âœ… ë°±ì—”ë“œ ê²€ì¦ í†µê³¼
âœ… í¬ë ˆë”§ ì°¨ê° ì„±ê³µ

ë¦¬í”Œë ˆì´ ê³µê²© ì‹œë„:
âŒ ë™ì¼í•œ ìš”ì²­ 2ë²ˆ ì „ì†¡ â†’ "Duplicate request" ì˜¤ë¥˜
âŒ 5ë¶„ ì§€ë‚œ ìš”ì²­ â†’ "Request expired" ì˜¤ë¥˜
```

---

## ğŸ”§ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

### í”„ë¡ íŠ¸ì—”ë“œ
- `src/components/Withdraw.tsx`
  - useTonConnectUI ì„í¬íŠ¸ ì¶”ê°€
  - íƒ€ì„ìŠ¤íƒ¬í”„ + ë…¼ìŠ¤ ìƒì„± ë¡œì§
  - ë³´ì•ˆ í† í° í¬í•¨ ìš”ì²­ ì „ì†¡

### ë°±ì—”ë“œ
- `src/index.ts` - handleWithdrawRequest
  - action ê²€ì¦ ì¶”ê°€
  - íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (5ë¶„ ìœ íš¨)
  - ë…¼ìŠ¤ ì¤‘ë³µ í™•ì¸ (KV ì €ì¥, 10ë¶„ TTL)
  - userAddress í•„ë“œëª… ë³€ê²½

### ë¹Œë“œ ì„¤ì •
- `vite.config.ts`
  - _routes.json ìë™ ìƒì„± í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€
  - closeBundle í›…ì—ì„œ íŒŒì¼ ìƒì„±

---

## ğŸ“Š ë³´ì•ˆ ê°•í™” ì„¸ë¶€ì‚¬í•­

### ë¦¬í”Œë ˆì´ ê³µê²© ë°©ì§€
```typescript
// í”„ë¡ íŠ¸ì—”ë“œ (Withdraw.tsx)
const timestamp = Date.now();
const nonce = crypto.randomUUID();

const withdrawRequest = {
  action: 'withdraw',
  amount: withdrawAmount,
  userAddress: walletAddress,
  timestamp,
  nonce
};

// ë°±ì—”ë“œ (src/index.ts)
// 1. íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦
const age = Date.now() - body.timestamp;
if (age > 300000 || age < 0) {  // 5ë¶„
  return error('Request expired');
}

// 2. ë…¼ìŠ¤ ì¤‘ë³µ í™•ì¸
const nonceKey = `nonce:${body.nonce}`;
const existingNonce = await env.CREDIT_KV.get(nonceKey);
if (existingNonce) {
  return error('Duplicate request');
}

// 3. ë…¼ìŠ¤ ì €ì¥ (10ë¶„ TTL)
await env.CREDIT_KV.put(nonceKey, 'used', { expirationTtl: 600 });
```

### ë³´ì•ˆ íš¨ê³¼
- âœ… **ë¦¬í”Œë ˆì´ ê³µê²© ì°¨ë‹¨**: ë™ì¼í•œ ë…¼ìŠ¤ ì¬ì‚¬ìš© ë¶ˆê°€
- âœ… **íƒ€ì„ì•„ì›ƒ**: 5ë¶„ ì´ìƒ ì§€ë‚œ ìš”ì²­ ê±°ë¶€
- âœ… **ìë™ ì •ë¦¬**: ë…¼ìŠ¤ 10ë¶„ í›„ ìë™ ì‚­ì œ (KV ìš©ëŸ‰ ì ˆì•½)

---

## ğŸ› ë¬¸ì œ í•´ê²°

### 1. /admin ì—¬ì „íˆ 404
```powershell
# dist/_routes.json í™•ì¸
cat dist/_routes.json

# ê¸°ëŒ€ ê²°ê³¼:
{
  "version": 1,
  "include": ["/*"],
  "exclude": ["/assets/*"]
}

# ì—†ìœ¼ë©´ ë‹¤ì‹œ ë¹Œë“œ
npm run build
```

### 2. ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨
```
ì˜¤ë¥˜: "Request expired"
â†’ í´ë¼ì´ì–¸íŠ¸ ì‹œê°„ í™•ì¸ (NTP ë™ê¸°í™”)
â†’ 5ë¶„ ì´ìƒ í˜ì´ì§€ ì—´ì–´ë‘ì§€ ë§ ê²ƒ

ì˜¤ë¥˜: "Duplicate request"
â†’ ì •ìƒ! ë¦¬í”Œë ˆì´ ê³µê²© ì°¨ë‹¨
â†’ ìƒˆë¡œ ì¸ì¶œ ìš”ì²­
```

### 3. Cloudflare Pages ë¹Œë“œ ì‹¤íŒ¨
```
ì˜¤ë¥˜: vite.config.ts ì»´íŒŒì¼ ì‹¤íŒ¨
â†’ fs ëª¨ë“ˆ ëˆ„ë½

í•´ê²°:
# package.jsonì— @types/node ì¶”ê°€ í™•ì¸
npm install --save-dev @types/node
```

---

## ğŸ“‹ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë¡œì»¬ ë¹Œë“œ ì„±ê³µ (`npm run build`)
- [ ] dist/_routes.json ìƒì„± í™•ì¸
- [ ] Git ì»¤ë°‹ ë° í‘¸ì‹œ
- [ ] Cloudflare Pages ë¹Œë“œ ì„±ê³µ í™•ì¸
- [ ] https://aiandyou.me ì •ìƒ ì‘ë™
- [ ] https://aiandyou.me/admin ì ‘ì† í™•ì¸
- [ ] ê²Œì„ ìš´ì˜ì ì§€ê°‘ìœ¼ë¡œ ì¸ì¦ í…ŒìŠ¤íŠ¸
- [ ] ì¸ì¶œ ìš”ì²­ ë³´ì•ˆ ê²€ì¦ í…ŒìŠ¤íŠ¸
- [ ] ë¦¬í”Œë ˆì´ ê³µê²© ì°¨ë‹¨ í™•ì¸

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒ)

### Option 1: í¬ë ˆë”§ ìˆ˜ìˆ˜ë£Œ ì¶”ê°€
```typescript
// src/index.ts
const FEE_CSPIN = 5;  // 5 CSPIN ìˆ˜ìˆ˜ë£Œ

if (current.credit < body.amount + FEE_CSPIN) {
  return error('Insufficient credit (including fee)');
}

const newCredit = current.credit - body.amount - FEE_CSPIN;
```

**íš¨ê³¼**: ê²Œì„ ìš´ì˜ ë¹„ìš© ì ˆê°

### Option 2: ìµœì†Œ ì¸ì¶œ ê¸ˆì•¡ ì„¤ì •
```typescript
// src/index.ts
const MIN_WITHDRAW = 50;  // 50 CSPIN

if (body.amount < MIN_WITHDRAW) {
  return error(`Minimum withdrawal: ${MIN_WITHDRAW} CSPIN`);
}
```

**íš¨ê³¼**: ì¸ì¶œ ê±´ìˆ˜ ê°ì†Œ â†’ ë¹„ìš© ì ˆê°

### Option 3: ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”
```typescript
// í•˜ë£¨ 1íšŒ ëŒ€ì‹  ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
// 10ê±´ ì´ìƒ ìŒ“ì´ë©´ ìë™ ì²˜ë¦¬
```

**íš¨ê³¼**: ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

## ğŸ“ ë¬¸ì œ ë°œìƒ ì‹œ

1. **Cloudflare Dashboard í™•ì¸**
   - https://dash.cloudflare.com/pages
   - ë¹Œë“œ ë¡œê·¸ í™•ì¸

2. **Browser Console í™•ì¸**
   - F12 â†’ Console
   - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í™•ì¸

3. **Cloudflare Workers ë¡œê·¸**
   - https://dash.cloudflare.com/workers
   - Real-time Logs

---

## ğŸ‰ ì™„ë£Œ!

ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ë©´ ë°°í¬ ì™„ë£Œì…ë‹ˆë‹¤.

**ë³€ê²½ì‚¬í•­ ìš”ì•½**:
- âœ… /admin ë¼ìš°íŒ… ìˆ˜ì •
- âœ… ë³´ì•ˆ ê°•í™” (íƒ€ì„ìŠ¤íƒ¬í”„ + ë…¼ìŠ¤)
- âœ… ë¹Œë“œ ìë™í™” ê°œì„ 
