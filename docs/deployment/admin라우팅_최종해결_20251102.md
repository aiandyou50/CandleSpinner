# ğŸ‰ /admin ì ‘ì† ë¬¸ì œ ìµœì¢… í•´ê²°

**ì‘ì„±ì¼**: 2025-11-02  
**ë¬¸ì œ**: Error 1101 - Worker threw exception  
**ì›ì¸**: ASSETS ë°”ì¸ë”© ë¯¸ì„¤ì •  
**í•´ê²°**: wrangler.toml ìˆ˜ì • + ASSETS ì—ëŸ¬ í•¸ë“¤ë§

---

## ğŸ” ë¬¸ì œ ë¶„ì„

### Error 1101ì˜ ì›ì¸
```
TypeError: Cannot read properties of undefined (reading 'fetch')
```

**ê·¼ë³¸ ì›ì¸**: `env.ASSETS.fetch()`ì—ì„œ `env.ASSETS`ê°€ undefined

### ì™œ ASSETSê°€ undefinedì¸ê°€?

1. **wrangler.toml ì„¤ì • ë¯¸í¡**
   ```toml
   # âŒ ì˜ëª»ëœ ì„¤ì •
   [assets]
   directory = "./dist"
   
   # âœ… ì˜¬ë°”ë¥¸ ì„¤ì •
   [assets]
   directory = "./dist"
   binding = "ASSETS"  # ëª…ì‹œì  ë°”ì¸ë”© í•„ìš”
   ```

2. **Cloudflare Workers ë²„ì „ ë¬¸ì œ**
   - Wrangler 3.x: ASSETS ìë™ ë°”ì¸ë”© ë¶ˆì•ˆì •
   - Wrangler 4.x: ASSETS ì•ˆì •ì  ì§€ì›

---

## âœ… í•´ê²° ë°©ë²•

### 1. wrangler.toml ìˆ˜ì •
```toml
# ë³€ê²½ ì „
compatibility_date = "2024-11-01"
main = "src/index.ts"
node_compat = true

[assets]
directory = "./dist"

# ë³€ê²½ í›„
compatibility_date = "2024-11-01"
main = "src/index.ts"
compatibility_flags = ["nodejs_compat"]

[assets]
directory = "./dist"
binding = "ASSETS"
```

**ë³€ê²½ì‚¬í•­**:
- `node_compat = true` â†’ `compatibility_flags = ["nodejs_compat"]`
- `binding = "ASSETS"` ì¶”ê°€

### 2. src/index.ts - ASSETS ì—ëŸ¬ í•¸ë“¤ë§
```typescript
// âœ… ASSETSê°€ ìˆëŠ” ê²½ìš° (ì •ìƒ)
if (env.ASSETS) {
  if (!url.pathname.startsWith('/api') && !url.pathname.startsWith('/assets/')) {
    console.log('[SPA] Redirecting to index.html:', url.pathname);
    const indexRequest = new Request(new URL('/', url), request);
    return env.ASSETS.fetch(indexRequest);
  }
  return env.ASSETS.fetch(request);
}

// âŒ ASSETSê°€ ì—†ëŠ” ê²½ìš° - ì—ëŸ¬ í˜ì´ì§€ ë°˜í™˜
return new Response(
  `<!DOCTYPE html>
  <html>
  <head><title>Configuration Error</title></head>
  <body>
    <h1>Workers Configuration Error</h1>
    <p>ASSETS binding is not configured.</p>
    <p>Please deploy using: <code>npx wrangler deploy</code></p>
  </body>
  </html>`,
  { status: 500, headers: { 'Content-Type': 'text/html' } }
);
```

### 3. vite.config.ts - _routes.json ìë™ ìƒì„±
```typescript
// âœ… ì´ë¯¸ êµ¬í˜„ë¨
{
  name: 'generate-routes-json',
  closeBundle() {
    const routesJson = {
      version: 1,
      include: ['/*'],
      exclude: ['/assets/*']
    };
    fs.writeFileSync(
      path.resolve(__dirname, 'dist/_routes.json'),
      JSON.stringify(routesJson, null, 2)
    );
  }
}
```

---

## ğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤

### 1ë‹¨ê³„: ë¹Œë“œ
```powershell
npm run build
```

**í™•ì¸ì‚¬í•­**:
- âœ… dist/_routes.json ìƒì„±
- âœ… dist/index.html ìƒì„±
- âœ… dist/assets/ í´ë” ìƒì„±

### 2ë‹¨ê³„: Workers ë°°í¬
```powershell
npx wrangler deploy
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
ğŸŒ€ Building list of assets...
ğŸŒ€ Starting asset upload...
âœ¨ Success! Uploaded 4 files

Your worker has access to the following bindings:
- KV Namespaces:
  - CREDIT_KV: 0190e4e479144180a5e0ee7bd47b959b
  
Deployed candlespinner-workers triggers
  https://candlespinner-workers.x00518.workers.dev
```

### 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸
```powershell
# 1. ë©”ì¸ í˜ì´ì§€
curl https://aiandyou.me/

# 2. ê´€ë¦¬ì í˜ì´ì§€
curl https://aiandyou.me/admin

# 3. API ì—”ë“œí¬ì¸íŠ¸
curl https://aiandyou.me/api/check-api-key
```

**ê¸°ëŒ€ ê²°ê³¼**:
- âœ… ëª¨ë‘ index.html ë°˜í™˜ (SPA)
- âœ… APIëŠ” JSON ë°˜í™˜

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

### âœ… ì„±ê³µ ì¼€ì´ìŠ¤

#### 1. ë©”ì¸ í˜ì´ì§€ (/)
```html
<!DOCTYPE html>
<html lang="ko">
  <head>
    <title>CandleSpinner - TON Slot Machine</title>
    <script src="/assets/index-CzHxvIXt.js"></script>
    <link href="/assets/index-DLFzXh3H.css">
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
```

#### 2. ê´€ë¦¬ì í˜ì´ì§€ (/admin)
```html
<!-- ë™ì¼í•œ index.html ë°˜í™˜ -->
<!-- React Routerê°€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ /admin ë Œë”ë§ -->
âœ… ì •ìƒ ì‘ë™!
```

#### 3. API ì—”ë“œí¬ì¸íŠ¸ (/api/check-api-key)
```json
{
  "status": "ok",
  "hasApiKey": true
}
```

---

## ğŸ¯ ìµœì¢… í™•ì¸ ì‚¬í•­

### ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸
1. https://aiandyou.me ì ‘ì†
   - âœ… ê²Œì„ í˜ì´ì§€ ë¡œë“œ
   - âœ… TON Connect ì‘ë™

2. https://aiandyou.me/admin ì ‘ì†
   - âœ… ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ
   - âœ… "ğŸ” ê´€ë¦¬ì ì¸ì¦ í•„ìš”" í‘œì‹œ

3. TON Connect ì—°ê²°
   - âœ… ê²Œì„ ìš´ì˜ì ì§€ê°‘: ê´€ë¦¬ì ê¸°ëŠ¥ í‘œì‹œ
   - âœ… ë‹¤ë¥¸ ì§€ê°‘: "ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ"

### ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
1. **ì¸ì¶œ ìš”ì²­** (ì‚¬ìš©ì)
   - âœ… ë…¼ìŠ¤ + íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
   - âœ… ë°±ì—”ë“œ ê²€ì¦ í†µê³¼
   - âœ… í¬ë ˆë”§ ì°¨ê°
   - âœ… ëŒ€ê¸°ì—´ ì¶”ê°€

2. **ì¸ì¶œ ì²˜ë¦¬** (ê´€ë¦¬ì)
   - âœ… ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ
   - âœ… [ìƒˆë¡œê³ ì¹¨] ë²„íŠ¼ ì‘ë™
   - âœ… [âœ… ì²˜ë¦¬] ë²„íŠ¼ ì‘ë™

---

## ğŸ› ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

### 1. ì—¬ì „íˆ Error 1101 ë°œìƒ
```powershell
# Cloudflare Workers ë¡œê·¸ í™•ì¸
npx wrangler tail

# ë˜ëŠ” Dashboard
https://dash.cloudflare.com/workers â†’ candlespinner-workers â†’ Logs
```

**í™•ì¸ì‚¬í•­**:
- env.ASSETSê°€ undefinedì¸ê°€?
- wrangler.tomlì— binding = "ASSETS" ìˆëŠ”ê°€?
- ìµœì‹  ì½”ë“œê°€ ë°°í¬ë˜ì—ˆëŠ”ê°€?

### 2. /adminì´ 404 ë°˜í™˜
```powershell
# SPA ë¦¬ë””ë ‰ì…˜ ë¡œì§ í™•ì¸
curl -v https://aiandyou.me/admin

# ë¡œê·¸ í™•ì¸
[SPA] pathname: /admin
[SPA] Redirecting to index.html: /admin
```

**í•´ê²°**:
- src/index.tsì˜ SPA ë¡œì§ í™•ì¸
- `!url.pathname.startsWith('/api')` ì¡°ê±´ í™•ì¸

### 3. ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ ì˜¤ë¥˜
```
í˜„ìƒ: "ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ" í‘œì‹œ
ì›ì¸: GAME_WALLET_ADDRESS ë¶ˆì¼ì¹˜
```

**í•´ê²°**:
```typescript
// src/constants.ts
export const GAME_WALLET_ADDRESS = 'UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd';

// ì‹¤ì œ ì—°ê²°ëœ ì§€ê°‘ ì£¼ì†Œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
```

---

## ğŸ“¦ ë°°í¬ëœ íŒŒì¼

### Cloudflare Workers
- `src/index.ts` (ë°±ì—”ë“œ ë¡œì§)
  - API ë¼ìš°íŒ…
  - SPA ë¦¬ë””ë ‰ì…˜
  - ASSETS ì—ëŸ¬ í•¸ë“¤ë§

### Assets (dist/)
- `index.html`
- `assets/index-CzHxvIXt.js` (React ì•±)
- `assets/index-DLFzXh3H.css`
- `icon.png`
- `tonconnect-manifest.json`
- `_routes.json` (ìë™ ìƒì„±)

---

## ğŸ‰ ì™„ë£Œ!

### êµ¬í˜„ëœ ê¸°ëŠ¥
- âœ… /admin ì ‘ì† ê°€ëŠ¥
- âœ… React Router SPA ë¼ìš°íŒ…
- âœ… ê´€ë¦¬ì ì¸ì¦ (ê²Œì„ ìš´ì˜ì ì§€ê°‘)
- âœ… ë³´ì•ˆ ê°•í™” (íƒ€ì„ìŠ¤íƒ¬í”„ + ë…¼ìŠ¤)
- âœ… ìˆ˜ë™ ì¸ì¶œ ì‹œìŠ¤í…œ

### ë‹¤ìŒ ë‹¨ê³„
1. **í…ŒìŠ¤íŠ¸**: ì‹¤ì œ ì¸ì¶œ ì²˜ë¦¬ ì—”ë“œíˆ¬ì—”ë“œ
2. **ìµœì í™”**: í¬ë ˆë”§ ìˆ˜ìˆ˜ë£Œ ì¶”ê°€
3. **ìë™í™”**: ë°°ì¹˜ ì²˜ë¦¬ ê°œì„ 

---

## ğŸ“ ì§€ì›

ë¬¸ì œ ë°œìƒ ì‹œ:
1. Cloudflare Workers ë¡œê·¸ í™•ì¸
2. ë¸Œë¼ìš°ì € Console í™•ì¸ (F12)
3. Network íƒ­ì—ì„œ API ì‘ë‹µ í™•ì¸

**ì„±ê³µì ì¸ ë°°í¬ë¥¼ ì¶•í•˜í•©ë‹ˆë‹¤!** ğŸ‰
