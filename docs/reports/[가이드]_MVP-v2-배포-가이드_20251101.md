# MVP v2 배포 가이드

**작성일**: 2025-11-01  
**버전**: v2.0.0

---

## 1. Cloudflare KV Namespace 생성

```powershell
# KV Namespace 생성
npx wrangler kv:namespace create "CREDIT_KV"

# 결과 예시:
# { binding = "CREDIT_KV", id = "abc123..." }

# wrangler.toml 업데이트
# [[kv_namespaces]]
# binding = "CREDIT_KV"
# id = "abc123..."  # 위 결과의 id 값
```

---

## 2. Cloudflare Workers 환경 변수 설정

### Dashboard에서 설정:
1. Cloudflare Dashboard → Workers & Pages
2. `candlespinner-workers-api` 선택
3. Settings → Variables → Edit variables
4. 추가:
   ```
   GAME_WALLET_PRIVATE_KEY = word1 word2 ... word24
   GAME_WALLET_ADDRESS = UQBdBXl...
   CSPIN_TOKEN_ADDRESS = EQCsBJHqi3TtqOFiEP2c...
   TONCENTER_API_KEY = your-api-key
   ```

### 또는 CLI로 설정:
```powershell
npx wrangler secret put GAME_WALLET_PRIVATE_KEY
npx wrangler secret put TONCENTER_API_KEY
```

---

## 3. 백엔드 배포 (Cloudflare Workers)

```powershell
# Workers 배포
npm run wrangler:deploy

# 결과:
# Published candlespinner-workers-api
# https://candlespinner-workers-api.your-account.workers.dev
```

**배포 URL 메모**: `https://candlespinner-workers-api.your-account.workers.dev`

---

## 4. 프론트엔드 환경 변수 설정

`.env` 파일 생성:
```bash
VITE_API_URL=https://candlespinner-workers-api.your-account.workers.dev
VITE_CSPIN_TOKEN_ADDRESS=EQCsBJHqi3TtqOFiEP2c...
VITE_GAME_WALLET_ADDRESS=UQBdBXl...
```

---

## 5. 프론트엔드 배포 (Cloudflare Pages)

### 방법 1: CLI 배포
```powershell
# 빌드
npm run build

# Pages 배포
npx wrangler pages deploy dist --project-name=candlespinner
```

### 방법 2: GitHub 연동 (권장)
1. GitHub에 코드 푸시
2. Cloudflare Dashboard → Pages → Create a project
3. Connect to Git → 레포지토리 선택
4. Build settings:
   - Framework preset: Vite
   - Build command: `npm run build`
   - Build output directory: `dist`
5. Environment variables 추가:
   ```
   VITE_API_URL = https://candlespinner-workers-api.your-account.workers.dev
   VITE_CSPIN_TOKEN_ADDRESS = EQCsBJHqi3TtqOFiEP2c...
   VITE_GAME_WALLET_ADDRESS = UQBdBXl...
   ```

---

## 6. TON Connect Manifest 업데이트

`public/tonconnect-manifest.json`의 `url` 수정:
```json
{
  "url": "https://candlespinner.pages.dev",
  "name": "CandleSpinner",
  "iconUrl": "https://candlespinner.pages.dev/icon.png"
}
```

---

## 7. 배포 확인

1. 프론트엔드 접속: `https://candlespinner.pages.dev`
2. TON Connect 지갑 연결 테스트
3. 크레딧 조회 테스트 (0 CSPIN 표시되어야 함)
4. 입금/게임/인출 플로우 테스트

---

## 8. 로컬 개발 환경

### 백엔드 (Workers) 로컬 실행:
```powershell
# .dev.vars 파일 생성 (.dev.vars.example 참고)
# GAME_WALLET_PRIVATE_KEY=...
# TONCENTER_API_KEY=...

npx wrangler dev
# → http://localhost:8787
```

### 프론트엔드 로컬 실행:
```powershell
# .env 파일 생성
# VITE_API_URL=http://localhost:8787

npm run dev
# → http://localhost:5173
```

---

## 9. 트러블슈팅

### CORS 에러
- `functions/_worker.ts`의 `Access-Control-Allow-Origin` 헤더 확인
- 프로덕션에서는 특정 도메인으로 제한 권장

### KV 읽기 실패
- Cloudflare Dashboard에서 KV Namespace ID 확인
- wrangler.toml의 ID와 일치하는지 확인

### TON Connect 연결 실패
- `tonconnect-manifest.json`의 URL이 실제 배포 URL과 일치하는지 확인

---

**다음 단계**: [실전 테스트](./테스트-체크리스트_20251101.md)
