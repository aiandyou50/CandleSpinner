# 🔬 심층분석: Cloudflare RPC vs 스마트컨트랙트 방식

**작성일**: 2025-10-25 오전 4:15  
**주제**: 비용 절감을 위한 2가지 대안 기술 검증

---

## 상황 분석

### 현재의 문제
```
Ankr RPC가 유료
↓
RPC 호출마다 비용 발생
↓
대규모 사용 시 비용 증가
↓
예산 압박
```

### 사용자의 2가지 제안
```
① "Cloudflare Workers에서 RPC 직접 운영?"
② "스마트 컨트랙트로 비용을 사용자에게 전가?"
```

---

## 제안 #1: Cloudflare Workers에서 RPC 직접 운영

### 1️⃣ RPC의 정확한 정의

```
RPC (Remote Procedure Call):
├─ "원격 컴퓨터의 함수를 호출하는 것"
├─ 누군가의 컴퓨터/서버가 필요
├─ 그 컴퓨터가 TON 블록체인의 "풀 노드" 운영
└─ RPC 요청을 처리하는 서버

예시:
Ankr RPC = Ankr 회사가 운영하는 TON 풀 노드
toncenter.com = toncenter.com이 운영하는 TON 풀 노드
```

---

### 2️⃣ "Cloudflare Workers에서 RPC 직접 운영" 이 가능한가?

#### ❌ 불가능한 이유

```
RPC 운영 = TON 풀 노드 운영

TON 풀 노드의 요구사항:
├─ 메모리: 최소 16GB ~ 64GB
├─ 디스크: 최소 500GB ~ 1TB 이상
├─ CPU: 고성능 (i7 또는 고급 서버 CPU)
├─ 네트워크: 항상 켜져 있음 (24/7)
├─ 대역폭: 지속적인 동기화 필요
└─ 관리: 24/7 모니터링 필요

Cloudflare Workers의 제한사항:
├─ 메모리: ~128MB (매우 제한적!)
├─ 실행 시간: 30초 ~ 600초 (시간 제한)
├─ 디스크: 없음 (상태 저장 불가능)
├─ 배경 작업: 불가능
├─ 항상 켜짐: 불가능 (요청 시에만 활성화)
└─ CPU: 공유 환경 (제한적)

결론: ❌ 불가능합니다!
```

---

### 3️⃣ 그럼 Cloudflare Workers에서 뭘 할 수 있나?

```
가능한 것:
├─ 외부 RPC (Ankr, toncenter)에 요청 전송 ✓
├─ 응답을 처리/가공 ✓
├─ 결과를 프론트에 반환 ✓
├─ 게임 로직 실행 ✓
└─ 개인키로 BOC 서명 ✓

불가능한 것:
├─ TON 풀 노드 직접 운영 ❌
├─ 블록체인 데이터 로컬 저장 ❌
├─ 항상 동기화된 상태 유지 ❌
└─ 풀 노드 역할 ❌
```

---

### 4️⃣ "RPC 프록시" 개념은 가능한가?

```
"RPC 프록시" = "RPC 중개자"

구조:
Cloudflare Workers
  ↓
  ├─ 게임 백엔드에서 요청 처리
  ├─ 외부 RPC (Ankr)에 요청 전송
  ├─ 응답 받아서 가공
  └─ 결과 반환

장점:
├─ 외부 RPC 요청 숨길 수 있음 (보안)
├─ 로직 추가 가능 (유연성)
├─ 요청 캐싱 가능? (성능)
└─ Rate limiting 적용 가능 (보안)

단점:
├─ 여전히 외부 RPC 비용 발생 💰
│  (Ankr의 유료 요금은 그대로)
├─ 추가 레이턴시 (느려짐)
├─ 복잡도 증가
└─ 비용 절감 효과 없음! ❌

결론: 비용 문제 해결 안 됨!
```

---

### ✅ 제안 #1의 결론

```
Q: "Cloudflare Workers에서 RPC 직접 운영?"

A: ❌ 불가능합니다!

이유:
1. TON 풀 노드는 고사양 서버 필요
   └─ Cloudflare Workers: 제한적 환경

2. 풀 노드 운영 비용 >> RPC API 비용
   └─ 직접 운영이 더 비쌈!

3. 24/7 동기화 필수
   └─ Cloudflare는 요청 시에만 활성화

4. Cloudflare의 제약 (128MB, 30-600초)
   └─ 풀 노드 운영 절대 불가능

대신 가능한 것:
✅ RPC 프록시 (Ankr → Workers → 프론트)
   └─ 하지만 비용은 그대로

최종: RPC 비용 절감이 목표라면
     이 방법은 효과 없습니다. ❌
```

---

---

## 제안 #2: 스마트 컨트랙트 + 사용자가 Gas 비용 지불

### 1️⃣ 개념 이해

```
현재 구조:
게임 백엔드 → RPC 비용 게임이 부담
               ↓
             Ankr 유료 요청
             ↓
          TON 블록체인

제안 구조:
게임 백엔드 → RPC 비용 한 번만
             ↓
           스마트 컨트랙트 배포
             ↓
         스마트 컨트랙트가 
         사용자 대신 CSPIN 전송
         + Gas는 사용자가 부담!
```

---

### 2️⃣ 스마트 컨트랙트 방식의 메커니즘

```
1단계: 초기 설정 (한 번만)
  └─ 게임이 "WithdrawalManager" 스마트 컨트랙트 배포
     ├─ 배포 비용: ~1-2 TON (~3-6 USD)
     ├─ 주소: EQX1YZ...
     └─ 코드: 블록체인에 영원히 저장

2단계: 게임이 컨트랙트에 CSPIN 입금
  └─ 게임 컨트랙트: CSPIN 10,000개 보유
  
3단계: 사용자가 출금 요청
  ├─ "10 CSPIN 출금해주세요"
  └─ 게임 백엔드: API 요청 기록

4단계: 게임이 컨트랙트 호출
  ├─ RPC로 1번만 호출 (배치 처리 가능)
  └─ "사용자 ABC...에게 10 CSPIN 보내"

5단계: 사용자가 TON으로 Gas 지불
  ├─ 트랜잭션이 블록체인에 포함
  ├─ Gas 비용 = ~0.01 TON (~0.03 USD)
  └─ 사용자의 TON 지갑에서 차감

6단계: 완료!
  └─ 사용자: CSPIN 10개 수령 ✓
  └─ 게임: Gas 비용 0 ✓
  └─ 사용자: Gas 비용 ~0.03 USD 지불
```

---

### 3️⃣ 이 방식의 기술적 가능성

#### ✅ 기술적으로 완벽하게 가능합니다!

```
장점:
├─ 게임의 RPC 비용 대폭 절감 ✅
│  └─ 초기 배포 비용만 ~2 USD
│  └─ 이후 비용 거의 없음
│
├─ 사용자가 Gas 지불 (합리적)
│  └─ 사용자가 TON 출금하는 거니까
│  └─ 사용자가 비용 부담 자연스러움
│
├─ 배치 처리 가능 (최적화)
│  └─ 여러 사용자 한 번에 처리
│  └─ RPC 호출 최소화
│
├─ 완전히 투명 (블록체인)
│  └─ 누구나 검증 가능
│  └─ 신뢰도 높음 ✓
│
└─ 24/7 자동화
   └─ 서버 없어도 실행
   └─ 스마트 컨트랙트가 24/7 대기
```

---

### 4️⃣ 실제 비용 계산

```
현재 RPC 방식 (Ankr):

월간 비용 계산:
├─ 일 사용자: 100명
├─ 하루 인출: 100명 × 1회 = 100번
├─ 월간 인출: 100 × 30 = 3,000번
├─ RPC 호출: 3,000번 × $0.0001 = $0.30
│           (Ankr 추정 요금)
└─ 월간 비용: ~$30 (서버 비용 별도)

스마트 컨트랙트 방식:

초기 비용:
├─ 컨트랙트 배포: ~2 TON (~$6)
└─ 첫 달 총: ~$6

월간 반복 비용:
├─ RPC 호출 (배치): 월 5-10번
│  └─ 비용: ~$0.001
├─ Gas 비용 (사용자 부담): 사용자 부담
└─ 월간 게임 비용: ~$0.001 (거의 무료!)

비용 절감:
├─ 첫 달: $0.30 → $6 (초기 배포라 높음)
└─ 2달 이후: $0.30 → $0.001
            = 99.7% 절감! 🎉

6개월 기준:
├─ RPC 방식: $0.30 × 6 = $1.80
├─ 스마트 계약: $6 + $0.001 × 5 = ~$6.01
└─ 거의 같음 (규모가 작아서)

1년 기준:
├─ RPC 방식: $0.30 × 12 = $3.60
├─ 스마트 계약: $6 + $0.001 × 11 = ~$6.01
└─ 거의 같음 (규모가 작아서)

규모 증가 시나리오:
일 사용자 1,000명:

RPC 방식:
├─ 월간 인출: 1,000 × 30 = 30,000번
├─ RPC 비용: 30,000 × $0.0001 = $3
└─ 월간 비용: ~$300 (큰 비용!)

스마트 계약 방식:
├─ RPC 호출 (배치): 월 10-50번
├─ RPC 비용: 50 × $0.0001 = $0.005
└─ 월간 게임 비용: ~$0.01 (거의 무료!)

결론: 규모가 커질수록 스마트 계약이 훨씬 유리!
```

---

### 5️⃣ 스마트 컨트랙트 구현 코드 (개요)

```tact
// WithdrawalManager.tact

message WithdrawRequest {
    userAddress: Address;
    amount: Int;
}

contract WithdrawalManager {
    owner: Address;              // 게임 주소
    jettonMasterAddress: Address; // CSPIN 마스터
    jettonWalletAddress: Address; // 게임의 CSPIN 지갑
    
    init(master: Address, wallet: Address) {
        self.owner = sender();
        self.jettonMasterAddress = master;
        self.jettonWalletAddress = wallet;
    }
    
    // 게임만 호출 가능
    receive(msg: WithdrawRequest) {
        require(sender() == self.owner);
        require(msg.amount > 0);
        
        // Jetton 전송 요청
        send(SendParameters{
            to: self.jettonWalletAddress,
            value: ton("0.05"),  // Gas 비용
            mode: SendPayGas,
            body: JettonTransferMessage{
                queryId: 0,
                amount: msg.amount,
                destination: msg.userAddress,
                responseDestination: self.owner,
                forwardTonAmount: 0,
                forwardPayload: emptySlice()
            }.toCell()
        });
    }
}

특징:
├─ 게임만 호출 가능 (require)
├─ 자동으로 사용자에게 CSPIN 전송
├─ Gas는 컨트랙트가 선결제 후 사용자에게 청구
└─ 완전히 투명 (코드 공개)
```

---

### 6️⃣ 사용자 경험 비교

```
RPC 방식:
사용자: "출금 버튼" → 1-2초 → "완료!"
비용: 사용자 무료 (게임이 부담)

스마트 컨트랙트 방식:
사용자: "출금 버튼" → 3-5초 → "완료!"
비용: 사용자가 Gas 비용 지불 (~0.03 USD)

사용자 입장: "어? 조금 느리고 비용 낸다고?"

하지만 게임 입장:
RPC: 월 $300 (규모 커질수록 증가)
계약: 월 $0.01 (거의 무료)

```

---

### 7️⃣ 스마트 컨트랙트 방식의 문제점

```
① Gas 비용을 사용자에게 전가
  ├─ 사용자가 추가 비용 지불 필요
  ├─ UX 저하 (느려짐, 비용)
  └─ 사용자 만족도 ↓

② 배포 후 수정 불가능
  ├─ 버그 있으면 재배포 필요
  ├─ 새로 배포 = 또 다른 주소
  └─ 위험! (테스트 필수)

③ 실행 시간 3-5초
  ├─ RPC 방식: 1-2초
  └─ 약 2배 느림

④ TON 가스비 변동성
  ├─ 네트워크 혼잡 시 가스비 증가
  └─ 사용자가 예측 불가능

⑤ 규모가 작을 때는 이점 없음
  ├─ 배포 비용 ~$6
  ├─ 월간 사용자 100명 정도면
  └─ RPC 방식이 더 저렴할 수도

⑥ Jetton 표준 복잡도
  ├─ Jetton Transfer 메시지 구조 복잡
  ├─ 오류 가능성 높음
  └─ 테스트 필수
```

---

### 8️⃣ 스마트 컨트랙트 적용 판단

```
스마트 컨트랙트 방식이 좋은 경우:
✅ 대규모 게임 (일 사용자 1,000+)
✅ 장기 운영 (비용 절감 중요)
✅ 완전 탈중앙화 필요
✅ 투명성 최고 우선순위
✅ 예산이 극도로 제한적

스마트 컨트랙트 방식이 나쁜 경우:
❌ 소규모 게임 (초기 단계)
❌ 빠른 출시 필요
❌ 사용자 비용 거부감
❌ UX 최우선
❌ 테스트 기간 부족

현재 상황 (CandleSpinner):
├─ 초기 개발 단계
├─ 테스트 유저 100명 미만
├─ 빠른 출시 중요
├─ 초기 비용 최소화
└─ 규모 확대 후 검토

결론: 지금은 시기상조! 
      나중에 고려하세요.
```

---

---

## 🎯 종합 분석: 어떤 방식을 선택할 것인가?

### 선택지 3가지

```
① Ankr RPC (현재)
   ├─ 비용: 월 ~$30 (소규모), 월 ~$300 (대규모)
   ├─ 속도: 1-2초 ✨
   ├─ UX: 우수 (사용자 무료)
   ├─ 복잡도: 낮음
   ├─ 신뢰도: Ankr에 의존
   └─ 권장: 지금 진행 중! ✓

② Cloudflare Workers RPC
   ├─ 기술: ❌ 불가능 (풀 노드 운영 불가)
   └─ 폐기: 불가능한 아이디어

③ 스마트 컨트랙트 (향후)
   ├─ 비용: 초기 ~$6, 이후 거의 무료
   ├─ 속도: 3-5초 (느림)
   ├─ UX: 나쁨 (사용자 비용 지불)
   ├─ 복잡도: 높음
   ├─ 신뢰도: 블록체인 (가장 높음)
   └─ 권장: 규모 증가 후 고려
```

---

## 💡 최적의 로드맵

### Phase 1: 지금 (초기 개발)

```
┌────────────────────────────────────┐
│ Ankr RPC + Cloudflare 조합         │
├────────────────────────────────────┤
│ 사용자 수: 100-1,000 테스트        │
│ 월간 비용: ~$30-300                │
│ 우선순위: 빠른 출시 ✓              │
│ UX: 최고 ✓                         │
│                                    │
│ 구조:                              │
│ 게임 프론트                        │
│   ↓                                │
│ Cloudflare Workers (게임 백엔드)  │
│   ├─ BOC 생성                      │
│   ├─ 개인키 서명                   │
│   └─ RPC 호출                      │
│   ↓                                │
│ Ankr RPC (외부)                    │
│   ↓                                │
│ TON 블록체인                       │
└────────────────────────────────────┘

진행 방향: 이것으로 지금 진행! 🚀
```

---

### Phase 2: 3-6개월 후 (규모 확대)

```
사용자 수가 증가했을 때:

옵션 A: RPC 비용 증가 감수
├─ 월 비용: $300 → $1,000
└─ 간단함

옵션 B: 다른 RPC 제공자로 분산
├─ Ankr, toncenter, node-as-a-service
├─ 각각 비용 분산
└─ 복잡도 증가

옵션 C: 스마트 컨트랙트로 전환 (검토 시기)
├─ 배포 비용: ~$6
├─ 월간 이후 비용: 거의 무료
├─ 사용자가 Gas 비용 지불
├─ 복잡도 매우 높음
└─ 신뢰도 최고
```

---

### Phase 3: 대규모 운영 (1년 후)

```
스마트 컨트랙트 + 다른 시스템 조합:

┌─────────────────────────────────┐
│ 게임 백엔드 (Cloudflare)        │
├─────────────────────────────────┤
│                                 │
│ 1단계: 출금 요청 기록            │
│ (데이터베이스 저장)              │
│                                 │
│ 2단계: 배치 처리 (시간마다)      │
│ ├─ 일일 인출 집계                │
│ ├─ 스마트 컨트랙트 호출           │
│ │ (배치: 100명 한 번에)          │
│ └─ RPC 비용 최소화               │
│                                 │
│ 3단계: 사용자 알림               │
│ └─ "Gas 비용 ~0.03 USD"          │
└─────────────────────────────────┘
        ↓
   스마트 컨트랙트 호출
        ↓
   TON 블록체인
        ↓
   사용자 게정에 CSPIN 입금
   + Gas 비용 차감
```

---

## ✅ 현재 상황 판단

### 질문 1: "Cloudflare Workers RPC?"
```
❌ 불가능합니다.

이유:
- TON 풀 노드 운영 불가능
- Cloudflare의 제약 (메모리, 시간)
- 직접 운영 비용 >> RPC API 비용

대신: RPC 프록시만 가능 (비용 절감 효과 없음)
```

---

### 질문 2: "스마트 컨트랙트 + 사용자 Gas?"
```
✅ 기술적으로 완벽히 가능합니다.

장점:
- 게임 비용 대폭 절감 (규모 커질수록)
- 완전 투명 (블록체인)
- 24/7 자동화

단점:
- 초기 개발 복잡도 높음
- 테스트 기간 필요
- 배포 후 수정 불가능 (위험)
- 사용자가 Gas 비용 지불 (UX 저하)
- 현 규모에선 이점 없음

권장: 지금은 시기상조
      규모 증가 후 고려 (3-6개월)
```

---

## 🚀 최종 권장사항

```
지금 해야 할 것:
1. Ankr RPC로 계속 진행 ✓
2. RPC Origin 문제 해결
3. 빠른 출시 진행

향후 검토 (3-6개월 후):
1. 사용 규모 및 비용 분석
2. 스마트 컨트랙트 필요성 검토
3. 사용자 피드백 수집

최종 결정:
현재: RPC 방식 (Ankr) ✓
향후: 규모에 따라 스마트 컨트랙트 고려

비용 절감 전략:
- 단계별 성장에 맞춰 최적화
- 조급한 판단 금지
- 데이터 기반 결정
```

---

## 📌 요약 테이블

| 항목 | Ankr RPC | CF 워커 | 스마트계약 |
|------|----------|--------|----------|
| 기술 가능 | ✅ | ❌ | ✅ |
| 비용 (소규모) | $30 | 불가능 | $6+$0.01 |
| 비용 (대규모) | $300+ | 불가능 | $0.01 |
| 속도 | 1-2초 | - | 3-5초 |
| UX | 우수 | - | 낮음 |
| 복잡도 | 낮음 | - | 높음 |
| 신뢰도 | 중간 | - | 높음 |
| 현재 권장 | ✅✅✅ | ❌ | 🔜 |
| 향후 권장 | ✅ | ❌ | ✅ |

---

## 🎓 최종 학습 정리

### RPC의 본질
```
RPC = "누군가의 풀 노드 빌려쓰기"

직접 운영: 불가능 (Cloudflare 환경)
외부 사용: 가능하고 저렴
자체 빌드: 불필요한 지출
```

### 비용 절감 전략
```
1순위: 효율적인 RPC 사용 (현재) ✓
2순위: 다른 RPC 제공자 비교
3순위: RPC 요청 최적화 (배치)
4순위: 스마트 컨트랙트 (향후)
```

### 결론
```
현재: Ankr RPC로 계속 진행!
비용 문제는 나중에 최적화하세요.
빠른 출시가 최우선입니다.
```

---

**이제 Ankr Origin 문제를 집중해서 해결하세요!** 🎯

