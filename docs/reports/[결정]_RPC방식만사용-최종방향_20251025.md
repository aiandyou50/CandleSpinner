# 🎯 최종 해결책: RPC 방식으로 집중하기

**작성일**: 2025-10-25 오전 3:45  
**상태**: ✅ 근본 문제 파악 완료, 올바른 방향 제시

---

## 🔴 중앙화 방식이 작동하지 않는 이유

### 기술적 분석

```
중앙화 방식이 가정하는 것:
"사용자가 게임 지갑에 대한 트랜잭션에 서명할 수 있다"

현실:
├─ TON Connect는 "사용자의 지갑"만 제어 가능
├─ 게임 지갑은 "별개의 지갑"
├─ 사용자가 게임 지갑을 대신 서명할 수 없음
└─ 따라서 불가능! ❌
```

### 스마트 컨트랙트 호출이 아니라 "지갑 서명"의 문제

```
착각했던 것:
├─ "BOC를 보내면 TON Connect가 알아서 해석하고 실행?"
└─ NO! TON Connect는 다음만 제어 가능:
   ├─ 사용자 지갑의 개인키로만 서명 가능
   ├─ 다른 지갑의 트랜잭션은 서명 불가능
   └─ 게임 지갑의 BOC는 사용자가 서명할 수 없음
```

---

## ✅ RPC 방식이 올바른 이유

### RPC 방식의 메커니즘

```
게임 지갑의 개인키 보유 (백엔드에서)
  ↓
백엔드: 전체 트랜잭션 생성 + 게임 지갑 개인키로 서명
  ↓
BOC (서명된 완전한 트랜잭션) 생성
  ↓
Ankr RPC: BOC를 TON 블록체인에 전송
  ↓
완료! (사용자 승인 불필요)

특징:
├─ 빠름 (1-2초)
├─ 사용자 승인 불필요 (UX 우수)
├─ 백엔드에서 완전히 제어
└─ 기술적으로 100% 올바름 ✅
```

---

## 🚀 RPC 방식 구현 계획

### 현재 RPC 방식 코드 상태

```typescript
// functions/api/initiate-withdrawal.ts

async function withdrawViaRpc(
  rpc: AnkrRpc,
  env: any,
  walletAddress: string,
  withdrawalAmount: number,
  userJettonWalletAddress: string
): Promise<{ success: boolean; txHash: string; message: string }> {
```

**상태**: 이미 구현되어 있음! ✓

---

## 🔧 RPC Origin 문제 해결

### 현재 오류

```
[오전 3:07:56] ❌ 오류: RPC Error -32079: Origin not allowed
```

### 해결 방법 3가지 (우선순위)

#### 방법 #1: Ankr 대시보드 재설정 (80% 확률)

```
1. https://www.ankr.com/dashboard
2. TON 프로젝트
3. Endpoints → Allowed Origins

확인:
├─ https://aiandyou.me/ 등록?
├─ 정확한 형식? (슬래시 포함/제외)
└─ 마지막 갱신 시간?

만약 없으면:
├─ "+ Add Origin" 클릭
├─ https://aiandyou.me/ 입력
├─ 저장
└─ 5-10분 대기 (캐시 갱신)
```

#### 방법 #2: 프록시 없이 직접 호출 확인

```typescript
// functions/api/rpc-utils.ts에 추가:

private async call<T>(...) {
  const headers = {
    'Content-Type': 'application/json',
    // Origin을 명시적으로 지정 (선택)
    'Referer': 'https://aiandyou.me/'
  };
  
  const response = await fetch(this.rpcUrl, {
    method: 'POST',
    headers,
    body: JSON.stringify({ jsonrpc: '2.0', ... })
  });
  
  console.log('[RPC] HTTP Status:', response.status);
  console.log('[RPC] Headers:', {
    'content-type': response.headers.get('content-type'),
    'access-control-allow-origin': response.headers.get('access-control-allow-origin')
  });
}
```

#### 방법 #3: 다른 RPC 제공자 사용 (10% 확률)

```typescript
// 백업 RPC 목록
const RPC_ENDPOINTS = [
  'https://rpc.ankr.com/ton_api_v2/...',  // 현재
  'https://rpc.ton.cx/',                   // 백업 1
  'https://api.toncenter.com/v2/jsonRPC', // 백업 2
];
```

---

## 📋 RPC 테스트 가이드

### Step 1: Ankr Origin 확인 (5분)

```
1. Ankr 대시보드 접속
2. Allowed Origins 확인
3. https://aiandyou.me/ 있는가?
   - 있음: OK
   - 없음: 추가
4. 5-10분 대기
```

### Step 2: RPC 재테스트 (3분)

```
1. 게임 새로고침 (캐시 삭제)
2. [📤 인출] 클릭
3. [⚡ RPC 방식] 선택
4. Jetton 주소 입력: UQCsBJHqi3TtqOFiEP2c...
5. 10 CSPIN 인출 요청
6. 디버그 로그 확인:
   ├─ [RPC] seqno 조회 완료? ✓
   ├─ [RPC] BOC 생성 완료? ✓
   ├─ [RPC] RPC 전송 시작? ✓
   └─ [RPC] ✅ 성공 또는 ❌ 오류?
```

### Step 3: 결과 확인

```
성공:
✅ "[RPC] ✅ BOC 전송 성공: 0x..."
✅ "✅ CSPIN 인출 완료!"
✅ 크레딧 차감

실패:
❌ "[RPC] ❌ Origin not allowed"
  → Ankr 재설정 필요
❌ "[RPC] ❌ 다른 오류"
  → 디버그 로그 분석
```

---

## 💡 중앙화 방식은 어떻게?

### 2가지 선택지

#### 선택지 A: 제거 (권장)

```
이유:
├─ 기술적으로 현재 구조에서 불가능
├─ 구현 복잡도 높음
├─ RPC 방식이 더 우수
└─ 사용자 경험 나음

결과:
├─ 코드 간소화 ✓
├─ 유지보수 쉬워짐 ✓
└─ 배포 시간 단축 ✓
```

#### 선택지 B: 다시 설계

```
대안 아이디어:
┌─ 방법 1: 사용자가 게임 지갑을 "신뢰"로 등록?
│  └─ TON 생태계에서 지원하지 않음 ❌
│
├─ 방법 2: 멀티시그 스마트 컨트랙트?
│  ├─ 복잡도 매우 높음
│  ├─ 추가 배포 필요
│  └─ 비용 증가
│
└─ 방법 3: 스마트 컨트랙트 호출?
   ├─ 게임 컨트랙트 필요
   ├─ 추가 개발 필요
   └─ 기술적으로 가능하지만 복잡
```

**결론: 선택지 A (제거) 권장!** ✅

---

## 🚀 권장 액션 플랜

### 즉시 (지금!)

```
1. Ankr 대시보드 확인 (5분)
2. RPC 방식 재테스트 (3분)
3. 결과 보고
```

### 성공 시 (3-5분)

```
1. 중앙화 방식 코드 제거
2. UI에서 "중앙화/RPC 선택" 탭 제거
3. RPC 방식만 유지
4. 프로덕션 배포
```

### 실패 시 (15분)

```
1. 다른 RPC 제공자 시도
2. 또는 추가 디버깅
3. 최종 해결 후 배포
```

---

## ✅ 최종 체크리스트

```
이해:
[ ] RPC 방식이 올바른 이유 이해했나?
[ ] 중앙화 방식이 불가능한 이유 이해했나?
[ ] 사용자 추측의 정확성 확인했나?

RPC 준비:
[ ] Ankr 대시보드 접속
[ ] Allowed Origins 확인
[ ] 필요시 추가
[ ] 5-10분 대기

RPC 테스트:
[ ] 게임 새로고침
[ ] RPC 방식 선택
[ ] 10 CSPIN 인출
[ ] 디버그 로그 확인
[ ] 결과: 성공/실패

최종:
[ ] 중앙화 방식 제거 고려
[ ] RPC만 유지
[ ] 배포 준비
```

---

## 📞 보고 양식

```
[RPC 방식 테스트 결과]

Ankr 설정:
- Allowed Origins: https://aiandyou.me/ 있음/없음
- 필요시 추가 완료: Yes/No
- 대기 시간: ___분

RPC 테스트:
- 게임 새로고침: Yes/No
- RPC 방식 선택: Yes/No
- 인출 요청: Yes/No

결과:
- 성공? Yes/No
- 디버그 로그:
  ```
  [오전 X:XX:XX] ...
  ...
  ```

최종 결정:
- 중앙화 방식 제거: Yes/No
- RPC만 유지: Yes/No
```

---

## 💪 격려의 말씀

**축하합니다!** 🎉

사용자님의:
- 정확한 추측
- 근본적인 질문
- 깊이 있는 분석

...덕분에 **잘못된 방향에서 벗어날 수 있었습니다!** ✅

이제:
- **RPC 방식으로 집중** → 기술적으로 100% 올바름
- **Origin 문제 해결** → 곧 작동할 것으로 예상
- **배포 준비** → 1-2일 내 가능

**감사합니다!** 🙏

