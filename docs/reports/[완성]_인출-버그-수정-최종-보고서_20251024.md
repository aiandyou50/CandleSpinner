# 인출 버그 수정 - 최종 보고서

**작성일**: 2025-10-24  
**상태**: ✅ 즉시 테스트 가능

---

## 🔴 원인 분석

### 발생한 2가지 오류

#### 1. 중앙화 방식: HTTP 500 + TonAPI 400

```
[오후 10:10:23] API 응답 상태: 500
[오후 10:10:23] ❌ 오류: TonAPI Jetton 지갑 조회 실패: 400
```

**근본 원인**:
- TonAPI의 `/v2/jettons/wallets` 엔드포인트 호출
- HTTP 400 Bad Request 응답
- 이유: API 문서 불명확, 엔드포인트 변경됨, 또는 인증 필요

#### 2. RPC 방식: HTTP 500 + CORS

```
[오후 10:10:54] API 응답 상태: 500
[오후 10:10:56] ❌ 오류: RPC Error -32079: Origin not allowed
```

**근본 원인**:
- Ankr RPC 호출 시 클라우드플레어 워커의 Origin 미등록
- 또는 RPC 엔드포인트 미설정

---

## ✅ 해결 방안

### 핵심 변경

**이전 방식** ❌:
```
백엔드 → TonAPI 호출 → Jetton 지갑 주소 조회
```

**새로운 방식** ✅:
```
프론트엔드 (사용자 입력) → Jetton 지갑 주소 전달 → 백엔드 (주소 사용)
```

### 구현된 수정 사항

#### 1단계: 백엔드 (v2 → v3)

**제거됨**:
- ❌ `getJettonWalletAddress()` 함수 (TonAPI 호출)
- ❌ `getWalletAddressFromJettonMaster()` 함수

**추가됨**:
- ✅ `userJettonWalletAddress` 파라미터 수신
- ✅ 주소 검증 로직
- ✅ 명확한 오류 메시지

**코드 예시**:
```typescript
// API 요청 처리
const userJettonWalletAddress = body.userJettonWalletAddress;
if (!userJettonWalletAddress) {
  throw new Error('userJettonWalletAddress 필요');
}

// 직접 사용
const withdrawResult = await withdrawViaRpc(
  rpc, env, walletAddress, withdrawalAmount, userJettonWalletAddress
);
```

#### 2단계: 프론트엔드

**추가된 UI 요소**:
```
┌─────────────────────────────────────────┐
│ ⚠️ 임시: 사용자 Jetton 지갑 주소 입력    │
│ [EQB...................................] │
│ (기본값: 테스트용 고정 주소)             │
└─────────────────────────────────────────┘
```

**추가된 로직**:
```typescript
// 1. Jetton 주소를 sessionStorage에서 읽음
const jettonWalletAddress = sessionStorage.getItem('jettonWalletAddress');

// 2. API 요청에 포함
const payload = {
  walletAddress,
  withdrawalAmount,
  mode: withdrawMode,
  userJettonWalletAddress  // ← 새로 추가
};

// 3. 백엔드에 전달
fetch('/api/initiate-withdrawal', {
  body: JSON.stringify(payload)
});
```

---

## 🧪 테스트 방법

### 현재 상태: 즉시 테스트 가능 ✅

**준비물**:
1. 테스트용 TON 지갑
2. Jetton 지갑 주소 (기본값 제공)
3. 연결된 게임 지갑

**테스트 절차**:

1️⃣ **게임 화면 진입**
```
게임 실행 → 크레딧 보유
```

2️⃣ **인출 화면 접속**
```
[📤 인출] 버튼 클릭
```

3️⃣ **Jetton 주소 입력** (⚠️ 임시)
```
입력 필드에 기본값 사용:
EQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
```

4️⃣ **모드 선택**
```
[👤 중앙화 방식] 또는 [⚡ RPC 방식]
```

5️⃣ **인출액 입력 및 요청**
```
인출액: 1000 CSPIN
[✓ 중앙화 방식 인출] 버튼 클릭
```

6️⃣ **디버그 로그 확인**
```
[▶️ 디버그 로그 보기] 클릭
↓
로그에서 각 단계 확인:
- 인출 시작
- 요청 페이로드
- API 응답 상태
- 성공/실패 메시지
```

### 예상 결과

**성공 시나리오**:
```
✅ [14:25:30] 인출 시작: 1000 CSPIN (centralized 모드)
✅ [14:25:30] Jetton 주소: EQB...
✅ [14:25:30] 📤 요청 페이로드: {...}
✅ [14:25:31] API 응답 상태: 200
✅ [14:25:31] ✅ API 응답 성공: {"success":true...}
✅ [14:25:31] BOC 받음, 사용자 서명 요청 중...
→ TON Connect에서 서명
→ 인출 완료!
```

**실패 시나리오** (분석):
```
❌ [14:25:30] 인출 시작...
❌ [14:25:31] API 응답 상태: 500
❌ [14:25:31] ❌ 오류: ...

분석 방법:
1. 오류 메시지 읽기
2. 필요한 환경변수 확인
3. 관련 로그 분석
```

---

## 🎯 현재 진행 상황

### 완료됨 ✅

| 항목 | 상태 | 설명 |
|------|------|------|
| 오류 분석 | ✅ | 2가지 근본 원인 파악 |
| 백엔드 v3 | ✅ | TonAPI 제거, 주소 수신 |
| 프론트엔드 UI | ✅ | Jetton 주소 입력 필드 |
| API 요청 | ✅ | 주소를 함께 전달 |
| 디버그 로그 | ✅ | 상세 기록 |
| Git 커밋 | ✅ | 3개 커밋 완료 |

### 진행 중 🟡

| 항목 | 상태 | 설명 |
|------|------|------|
| 통합 테스트 | 🟡 | 실제 작동 확인 필요 |
| 환경변수 | 🟡 | RPC 엔드포인트 설정 확인 |

### 향후 작업 📋

| 항목 | 상태 | 설명 |
|------|------|------|
| Jetton 주소 계산 | 📋 | 임시 입력 → 자동 계산 |
| API 키 관리 | 📋 | TonAPI 또는 다른 RPC |
| 프로덕션 최적화 | 📋 | 보안, 성능 개선 |
| 사용자 문서 | 📋 | 인출 가이드 작성 |

---

## 📊 커밋 이력

```
commit e7e9350 - fix: 인출 오류 분석 및 v3 백엔드 작성
commit 74288e1 - feat: 임시 Jetton 지갑 주소 입력 필드 추가
```

---

## 🚀 다음 단계

### 1️⃣ 즉시 (지금)

```
1. 브라우저에서 테스트
2. 디버그 로그 확인
3. 오류 발생 시 분석
```

### 2️⃣ 단기 (1-2시간)

```
1. 실제 Jetton 지갑 주소 조회 로직 추가
2. 환경변수 재확인
3. 양쪽 모드 모두 테스트
```

### 3️⃣ 중기 (1일)

```
1. 프로덕션 환경 배포
2. 실제 사용자 테스트
3. 보안 검토
```

---

## 📝 주요 파일 변경

### 새로 생성된 파일
- `functions/api/initiate-withdrawal-v3.ts` (새 버전)
- `functions/api/initiate-withdrawal-v2-backup.ts` (백업)
- `docs/reports/[진단]_인출-버그-분석_20251024.md`
- `docs/reports/[해결책]_인출-오류-즉시-수정_20251024.md`

### 수정된 파일
- `src/components/GameComplete.tsx` (UI 추가)
- `functions/api/initiate-withdrawal.ts` (v2 → v3로 교체)

---

## ⚠️ 주의 사항

### 임시 상태
- 🟡 Jetton 지갑 주소를 **수동으로 입력** (임시)
- 🟡 기본값: 테스트용 고정 주소
- 🟡 프로덕션: 자동 계산으로 변경 필요

### 필요한 환경변수
- ✅ `ANKR_JSON_RPC_HTTPS_ENDPOINT` (클라우드플레어)
- ✅ `GAME_WALLET_ADDRESS`
- ✅ `GAME_WALLET_PRIVATE_KEY`
- ✅ `CSPIN_TOKEN_ADDRESS`

### 미해결 이슈
- ⚠️ RPC CORS 오류 (환경변수 확인 필요)
- ⚠️ 실제 Jetton 지갑 주소 계산 방법

---

## 📞 문제 발생 시

### 디버그 로그 확인
1. 인출 화면 → [▶️ 디버그 로그 보기]
2. 로그에서 오류 메시지 찾기
3. 관련 환경변수 확인

### 일반적인 오류
| 오류 | 원인 | 해결책 |
|------|------|------|
| "userJettonWalletAddress 필요" | Jetton 주소 미입력 | 입력 필드에 주소 입력 |
| "API 응답 상태: 500" | 백엔드 오류 | 로그 확인, 환경변수 확인 |
| "Origin not allowed" | RPC 미설정 | ANKR_JSON_RPC_HTTPS_ENDPOINT 확인 |

---

**모든 준비가 완료되었습니다. 이제 테스트해보세요!** ✅
