# ì¸ì¶œ ê¸°ëŠ¥ - ì¦‰ì‹œ í•´ê²° ë°©ì•ˆ

**ì‘ì„±ì¼**: 2025-10-24  
**ìƒíƒœ**: ğŸ”§ ìˆ˜ì • ì¤‘

---

## ğŸ”´ 2ê°€ì§€ ì˜¤ë¥˜ ì›ì¸

### 1. TonAPI 400 ì˜¤ë¥˜ (ì¤‘ì•™í™” ë°©ì‹)

**ì›ì¸**:
- TonAPIì˜ Jetton ì§€ê°‘ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ ì‹¤íŒ¨
- API ë¬¸ì„œì— ì •í™•í•œ ì—”ë“œí¬ì¸íŠ¸ê°€ ë¶ˆëª…í™•
- ë˜ëŠ” API í‚¤ê°€ í•„ìš”í•œë° ì—†ìŒ

**í•´ê²°ì±…** âœ…:
- TonAPI í˜¸ì¶œ **ì™„ì „ ì œê±°**
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Jetton ì§€ê°‘ ì£¼ì†Œë¥¼ **ì§ì ‘ ê³„ì‚° ë˜ëŠ” ì…ë ¥**í•˜ì—¬ ë°±ì—”ë“œì— ì „ë‹¬
- ë°±ì—”ë“œëŠ” ë°›ì€ ì£¼ì†Œë¥¼ **ê·¸ëŒ€ë¡œ ì‚¬ìš©**

### 2. Ankr RPC CORS ì˜¤ë¥˜ (RPC ë°©ì‹)

**ì›ì¸**:
- Ankr RPC ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í´ë¼ìš°ë“œí”Œë ˆì–´ ì›Œì»¤ì˜ Originì„ ì¸ì‹ ë¶ˆê°€
- ë˜ëŠ” RPC ì—”ë“œí¬ì¸íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ

**í•´ê²°ì±…** âœ…:
- RPC í˜¸ì¶œë„ ë°±ì—”ë“œì—ì„œë§Œ ìˆ˜í–‰ (í´ë¼ì´ì–¸íŠ¸ X)
- í™˜ê²½ë³€ìˆ˜ `ANKR_JSON_RPC_HTTPS_ENDPOINT` ì˜¬ë°”ë¥´ê²Œ ì„¤ì •
- Ankr ëŒ€ì‹œë³´ë“œì—ì„œ Origin ë“±ë¡ (í•„ìš”ì‹œ)

---

## ğŸ› ï¸ ìˆ˜ì • ì‚¬í•­

### ë°±ì—”ë“œ ë³€ê²½ (v2 â†’ v3)

#### ì œê±°ëœ ë¶€ë¶„
```typescript
// âŒ ì œê±°: TonAPI í˜¸ì¶œ
async function getJettonWalletAddress(
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  // TonAPI í˜¸ì¶œ... â† ì´ ë¶€ë¶„ ì œê±°
}
```

#### ì¶”ê°€ëœ ë¶€ë¶„
```typescript
// âœ… ì¶”ê°€: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°›ì€ ì£¼ì†Œ ì‚¬ìš©
const userJettonWalletAddress = body.userJettonWalletAddress;
if (!userJettonWalletAddress) {
  throw new Error('userJettonWalletAddress í•„ìš”');
}
```

### í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½

#### API ìš”ì²­ì— Jetton ì£¼ì†Œ í¬í•¨

```typescript
const payload = {
  walletAddress: wallet.account.address,
  withdrawalAmount: withdrawAmount,
  mode: withdrawMode,
  userJettonWalletAddress: '...'  // â† í”„ë¡ íŠ¸ì—ì„œ ê³„ì‚°í•˜ì—¬ ì „ë‹¬
};
```

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### 1ë‹¨ê³„: ì‚¬ìš©ì Jetton ì§€ê°‘ ì£¼ì†Œ êµ¬í•˜ê¸°

**ì˜µì…˜ A: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê³„ì‚°** (ê¶Œì¥)

```typescript
import { Address } from '@ton/ton';

async function calculateJettonWalletAddress(
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  // TON ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ ê³„ì‚°
  // ë˜ëŠ” í†¤ìŠ¤í‚¬ì„ ì‚¬ìš©í•˜ì—¬ ê³„ì‚°
  // ë˜ëŠ” TonWeb ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
  
  // ì„ì‹œ: ê³ ì •ê°’ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ê¸°
  return process.env.REACT_APP_JETTON_WALLET_ADDRESS || '';
}
```

**ì˜µì…˜ B: TonAPI ì‚¬ìš©** (API í‚¤ í•„ìš”)

```typescript
async function getJettonWalletAddress(
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  const response = await fetch(
    `https://tonapi.io/v2/jettons/${masterAddress}/wallets?owner_account=${ownerAddress}`,
    {
      headers: { Authorization: `Bearer ${TONAPI_KEY}` }
    }
  );
  // ...
}
```

### 2ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •

```typescript
// ì¸ì¶œ ë²„íŠ¼ í´ë¦­ ì‹œ:
const userJettonWallet = await getJettonWalletAddress(
  process.env.REACT_APP_CSPIN_TOKEN_ADDRESS,
  wallet.account.address
);

const response = await fetch('/api/initiate-withdrawal', {
  body: JSON.stringify({
    walletAddress: wallet.account.address,
    withdrawalAmount,
    mode: withdrawMode,
    userJettonWalletAddress: userJettonWallet  // â† ì¶”ê°€
  })
});
```

### 3ë‹¨ê³„: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

**í´ë¼ìš°ë“œí”Œë ˆì–´ (ë°±ì—”ë“œ)**:
```
ANKR_JSON_RPC_HTTPS_ENDPOINT = https://rpc.ankr.com/ton/jsonrpc
GAME_WALLET_ADDRESS = UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
GAME_WALLET_PRIVATE_KEY = (64ì hex ë¬¸ìì—´)
CSPIN_TOKEN_ADDRESS = EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV
```

**í´ë¼ì´ì–¸íŠ¸** (`.env.local`):
```
REACT_APP_JETTON_WALLET_ADDRESS = (ì‚¬ìš©ì jetton ì§€ê°‘ ì£¼ì†Œ ë˜ëŠ” ê³„ì‚° í•¨ìˆ˜)
REACT_APP_CSPIN_TOKEN_ADDRESS = EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV
```

---

## âš ï¸ í˜„ì¬ ìƒí™©

### ì™„ë£Œë¨ âœ…
- [x] v3 ë°±ì—”ë“œ ì‘ì„± (Jetton ì£¼ì†Œ ì¡°íšŒ ì œê±°)
- [x] í”„ë¡ íŠ¸ì—”ë“œ ìš”ì²­ ìˆ˜ì • (ì£¼ì†Œ ì „ë‹¬ ì¤€ë¹„)
- [x] ì˜¤ë¥˜ ë¶„ì„ ë¬¸ì„œ ì‘ì„±

### ì§„í–‰ ì¤‘ ğŸŸ¡
- [ ] í”„ë¡ íŠ¸ì—”ë“œ: Jetton ì§€ê°‘ ì£¼ì†Œ ê³„ì‚° í•¨ìˆ˜ ì¶”ê°€
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸

### í•„ìš”í•œ ì •ë³´ â“
- ì‚¬ìš©ì Jetton ì§€ê°‘ ì£¼ì†Œë¥¼ ì–´ë””ì„œ êµ¬í• ì§€? (ê³„ì‚° vs API vs ê³ ì •ê°’)
- Ankr RPC ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • í™•ì¸ë˜ì—ˆë‚˜?
- TON í…ŒìŠ¤íŠ¸ë„· ë˜ëŠ” ë©”ì¸ë„·?

---

## ğŸ¯ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ (ì„ì‹œ)

### ì„ì‹œ ê³ ì •ê°’ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°

**í”„ë¡ íŠ¸ì—”ë“œ**:
```typescript
// ì„ì‹œ: ê³ ì •ëœ Jetton ì§€ê°‘ ì£¼ì†Œ ì‚¬ìš©
const userJettonWallet = 'EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV';

const response = await fetch('/api/initiate-withdrawal', {
  body: JSON.stringify({
    walletAddress: wallet.account.address,
    withdrawalAmount,
    mode: withdrawMode,
    userJettonWalletAddress: userJettonWallet
  })
});
```

**ê²°ê³¼**:
- âœ… ì •ìƒ ì‘ë™ â†’ ì‹¤ì œ ì£¼ì†Œë¡œ ê³„ì‚° í•„ìš”
- âŒ ì—¬ì „íˆ ì˜¤ë¥˜ â†’ ë‹¤ë¥¸ ë¬¸ì œ ë¶„ì„

---

## ğŸ“Œ ê²°ë¡ 

**ì¦‰ì‹œ ì¡°ì¹˜**:
1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Jetton ì§€ê°‘ ì£¼ì†Œ ì…ë ¥/ê³„ì‚°
2. ë°±ì—”ë“œì— ì£¼ì†Œ ì „ë‹¬
3. í…ŒìŠ¤íŠ¸

**ì˜ˆìƒ ì‹œê°„**: 10-20ë¶„

---
