# 인출 기능 - 즉시 해결 방안

**작성일**: 2025-10-24  
**상태**: 🔧 수정 중

---

## 🔴 2가지 오류 원인

### 1. TonAPI 400 오류 (중앙화 방식)

**원인**:
- TonAPI의 Jetton 지갑 조회 엔드포인트 호출 실패
- API 문서에 정확한 엔드포인트가 불명확
- 또는 API 키가 필요한데 없음

**해결책** ✅:
- TonAPI 호출 **완전 제거**
- 프론트엔드에서 Jetton 지갑 주소를 **직접 계산 또는 입력**하여 백엔드에 전달
- 백엔드는 받은 주소를 **그대로 사용**

### 2. Ankr RPC CORS 오류 (RPC 방식)

**원인**:
- Ankr RPC 엔드포인트에서 클라우드플레어 워커의 Origin을 인식 불가
- 또는 RPC 엔드포인트가 설정되지 않음

**해결책** ✅:
- RPC 호출도 백엔드에서만 수행 (클라이언트 X)
- 환경변수 `ANKR_JSON_RPC_HTTPS_ENDPOINT` 올바르게 설정
- Ankr 대시보드에서 Origin 등록 (필요시)

---

## 🛠️ 수정 사항

### 백엔드 변경 (v2 → v3)

#### 제거된 부분
```typescript
// ❌ 제거: TonAPI 호출
async function getJettonWalletAddress(
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  // TonAPI 호출... ← 이 부분 제거
}
```

#### 추가된 부분
```typescript
// ✅ 추가: 프론트엔드에서 받은 주소 사용
const userJettonWalletAddress = body.userJettonWalletAddress;
if (!userJettonWalletAddress) {
  throw new Error('userJettonWalletAddress 필요');
}
```

### 프론트엔드 변경

#### API 요청에 Jetton 주소 포함

```typescript
const payload = {
  walletAddress: wallet.account.address,
  withdrawalAmount: withdrawAmount,
  mode: withdrawMode,
  userJettonWalletAddress: '...'  // ← 프론트에서 계산하여 전달
};
```

---

## 🚀 다음 단계

### 1단계: 사용자 Jetton 지갑 주소 구하기

**옵션 A: 프론트엔드에서 계산** (권장)

```typescript
import { Address } from '@ton/ton';

async function calculateJettonWalletAddress(
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  // TON 라이브러리를 사용하여 직접 계산
  // 또는 톤스킬을 사용하여 계산
  // 또는 TonWeb 라이브러리 사용
  
  // 임시: 고정값 또는 환경변수에서 읽기
  return process.env.REACT_APP_JETTON_WALLET_ADDRESS || '';
}
```

**옵션 B: TonAPI 사용** (API 키 필요)

```typescript
async function getJettonWalletAddress(
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  const response = await fetch(
    `https://tonapi.io/v2/jettons/${masterAddress}/wallets?owner_account=${ownerAddress}`,
    {
      headers: { Authorization: `Bearer ${TONAPI_KEY}` }
    }
  );
  // ...
}
```

### 2단계: 프론트엔드 수정

```typescript
// 인출 버튼 클릭 시:
const userJettonWallet = await getJettonWalletAddress(
  process.env.REACT_APP_CSPIN_TOKEN_ADDRESS,
  wallet.account.address
);

const response = await fetch('/api/initiate-withdrawal', {
  body: JSON.stringify({
    walletAddress: wallet.account.address,
    withdrawalAmount,
    mode: withdrawMode,
    userJettonWalletAddress: userJettonWallet  // ← 추가
  })
});
```

### 3단계: 환경 변수 설정

**클라우드플레어 (백엔드)**:
```
ANKR_JSON_RPC_HTTPS_ENDPOINT = https://rpc.ankr.com/ton/jsonrpc
GAME_WALLET_ADDRESS = UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
GAME_WALLET_PRIVATE_KEY = (64자 hex 문자열)
CSPIN_TOKEN_ADDRESS = EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV
```

**클라이언트** (`.env.local`):
```
REACT_APP_JETTON_WALLET_ADDRESS = (사용자 jetton 지갑 주소 또는 계산 함수)
REACT_APP_CSPIN_TOKEN_ADDRESS = EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV
```

---

## ⚠️ 현재 상황

### 완료됨 ✅
- [x] v3 백엔드 작성 (Jetton 주소 조회 제거)
- [x] 프론트엔드 요청 수정 (주소 전달 준비)
- [x] 오류 분석 문서 작성

### 진행 중 🟡
- [ ] 프론트엔드: Jetton 지갑 주소 계산 함수 추가
- [ ] 환경 변수 설정 확인
- [ ] 테스트

### 필요한 정보 ❓
- 사용자 Jetton 지갑 주소를 어디서 구할지? (계산 vs API vs 고정값)
- Ankr RPC 엔드포인트 설정 확인되었나?
- TON 테스트넷 또는 메인넷?

---

## 🎯 빠른 테스트 (임시)

### 임시 고정값으로 테스트하기

**프론트엔드**:
```typescript
// 임시: 고정된 Jetton 지갑 주소 사용
const userJettonWallet = 'EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV';

const response = await fetch('/api/initiate-withdrawal', {
  body: JSON.stringify({
    walletAddress: wallet.account.address,
    withdrawalAmount,
    mode: withdrawMode,
    userJettonWalletAddress: userJettonWallet
  })
});
```

**결과**:
- ✅ 정상 작동 → 실제 주소로 계산 필요
- ❌ 여전히 오류 → 다른 문제 분석

---

## 📌 결론

**즉시 조치**:
1. 프론트엔드에서 Jetton 지갑 주소 입력/계산
2. 백엔드에 주소 전달
3. 테스트

**예상 시간**: 10-20분

---
