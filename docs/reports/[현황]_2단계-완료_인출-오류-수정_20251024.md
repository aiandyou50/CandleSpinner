# 인출 버그 수정 - 2단계 완료 보고서

**작성일**: 2025-10-24  
**상태**: 🟡 진행 중 (1/2 완료)

---

## 🎯 현재 상황

### ✅ 완료된 것

#### 1. 중앙화 방식 - Address 형식 오류 수정 ✅

**문제**:
```
❌ TON_CONNECT_SDK_ERROR: Wrong 'address' format
```

**원인**:
- TON Connect가 `0:ac04...` 형식(체크섬)을 거부
- `EQAsc...` 형식(User-Friendly)만 허용

**해결책** ✅:
```typescript
// Address 형식 자동 변환
const userFriendlyAddress = Address.parse(wallet.account.address).toString();
```

**상태**: 
- ✅ 코드 수정 완료
- ⏳ 재테스트 필요

---

### ⏳ 진행 중인 것

#### 2. RPC 방식 - CORS Origin 오류 진행 중

**문제**:
```
❌ RPC Error -32079: Origin not allowed
```

**원인**:
- Ankr RPC가 클라우드플레어 워커의 Origin 미인식
- 또는 환경 변수 설정 오류

**현재 상태**:
- 📋 환경 변수 확인 필요 (`ANKR_JSON_RPC_HTTPS_ENDPOINT`)
- 📋 Ankr 대시보드 Origin 등록 확인 필요
- 📋 대체 RPC 제공자 준비 중

---

## 📊 테스트 결과 요약

| 모드 | 상태 | 오류 | 조치 |
|------|------|------|------|
| 중앙화 | 🟡 수정됨 | Address 형식 | ✅ 변환 로직 추가 |
| RPC | 🔴 진행중 | CORS Origin | 📋 환경 설정 확인 |

---

## 🔧 적용된 수정사항

### 프론트엔드 변경 사항

#### 1️⃣ Address 형식 자동 변환
```typescript
// ✅ 추가: 체크섬 형식 → User-Friendly 형식 변환
let userFriendlyAddress = wallet.account.address;
try {
  if (wallet.account.address.includes(':')) {
    const { Address } = await import('@ton/ton');
    userFriendlyAddress = Address.parse(wallet.account.address).toString();
    addDebugLog(`📍 주소 변환: ${wallet.account.address.substring(0, 20)}... → ${userFriendlyAddress.substring(0, 20)}...`);
  }
} catch (addrErr) {
  addDebugLog(`⚠️ 주소 변환 경고: ...`);
}
```

#### 2️⃣ 향상된 디버그 로그
```typescript
// ✅ 추가: 더 상세한 로그
addDebugLog(`📨 TON Connect 트랜잭션 전송 (주소: ${userFriendlyAddress.substring(0, 20)}...)`);
```

#### 3️⃣ RPC 오류 처리 개선
```typescript
// ✅ 추가: CORS 오류 구체적 안내
if (errorMsg.includes('Origin not allowed') || errorMsg.includes('-32079')) {
  addDebugLog('💡 팁: RPC 엔드포인트가 현재 Origin을 허용하지 않습니다');
  addDebugLog('해결책: 환경 변수 ANKR_JSON_RPC_HTTPS_ENDPOINT 확인');
}
```

#### 4️⃣ UI 개선
```typescript
// ✅ 추가: Jetton 주소 입력 필드 설명 개선
"⚠️ 임시: 사용자 Jetton 지갑 주소 입력 (현재 테스트용)"
"💡 프로덕션: CSPIN 토큰의 사용자 Jetton 지갑 주소"
"입력: EQ로 시작하는 주소"
```

---

## 🧪 다음 테스트 절차

### 즉시 실행 (중앙화 방식)

```
1. 게임 화면 진입
   └─ 크레딧 보유 확인

2. [📤 인출] 버튼 클릭

3. Jetton 주소 입력 (또는 기본값 사용)
   └─ 기본값: EQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd

4. [👤 중앙화 방식] 선택

5. 인출액 입력
   └─ 예: 1000 CSPIN

6. [✓ 중앙화 방식 인출] 클릭

7. [▶️ 디버그 로그 보기] 클릭하여 확인:
   ✅ "📍 주소 변환" 로그 나타나는가?
   ✅ "📨 TON Connect 트랜잭션 전송" 로그 나타나는가?
   ✅ TON Connect 팝업 나타나는가?
   ✅ 서명 후 "✅ 트랜잭션 완료" 로그 나타나는가?

예상 로그 시퀀스:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[10:25:30] 인출 시작: 1000 CSPIN (centralized 모드)
[10:25:30] Jetton 주소: EQB...
[10:25:30] 📍 주소 변환: 0:ac04... → EQAsc...
[10:25:30] 📨 TON Connect 트랜잭션 전송 (주소: EQAsc...)
[10:25:30] (TON Connect 팝업 나타남)
[10:25:35] ✅ 트랜잭션 완료: te6cckEBAQEA...
[10:25:35] ✅ 1000 CSPIN 인출 완료!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### RPC 방식 테스트 (환경설정 후)

```
1. wrangler.toml에서 확인:
   ANKR_JSON_RPC_HTTPS_ENDPOINT = ?
   
2. Ankr 대시보드 확인:
   https://app.ankr.com/dashboard
   - Origin 등록 상태 확인
   - 클라우드플레어 도메인 등록되었나?

3. 필요시:
   - Origin 추가: https://candlespinner.pages.dev
   - 또는 다른 RPC 제공자로 변경

4. [⚡ RPC 방식] 선택 후 인출 요청

5. 디버그 로그 확인:
   - Origin not allowed 오류 계속 나타나나?
   - 환경 변수 확인 메시지 나타나는가?
```

---

## 💡 주의 사항

### Jetton 지갑 주소에 대해

**현재 상황** (임시):
- 사용자가 **수동으로 입력**
- 기본값: 테스트용 고정 주소 제공

**입력 시 주의**:
- ❌ 일반 TON 지갑 주소 (0:... 또는 UQ...)
- ❌ CSPIN 토큰 마스터 주소
- ✅ **CSPIN 토큰의 사용자 Jetton 지갑 주소 (EQ...)**

**프로덕션에서는** (향후):
- 자동으로 계산되거나
- TonAPI로 조회되거나
- 프론트에서 직접 계산

---

## 📈 진행률

```
┌────────────────────────────────────┐
│ 전체 인출 기능 수정 진행률        │
├────────────────────────────────────┤
│ 분석 및 설계            [████████] 100% ✅
│ 백엔드 수정             [████████] 100% ✅
│ 프론트엔드 수정         [██████░░]  75% 🟡
│ 테스트 및 검증          [████░░░░]  50% 🟡
│ 배포                    [░░░░░░░░]   0% ⏳
└────────────────────────────────────┘

전체: 🟡 60% 진행 중
```

---

## 📝 커밋 이력

```
1. efe26ba - fix: 중앙화 Address 형식 오류 수정 및 RPC 오류 처리
2. 93d93d2 - docs: 인출 버그 수정 최종 보고서 작성
3. 74288e1 - feat: Jetton 주소 입력 필드 추가
4. e7e9350 - fix: 인출 오류 분석 및 v3 백엔드 작성
5. cca4547 - fix: React hooks 규칙 위반 수정
```

---

## 🎯 다음 조치

### 우선순위 1️⃣ (지금)
- [ ] 중앙화 방식 재테스트 실행
- [ ] Address 변환 로그 확인
- [ ] TON Connect 서명 성공 여부 확인

### 우선순위 2️⃣ (1시간 내)
- [ ] RPC 환경 변수 확인
- [ ] Ankr 대시보드 Origin 설정 확인
- [ ] 필요시 RPC 제공자 변경

### 우선순위 3️⃣ (완료 시)
- [ ] 양쪽 모드 모두 정상 작동 확인
- [ ] 메인넷/테스트넷 모두 테스트
- [ ] 프로덕션 배포

---

## 🔗 관련 자료

### 파일 위치
- 프론트엔드: `src/components/GameComplete.tsx`
- 백엔드: `functions/api/initiate-withdrawal.ts`
- 설정: `wrangler.toml`

### 문서
- `docs/reports/[진행]_오류-해결-진행상황_20251024.md`
- `docs/reports/[완성]_인출-버그-수정-최종-보고서_20251024.md`

### 외부 링크
- Ankr 대시보드: https://app.ankr.com/dashboard
- TON 문서: https://ton.org
- TON Connect: https://tonconnect.org

---

## 📞 문제 발생 시

### 중앙화 방식
- ❌ Address 변환 로그 없음 → import 문제
- ❌ TON Connect 팝업 안 뜸 → 주소 형식 여전히 오류
- ❌ 서명 후 오류 → 백엔드 오류 분석

### RPC 방식
- ❌ Origin not allowed → 환경 변수 확인
- ❌ RPC 호출 실패 → Ankr 설정 또는 RPC 변경

---

**상태**: 중앙화 방식 수정 완료, RPC 방식 진행 중 ✅🟡
