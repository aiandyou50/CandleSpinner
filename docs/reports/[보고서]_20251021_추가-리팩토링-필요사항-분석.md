# [보고서]_20251021_추가-리팩토링-필요사항-분석

**작성자**: AI 분석 엔진  
**분석 범위**: v2.0.0 코드베이스  
**권장사항**: v2.1.0 스프린트

---

## 1️⃣ **Cloudflare wrangler.toml 경고 이슈**

### 문제점
```
⚠️ WARNING: "env.production" environment configuration
   - "vars" exists at the top level, but not on "env.production"
```

### 영향도
- 🟡 **중간**: 배포 시에는 작동하지만, 최상의 실습이 아님
- 프로덕션 환경 변수가 명시적으로 상속되지 않음

### 해결책
```toml
[vars]
BACKEND_RPC_URL = "https://toncenter.com/api/v2/jsonRPC"

[env.production]
vars = { BACKEND_RPC_URL = "https://toncenter.com/api/v2/jsonRPC" }
# TON_RPC_API_KEY, TON_RPC_HTTPS_ENDPOINT도 추가
```

**우선순위**: 🔴 높음 (배포 전 필수 수정)

---

## 2️⃣ **Transaction Fee 정책 부재**

### 현재 상태
```typescript
// Deposit.tsx L34-39
amount: (BigInt(amount) * BigInt(1000000000)).toString(), // nano TON
payload: undefined
```

- ❌ 고정 Fee 값 미설정
- ❌ 사용자 입금액이 그대로 GAME_WALLET로 전송됨
- ❌ 네트워크 Fee 동적 조정 메커니즘 없음

### 사용자 보고
- "100TON을 요구함" → 이는 입금액 그 자체가 100TON이어서 발생한 것으로 보임
- Network Fee는 TonConnect에서 자동 계산되므로, 사용자가 "추가로" 100TON 네트워크비를 내는 것처럼 느껴짐

### 해결책
```typescript
// Transaction에서 명시적 Fee 설정
const NETWORK_FEE_TON = 0.03; // nano TON = 30,000,000
const netFeeNano = Math.floor(NETWORK_FEE_TON * 1e9);

const transaction = {
  validUntil: Math.floor(Date.now() / 1000) + 600,
  messages: [
    {
      address: GAME_WALLET_ADDRESS,
      amount: (BigInt(amount) * BigInt(1e9)).toString(),
      // ✅ Fee는 TonConnect에서 자동 추가 (사용자에게 미리 표시)
    }
  ]
};
```

**우선순위**: 🔴 높음 (사용자 UX 개선)

---

## 3️⃣ **TonConnect 버튼 가시성 이슈**

### 현재 상태 (App.tsx)
```typescript
<header className="fixed top-0 left-0 right-0 h-16 z-50 bg-gradient-to-r from-blue-900 to-purple-900 flex items-center justify-between px-4">
  <div className="text-white font-bold">CandleSpinner</div>
  <TonConnectButton />  // ✅ 추가됨
</header>
```

- ✅ 이론적으로 모든 화면에서 보임
- ❌ 하지만 사용자가 "보이지 않음" 보고

### 잠재적 원인
1. TonConnect UI 라이브러리 버전 호환성
2. Telegram WebApp 환경에서 렌더링 문제
3. z-index 충돌 (다른 overlay 요소)

### 검증 필요
```
1. TonConnectButton이 실제로 DOM에 렌더되는지 브라우저 콘솔에서 확인
2. Telegram Mini App에서 DevTools 열어서 확인
3. TonConnect 라이브러리 CSS 로드 여부 확인
```

**우선순위**: 🔴 높음 (배포 후 실제 테스트 필수)

---

## 4️⃣ **타입 정의 누락**

### Deposit.tsx
```typescript
const result = await tonConnectUI.sendTransaction(transaction as any);
```

- ❌ `as any` 사용 (타입 안전성 저하)
- ❌ 정확한 TonConnect API 타입 정의 필요

### 개선안
```typescript
import type { SendTransactionRequest, SendTransactionResponse } from '@tonconnect/ui-react';

const result: SendTransactionResponse = await tonConnectUI.sendTransaction(
  transaction as SendTransactionRequest
);
```

**우선순위**: 🟡 중간 (타입 안전성)

---

## 5️⃣ **환경변수 구조 불충분**

### 현재 상태
```toml
[vars]
BACKEND_RPC_URL = "https://toncenter.com/api/v2/jsonRPC"
```

- ❌ ankr.com RPC 미사용
- ❌ TON_RPC_API_KEY 미설정
- ❌ TON_RPC_HTTPS_ENDPOINT 미설정

### 필요한 추가 변수
```toml
[vars]
BACKEND_RPC_URL = "https://toncenter.com/api/v2/jsonRPC"
TON_RPC_HTTPS_ENDPOINT = "https://mainnet-v4.akka.tonwhales.com"  # 또는 ankr
TON_RPC_API_KEY = "YOUR_ANKR_API_KEY"
NETWORK_FEE_TON = "0.03"
```

**우선순위**: 🔴 높음 (A/B 테스트 준비)

---

## 6️⃣ **A/B 테스트 구조 미비**

### 현재 상태
- TonConnect만 지원 (단일 입금 방식)
- RPC 직접 호출 없음

### 필요 개선
```typescript
// Deposit.tsx 신규 기능
type DepositMethod = 'tonconnect' | 'rpc-direct';

const handleDepositRPC = async () => {
  // ankr RPC를 사용한 직접 트랜잭션 전송
};

const handleDepositTonConnect = async () => {
  // 기존 TonConnect 로직
};
```

**우선순위**: 🟠 높음 (v2.1.0 신규 기능)

---

## 7️⃣ **문서 동기화 필요**

### SSoT 문서 상태
- ✅ `[산출물1]`: 프로젝트 정의 (최신)
- ✅ `[산출물2]`: 기술 스택 (v2.0.0 기준)
- ⚠️ `[산출물4]`: TMA 구현 (확인 필요)
- ❌ `[산출물3]`: 없음 (v2.0.0에서 삭제됨)

### 개선안
```
새로운 [산출물3] 필요: "API & 통합 가이드"
- 현재 모든 엔드포인트 상세 설명
- 입금/출금 플로우 다이어그램
- 환경변수 전체 정의
```

**우선순위**: 🟡 중간 (문서화)

---

## 📋 **최종 권장사항**

| 항목 | 현상태 | 목표상태 | 우선순위 | 분류 |
|------|--------|---------|---------|------|
| wrangler.toml 경고 | ⚠️ | ✅ | 🔴 높음 | 배포 |
| Transaction Fee | ❌ | ✅ | 🔴 높음 | UX |
| TonConnect 버튼 표시 | ❓ | ✅ | 🔴 높음 | 테스트 |
| 타입 정의 | ⚠️ | ✅ | 🟡 중간 | 코드품질 |
| 환경변수 구조 | ❌ | ✅ | 🔴 높음 | A/B준비 |
| A/B 테스트 구조 | ❌ | ✅ | 🟠 높음 | v2.1.0 |
| SSoT 문서 | ⚠️ | ✅ | 🟡 중간 | 문서화 |

---

## 🎯 **v2.1.0 스프린트 계획**

```
1️⃣ 긴급 (배포 직전)
   - wrangler.toml 경고 제거
   - TonConnect 버튼 가시성 실제 테스트

2️⃣ 중요 (1주일 이내)
   - Fee 정책 명확화 (0.03TON 고정)
   - 타입 정의 개선
   - 환경변수 추가

3️⃣ 신규기능 (1-2주)
   - RPC 직접 입금 추가
   - A/B 테스트 버튼 구현

4️⃣ 문서 (병렬 진행)
   - [산출물3] 신규 작성
   - SSoT 동기화
```

---

**작성 일시**: 2025-10-21 01:00 KST  
**다음 단계**: 사용자 승인 후 v2.1.0 구현 시작
