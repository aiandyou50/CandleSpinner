# π” μΈμ¶(Withdrawal) λ΅μ§ μƒμ„Έ μ„¤λ…

**μ‘μ„±μΌ:** 2025-10-23  
**λ€μƒ:** κ²μ„ μ§€κ°‘β†’μ‚¬μ©μ μ§€κ°‘ CSPIN μ „μ†΅ λ©”μ»¤λ‹μ¦  
**λ²„μ „:** v1.0

---

## π“ **ν•µμ‹¬ μ”μ•½**

> **μ‚¬μ©μλ” μΉμΈμ„ λ„λ¥΄μ§€ μ•μµλ‹λ‹¤!**  
> κ²μ„ μ„λ²„(Cloudflare Worker)κ°€ **κ²μ„ μ§€κ°‘μ κ°μΈν‚¤λ¥Ό λ³΄μ **ν•κ³  μμ–΄μ„,  
> μ‚¬μ©μλ¥Ό λ€μ‹ ν•μ—¬ **νΈλμ­μ…μ„ μλ™ μ„λ… ν›„ μ „μ†΅**ν•©λ‹λ‹¤.

---

## π― **μΈμ¶ ν”λ΅μ° (10λ‹¨κ³„)**

```
μ‚¬μ©μκ°€ "μΈμ¶" λ²„νΌ ν΄λ¦­
    β†“
[Step 1] μ”μ²­ νμ‹±
    β””β”€ walletAddress, withdrawalAmount μ¶”μ¶
    β†“
[Step 2] KVμ—μ„ μ‚¬μ©μ ν¬λ λ”§ ν™•μΈ
    β””β”€ μΈμ¶μ•΅ <= ν¬λ λ”§? κ²€μ¦
    β†“
[Step 3-4] κ²μ„ μ§€κ°‘ λ³µμ›
    β”β”€ env.GAME_WALLET_PRIVATE_KEY μ½κΈ°
    β”β”€ κ°μΈν‚¤ β†’ ν‚¤νμ–΄ μƒμ„±
    β””β”€ κ²μ„ μ§€κ°‘ μ£Όμ† μƒμ„±
    β†“
[Step 5] seqno μ¦κ°€
    β””β”€ νΈλμ­μ… μμ„ λ²νΈ (μ¤‘λ³µ λ°©μ§€)
    β†“
[Step 6] κ²μ„ Jetton μ§€κ°‘ μ΅°ν
    β”β”€ TonAPI νΈμ¶
    β””β”€ κ²μ„ μ§€κ°‘μ΄ CSPINμ„ λ³΄κ΄€ν•λ” Jetton μ§€κ°‘ μ£Όμ† μ΅°ν
    β†“
[Step 7-8] νΈλμ­μ… λ©”μ‹μ§€ μƒμ„±
    β”β”€ Jetton Transfer Payload μƒμ„± (TEP-74 ν‘μ¤€)
    β”β”€ λ©ν‘: κ²μ„ Jetton μ§€κ°‘
    β”β”€ λ…λ Ή: μ‚¬μ©μμ—κ² CSPIN μ „μ†΅
    β”β”€ κΈμ•΅: withdrawalAmount
    β””β”€ μμ‹ μ: walletAddress
    β†“
[Step 9] νΈλμ­μ… μ„λ…
    β”β”€ κ²μ„ μ§€κ°‘μ κ°μΈν‚¤ μ‚¬μ©
    β””β”€ νΈλμ­μ…μ— λ””μ§€ν„Έ μ„λ…
    β†“
[Step 10] BOC μƒμ„± λ° TonAPIλ΅ μ „μ†΅
    β”β”€ Binary Object Code (BOC) μƒμ„±
    β”β”€ TonAPIμ— POST /blockchain/message
    β””β”€ TON λΈ”λ΅μ²΄μΈμ— λΈλ΅λ“μΊμ¤νΈ
    β†“
[Step 11] KV μ—…λ°μ΄νΈ
    β”β”€ μ‚¬μ©μ ν¬λ λ”§ μ°¨κ°
    β””β”€ νΈλμ­μ… λ΅κ·Έ μ €μ¥
    β†“
β… μ‚¬μ©μ μ§€κ°‘μ— CSPIN λ„μ°©!
```

---

## π”‘ **ν•µμ‹¬ μ°¨μ΄: μ¤‘μ•™ν™” vs λ¶„μ‚°ν™”**

### **μΌλ°μ μΈ Web3 μ•± (μ‚¬μ©μκ°€ μΉμΈ)**

```
μ‚¬μ©μ μ§€κ°‘ (MetaMask λ“±)
    β†“
μ‚¬μ©μκ°€ "μΉμΈ" ν΄λ¦­ β† μ„λ… νμ—… λ‚νƒ€λ‚¨!
    β†“
νΈλμ­μ… μ„λ…λ¨
    β†“
λΈ”λ΅μ²΄μΈμ— λΈλ΅λ“μΊμ¤νΈ
```

**νΉμ§•:**
- β… μ‚¬μ©μκ°€ μ§μ ‘ μ„λ… (μ‹ λΆ°μ„± λ†’μ)
- β μ‚¬μ©μ ν™•μΈ ν•„μ” (UX λ‚μ¨)
- β λ€λ‰ νΈλμ­μ… λ¶κ°€λ¥

---

### **CandleSpinner μΈμ¶ λ΅μ§ (κ²μ„ μ„λ²„κ°€ μ„λ…)**

```
κ²μ„ μ„λ²„κ°€ κ°μΈν‚¤ λ³΄κ΄€
    β†“
μ‚¬μ©μκ°€ "μΈμ¶" ν΄λ¦­ (ν™•μΈ X)
    β†“
μ„λ²„κ°€ μ‚¬μ©μ λ€μ‹  νΈλμ­μ… μƒμ„±
    β†“
μ„λ²„μ κ°μΈν‚¤λ΅ μ„λ…
    β†“
μ„λ²„κ°€ TonAPIλ΅ μ „μ†΅
```

**νΉμ§•:**
- β… μ‚¬μ©μ ν™•μΈ λ¶ν•„μ” (UX μΆ‹μ)
- β… μ¦‰μ‹ μ²λ¦¬ κ°€λ¥ (λΉ λ¦„)
- β οΈ μ¤‘μ•™ν™” (κ²μ„ μ„λ²„λ¥Ό μ‹ λΆ°ν•΄μ•Ό ν•¨)

---

## π—οΈ **μ•„ν‚¤ν…μ² λ‹¤μ΄μ–΄κ·Έλ¨**

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                   μ‚¬μ©μ (Browser)                          β”‚
β”‚  "μΈμ¶ 100 CSPIN" λ²„νΌ ν΄λ¦­                                β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                     β”‚ POST /api/initiate-withdrawal
                     β”‚ { walletAddress, withdrawalAmount }
                     β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚         Cloudflare Worker (κ²μ„ μ„λ²„)                       β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”‚ Step 1-5: μ…λ ¥ κ²€μ¦, κ²μ„ μ§€κ°‘ λ³µμ›, seqno μ¦κ°€      β”‚β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”‚ Step 6: TonAPI νΈμ¶                                   β”‚β”‚
β”‚  β”‚   GET /v2/jettons/wallets                             β”‚β”‚
β”‚  β”‚   ?owner_account=<game_wallet>                        β”‚β”‚
β”‚  β”‚   &jetton=<CSPIN_master>                              β”‚β”‚
β”‚  β”‚   β†“ μ‘λ‹µ: gameJettonWalletAddress                     β”‚β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”‚ Step 7-8: Jetton Transfer Payload μƒμ„±                β”‚β”‚
β”‚  β”‚   β”β”€ Op: 0xf8a7ea5 (Jetton transfer)                  β”‚β”‚
β”‚  β”‚   β”β”€ Amount: 100 CSPIN                                β”‚β”‚
β”‚  β”‚   β”β”€ Destination: <user_wallet>                       β”‚β”‚
β”‚  β”‚   β””β”€ ResponseTo: <game_wallet>                        β”‚β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”‚ Step 9: νΈλμ­μ… μ„λ…                                 β”‚β”‚
β”‚  β”‚   β”β”€ κ°μΈν‚¤ μ‚¬μ©: env.GAME_WALLET_PRIVATE_KEY β† μ¤‘μ”! β”‚β”‚
β”‚  β”‚   β”β”€ μ„λ…μ: κ²μ„ μ§€κ°‘                                β”‚β”‚
β”‚  β”‚   β””β”€ seqno ν¬ν•¨: νΈλμ­μ… μμ„ λ²νΈ                   β”‚β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”‚ Step 10: BOC μƒμ„± λ° TonAPI μ „μ†΅                      β”‚β”‚
β”‚  β”‚   POST https://tonapi.io/v1/blockchain/message        β”‚β”‚
β”‚  β”‚   { "boc": "<base64_encoded_transaction>" }           β”‚β”‚
β”‚  β”‚   β†“ μ‘λ‹µ: txHash                                      β”‚β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β”‚  β”‚ Step 11: KV μ—…λ°μ΄νΈ                                  β”‚β”‚
β”‚  β”‚   β”β”€ ν¬λ λ”§ μ°¨κ°: 100 CSPIN                            β”‚β”‚
β”‚  β”‚   β””β”€ νΈλμ­μ… λ΅κ·Έ μ €μ¥                                β”‚β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                     β”‚ POST μ‘λ‹µ
                     β”‚ { success: true, txHash: "..." }
                     β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                 TON λΈ”λ΅μ²΄μΈ                                β”‚
β”‚  νΈλμ­μ… κ²€μ¦ λ° μ‹¤ν–‰                                     β”‚
β”‚  κ²μ„ Jetton μ§€κ°‘ β†’ μ‚¬μ©μ μ§€κ°‘ (100 CSPIN)              β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                     β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                   μ‚¬μ©μ μ§€κ°‘                               β”‚
β”‚  +100 CSPIN λ„μ°©! β…                                       β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## π” **κ°μΈν‚¤ κ΄€λ¦¬ - λ§¤μ° μ¤‘μ”!**

### **κ°μΈν‚¤ μ €μ¥ μ„μΉ**

```typescript
// env.GAME_WALLET_PRIVATE_KEYλ” μ–΄λ””μ—?
// β†’ Cloudflare ν™κ²½ λ³€μ (wrangler.toml)

[env.production.vars]
GAME_WALLET_PRIVATE_KEY = "0x..." β† λ§¤μ° λ―Όκ°ν• μ •λ³΄!
```

### **μ„ν—μ„±**

```
β κ°μΈν‚¤ μ μ¶ = κ²μ„ μ§€κ°‘μ λ¨λ“  ν† ν° νƒμ·¨!
   - λ„κµ¬λ“  μ΄ κ°μΈν‚¤λ΅ νΈλμ­μ… μ„λ… κ°€λ¥
   - κ²μ„ μ§€κ°‘μ λ¨λ“  CSPINμ΄ μ„ν—
   
β… λ”°λΌμ„ Cloudflareμ λ³΄μ• μ‹μ¤ν…μ— μμ΅΄:
   - ν™κ²½ λ³€μ μ•”νΈν™”
   - μ ‘κ·Ό μ μ–΄
   - κ°μ‚¬ λ΅κ·Έ
```

### **μ‹¤μ  κµ¬ν„**

```typescript
// Step 4: κ°μΈν‚¤μ—μ„ ν‚¤νμ–΄ μƒμ„±
const keyPair = keyPairFromSecretKey(
  Buffer.from(gameWalletPrivateKey, 'hex')
);

// Step 9: ν‚¤νμ–΄λ΅ νΈλμ­μ… μ„λ…
const transfer = gameWallet.createTransfer({
  seqno,
  secretKey: keyPair.secretKey,  β† κ°μΈν‚¤ μ‚¬μ©!
  messages: [transferMessage]
});

// β οΈ μ΄ μκ°„, κ²μ„ μ„λ²„κ°€ μ‚¬μ©μ λ€μ‹  μ„λ…!
```

---

## π“ **νΈλμ­μ… κµ¬μ΅° (TEP-74 Jetton ν‘μ¤€)**

### **Jetton Transfer Payload**

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Opcode: 0xf8a7ea5                β”‚ β† Jetton transfer λ…λ Ή
β”‚  query_id: 0                       β”‚
β”‚  amount: 100000000000 (100 CSPIN)  β”‚
β”‚  destination: <user_wallet>        β”‚ β† λ°›λ” μ‚¬λ
β”‚  response_destination: <game_wallet>β”‚ β† μ‘λ‹µ λ°›μ„ μ£Όμ†
β”‚  custom_payload: 0                 β”‚ β† μ¶”κ°€ λ°μ΄ν„° μ—†μ
β”‚  forward_ton_amount: 1             β”‚ β† 1 nanoton (μμλ£)
β”‚  forward_payload: 0                β”‚ β† μ¶”κ°€ λ©”μ‹μ§€ μ—†μ
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### **μ΄ Payloadλ¥Ό λ‹΄λ” Message**

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ To: <game_jetton_wallet>           β”‚ β† Jetton μ§€κ°‘μ— λ©”μ‹μ§€
β”‚ Value: 0.03 TON                    β”‚ β† μμλ£
β”‚ Body: <μ„μ Payload>               β”‚ β† Jetton μ „μ†΅ μ§€μ‹
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### **μ΄ Messageλ¥Ό λ‹΄λ” Transaction**

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ From: <game_wallet>                β”‚ β† λ°μ‹ μ
β”‚ Seqno: 123                         β”‚ β† μμ„ λ²νΈ
β”‚ Messages: [μ„μ Message]           β”‚ β† μ „μ†΅ν•  λ©”μ‹μ§€
β”‚ Signature: <κ°μΈν‚¤ μ„λ…>            β”‚ β† κ²μ„ μ„λ²„μ μ„λ…
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## π”„ **μ™ "μ‚¬μ©μ μΉμΈ"μ΄ ν•„μ” μ—†λ‚?**

### **μ΄μ  1: κ²μ„ μ§€κ°‘μ΄ μ„λ…μ**

```
μΌλ°μ μΈ κ²½μ°:
  μ‚¬μ©μ μ§€κ°‘ (κ°μΈν‚¤) β†’ μ‚¬μ©μκ°€ μΉμΈν•΄μ•Ό ν•¨

CandleSpinner:
  κ²μ„ μ§€κ°‘ (κ°μΈν‚¤) β†’ κ²μ„ μ„λ²„κ°€ μλ™ μ„λ…
  
μ‚¬μ©μμ μ§€κ°‘μ€ 'μμ‹ μ' μ—­ν• λ§ ν•¨ (μΉμΈ ν•„μ” X)
```

### **μ΄μ  2: νΈλμ­μ… νλ¦„**

```
Step 1: κ²μ„ μ„λ²„κ°€ νΈλμ­μ… μƒμ„±
Step 2: κ²μ„ μ„λ²„κ°€ κ°μΈν‚¤λ΅ μ„λ…
Step 3: κ²μ„ μ„λ²„κ°€ λΈ”λ΅μ²΄μΈμΌλ΅ μ „μ†΅
Step 4: λΈ”λ΅μ²΄μΈμ΄ κ²€μ¦ (μ„λ…μ΄ κ²μ„ μ§€κ°‘ κ²ƒμΈκ°€?)
Step 5: κ²€μ¦ μ„±κ³µ β†’ μ‹¤ν–‰

μ‚¬μ©μλ” "κµ¬κ²½λ§ ν•¨" π‘€
```

---

## β οΈ **ν„μ¬ κµ¬ν„μ ν•κ³„**

### **ν„μ¬ λ°©μ‹μ λ¬Έμ **

| λ¬Έμ  | μ„¤λ… | ν•΄κ²°μ±… |
|------|------|--------|
| **μ¤‘μ•™ν™”** | κ²μ„ μ„λ²„κ°€ μ§€κ°‘ μ μ–΄ | λ‹¤μ¤‘ μ„λ… λλ” νƒ€μ„λ½ |
| **κ°μΈν‚¤ λ…Έμ¶** | ν™κ²½λ³€μμ— μ €μ¥ | ν•λ“μ›¨μ–΄ μ§€κ°‘ λλ” Vault |
| **μ¦‰μ‹ μ‹¤ν–‰** | μ‚¬μ©μ ν™•μΈ μ—†μ | ν™•μΈ λ©”μ»¤λ‹μ¦ μ¶”κ°€ |
| **μ°¨ν›„ μ·¨μ† λ¶κ°€** | μΌλ‹¨ λ³΄λ‚΄μ§€λ©΄ λ | μ—μ¤ν¬λ΅(Escrow) μ‹μ¤ν… |

### **ν”„λ΅λ•μ… κ°μ„  λ°©μ•**

```typescript
// 1. λ‹¤μ¤‘ μ„λ… (2-of-3)
//    - κ²μ„ μ„λ²„
//    - μ‚¬μ©μ
//    - κ΄€λ¦¬μ
// β†’ μµμ† 2λ…μ΄ μ„λ…ν•΄μ•Ό μ‹¤ν–‰

// 2. νƒ€μ„λ½
//    - μ”μ²­ ν›„ 24μ‹κ°„ λ’¤ μ‹¤ν–‰
//    - μ·¨μ† κ°€λ¥ κΈ°κ°„ μ κ³µ

// 3. ν•λ„ μ ν•
//    - ν•λ£¨ μµλ€ μΈμ¶μ•΅ μ„¤μ •
//    - λ€μ•΅ μΈμ¶ μ‹ μ¶”κ°€ ν™•μΈ
```

---

## π“‹ **ν„μ¬ μ½”λ“ ν”λ΅μ° (initiate-withdrawal.ts)**

```typescript
export async function onRequestPost(context: any) {
  // Step 1-2: μ…λ ¥ κ²€μ¦
  const { walletAddress, withdrawalAmount } = body;
  
  // Step 2: KVμ—μ„ ν¬λ λ”§ ν™•μΈ
  const userState = await env.CREDIT_KV.get(stateKey);
  if (userState.credit < withdrawalAmount) {
    return { error: 'ν¬λ λ”§ λ¶€μ΅±' };
  }
  
  // Step 3-4: κ²μ„ μ§€κ°‘ λ³µμ›
  const keyPair = keyPairFromSecretKey(
    Buffer.from(env.GAME_WALLET_PRIVATE_KEY, 'hex')
  );
  const gameWallet = WalletContractV4.create({
    publicKey: keyPair.publicKey,
    workchain: 0
  });
  
  // Step 5: seqno μ¦κ°€
  const seqno = await getAndIncrementSeqno(env);
  
  // Step 6: Jetton μ§€κ°‘ μ΅°ν
  const gameJettonWalletAddress = await getJettonWalletAddress(
    env.CSPIN_TOKEN_ADDRESS,
    gameWallet.address.toString()
  );
  
  // Step 7-8: Payload + Message μƒμ„±
  const jettonPayload = buildJettonTransferPayload(...);
  const transferMessage = internal({
    to: gameJettonWalletAddress,
    body: jettonPayload
  });
  
  // Step 9: μ„λ…
  const transfer = gameWallet.createTransfer({
    seqno,
    secretKey: keyPair.secretKey,
    messages: [transferMessage]
  });
  
  // Step 10: μ „μ†΅
  const boc = transfer.toBoc().toString('base64');
  const txHash = await sendBocViaTonAPI(boc);
  
  // Step 11: KV μ—…λ°μ΄νΈ
  userState.credit -= withdrawalAmount;
  await env.CREDIT_KV.put(stateKey, JSON.stringify(userState));
  
  return { success: true, txHash };
}
```

---

## π“ **κ²°λ΅ **

### **ν•µμ‹¬ 3κ°€μ§€**

1. **κ°μΈν‚¤κ°€ μ„λ²„μ— μμ**
   - κ²μ„ μ„λ²„κ°€ κ²μ„ μ§€κ°‘ μ μ–΄
   - μ‚¬μ©μ μΉμΈ λ¶ν•„μ”

2. **νΈλμ­μ…μ„ μ„λ²„κ°€ μƒμ„± & μ„λ…**
   - κ²μ„ μ§€κ°‘μ κ°μΈν‚¤λ΅ μ„λ…
   - μ‚¬μ©μλ” μµμΆ… μμ‹ μ

3. **μλ™μΌλ΅ λΈ”λ΅μ²΄μΈμ— λΈλ΅λ“μΊμ¤νΈ**
   - TonAPI μ‚¬μ©
   - μ¦‰μ‹ μ²λ¦¬ (UX μ°μ)

---

**λ‹¤μ μ§λ¬Έ μμΌμ‹ κ°€μ”? π€**

