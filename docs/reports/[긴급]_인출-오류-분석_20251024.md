# 🔍 인출 오류 분석 리포트

## 📊 현재 상황

**에러:** HTTP 500 - `/api/initiate-withdrawal`  
**증상:** 클라이언트에서 인출 요청 시 백엔드에서 500 오류 응답

---

## 🎯 문제 분석

### 가능한 원인 (우선순위순)

#### 1️⃣ **환경변수 누락** (가장 높은 확률)
```typescript
// initiate-withdrawal.ts Line 203-207
const gameWalletPrivateKey = env.GAME_WALLET_PRIVATE_KEY;
const gameWalletAddress = env.GAME_WALLET_ADDRESS;
const cspinTokenAddress = env.CSPIN_TOKEN_ADDRESS;

if (!gameWalletPrivateKey || !gameWalletAddress || !cspinTokenAddress) {
  // ← HTTP 500 반환
  return new Response(
    JSON.stringify({ success: false, error: '서버 설정 오류' })
  );
}
```

**확인 방법:**
```
Cloudflare Pages → 프로젝트 설정 → 환경변수
```

**필수 환경변수:**
- `GAME_WALLET_PRIVATE_KEY` (128자 hex)
- `GAME_WALLET_ADDRESS` (UQ...로 시작)
- `CSPIN_TOKEN_ADDRESS` (EQ...로 시작)

---

#### 2️⃣ **KV 바인딩 누락** (높은 확률)
```typescript
// Line 49-52
async function getAndIncrementSeqno(env: any): Promise<number> {
  const current = await env.CREDIT_KV.get(SEQNO_KEY);
  // ← env.CREDIT_KV가 undefined라면 에러
}
```

**확인 방법:**
- `wrangler.toml`에서 KV 바인딩 확인

```toml
[[env.production.kv_namespaces]]
binding = "CREDIT_KV"
id = "..."  # ← ID 확인 필수
```

---

#### 3️⃣ **TonAPI 네트워크 오류** (중간 확률)
```typescript
// Line 88-102
async function sendBocViaTonAPI(bocBase64: string): Promise<string> {
  const response = await fetch(url, { ... });
  if (!response.ok) {
    throw new Error(`TonAPI sendBoc 실패: ${response.status} ${text}`);
  }
}
```

**가능한 상황:**
- TonAPI 서비스 다운
- 네트워크 연결 끊김
- 인증 토큰 만료

---

#### 4️⃣ **지갑 주소 형식 오류** (낮은 확률)
```typescript
// Line 151-152
const userJettonWalletAddress = await getJettonWalletAddress(
  cspinTokenAddress,
  gameWallet.address.toString()
);
```

**가능한 상황:**
- 주소 포맷 불일치 (UQ vs EQ vs raw format)
- 체크섬 오류

---

## 📋 필수 정보 수집

**다음 정보를 알려주면 정확한 원인 파악이 가능합니다:**

### 1. Cloudflare Pages 환경변수 확인
```
Q: Cloudflare 대시보드에서 다음 환경변수가 설정되어 있나요?
  - GAME_WALLET_PRIVATE_KEY: ✅ 설정됨 / ❌ 미설정
  - GAME_WALLET_ADDRESS: ✅ 설정됨 / ❌ 미설정
  - CSPIN_TOKEN_ADDRESS: ✅ 설정됨 / ❌ 미설정

(개인키는 마스킹해서 알려주세요. 예: 4e6568d1...ef7978fc)
```

### 2. wrangler.toml KV 바인딩 확인
```
Q: wrangler.toml에서 CREDIT_KV가 설정되어 있나요?
  [[env.production.kv_namespaces]]
  binding = "CREDIT_KV"
  id = "..." (이 ID를 알려주세요)
  
또는 [env.production] 섹션에
  kv_namespaces = [...]  설정?
```

### 3. Cloudflare Worker 로그 확인
```
Cloudflare 대시보드 → Workers → 프로젝트
→ Real-time Logs → `/api/initiate-withdrawal` 로그 확인

예상 로그:
  "[인출] 요청: UQ... → 100 CSPIN"
  "[인출] ✅ 완료" 또는
  "[인출] ❌ 오류: ..."
```

### 4. 브라우저 개발자 도구
```
Network 탭에서:
  POST /api/initiate-withdrawal 응답 상세 보기
  → Response 탭에서 정확한 에러 메시지 확인
  
예상 응답:
  {
    "success": false,
    "error": "서버 설정 오류" 또는
    "error": "[TonAPI] ..." 또는
    "error": "..."
  }
```

---

## 🔧 즉시 확인할 체크리스트

### Step 1: 환경변수 확인
```
Cloudflare Pages → Settings → Environment variables
→ Production 탭 확인

[ ] GAME_WALLET_PRIVATE_KEY - 128자 hex 포맷
[ ] GAME_WALLET_ADDRESS - UQ... 포맷
[ ] CSPIN_TOKEN_ADDRESS - EQ... 포맷
[ ] CREDIT_KV 바인딩 - ID 확인됨
```

### Step 2: 배포 상태 확인
```
[ ] 최신 커밋이 Cloudflare에 배포됨?
  → Deployments 탭 확인
  
[ ] 배포 로그에 에러 없음?
  → Build logs 확인
```

### Step 3: 네트워크 확인
```
[ ] TonAPI 서비스 정상?
  → https://tonapi.io/v1/status (브라우저에서 확인)
  
[ ] Cloudflare Workers 정상?
  → Cloudflare 상태 페이지 확인
```

---

## 📱 임시 해결 방법 (테스트용)

만약 환경변수 문제라면, 로컬 개발 환경에서 테스트:

```bash
# Step 1: 로컬 환경변수 설정
cp .env.example .env.local

# Step 2: wrangler.toml에 로컬 값 추가 (개발용만)
cat >> wrangler.toml << 'EOF'
[env.development]
name = "candlespinner-dev"
EOF

# Step 3: 로컬 서버 시작
npm run dev

# Step 4: 로컬에서 인출 테스트
curl -X POST http://localhost:8788/api/initiate-withdrawal \
  -H "Content-Type: application/json" \
  -d '{"walletAddress":"UQ...","withdrawalAmount":10}'
```

---

## 🎯 다음 액션

**당신이 할 일:**
1. 위 정보 수집 목록에서 답변해주기
2. 브라우저 콘솔 + Network 탭의 정확한 에러 메시지 알려주기
3. Cloudflare 대시보드 환경변수 설정 상태 확인

**내가 할 일:**
1. 원인 정확히 파악
2. 수정 코드 작성
3. 배포 및 테스트

---

**준비 완료되면 알려주세요!** 🚀
