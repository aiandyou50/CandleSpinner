# ğŸ” ì¸ì¶œ ì˜¤ë¥˜ ë¶„ì„ ë¦¬í¬íŠ¸

## ğŸ“Š í˜„ì¬ ìƒí™©

**ì—ëŸ¬:** HTTP 500 - `/api/initiate-withdrawal`  
**ì¦ìƒ:** í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¸ì¶œ ìš”ì²­ ì‹œ ë°±ì—”ë“œì—ì„œ 500 ì˜¤ë¥˜ ì‘ë‹µ

---

## ğŸ¯ ë¬¸ì œ ë¶„ì„

### ê°€ëŠ¥í•œ ì›ì¸ (ìš°ì„ ìˆœìœ„ìˆœ)

#### 1ï¸âƒ£ **í™˜ê²½ë³€ìˆ˜ ëˆ„ë½** (ê°€ì¥ ë†’ì€ í™•ë¥ )
```typescript
// initiate-withdrawal.ts Line 203-207
const gameWalletPrivateKey = env.GAME_WALLET_PRIVATE_KEY;
const gameWalletAddress = env.GAME_WALLET_ADDRESS;
const cspinTokenAddress = env.CSPIN_TOKEN_ADDRESS;

if (!gameWalletPrivateKey || !gameWalletAddress || !cspinTokenAddress) {
  // â† HTTP 500 ë°˜í™˜
  return new Response(
    JSON.stringify({ success: false, error: 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜' })
  );
}
```

**í™•ì¸ ë°©ë²•:**
```
Cloudflare Pages â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ í™˜ê²½ë³€ìˆ˜
```

**í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜:**
- `GAME_WALLET_PRIVATE_KEY` (128ì hex)
- `GAME_WALLET_ADDRESS` (UQ...ë¡œ ì‹œì‘)
- `CSPIN_TOKEN_ADDRESS` (EQ...ë¡œ ì‹œì‘)

---

#### 2ï¸âƒ£ **KV ë°”ì¸ë”© ëˆ„ë½** (ë†’ì€ í™•ë¥ )
```typescript
// Line 49-52
async function getAndIncrementSeqno(env: any): Promise<number> {
  const current = await env.CREDIT_KV.get(SEQNO_KEY);
  // â† env.CREDIT_KVê°€ undefinedë¼ë©´ ì—ëŸ¬
}
```

**í™•ì¸ ë°©ë²•:**
- `wrangler.toml`ì—ì„œ KV ë°”ì¸ë”© í™•ì¸

```toml
[[env.production.kv_namespaces]]
binding = "CREDIT_KV"
id = "..."  # â† ID í™•ì¸ í•„ìˆ˜
```

---

#### 3ï¸âƒ£ **TonAPI ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜** (ì¤‘ê°„ í™•ë¥ )
```typescript
// Line 88-102
async function sendBocViaTonAPI(bocBase64: string): Promise<string> {
  const response = await fetch(url, { ... });
  if (!response.ok) {
    throw new Error(`TonAPI sendBoc ì‹¤íŒ¨: ${response.status} ${text}`);
  }
}
```

**ê°€ëŠ¥í•œ ìƒí™©:**
- TonAPI ì„œë¹„ìŠ¤ ë‹¤ìš´
- ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€
- ì¸ì¦ í† í° ë§Œë£Œ

---

#### 4ï¸âƒ£ **ì§€ê°‘ ì£¼ì†Œ í˜•ì‹ ì˜¤ë¥˜** (ë‚®ì€ í™•ë¥ )
```typescript
// Line 151-152
const userJettonWalletAddress = await getJettonWalletAddress(
  cspinTokenAddress,
  gameWallet.address.toString()
);
```

**ê°€ëŠ¥í•œ ìƒí™©:**
- ì£¼ì†Œ í¬ë§· ë¶ˆì¼ì¹˜ (UQ vs EQ vs raw format)
- ì²´í¬ì„¬ ì˜¤ë¥˜

---

## ğŸ“‹ í•„ìˆ˜ ì •ë³´ ìˆ˜ì§‘

**ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ë©´ ì •í™•í•œ ì›ì¸ íŒŒì•…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:**

### 1. Cloudflare Pages í™˜ê²½ë³€ìˆ˜ í™•ì¸
```
Q: Cloudflare ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ìŒ í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆë‚˜ìš”?
  - GAME_WALLET_PRIVATE_KEY: âœ… ì„¤ì •ë¨ / âŒ ë¯¸ì„¤ì •
  - GAME_WALLET_ADDRESS: âœ… ì„¤ì •ë¨ / âŒ ë¯¸ì„¤ì •
  - CSPIN_TOKEN_ADDRESS: âœ… ì„¤ì •ë¨ / âŒ ë¯¸ì„¤ì •

(ê°œì¸í‚¤ëŠ” ë§ˆìŠ¤í‚¹í•´ì„œ ì•Œë ¤ì£¼ì„¸ìš”. ì˜ˆ: 4e6568d1...ef7978fc)
```

### 2. wrangler.toml KV ë°”ì¸ë”© í™•ì¸
```
Q: wrangler.tomlì—ì„œ CREDIT_KVê°€ ì„¤ì •ë˜ì–´ ìˆë‚˜ìš”?
  [[env.production.kv_namespaces]]
  binding = "CREDIT_KV"
  id = "..." (ì´ IDë¥¼ ì•Œë ¤ì£¼ì„¸ìš”)
  
ë˜ëŠ” [env.production] ì„¹ì…˜ì—
  kv_namespaces = [...]  ì„¤ì •?
```

### 3. Cloudflare Worker ë¡œê·¸ í™•ì¸
```
Cloudflare ëŒ€ì‹œë³´ë“œ â†’ Workers â†’ í”„ë¡œì íŠ¸
â†’ Real-time Logs â†’ `/api/initiate-withdrawal` ë¡œê·¸ í™•ì¸

ì˜ˆìƒ ë¡œê·¸:
  "[ì¸ì¶œ] ìš”ì²­: UQ... â†’ 100 CSPIN"
  "[ì¸ì¶œ] âœ… ì™„ë£Œ" ë˜ëŠ”
  "[ì¸ì¶œ] âŒ ì˜¤ë¥˜: ..."
```

### 4. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬
```
Network íƒ­ì—ì„œ:
  POST /api/initiate-withdrawal ì‘ë‹µ ìƒì„¸ ë³´ê¸°
  â†’ Response íƒ­ì—ì„œ ì •í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
  
ì˜ˆìƒ ì‘ë‹µ:
  {
    "success": false,
    "error": "ì„œë²„ ì„¤ì • ì˜¤ë¥˜" ë˜ëŠ”
    "error": "[TonAPI] ..." ë˜ëŠ”
    "error": "..."
  }
```

---

## ğŸ”§ ì¦‰ì‹œ í™•ì¸í•  ì²´í¬ë¦¬ìŠ¤íŠ¸

### Step 1: í™˜ê²½ë³€ìˆ˜ í™•ì¸
```
Cloudflare Pages â†’ Settings â†’ Environment variables
â†’ Production íƒ­ í™•ì¸

[ ] GAME_WALLET_PRIVATE_KEY - 128ì hex í¬ë§·
[ ] GAME_WALLET_ADDRESS - UQ... í¬ë§·
[ ] CSPIN_TOKEN_ADDRESS - EQ... í¬ë§·
[ ] CREDIT_KV ë°”ì¸ë”© - ID í™•ì¸ë¨
```

### Step 2: ë°°í¬ ìƒíƒœ í™•ì¸
```
[ ] ìµœì‹  ì»¤ë°‹ì´ Cloudflareì— ë°°í¬ë¨?
  â†’ Deployments íƒ­ í™•ì¸
  
[ ] ë°°í¬ ë¡œê·¸ì— ì—ëŸ¬ ì—†ìŒ?
  â†’ Build logs í™•ì¸
```

### Step 3: ë„¤íŠ¸ì›Œí¬ í™•ì¸
```
[ ] TonAPI ì„œë¹„ìŠ¤ ì •ìƒ?
  â†’ https://tonapi.io/v1/status (ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸)
  
[ ] Cloudflare Workers ì •ìƒ?
  â†’ Cloudflare ìƒíƒœ í˜ì´ì§€ í™•ì¸
```

---

## ğŸ“± ì„ì‹œ í•´ê²° ë°©ë²• (í…ŒìŠ¤íŠ¸ìš©)

ë§Œì•½ í™˜ê²½ë³€ìˆ˜ ë¬¸ì œë¼ë©´, ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸:

```bash
# Step 1: ë¡œì»¬ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
cp .env.example .env.local

# Step 2: wrangler.tomlì— ë¡œì»¬ ê°’ ì¶”ê°€ (ê°œë°œìš©ë§Œ)
cat >> wrangler.toml << 'EOF'
[env.development]
name = "candlespinner-dev"
EOF

# Step 3: ë¡œì»¬ ì„œë²„ ì‹œì‘
npm run dev

# Step 4: ë¡œì»¬ì—ì„œ ì¸ì¶œ í…ŒìŠ¤íŠ¸
curl -X POST http://localhost:8788/api/initiate-withdrawal \
  -H "Content-Type: application/json" \
  -d '{"walletAddress":"UQ...","withdrawalAmount":10}'
```

---

## ğŸ¯ ë‹¤ìŒ ì•¡ì…˜

**ë‹¹ì‹ ì´ í•  ì¼:**
1. ìœ„ ì •ë³´ ìˆ˜ì§‘ ëª©ë¡ì—ì„œ ë‹µë³€í•´ì£¼ê¸°
2. ë¸Œë¼ìš°ì € ì½˜ì†” + Network íƒ­ì˜ ì •í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì•Œë ¤ì£¼ê¸°
3. Cloudflare ëŒ€ì‹œë³´ë“œ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ìƒíƒœ í™•ì¸

**ë‚´ê°€ í•  ì¼:**
1. ì›ì¸ ì •í™•íˆ íŒŒì•…
2. ìˆ˜ì • ì½”ë“œ ì‘ì„±
3. ë°°í¬ ë° í…ŒìŠ¤íŠ¸

---

**ì¤€ë¹„ ì™„ë£Œë˜ë©´ ì•Œë ¤ì£¼ì„¸ìš”!** ğŸš€
