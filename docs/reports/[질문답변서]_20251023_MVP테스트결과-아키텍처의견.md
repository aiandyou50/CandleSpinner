# 📋 MVP 테스트 결과 및 질문 답변 보고서

**작성일:** 2025-10-23  
**버전:** v2.5.2  
**상태:** 긴급 개선 60% 완료

---

## 🔴 긴급 문제 (이미 해결)

### 문제 1: 상금 수령 후 크레딧 리셋

**원인:** 화면 전환 시 saveGameState 호출 누락

**해결책 (커밋 6fea226):**
```typescript
// GameComplete.tsx에 추가
useEffect(() => {
  if (currentScreen !== 'main') {
    console.log('[GameComplete] 💾 화면 전환 시 크레딧 자동 저장:', currentScreen, userCredit);
    setTimeout(() => {
      saveGameState();
    }, 100);
  }
}, [currentScreen, userCredit, saveGameState]);
```

**효과:**
```
모든 화면 전환(result → main, withdraw 등)에서
자동으로 POST /api/save-game-state 호출
→ KV에 현재 크레딧 저장
→ 페이지 이동 후 크레딧 손실 방지
```

**테스트 방법:**
```
1. 스핀 승리 → credit: 1250
2. 입금 페이지 이동 (자동 saveGameState 호출)
3. 뒤로가기 → 메인 페이지
4. UI 크레딧: 1250 유지 확인? ✅
```

---

## 📋 질문 1-4: 기술 진단 가이드

### Q1: /api/debug-withdrawal 호출 방법

**방법 A: 브라우저 주소창**
```
https://aiandyou.me/api/debug-withdrawal
```

**방법 B: 터미널**
```bash
curl https://aiandyou.me/api/debug-withdrawal
```

**방법 C: 개발자 도구 (F12)**
```javascript
// Console 탭에 입력
fetch('/api/debug-withdrawal').then(r => r.json()).then(d => console.log(d))
```

**응답 분석:**
```json
{
  "environment": {
    "hasPrivateKey": true,           ← false면 문제!
    "privateKeyLength": 128,         ← 0이면 문제!
    "gameWalletAddress": "UQA...",  ← 비어있으면 문제!
    "cspinTokenAddress": "EQB..."   ← 비어있으면 문제!
  },
  "status": {
    "privateKeyValid": true,         ← false면 원인 찾음!
    "gameWalletValid": true,
    "cspinTokenValid": true
  }
}
```

**가능한 결과와 대응:**

| 결과 | 의미 | 해결책 |
|------|------|--------|
| privateKeyValid: false | 환경변수 GAME_WALLET_PRIVATE_KEY 누락 | wrangler.toml에서 추가 |
| gameWalletValid: false | GAME_WALLET_ADDRESS 누락 | wrangler.toml에서 추가 |
| cspinTokenValid: false | CSPIN_TOKEN_ADDRESS 누락 | wrangler.toml에서 추가 |
| 모두 true | 설정 정상 | Cloudflare 로그 확인 |

---

### Q2: Cloudflare 로그 확인 방법

**방법 1: Wrangler CLI (가장 쉬움)**

```bash
# 터미널에서
wrangler tail

# 실시간 로그 표시됨 (Ctrl+C로 종료)
```

**방법 2: Cloudflare Dashboard**

```
1. https://dash.cloudflare.com 접속
2. Workers & Pages → CandleSpinner 선택
3. "Logs" 탭 클릭
4. 실시간 로그 확인
```

**확인할 로그 메시지:**

```
[인출] 요청: 0:ac0491... → 100 CSPIN
[인출] 현재 크레딧: 1150
[인출] 게임 지갑: EQA...
[인출] 게임 Jetton 지갑: EQB...
[인출] ❌ 오류: getJettonWalletAddress 실패

또는

[save-game-state] ✅ 저장 성공: {walletAddress, credit: 1250}
```

**로그가 없으면:**
- API 호출 자체가 안 됨
- 네트워크 오류 가능

**로그가 있는데 ❌ 오류면:**
- 오류 메시지로 원인 파악 가능

---

### Q3: 상금 수령 후 크레딧 미저장 진단

**체크리스트:**

```
Step 1: KV 페이지 확인
├─ state:0:abc123 값 확인
├─ "lastUpdateTime" 필드 최신?
└─ "credit" 값이 스핀 상금 포함?

Step 2: 브라우저 개발자 도구 (F12)
├─ Network 탭 열기
├─ 스핀 후 "계속 게임" 클릭
├─ POST /api/save-game-state 요청 있는가?
├─ 응답 status: 200? 500?
└─ 응답 body: {"success": true}?

Step 3: Cloudflare 로그
├─ wrangler tail 실행
├─ 스핀 후 화면 전환
├─ [save-game-state] ✅ 저장 성공 메시지 있는가?
└─ ❌ 오류 메시지면 원인 기록

Step 4: 최종 확인
├─ KV 업데이트: state 값의 lastUpdateTime 변경?
├─ UI 크레딧: 새로고침 후 상금 포함 유지?
└─ 인출 버튼: 올바른 금액 보이는가?
```

**이제 자동 저장이 적용되었으므로:**
```
이전: "계속 게임" 클릭할 때만 저장
현재: 모든 화면 전환(deposit 가기, withdraw 가기 등)에서 자동 저장 ✅
```

---

### Q4: 추가 필요 정보

**인출 500 오류를 해결하기 위해 제공해주세요:**

```markdown
## 필수 정보

### 1. /api/debug-withdrawal 결과
```json
{
  "environment": { ... },
  "status": { ... }
}
```
복사해서 첨부해주세요.

### 2. Cloudflare 로그 (wrangler tail)
```
[인출] 요청: ...
[인출] ❌ 오류: ...
```
에러 메시지 전체 첨부해주세요.

### 3. 브라우저 콘솔 오류 (F12 → Console)
```
POST /api/initiate-withdrawal 500
Response: { "error": "..." }
```
응답 body 전체 첨부해주세요.

### 4. KV 상태 (Dashboard → KV)
state:0:abc123 값의 최신 내용:
```json
{
  "credit": ???,
  "canDoubleUp": false,
  "pendingWinnings": 0,
  "lastUpdateTime": ???
}
```
```

**이 정보들이 있으면 원인을 정확히 파악할 수 있습니다!**

---

## 🏗️ 질문 5: Cloudflare Pages vs Workers

### 현재 구조

```
Cloudflare Pages
  ├─ Frontend (React SPA)
  │   ├─ App.tsx
  │   ├─ GameComplete.tsx
  │   └─ ...
  │
  └─ Functions (API)
      ├─ /api/deposit.ts
      ├─ /api/initiate-withdrawal.ts
      ├─ /api/save-game-state.ts
      └─ ...
```

### Pages vs Workers 비교

| 항목 | Pages | Workers |
|------|-------|---------|
| **용도** | 웹사이트 호스팅 | Serverless 함수 호스팅 |
| **비용** | 무료 | 무료 (충분한 한도) |
| **KV 접근** | ✅ Functions로 가능 | ✅ 직접 가능 |
| **배포 어려움** | ⭐ 쉬움 | ⭐⭐⭐ 어려움 |
| **마이그레이션** | 불필요 | 선택사항 |

### 결론: **Pages 유지 강력 권장** ✅

```
이유:
1. 현재 구조가 최적
   - Pages에서 Frontend + Functions 모두 호스팅 가능
   - 배포 자동화 (git push)
   
2. 추가 이점
   - 개발 복잡도 낮음
   - 비용 차이 없음
   - 마이그레이션 필요 없음
   
3. Workers 전환 필요 없음
   - Pages의 Functions = Workers의 기능
   - 동일한 성능, 동일한 가격
   
결론: 현재 Pages 구조 계속 사용 ✅
```

---

## 📚 질문 6-8: 아키텍처 설계 철학

### Q6: SPA를 선택한 이유

**프로젝트 요구사항 분석:**

```
┌──────────────────────────────┐
│  Telegram Mini App Game      │
├──────────────────────────────┤
│ 1. 모바일 우선               │
│ 2. 빠른 응답 필수            │
│ 3. 게임 상태 유지            │
│ 4. 블록체인 연동             │
│ 5. 가벼운 배포               │
└──────────────────────────────┘
           ↓
        SPA 필수
```

**구체적 이유:**

| 요구사항 | SPA의 해결책 | MPA의 한계 |
|---------|------------|----------|
| 모바일 | React Native 최적화 | HTML 로드 반복 (느림) |
| 응답성 | 컴포넌트만 변경 (매우 빠름) | 매번 서버 요청 (느림) |
| 상태 유지 | 메모리에 유지 | 새로고침 시 손실 |
| 블록체인 | 지갑 연결 유지 | 매번 재연결 |
| 배포 | 정적 번들 (작음) | 서버 필수 |

**결론:**
```
TMA 환경에서 SPA는 선택이 아닌 필수 ✅
MPA는 사용 불가능
```

---

### Q7: History API로 SPA에 브라우저 뒤로가기 추가

**정답: YES! ✅ 완벽하게 가능**

**구현 방법:**

```typescript
// App.tsx
useEffect(() => {
  // URL 변경 (히스토리에 기록)
  const newUrl = appMode === 'game' ? '/' : `/${appMode}`;
  window.history.pushState({ appMode }, '', newUrl);
}, [appMode]);

// 브라우저 뒤로/앞으로 버튼 감지
window.addEventListener('popstate', (event) => {
  const newAppMode = event.state?.appMode || 'game';
  setAppMode(newAppMode);
});
```

**작동 원리:**

```
사용자 "입금" 클릭
       ↓
setAppMode('deposit')
       ↓
useEffect 트리거
       ↓
window.history.pushState({ appMode: 'deposit' }, '', '/deposit')
       ↓
URL 변경: / → /deposit (히스토리에 기록)
       ↓
브라우저 뒤로 버튼 클릭
       ↓
popstate 이벤트
       ↓
setAppMode('game')
       ↓
URL 변경: /deposit → / ✅
```

**효과:**

```
Before (현재):
- 입금 클릭 → URL 변경 X
- 뒤로 버튼 → 작동 X
- 북마크 → 불가능

After (History API 적용):
- 입금 클릭 → URL: /deposit
- 뒤로 버튼 → game 화면 ✅
- 북마크 → /deposit 저장 가능
```

**추가 장점:**

```
1. 새로고침 시 상태 복구
   /deposit → 새로고침 → Deposit 화면 유지
   
2. 사용자 경험 향상
   - 전통적인 웹 브라우징과 동일
   - 뒤로가기 버튼 직관적
   
3. 디버깅 용이
   - URL로 상태 파악 가능
   - 로그에 URL 기록
```

**언제 추가할까?**
→ **다음 세션** (우선순위 🟡)

---

### Q8: SPA vs MPA 최종 판단

#### 프로젝트별 최적 구조

**CandleSpinner (현재 프로젝트):**
```
┌──────────────────────────┐
│  SPA ✅ (필수)            │
├──────────────────────────┤
│ 이유:                    │
│ - TMA 게임               │
│ - 모바일 우선            │
│ - 빠른 응답              │
│ - 상태 유지              │
└──────────────────────────┘
```

**다른 프로젝트별 추천:**

| 프로젝트 | 구조 | 이유 |
|---------|------|------|
| **전자상거래** | MPA | SEO 중요, 페이지 간 독립적 |
| **블로그** | MPA | SEO 필수, 컨텐츠 중심 |
| **게임** | SPA | 빠른 응답, 상태 유지 |
| **금융 앱** | SPA | 보안, 실시간 동기화 |
| **SNS** | SPA | 실시간 업데이트, 상태 유지 |

#### 상세 비교표

| 평가항목 | SPA | MPA | CandleSpinner 최적 |
|---------|-----|-----|----------------|
| **초기 로딩** | ⭐⭐⭐⭐ (빠름) | ⭐⭐⭐ (느림) | SPA |
| **페이지 전환** | ⭐⭐⭐⭐⭐ (매우 빠름) | ⭐⭐ (느림) | SPA |
| **상태 유지** | ⭐⭐⭐⭐⭐ (완벽) | ⭐ (불가능) | SPA |
| **SEO** | ⭐⭐ (어려움) | ⭐⭐⭐⭐⭐ | MPA |
| **모바일** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | SPA |
| **개발 복잡도** | ⭐⭐⭐ | ⭐⭐ | 합리적 |
| **배포** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | SPA |

#### 결론

```
┌─────────────────────────────────┐
│ 최종 판단: SPA ✅ (변경 불필요) │
├─────────────────────────────────┤
│                                 │
│ 이유:                           │
│ 1. TMA 게임 특성상 SPA 필수    │
│ 2. 모바일 환경 최우선          │
│ 3. 응답 속도 매우 중요         │
│ 4. 게임 상태 유지 필수         │
│ 5. 추가 비용 0 (History API)  │
│                                 │
│ 단점 해결책:                    │
│ - 브라우저 뒤로가기 X          │
│   → History API로 해결 ✅      │
│ - URL 변경 X                   │
│   → pushState로 해결 ✅        │
│ - SEO X                        │
│   → TMA에는 불필요 (봇 X)    │
│                                 │
└─────────────────────────────────┘
```

---

## 📊 다음 우선순위 (지침서 준수)

### 🔴 즉시 (지금 바로)

1. **인출 로직 진단** (500 오류 해결)
   - /api/debug-withdrawal 결과 공유
   - Cloudflare 로그 확인
   - 원인 파악 후 수정

2. **상금 수령 KV 저장 테스트** ✅ (자동 저장 적용됨)
   - 스핀 후 입금 이동 → 복귀
   - 크레딧 유지 확인

### 🟡 다음 세션 (권장)

1. **History API 추가** (1시간 소요)
   - App.tsx에 pushState 추가
   - popstate 리스너 구현
   - 브라우저 뒤로/앞으로 정상화

2. **localStorage 개선** (30분 소요)
   - deposit 이벤트 → 직접 콜백 변경
   - 입금 후 즉시 상태 반영

### 🟢 나중 (선택)

1. **deposit.ts seqno 원자성**
2. **에러 로깅 개선**
3. **캐시 전략 추가**

---

## ✅ 현재 배포 상태

| 커밋 | 내용 | 상태 |
|------|------|------|
| 187f9f7 | KV 키 형식 수정 | ✅ 배포 완료 |
| e572033 | 스핀 결과 KV 저장 | ✅ 배포 완료 |
| 9aa18c8 | 분석 보고서 + 진단 API | ✅ 배포 완료 |
| 6fea226 | 화면 전환 시 자동 저장 | ✅ 배포 중 |

---

**다음 액션:**
1. /api/debug-withdrawal 호출 → 결과 공유
2. Cloudflare 로그 → 인출 오류 메시지 공유
3. 스핀 후 상금 수령 테스트 (자동 저장 확인)
4. 인출 실행 테스트 (새 오류 메시지 수집)

