# **[보고서] TON 블록체인 학습 및 PoC 분석 보고서**

**프로젝트:** CandleSpinner  
**날짜:** 2025년 10월 20일  
**버전:** 1.0  
**작성자:** GitHub Copilot  

---

## **Executive Summary**

CandleSpinner 프로젝트의 TON 블록체인 통합을 위해 클론된 GitHub 레포지토리를 통해 학습한 내용을 분석하고 문서화하였다. PoC(Proof of Concept) 구현을 통해 TON Connect, 제톤 토큰 전송, 트랜잭션 생성 등의 핵심 기술을 습득하여 실제 프로젝트 적용에 성공하였다.

**주요 성과:**
- ✅ TON 생태계 기본 개념 습득 (TEP-74 제톤 표준, TON Connect SDK)
- ✅ 제톤 전송 페이로드 빌드 및 트랜잭션 생성 로직 구현
- ✅ 주요 오류 해결 방법 학습 (Transaction verification failed 등)
- ✅ 실제 프로젝트에 PoC 로직 적용 (CSPIN 입금/인출 기능)

---

## **학습 배경 및 목적**

### **클론된 레포지토리 개요**
프로젝트 초기 단계에서 TON 블록체인 기술에 대한 이해가 부족하여, 관련 예제 코드와 튜토리얼이 포함된 공개 GitHub 레포지토리를 클론하여 학습 자료로 활용하였다.

**주요 클론 레포:**
- **ton-core**: https://github.com/ton-org/ton-core - TON 블록체인 코어 라이브러리 및 예제
- **TON Connect**: https://github.com/ton-connect - TON 지갑 연동 SDK 및 샘플 코드
- **TEP-74 Jetton Standard**: https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md - 제톤 토큰 표준 문서

### **학습 목적**
- TON Connect를 통한 지갑 연동 방식 이해
- 제톤(Jetton) 토큰 전송 페이로드 구조 습득
- 트랜잭션 생성 및 검증 오류 해결 방법 학습
- 실제 프로젝트(CSPIN 입금/인출)에 적용 가능한 코드 패턴 확보

---

## **학습 내용 상세 분석**

### **1. TON Connect 지갑 연동**

#### **학습한 주요 개념**
- TON Connect UI를 통한 지갑 연결/해제
- 연결된 지갑 정보 (주소, 체인 등) 접근
- 트랜잭션 전송 인터페이스 (`sendTransaction`)

#### **적용 사례**
```typescript
const connectedWallet = useTonWallet();
const [tonConnectUI] = useTonConnectUI();

// 트랜잭션 전송
const result = await tonConnectUI.sendTransaction(tx);
```

#### **프로젝트 적용**
- `src/hooks/useTonConnect.ts`에서 지갑 상태 관리 구현
- `src/components/Game.tsx`에서 CSPIN 입금 시 지갑 연결 확인

### **2. 제톤 토큰 전송 페이로드 빌드**

#### **학습한 주요 개념**
- TEP-74 제톤 표준에 따른 transfer 메시지 구조
- `beginCell()`을 사용한 boc(Bag of Cells) 생성
- 필수 필드: op(0xF8A7EA5), query_id, amount, destination, response_destination 등

#### **적용 사례**
```typescript
const payloadCell = beginCell()
  .storeUint(0xF8A7EA5, 32)     // op: transfer
  .storeUint(0, 64)             // query_id
  .storeCoins(amount)            // CSPIN amount
  .storeAddress(destination)     // destination
  .storeAddress(responseTo)      // response_destination
  .storeBit(0)                   // custom_payload: none
  .storeCoins(BigInt(0))         // forward_ton_amount
  .storeBit(1)                   // forward_payload: right (for ^Cell)
  .endCell();
```

#### **프로젝트 적용**
- `src/components/Game.tsx`의 `buildCSPINTransferPayload` 함수
- CSPIN 입금 시 제톤 지갑 주소로 트랜잭션 전송

### **3. 제톤 지갑 주소 파생**

#### **학습한 주요 개념**
- 사용자의 제톤 지갑 주소 계산 방법
- RPC를 통한 `getJettonWalletAddress` 호출
- ton-core 라이브러리의 헬퍼 함수 사용

#### **적용 사례**
```typescript
const jettonWalletAddressStr = await rpc.getJettonWalletAddress(CSPIN_TOKEN_ADDRESS, connectedWallet.account.address);
```

#### **프로젝트 적용**
- CSPIN 입금 시 올바른 제톤 컨트랙트 주소 사용
- 최근 수정: `useRpc` hook을 컴포넌트 상단에서 선언하여 규칙 준수

### **4. 트랜잭션 생성 및 오류 해결**

#### **학습한 주요 오류 및 해결**
- **Transaction verification failed**: 페이로드 구조 불완전 (custom_payload, forward_payload 누락)
- **제톤 지갑 주소 파생 실패**: ton-core API 변경 또는 RPC 실패
- **boc 생성 오류**: TL-B 구조 준수 실패

#### **적용 사례**
```typescript
const tx = {
  validUntil: Math.floor(Date.now() / 1000) + 600,
  messages: [{
    address: userJettonWalletAddress,
    amount: '30000000', // 0.03 TON
    payload: base64
  }]
};
```

#### **프로젝트 적용**
- CSPIN 입금/인출 시 트랜잭션 구조 표준화
- 오류 해결: forward_payload TL-B 구조 수정, 수수료 최적화 (0.1 → 0.03 TON)

### **5. 기타 학습 내용**

#### **TON 생태계 이해**
- TON의 Cell 기반 데이터 구조
- 네트워크 수수료 및 트랜잭션 검증
- TON Connect SDK의 버전 호환성

#### **개발 모범 사례**
- TypeScript 엄격 모드 사용
- 에러 처리 및 사용자 피드백 강화
- 디버그 로깅 및 트랜잭션 상태 추적

---

## **프로젝트 적용 결과**

### **성공 사례**
- CSPIN 입금 기능 정상화 (useRpc hook 규칙 준수)
- 제톤 전송 페이로드 빌드 성공
- 빌드 오류 해결 (라이브러리 import 수정)

### **개선된 기능**
- TON Connect 기반 지갑 연동
- CSPIN 토큰 실제 전송 구현
- 트랜잭션 검증 및 오류 처리 강화

### **남은 과제**
- 실제 배포 환경에서 입금/인출 테스트
- 추가 TON 기능 확장 (예: 잔액 조회 자동화)
- RPC rate limit 처리 및 백엔드 API 활용

---

## **Troubleshooting 가이드**

### **RPC Rate Limit (429 오류)**
- **증상**: "Failed to get jetton wallet address" 또는 429 Too Many Requests
- **원인**: 프론트엔드에서 직접 RPC 호출 시 rate limit 초과
- **해결**: 백엔드 API를 통해 RPC 호출 (예: `/api/get-jetton-wallet`)
- **코드 예시**:
  ```typescript
  // 백엔드 API 호출
  const walletResp = await fetch('/api/get-jetton-wallet', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      tokenAddress: CSPIN_TOKEN_ADDRESS,
      userAddress: connectedWallet.account.address
    })
  });
  ```

### **Transaction Verification Failed**
- **증상**: 지갑에서 트랜잭션 검증 실패
- **원인**: 페이로드 구조 불완전 (custom_payload, forward_payload 누락)
- **해결**: TEP-74 표준 준수, forward_payload를 `storeBit(1)`로 설정

### **제톤 지갑 주소 파생 실패**
- **증상**: 주소 계산 불가
- **원인**: ton-core API 변경 또는 네트워크 문제
- **해결**: 백엔드에서 RPC `runGetMethod` 사용

### **빌드 오류 (라이브러리 호환성)**
- **증상**: @ton/ton import 실패
- **해결**: @ton/core로 변경, 버전 확인

---

## **결론 및 추천**

클론된 GitHub 레포를 통한 학습은 TON 블록체인 통합의 핵심 기반이 되었다. PoC 구현을 통해 이론적 지식을 실제 코드로 변환할 수 있었으며, 이는 프로젝트의 성공적인 MVP 구축에 기여하였다.

**향후 추천:**
- TON 개발자 커뮤니티 (TON Dev Chat) 적극 참여
- 최신 TEP 문서 및 SDK 업데이트 지속 모니터링
- 추가 제톤 관련 기능 (스테이킹, 스왑 등) 학습 고려

---

*이 보고서는 PoC 폴더의 학습 자료를 기반으로 작성되었으며, 실제 프로젝트 적용 사례를 포함합니다.*