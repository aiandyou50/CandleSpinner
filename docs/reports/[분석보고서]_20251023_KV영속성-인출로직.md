# 🔍 KV 영속성 + 인출 로직 상세 분석 보고서

**작성일:** 2025-10-23  
**버전:** v2.5.1  
**상태:** 필수 개선 조치 50% 완료

---

## 📋 목차

1. [아키텍처 구조](#1-아키텍처-구조)
2. [테스트 결과 분석](#2-테스트-결과-분석)
3. [문제 원인 분석](#3-문제-원인-분석)
4. [용어 정리](#4-용어-정리)
5. [구현 상태](#5-구현-상태)
6. [다음 단계](#6-다음-단계)

---

## 1. 아키텍처 구조

### 1-1. SPA (Single Page Application) vs MPA (Multi Page Application)

**현재 구조: SPA**

```
┌────────────────────────────────────────────┐
│  app.tsx                                    │
│  (appMode 상태로 UI 전환)                   │
└────────────────────────────────────────────┘
         ↓
   URL: /  (변경 안 됨)
         ↓
    React 컴포넌트만 렌더링
    game → deposit → game (서버 요청 없음)
```

**SPA의 장점:**
- ✅ 매우 빠름 (컴포넌트만 변경)
- ✅ 상태 유지 용이 (메모리에 크레딧, 베팅액 유지)
- ✅ Telegram Mini App 호환성
- ✅ 번들 크기 작음

**SPA의 단점:**
- ❌ 브라우저 뒤로가기 작동 안 함
- ❌ URL이 변경되지 않음
- ❌ 새로고침 시 상태 손실

### 1-2. 현재 페이지 네비게이션 흐름

```
사용자 "입금" 버튼 클릭
         ↓
setAppMode('deposit')
         ↓
GameComplete 언마운트 ← ⚠️ 문제!
         ↓
Deposit 마운트
         ↓
입금 완료 후 "뒤로가기"
         ↓
setAppMode('game')
         ↓
GameComplete 다시 마운트
↓
useGameState() 새로 초기화 ← ⚠️ 상태 손실!
↓
useEffect 트리거
↓
GET /api/get-credit
↓
KV에서 크레딧 1150 로드 ← 스핀 상금 없음!
```

### 1-3. 개선안: History API 사용

```typescript
// App.tsx
useEffect(() => {
  window.history.pushState({ appMode }, '', appMode === 'game' ? '/' : `/${appMode}`);
}, [appMode]);

window.addEventListener('popstate', (e) => {
  if (e.state?.appMode) setAppMode(e.state.appMode);
});
```

결과: 브라우저 뒤로/앞으로 버튼 정상 작동 가능

---

## 2. 테스트 결과 분석

### 2-1. 테스트 항목별 결과

| # | 항목 | 예상 | 실제 | 상태 | 원인 |
|----|------|------|------|------|------|
| 1 | KV 크레딧 로드 | 1150 | 1150 | ✅ | 정상 |
| 2 | 스핀 승리 | +100 | +100 | ✅ | 정상 |
| 3 | 페이지 이동 후 복귀 | 1250 | 1150 | ❌ | **상태 초기화** |
| 4 | 인출 실행 | CSPIN 전송 | ❌ | ❌ | **환경변수? API?** |

### 2-2. 문제 3: 페이지 이동 후 크레딧 리셋

**시나리오:**
```
1. KV에서 로드: credit = 1000
2. 스핀 1회 승리: credit = 1000 + 100 = 1100 (메모리만)
3. "입금" 버튼 → GameComplete 언마운트
4. "뒤로가기" → GameComplete 다시 마운트
5. useGameState 새로 초기화 → GET /api/get-credit
6. KV에서 크레딧 로드: 1000 (스핀 상금 손실!)
```

**근본 원인:**
- ❌ endSpin()에서 **KV에 저장하지 않음**
- ✅ **해결책 적용:** saveGameState() 추가 (commit e572033)

### 2-3. 문제 4: 인출 미작동

**가능한 원인:**

| 순번 | 원인 | 확인 방법 |
|------|------|---------|
| 1 | 환경변수 누락 | GET /api/debug-withdrawal 호출 |
| 2 | TonAPI 오류 | Cloudflare 로그 확인 |
| 3 | 지갑 설정 오류 | wrangler.toml 검증 |
| 4 | 게임 지갑 주소 형식 오류 | Bot 에러 메시지 |

---

## 3. 문제 원인 분석

### 3-1. 문제 3 해결 (커밋 e572033)

✅ **구현 완료:**

```typescript
// 1. 새로운 API: /api/save-game-state
POST /api/save-game-state
{
  walletAddress: "UQ...",
  credit: 1100,
  canDoubleUp: false,
  pendingWinnings: 0
}

// 2. useGameState에 saveGameState() 메서드 추가
const saveGameState = useCallback(async (overrideCredit?: number) => {
  const response = await fetch('/api/save-game-state', {
    method: 'POST',
    body: JSON.stringify({
      walletAddress: wallet.account.address,
      credit: overrideCredit || userCredit
    })
  });
  // ...
}, [...]);

// 3. GameComplete에서 "계속 게임" 버튼 클릭 시 호출
onClick={async () => {
  await saveGameState(); // ← 크레딧을 KV에 저장
  setCurrentScreen('main');
}}
```

**예상 결과:**
```
1. 스핀 승리: credit = 1100 (메모리)
2. "계속 게임" 클릭
3. saveGameState() → POST /api/save-game-state
4. KV 업데이트: state:${address} = {credit: 1100}
5. 페이지 이동 후 복귀
6. GET /api/get-credit → KV에서 1100 로드 ✅
```

### 3-2. 문제 4 진단 (필요한 검증)

❓ **인출 미작동 원인 필요한 확인:**

**Step 1: 환경변수 확인**
```bash
# Wrangler 로그에서 다음 확인
GET https://candlespinner.com/api/debug-withdrawal
→ GAME_WALLET_ADDRESS, CSPIN_TOKEN_ADDRESS 확인
```

**Step 2: initiate-withdrawal.ts 로그 확인**
```
Cloudflare Worker 로그:
[인출] 요청: 0:ac0491... → 100 CSPIN
[인출] 현재 크레딧: 1150
[인출] 게임 지갑: EQA...
[인출] 게임 Jetton 지갑: EQB...
[인출] 트랜잭션 발송 성공: TXhash...
```

**Step 3: 실제 트랜잭션 확인**
```
tonscope.com에서 TXhash 검색
→ 트랜잭션이 블록체인에 기록되었는가?
→ 상태: success / failed?
```

**Step 4: 지갑 주소 형식 검증**
```
게임 지갑: UQ... (User Friendly)
실제 계산: EQ... (Raw)
Jetton 지갑: EQ...

모두 올바른가?
```

---

## 4. 용어 정리

### 4-1. 웹 아키텍처 용어

| 용어 | 정의 | 현재 프로젝트 |
|------|------|----------|
| **SPA** | 하나의 HTML 페이지에서 JS로 모든 콘텐츠 변경 | ✅ 현재 구조 |
| **MPA** | 각 페이지가 별도 HTML (서버에서 로드) | ❌ 아님 |
| **클라이언트 사이드 렌더링 (CSR)** | 브라우저에서 JS로 HTML 생성 | ✅ 현재 사용 |
| **서버 사이드 렌더링 (SSR)** | 서버에서 HTML 생성 후 전송 | ❌ 아님 |
| **라우팅** | URL 경로에 따라 컴포넌트 선택 | ✅ 수동 구현 |
| **History API** | 브라우저 뒤로/앞으로 버튼 제어 | ❌ 미구현 |
| **페이지 로드** | 서버에서 새 HTML 수신 (새로고침) | ❌ 현재 안 함 |
| **클라이언트 네비게이션** | 서버 요청 없이 JS로 페이지 변경 | ✅ 현재 사용 |

### 4-2. KV 용어

| 용어 | 정의 | 사용 예 |
|------|------|---------|
| **KV (Key-Value)** | 서버 데이터베이스 (키로 값 저장) | `state:0:abc123` → `{credit: 1150}` |
| **TTL (Time-To-Live)** | 데이터 자동 삭제 시간 | 트랜잭션 로그 7일 후 자동 삭제 |
| **영속성** | 새로고침 후에도 데이터 유지 | 크레딧, 게임 기록 저장 |
| **동기화** | 여러 위치의 데이터 일관성 유지 | 메모리 ↔ KV 동기화 |

---

## 5. 구현 상태

### 5-1. 필수 개선 조치 (우선순위)

| # | 조치 | 상태 | 커밋 | 영향 |
|----|------|------|------|------|
| 1 | ✅ 스핀 결과 KV 저장 | **완료** | e572033 | 크레딧 손실 문제 해결 |
| 2 | ⏳ 인출 로직 진단 | **진행 중** | - | 인출 미작동 원인 파악 |
| 3 | ⏳ History API 추가 | **미작업** | - | 브라우저 뒤로가기 정상 작동 |
| 4 | ⏳ localStorage → 직접 콜백 | **미작업** | - | 입금 시 상태 즉시 반영 |

### 5-2. 파일 변경 사항

```
✅ 새 파일 생성:
- functions/api/save-game-state.ts (크레딧 저장 API)
- functions/api/debug-withdrawal.ts (진단 API)

✅ 수정된 파일:
- src/hooks/useGameState.ts (saveGameState 메서드 추가)
- src/components/GameComplete.tsx (saveGameState 호출)

⏳ 미적용:
- src/App.tsx (History API 아직 미적용)
- functions/api/deposit.ts (seqno 아직 미적용)
```

---

## 6. 다음 단계

### 6-1. 즉시 조치 (지금)

**Step 1: 인출 로직 진단**
```bash
# 1. debug-withdrawal 호출
GET https://candlespinner.com/api/debug-withdrawal

# 2. 결과 분석
- 환경변수 모두 있는가?
- privateKeyLength > 0?
- gameWalletAddress 유효?
- cspinTokenAddress 유효?
```

**Step 2: 스핀 결과 KV 저장 테스트**
```
1. 스핀 → 승리 (credit: 1250)
2. "계속 게임" 버튼 클릭
3. Cloudflare 로그 확인
   → [save-game-state] ✅ 저장 성공
4. 입금 페이지 이동 후 뒤로
5. UI 크레딧: 1250 유지? ✅
```

### 6-2. 권장 조치 (다음 세션)

**1. History API 추가**
```typescript
// App.tsx
useEffect(() => {
  window.history.pushState({ appMode }, '', appMode === 'game' ? '/' : `/${appMode}`);
}, [appMode]);

window.addEventListener('popstate', (e) => {
  setAppMode(e.state?.appMode || 'game');
});
```

**2. localStorage → 직접 콜백 변경**
```typescript
// App.tsx
const handleDepositSuccess = (amount: number) => {
  // localStorage 이벤트 대신 직접 호출
  setAppMode('game');
  // GameComplete에서 자동으로 refreshCreditFromKV
};
```

**3. deposit.ts에 seqno 원자성 추가**
```typescript
// functions/api/deposit.ts에 seqno 로직 추가
const seqnoKey = `seqno:${walletAddress}`;
const currentSeqno = parseInt(await env.CREDIT_KV.get(seqnoKey) || '0');
const newSeqno = currentSeqno + 1;
// ...
await env.CREDIT_KV.put(seqnoKey, newSeqno.toString());
```

### 6-3. 빌드 & 배포

```bash
npm run build
git add -A
git commit -m "..."
git push origin main
# Cloudflare Pages 자동 배포
```

---

## 📊 진행도

```
Phase 1: 아키텍처 분석        ✅ 완료 (2/2)
  - SPA 구조 설명            ✅
  - 용어 정리                ✅

Phase 2: 필수 개선            🔄 50% 완료 (1/2)
  - 스핀 결과 KV 저장         ✅ (commit e572033)
  - 인출 로직 진단            ⏳ 필요

Phase 3: 권장 개선            ⏳ 미작업 (0/3)
  - History API              ⏳
  - localStorage 개선         ⏳
  - seqno 원자성              ⏳
```

---

**다음 확인사항:**
1. `GET /api/debug-withdrawal` 결과 공유
2. 스핀 결과 KV 저장 테스트 결과 공유
3. 인출 실패 이유 파악

