***REMOVED***ğŸ” KV ì˜ì†ì„± + ì¸ì¶œ ë¡œì§ ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ

**ì‘ì„±ì¼:** 2025-10-23  
**ë²„ì „:** v2.5.1  
**ìƒíƒœ:** í•„ìˆ˜ ê°œì„  ì¡°ì¹˜ 50% ì™„ë£Œ

---

#***REMOVED***ğŸ“‹ ëª©ì°¨

1. [ì•„í‚¤í…ì²˜ êµ¬ì¡°](#1-ì•„í‚¤í…ì²˜-êµ¬ì¡°)
2. [í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„](#2-í…ŒìŠ¤íŠ¸-ê²°ê³¼-ë¶„ì„)
3. [ë¬¸ì œ ì›ì¸ ë¶„ì„](#3-ë¬¸ì œ-ì›ì¸-ë¶„ì„)
4. [ìš©ì–´ ì •ë¦¬](#4-ìš©ì–´-ì •ë¦¬)
5. [êµ¬í˜„ ìƒíƒœ](#5-êµ¬í˜„-ìƒíƒœ)
6. [ë‹¤ìŒ ë‹¨ê³„](#6-ë‹¤ìŒ-ë‹¨ê³„)

---

#***REMOVED***1. ì•„í‚¤í…ì²˜ êµ¬ì¡°

##***REMOVED***1-1. SPA (Single Page Application) vs MPA (Multi Page Application)

**í˜„ì¬ êµ¬ì¡°: SPA**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app.tsx                                    â”‚
â”‚  (appMode ìƒíƒœë¡œ UI ì „í™˜)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
   URL: /  (ë³€ê²½ ì•ˆ ë¨)
         â†“
    React ì»´í¬ë„ŒíŠ¸ë§Œ ë Œë”ë§
    game â†’ deposit â†’ game (ì„œë²„ ìš”ì²­ ì—†ìŒ)
```

**SPAì˜ ì¥ì :**
- âœ… ë§¤ìš° ë¹ ë¦„ (ì»´í¬ë„ŒíŠ¸ë§Œ ë³€ê²½)
- âœ… ìƒíƒœ ìœ ì§€ ìš©ì´ (ë©”ëª¨ë¦¬ì— í¬ë ˆë”§, ë² íŒ…ì•¡ ìœ ì§€)
- âœ… Telegram Mini App í˜¸í™˜ì„±
- âœ… ë²ˆë“¤ í¬ê¸° ì‘ìŒ

**SPAì˜ ë‹¨ì :**
- âŒ ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ì‘ë™ ì•ˆ í•¨
- âŒ URLì´ ë³€ê²½ë˜ì§€ ì•ŠìŒ
- âŒ ìƒˆë¡œê³ ì¹¨ ì‹œ ìƒíƒœ ì†ì‹¤

##***REMOVED***1-2. í˜„ì¬ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ íë¦„

```
ì‚¬ìš©ì "ì…ê¸ˆ" ë²„íŠ¼ í´ë¦­
         â†“
setAppMode('deposit')
         â†“
GameComplete ì–¸ë§ˆìš´íŠ¸ â† âš ï¸ ë¬¸ì œ!
         â†“
Deposit ë§ˆìš´íŠ¸
         â†“
ì…ê¸ˆ ì™„ë£Œ í›„ "ë’¤ë¡œê°€ê¸°"
         â†“
setAppMode('game')
         â†“
GameComplete ë‹¤ì‹œ ë§ˆìš´íŠ¸
â†“
useGameState() ìƒˆë¡œ ì´ˆê¸°í™” â† âš ï¸ ìƒíƒœ ì†ì‹¤!
â†“
useEffect íŠ¸ë¦¬ê±°
â†“
GET /api/get-credit
â†“
KVì—ì„œ í¬ë ˆë”§ 1150 ë¡œë“œ â† ìŠ¤í•€ ìƒê¸ˆ ì—†ìŒ!
```

##***REMOVED***1-3. ê°œì„ ì•ˆ: History API ì‚¬ìš©

```typescript
// App.tsx
useEffect(() => {
  window.history.pushState({ appMode }, '', appMode === 'game' ? '/' : `/${appMode}`);
}, [appMode]);

window.addEventListener('popstate', (e) => {
  if (e.state?.appMode) setAppMode(e.state.appMode);
});
```

ê²°ê³¼: ë¸Œë¼ìš°ì € ë’¤ë¡œ/ì•ìœ¼ë¡œ ë²„íŠ¼ ì •ìƒ ì‘ë™ ê°€ëŠ¥

---

#***REMOVED***2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„

##***REMOVED***2-1. í…ŒìŠ¤íŠ¸ í•­ëª©ë³„ ê²°ê³¼

| ***REMOVED***| í•­ëª© | ì˜ˆìƒ | ì‹¤ì œ | ìƒíƒœ | ì›ì¸ |
|----|------|------|------|------|------|
| 1 | KV í¬ë ˆë”§ ë¡œë“œ | 1150 | 1150 | âœ… | ì •ìƒ |
| 2 | ìŠ¤í•€ ìŠ¹ë¦¬ | +100 | +100 | âœ… | ì •ìƒ |
| 3 | í˜ì´ì§€ ì´ë™ í›„ ë³µê·€ | 1250 | 1150 | âŒ | **ìƒíƒœ ì´ˆê¸°í™”** |
| 4 | ì¸ì¶œ ì‹¤í–‰ | CSPIN ì „ì†¡ | âŒ | âŒ | **í™˜ê²½ë³€ìˆ˜? API?** |

##***REMOVED***2-2. ë¬¸ì œ 3: í˜ì´ì§€ ì´ë™ í›„ í¬ë ˆë”§ ë¦¬ì…‹

**ì‹œë‚˜ë¦¬ì˜¤:**
```
1. KVì—ì„œ ë¡œë“œ: credit = 1000
2. ìŠ¤í•€ 1íšŒ ìŠ¹ë¦¬: credit = 1000 + 100 = 1100 (ë©”ëª¨ë¦¬ë§Œ)
3. "ì…ê¸ˆ" ë²„íŠ¼ â†’ GameComplete ì–¸ë§ˆìš´íŠ¸
4. "ë’¤ë¡œê°€ê¸°" â†’ GameComplete ë‹¤ì‹œ ë§ˆìš´íŠ¸
5. useGameState ìƒˆë¡œ ì´ˆê¸°í™” â†’ GET /api/get-credit
6. KVì—ì„œ í¬ë ˆë”§ ë¡œë“œ: 1000 (ìŠ¤í•€ ìƒê¸ˆ ì†ì‹¤!)
```

**ê·¼ë³¸ ì›ì¸:**
- âŒ endSpin()ì—ì„œ **KVì— ì €ì¥í•˜ì§€ ì•ŠìŒ**
- âœ… **í•´ê²°ì±… ì ìš©:** saveGameState() ì¶”ê°€ (commit e572033)

##***REMOVED***2-3. ë¬¸ì œ 4: ì¸ì¶œ ë¯¸ì‘ë™

**ê°€ëŠ¥í•œ ì›ì¸:**

| ìˆœë²ˆ | ì›ì¸ | í™•ì¸ ë°©ë²• |
|------|------|---------|
| 1 | í™˜ê²½ë³€ìˆ˜ ëˆ„ë½ | GET /api/debug-withdrawal í˜¸ì¶œ |
| 2 | TonAPI ì˜¤ë¥˜ | Cloudflare ë¡œê·¸ í™•ì¸ |
| 3 | ì§€ê°‘ ì„¤ì • ì˜¤ë¥˜ | wrangler.toml ê²€ì¦ |
| 4 | ê²Œì„ ì§€ê°‘ ì£¼ì†Œ í˜•ì‹ ì˜¤ë¥˜ | Bot ì—ëŸ¬ ë©”ì‹œì§€ |

---

#***REMOVED***3. ë¬¸ì œ ì›ì¸ ë¶„ì„

##***REMOVED***3-1. ë¬¸ì œ 3 í•´ê²° (ì»¤ë°‹ e572033)

âœ… **êµ¬í˜„ ì™„ë£Œ:**

```typescript
// 1. ìƒˆë¡œìš´ API: /api/save-game-state
POST /api/save-game-state
{
  walletAddress: "UQ...",
  credit: 1100,
  canDoubleUp: false,
  pendingWinnings: 0
}

// 2. useGameStateì— saveGameState() ë©”ì„œë“œ ì¶”ê°€
const saveGameState = useCallback(async (overrideCredit?: number) => {
  const response = await fetch('/api/save-game-state', {
    method: 'POST',
    body: JSON.stringify({
      walletAddress: wallet.account.address,
      credit: overrideCredit || userCredit
    })
  });
  // ...
}, [...]);

// 3. GameCompleteì—ì„œ "ê³„ì† ê²Œì„" ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
onClick={async () => {
  await saveGameState(); // â† í¬ë ˆë”§ì„ KVì— ì €ì¥
  setCurrentScreen('main');
}}
```

**ì˜ˆìƒ ê²°ê³¼:**
```
1. ìŠ¤í•€ ìŠ¹ë¦¬: credit = 1100 (ë©”ëª¨ë¦¬)
2. "ê³„ì† ê²Œì„" í´ë¦­
3. saveGameState() â†’ POST /api/save-game-state
4. KV ì—…ë°ì´íŠ¸: state:${address} = {credit: 1100}
5. í˜ì´ì§€ ì´ë™ í›„ ë³µê·€
6. GET /api/get-credit â†’ KVì—ì„œ 1100 ë¡œë“œ âœ…
```

##***REMOVED***3-2. ë¬¸ì œ 4 ì§„ë‹¨ (í•„ìš”í•œ ê²€ì¦)

â“ **ì¸ì¶œ ë¯¸ì‘ë™ ì›ì¸ í•„ìš”í•œ í™•ì¸:**

**Step 1: í™˜ê²½ë³€ìˆ˜ í™•ì¸**
```bash
***REMOVED***Wrangler ë¡œê·¸ì—ì„œ ë‹¤ìŒ í™•ì¸
GET https://candlespinner.com/api/debug-withdrawal
â†’ GAME_WALLET_ADDRESS, CSPIN_TOKEN_ADDRESS í™•ì¸
```

**Step 2: initiate-withdrawal.ts ë¡œê·¸ í™•ì¸**
```
Cloudflare Worker ë¡œê·¸:
[ì¸ì¶œ] ìš”ì²­: 0:ac0491... â†’ 100 CSPIN
[ì¸ì¶œ] í˜„ì¬ í¬ë ˆë”§: 1150
[ì¸ì¶œ] ê²Œì„ ì§€ê°‘: EQA...
[ì¸ì¶œ] ê²Œì„ Jetton ì§€ê°‘: EQB...
[ì¸ì¶œ] íŠ¸ëœì­ì…˜ ë°œì†¡ ì„±ê³µ: TXhash...
```

**Step 3: ì‹¤ì œ íŠ¸ëœì­ì…˜ í™•ì¸**
```
tonscope.comì—ì„œ TXhash ê²€ìƒ‰
â†’ íŠ¸ëœì­ì…˜ì´ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡ë˜ì—ˆëŠ”ê°€?
â†’ ìƒíƒœ: success / failed?
```

**Step 4: ì§€ê°‘ ì£¼ì†Œ í˜•ì‹ ê²€ì¦**
```
ê²Œì„ ì§€ê°‘: UQ... (User Friendly)
ì‹¤ì œ ê³„ì‚°: EQ... (Raw)
Jetton ì§€ê°‘: EQ...

ëª¨ë‘ ì˜¬ë°”ë¥¸ê°€?
```

---

#***REMOVED***4. ìš©ì–´ ì •ë¦¬

##***REMOVED***4-1. ì›¹ ì•„í‚¤í…ì²˜ ìš©ì–´

| ìš©ì–´ | ì •ì˜ | í˜„ì¬ í”„ë¡œì íŠ¸ |
|------|------|----------|
| **SPA** | í•˜ë‚˜ì˜ HTML í˜ì´ì§€ì—ì„œ JSë¡œ ëª¨ë“  ì½˜í…ì¸  ë³€ê²½ | âœ… í˜„ì¬ êµ¬ì¡° |
| **MPA** | ê° í˜ì´ì§€ê°€ ë³„ë„ HTML (ì„œë²„ì—ì„œ ë¡œë“œ) | âŒ ì•„ë‹˜ |
| **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë Œë”ë§ (CSR)** | ë¸Œë¼ìš°ì €ì—ì„œ JSë¡œ HTML ìƒì„± | âœ… í˜„ì¬ ì‚¬ìš© |
| **ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ (SSR)** | ì„œë²„ì—ì„œ HTML ìƒì„± í›„ ì „ì†¡ | âŒ ì•„ë‹˜ |
| **ë¼ìš°íŒ…** | URL ê²½ë¡œì— ë”°ë¼ ì»´í¬ë„ŒíŠ¸ ì„ íƒ | âœ… ìˆ˜ë™ êµ¬í˜„ |
| **History API** | ë¸Œë¼ìš°ì € ë’¤ë¡œ/ì•ìœ¼ë¡œ ë²„íŠ¼ ì œì–´ | âŒ ë¯¸êµ¬í˜„ |
| **í˜ì´ì§€ ë¡œë“œ** | ì„œë²„ì—ì„œ ìƒˆ HTML ìˆ˜ì‹  (ìƒˆë¡œê³ ì¹¨) | âŒ í˜„ì¬ ì•ˆ í•¨ |
| **í´ë¼ì´ì–¸íŠ¸ ë„¤ë¹„ê²Œì´ì…˜** | ì„œë²„ ìš”ì²­ ì—†ì´ JSë¡œ í˜ì´ì§€ ë³€ê²½ | âœ… í˜„ì¬ ì‚¬ìš© |

##***REMOVED***4-2. KV ìš©ì–´

| ìš©ì–´ | ì •ì˜ | ì‚¬ìš© ì˜ˆ |
|------|------|---------|
| **KV (Key-Value)** | ì„œë²„ ë°ì´í„°ë² ì´ìŠ¤ (í‚¤ë¡œ ê°’ ì €ì¥) | `state:0:abc123` â†’ `{credit: 1150}` |
| **TTL (Time-To-Live)** | ë°ì´í„° ìë™ ì‚­ì œ ì‹œê°„ | íŠ¸ëœì­ì…˜ ë¡œê·¸ 7ì¼ í›„ ìë™ ì‚­ì œ |
| **ì˜ì†ì„±** | ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ë°ì´í„° ìœ ì§€ | í¬ë ˆë”§, ê²Œì„ ê¸°ë¡ ì €ì¥ |
| **ë™ê¸°í™”** | ì—¬ëŸ¬ ìœ„ì¹˜ì˜ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€ | ë©”ëª¨ë¦¬ â†” KV ë™ê¸°í™” |

---

#***REMOVED***5. êµ¬í˜„ ìƒíƒœ

##***REMOVED***5-1. í•„ìˆ˜ ê°œì„  ì¡°ì¹˜ (ìš°ì„ ìˆœìœ„)

| ***REMOVED***| ì¡°ì¹˜ | ìƒíƒœ | ì»¤ë°‹ | ì˜í–¥ |
|----|------|------|------|------|
| 1 | âœ… ìŠ¤í•€ ê²°ê³¼ KV ì €ì¥ | **ì™„ë£Œ** | e572033 | í¬ë ˆë”§ ì†ì‹¤ ë¬¸ì œ í•´ê²° |
| 2 | â³ ì¸ì¶œ ë¡œì§ ì§„ë‹¨ | **ì§„í–‰ ì¤‘** | - | ì¸ì¶œ ë¯¸ì‘ë™ ì›ì¸ íŒŒì•… |
| 3 | â³ History API ì¶”ê°€ | **ë¯¸ì‘ì—…** | - | ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ì •ìƒ ì‘ë™ |
| 4 | â³ localStorage â†’ ì§ì ‘ ì½œë°± | **ë¯¸ì‘ì—…** | - | ì…ê¸ˆ ì‹œ ìƒíƒœ ì¦‰ì‹œ ë°˜ì˜ |

##***REMOVED***5-2. íŒŒì¼ ë³€ê²½ ì‚¬í•­

```
âœ… ìƒˆ íŒŒì¼ ìƒì„±:
- functions/api/save-game-state.ts (í¬ë ˆë”§ ì €ì¥ API)
- functions/api/debug-withdrawal.ts (ì§„ë‹¨ API)

âœ… ìˆ˜ì •ëœ íŒŒì¼:
- src/hooks/useGameState.ts (saveGameState ë©”ì„œë“œ ì¶”ê°€)
- src/components/GameComplete.tsx (saveGameState í˜¸ì¶œ)

â³ ë¯¸ì ìš©:
- src/App.tsx (History API ì•„ì§ ë¯¸ì ìš©)
- functions/api/deposit.ts (seqno ì•„ì§ ë¯¸ì ìš©)
```

---

#***REMOVED***6. ë‹¤ìŒ ë‹¨ê³„

##***REMOVED***6-1. ì¦‰ì‹œ ì¡°ì¹˜ (ì§€ê¸ˆ)

**Step 1: ì¸ì¶œ ë¡œì§ ì§„ë‹¨**
```bash
***REMOVED***1. debug-withdrawal í˜¸ì¶œ
GET https://candlespinner.com/api/debug-withdrawal

***REMOVED***2. ê²°ê³¼ ë¶„ì„
- í™˜ê²½ë³€ìˆ˜ ëª¨ë‘ ìˆëŠ”ê°€?
- privateKeyLength > 0?
- gameWalletAddress ìœ íš¨?
- cspinTokenAddress ìœ íš¨?
```

**Step 2: ìŠ¤í•€ ê²°ê³¼ KV ì €ì¥ í…ŒìŠ¤íŠ¸**
```
1. ìŠ¤í•€ â†’ ìŠ¹ë¦¬ (credit: 1250)
2. "ê³„ì† ê²Œì„" ë²„íŠ¼ í´ë¦­
3. Cloudflare ë¡œê·¸ í™•ì¸
   â†’ [save-game-state] âœ… ì €ì¥ ì„±ê³µ
4. ì…ê¸ˆ í˜ì´ì§€ ì´ë™ í›„ ë’¤ë¡œ
5. UI í¬ë ˆë”§: 1250 ìœ ì§€? âœ…
```

##***REMOVED***6-2. ê¶Œì¥ ì¡°ì¹˜ (ë‹¤ìŒ ì„¸ì…˜)

**1. History API ì¶”ê°€**
```typescript
// App.tsx
useEffect(() => {
  window.history.pushState({ appMode }, '', appMode === 'game' ? '/' : `/${appMode}`);
}, [appMode]);

window.addEventListener('popstate', (e) => {
  setAppMode(e.state?.appMode || 'game');
});
```

**2. localStorage â†’ ì§ì ‘ ì½œë°± ë³€ê²½**
```typescript
// App.tsx
const handleDepositSuccess = (amount: number) => {
  // localStorage ì´ë²¤íŠ¸ ëŒ€ì‹  ì§ì ‘ í˜¸ì¶œ
  setAppMode('game');
  // GameCompleteì—ì„œ ìë™ìœ¼ë¡œ refreshCreditFromKV
};
```

**3. deposit.tsì— seqno ì›ìì„± ì¶”ê°€**
```typescript
// functions/api/deposit.tsì— seqno ë¡œì§ ì¶”ê°€
const seqnoKey = `seqno:${walletAddress}`;
const currentSeqno = parseInt(await env.CREDIT_KV.get(seqnoKey) || '0');
const newSeqno = currentSeqno + 1;
// ...
await env.CREDIT_KV.put(seqnoKey, newSeqno.toString());
```

##***REMOVED***6-3. ë¹Œë“œ & ë°°í¬

```bash
npm run build
git add -A
git commit -m "..."
git push origin main
***REMOVED***Cloudflare Pages ìë™ ë°°í¬
```

---

#***REMOVED***ğŸ“Š ì§„í–‰ë„

```
Phase 1: ì•„í‚¤í…ì²˜ ë¶„ì„        âœ… ì™„ë£Œ (2/2)
  - SPA êµ¬ì¡° ì„¤ëª…            âœ…
  - ìš©ì–´ ì •ë¦¬                âœ…

Phase 2: í•„ìˆ˜ ê°œì„             ğŸ”„ 50% ì™„ë£Œ (1/2)
  - ìŠ¤í•€ ê²°ê³¼ KV ì €ì¥         âœ… (commit e572033)
  - ì¸ì¶œ ë¡œì§ ì§„ë‹¨            â³ í•„ìš”

Phase 3: ê¶Œì¥ ê°œì„             â³ ë¯¸ì‘ì—… (0/3)
  - History API              â³
  - localStorage ê°œì„          â³
  - seqno ì›ìì„±              â³
```

---

**ë‹¤ìŒ í™•ì¸ì‚¬í•­:**
1. `GET /api/debug-withdrawal` ê²°ê³¼ ê³µìœ 
2. ìŠ¤í•€ ê²°ê³¼ KV ì €ì¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê³µìœ 
3. ì¸ì¶œ ì‹¤íŒ¨ ì´ìœ  íŒŒì•…

