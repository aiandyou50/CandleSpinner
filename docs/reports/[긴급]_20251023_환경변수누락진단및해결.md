# ğŸš¨ ê¸´ê¸‰: ì¸ì¶œ 500 ì˜¤ë¥˜ ê·¼ë³¸ ì›ì¸ ë° í•´ê²°ì±…

**ì§„ë‹¨ ì¼ì‹œ:** 2025-10-23 12:33:34 UTC  
**ì‹¬ê°ë„:** ğŸ”´ Critical (ì¸ì¶œ ê¸°ëŠ¥ ì™„ì „ ë¯¸ì‘ë™)  
**ìƒíƒœ:** í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ í•„ìš”

---

## ğŸ“Š ì§„ë‹¨ ê²°ê³¼

### debug-withdrawal API ì‘ë‹µ ë¶„ì„

```json
{
  "environment": {
    "hasPrivateKey": true,          âœ… ì¡´ì¬
    "privateKeyLength": 128,        âœ… ì •ìƒ
    "gameWalletAddress": "ì—†ìŒ",    âŒ ëˆ„ë½!
    "cspinTokenAddress": "ì—†ìŒ"     âŒ ëˆ„ë½!
  },
  "status": {
    "privateKeyValid": true,        âœ…
    "gameWalletValid": false,       âŒ ë•Œë¬¸ì— ì‹¤íŒ¨
    "cspinTokenValid": false        âŒ ë•Œë¬¸ì— ì‹¤íŒ¨
  }
}
```

### ì›ì¸ íŒŒì•…

**initiate-withdrawal.ts 184-191 ì¤„:**
```typescript
if (!gameWalletPrivateKey || !gameWalletAddress || !cspinTokenAddress) {
  console.error('[ì¸ì¶œ] í™˜ê²½ë³€ìˆ˜ ëˆ„ë½:', { ... });
  return new Response(
    JSON.stringify({
      success: false,
      error: 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜'
    }),
    { status: 500, headers: { 'Content-Type': 'application/json' } }
  );
}
```

â†’ **ë¬¸ì œ:** `gameWalletAddress`ì™€ `cspinTokenAddress`ê°€ `undefined`ì´ë¯€ë¡œ 500 ë°˜í™˜

---

## âœ… í•´ê²°ì±…

### Step 1: wrangler.toml ìˆ˜ì • (ì™„ë£Œ)

**ìˆ˜ì • ë‚´ìš©:**
```toml
[vars]
BACKEND_RPC_URL = "https://rpc.ankr.com/ton_api_v2/${TON_RPC_API_KEY}"
TON_RPC_HTTPS_ENDPOINT = "https://rpc.ankr.com/ton_api_v2/${TON_RPC_API_KEY}"
NETWORK_FEE_TON = "0.03"
GAME_WALLET_ADDRESS = "${GAME_WALLET_ADDRESS}"        â† ì¶”ê°€ë¨
CSPIN_TOKEN_ADDRESS = "${CSPIN_TOKEN_ADDRESS}"        â† ì¶”ê°€ë¨

[env.production.vars]
...ë™ì¼...
GAME_WALLET_ADDRESS = "${GAME_WALLET_ADDRESS}"        â† ì¶”ê°€ë¨
CSPIN_TOKEN_ADDRESS = "${CSPIN_TOKEN_ADDRESS}"        â† ì¶”ê°€ë¨
```

**ì˜ë¯¸:** 
- ë¡œì»¬/í”„ë¡œë•ì…˜ ëª¨ë‘ì—ì„œ í™˜ê²½ë³€ìˆ˜ë¡œë¶€í„° ê°’ì„ ë°›ìŒ
- `${VARIABLE_NAME}` ë¬¸ë²•ìœ¼ë¡œ Cloudflare Secrets/Variablesì—ì„œ ì½ìŒ

### Step 2: Cloudflare ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì œ ê°’ ì„¤ì •

**í•„ìˆ˜ ì •ë³´ (ì‚¬ìš©ìê°€ ì œê³µí•´ì•¼ í•¨):**

1. **GAME_WALLET_ADDRESS**
   - ê²Œì„ ì„œë²„ ì§€ê°‘ ì£¼ì†Œ (TON)
   - í˜•ì‹: `0:abc123...` ë˜ëŠ” `UQA...`
   - ì–´ë””ì„œ ì–»ìŒ: ê²Œì„ ì§€ê°‘ ìƒì„± ì‹œ ì €ì¥í•œ ì£¼ì†Œ

2. **CSPIN_TOKEN_ADDRESS**
   - CSPIN í† í° ë§ˆìŠ¤í„° ì£¼ì†Œ (Jetton Master Contract)
   - í˜•ì‹: `0:def456...` ë˜ëŠ” `EQB...`
   - ì–´ë””ì„œ ì–»ìŒ: í† í° ë°°í¬ ì‹œ ì €ì¥í•œ ì£¼ì†Œ

### Step 3: Cloudflare Pages ì„¤ì •

**ê²½ë¡œ:**
```
1. https://dash.cloudflare.com ì ‘ì†
2. Workers & Pages â†’ CandleSpinner ì„ íƒ
3. Settings â†’ Environment Variables
4. Production íƒ­ì—ì„œ:
   - GAME_WALLET_ADDRESS = [ì‹¤ì œ ê²Œì„ ì§€ê°‘ ì£¼ì†Œ]
   - CSPIN_TOKEN_ADDRESS = [ì‹¤ì œ í† í° ë§ˆìŠ¤í„° ì£¼ì†Œ]
   ì €ì¥
```

**ë˜ëŠ” CLIë¡œ:**
```bash
# wrangler secret set (í”„ë¡œë•ì…˜ ë°°í¬)
wrangler secret:bulk --env production << EOF
GAME_WALLET_ADDRESS=[ì‹¤ì œì£¼ì†Œ]
CSPIN_TOKEN_ADDRESS=[ì‹¤ì œì£¼ì†Œ]
EOF
```

---

## ğŸ¯ ë¬¸ì œ 2: í¬ë ˆë”§ 1150 ì´ˆê¸°í™”

### ì¦ìƒ

```
ìŠ¤í•€ ìŠ¹ë¦¬ (í¬ë ˆë”§ ì¦ê°€) â†’ ìƒê¸ˆ ìˆ˜ë ¹ â†’ ì…ê¸ˆ í˜ì´ì§€ ì´ë™ 
â†’ ë’¤ë¡œê°€ê¸° â†’ ë©”ì¸ í˜ì´ì§€ ë¡œë”© â†’ í¬ë ˆë”§ 1150 ì´ˆê¸°í™”
```

### ì›ì¸ ë¶„ì„

**ê°€ì„¤ 1: ë’¤ë¡œê°€ê¸° ì‹œ localStorage ì´ˆê¸°ê°’ ë¡œë“œ**
```javascript
// App.tsxì—ì„œ ì§€ê°‘ ì—°ê²° ì‹œ
useEffect(() => {
  if (isConnected) {
    // localStorageì—ì„œ ì´ˆê¸°ê°’ì„ ì½ëŠ”ë°, 
    // í™”ë©´ ì „í™˜ ì¤‘ì— saveGameStateê°€ í˜¸ì¶œë˜ì§€ ì•Šì•˜ë‹¤ë©´?
    // â†’ KVì— ë¯¸ì €ì¥ ìƒíƒœë¡œ ë’¤ë¡œê°€ê¸°
    // â†’ GET /api/get-credit â†’ KVì—ëŠ” ì´ì „ ê°’ (1150)
    // â†’ UI í¬ë ˆë”§ 1150 í‘œì‹œ
  }
}, [isConnected]);
```

**ê°€ì„¤ 2: useEffect íƒ€ì´ë° ë¬¸ì œ**
```typescript
// GameComplete.tsxì—ì„œ (í˜„ì¬ ì½”ë“œ)
useEffect(() => {
  if (currentScreen !== 'main') {
    setTimeout(() => {
      saveGameState();
    }, 100);
  }
}, [currentScreen, userCredit, saveGameState]);
```

â†’ 100ms ë”œë ˆì´ ë™ì•ˆ ë’¤ë¡œê°€ê¸° ëˆ„ë¥´ë©´ ì €ì¥ ì „ì— í™”ë©´ ì „í™˜ ê°€ëŠ¥

### í•´ê²°ì±…

**ë°©ë²• A: useEffect ì˜ì¡´ì„± ê°œì„ ** (ì¦‰ì‹œ)

```typescript
// GameComplete.tsx
useEffect(() => {
  // currentScreen ë³€ê²½ ì§í›„ ì¦‰ì‹œ ì €ì¥
  const saveImmediately = async () => {
    console.log('[GameComplete] ğŸ’¾ í™”ë©´ ì „í™˜ ê°ì§€, ì¦‰ì‹œ ì €ì¥:', currentScreen, userCredit);
    await saveGameState();
  };

  if (currentScreen !== 'main') {
    saveImmediately();
  }
}, [currentScreen]); // userCredit ì œì™¸ - userCredit ë³€ê²½ì´ ì•„ë‹Œ currentScreen ë³€ê²½ë§Œ ê°ì§€

// ë˜ëŠ” ë³„ë„ useEffectë¡œ í¬ë ˆë”§ ë³€ê²½ë„ ê°ì§€
useEffect(() => {
  if (currentScreen !== 'main' && userCredit > 0) {
    console.log('[GameComplete] ğŸ’¾ í¬ë ˆë”§ ë³€ê²½, ì €ì¥:', userCredit);
    const timer = setTimeout(() => {
      saveGameState();
    }, 50); // ë” ì§§ì€ ë”œë ˆì´
    
    return () => clearTimeout(timer);
  }
}, [userCredit, currentScreen]);
```

**ë°©ë²• B: ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸ ì¶”ê°€** (ê¶Œì¥)

```typescript
// GameComplete.tsx ë˜ëŠ” App.tsx
useEffect(() => {
  // í˜ì´ì§€ ì–¸ë¡œë“œ ì§ì „ì— ì €ì¥ (ë’¤ë¡œê°€ê¸° í¬í•¨)
  const handleBeforeUnload = () => {
    saveGameState(); // ë™ê¸° í˜¸ì¶œ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ ì£¼ì˜ í•„ìš”
  };

  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [userCredit, currentScreen]);
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê¸´ê¸‰ (ì§€ê¸ˆ ë°”ë¡œ)

- [ ] **ì‚¬ìš©ì ì œê³µ í•„ìš”:**
  ```
  1. GAME_WALLET_ADDRESS = ?
  2. CSPIN_TOKEN_ADDRESS = ?
  ```

- [ ] **ìˆ˜í–‰í•  ì‘ì—…:**
  1. wrangler.toml ì»¤ë°‹ ë° git push
  2. Cloudflare ëŒ€ì‹œë³´ë“œì—ì„œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
  3. Pages ìë™ ì¬ë°°í¬ ëŒ€ê¸° (1-2ë¶„)
  4. `/api/debug-withdrawal` ë‹¤ì‹œ í˜¸ì¶œ â†’ gameWalletValid, cspinTokenValid í™•ì¸
  5. ì¸ì¶œ ë²„íŠ¼ í´ë¦­ í…ŒìŠ¤íŠ¸

### ì¤‘ìš” (ë‹¤ìŒ ë‹¨ê³„)

- [ ] GameComplete.tsxì˜ saveGameState useEffect ê°œì„ 
- [ ] ë’¤ë¡œê°€ê¸° ì‹œ í¬ë ˆë”§ ì†ì‹¤ ì¬í…ŒìŠ¤íŠ¸
- [ ] í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸

---

## ğŸ’¡ ì¶”ê°€ ì •ë³´

### ì™œ wrangler.tomlì— ì„ ì–¸í•´ì•¼ í•˜ë‚˜?

```
ë¡œì»¬ ê°œë°œ: ë¡œì»¬ í™˜ê²½ë³€ìˆ˜ ì½ìŒ
ë°°í¬ ì‹œ: wrangler.toml íŒŒì¼ ì½ìŒ
í”„ë¡œë•ì…˜: Cloudflare Secrets/Variablesì—ì„œ ì½ìŒ

${VARIABLE_NAME} ë¬¸ë²• = Cloudflareì˜ í•´ë‹¹ í™˜ê²½ë³€ìˆ˜ë¡œë¶€í„° ê°’ ëŒ€ì²´
```

### ë§Œì•½ GAME_WALLET_ADDRESS/CSPIN_TOKEN_ADDRESSë¥¼ ìƒì–´ë²„ë ¸ë‹¤ë©´?

```
1. í† í° ë¸”ë¡ì²´ì¸ íƒìƒ‰ê¸° (tonviewer.com ë“±)ì—ì„œ ê²€ìƒ‰
2. TON ì§€ê°‘ì—ì„œ ê±°ë˜ ë‚´ì—­ í™•ì¸ (ë°°í¬ ì‹œ ë³´ëƒˆë˜ ì£¼ì†Œ)
3. ë°±ì—… íŒŒì¼ í™•ì¸ (wallet-tools/, PoC/ ë””ë ‰í† ë¦¬)
```

---

**ë‹¤ìŒ ì§„í–‰:**
1. GAME_WALLET_ADDRESS, CSPIN_TOKEN_ADDRESS ê°’ ì œê³µ
2. Cloudflare í™˜ê²½ë³€ìˆ˜ ì„¤ì •
3. í…ŒìŠ¤íŠ¸ ë° ì¬ì§„ë‹¨

