# 🚨 긴급: 인출 500 오류 근본 원인 및 해결책

**진단 일시:** 2025-10-23 12:33:34 UTC  
**심각도:** 🔴 Critical (인출 기능 완전 미작동)  
**상태:** 환경변수 추가 필요

---

## 📊 진단 결과

### debug-withdrawal API 응답 분석

```json
{
  "environment": {
    "hasPrivateKey": true,          ✅ 존재
    "privateKeyLength": 128,        ✅ 정상
    "gameWalletAddress": "없음",    ❌ 누락!
    "cspinTokenAddress": "없음"     ❌ 누락!
  },
  "status": {
    "privateKeyValid": true,        ✅
    "gameWalletValid": false,       ❌ 때문에 실패
    "cspinTokenValid": false        ❌ 때문에 실패
  }
}
```

### 원인 파악

**initiate-withdrawal.ts 184-191 줄:**
```typescript
if (!gameWalletPrivateKey || !gameWalletAddress || !cspinTokenAddress) {
  console.error('[인출] 환경변수 누락:', { ... });
  return new Response(
    JSON.stringify({
      success: false,
      error: '서버 설정 오류'
    }),
    { status: 500, headers: { 'Content-Type': 'application/json' } }
  );
}
```

→ **문제:** `gameWalletAddress`와 `cspinTokenAddress`가 `undefined`이므로 500 반환

---

## ✅ 해결책

### Step 1: wrangler.toml 수정 (완료)

**수정 내용:**
```toml
[vars]
BACKEND_RPC_URL = "https://rpc.ankr.com/ton_api_v2/${TON_RPC_API_KEY}"
TON_RPC_HTTPS_ENDPOINT = "https://rpc.ankr.com/ton_api_v2/${TON_RPC_API_KEY}"
NETWORK_FEE_TON = "0.03"
GAME_WALLET_ADDRESS = "${GAME_WALLET_ADDRESS}"        ← 추가됨
CSPIN_TOKEN_ADDRESS = "${CSPIN_TOKEN_ADDRESS}"        ← 추가됨

[env.production.vars]
...동일...
GAME_WALLET_ADDRESS = "${GAME_WALLET_ADDRESS}"        ← 추가됨
CSPIN_TOKEN_ADDRESS = "${CSPIN_TOKEN_ADDRESS}"        ← 추가됨
```

**의미:** 
- 로컬/프로덕션 모두에서 환경변수로부터 값을 받음
- `${VARIABLE_NAME}` 문법으로 Cloudflare Secrets/Variables에서 읽음

### Step 2: Cloudflare 대시보드에서 실제 값 설정

**필수 정보 (사용자가 제공해야 함):**

1. **GAME_WALLET_ADDRESS**
   - 게임 서버 지갑 주소 (TON)
   - 형식: `0:abc123...` 또는 `UQA...`
   - 어디서 얻음: 게임 지갑 생성 시 저장한 주소

2. **CSPIN_TOKEN_ADDRESS**
   - CSPIN 토큰 마스터 주소 (Jetton Master Contract)
   - 형식: `0:def456...` 또는 `EQB...`
   - 어디서 얻음: 토큰 배포 시 저장한 주소

### Step 3: Cloudflare Pages 설정

**경로:**
```
1. https://dash.cloudflare.com 접속
2. Workers & Pages → CandleSpinner 선택
3. Settings → Environment Variables
4. Production 탭에서:
   - GAME_WALLET_ADDRESS = [실제 게임 지갑 주소]
   - CSPIN_TOKEN_ADDRESS = [실제 토큰 마스터 주소]
   저장
```

**또는 CLI로:**
```bash
# wrangler secret set (프로덕션 배포)
wrangler secret:bulk --env production << EOF
GAME_WALLET_ADDRESS=[실제주소]
CSPIN_TOKEN_ADDRESS=[실제주소]
EOF
```

---

## 🎯 문제 2: 크레딧 1150 초기화

### 증상

```
스핀 승리 (크레딧 증가) → 상금 수령 → 입금 페이지 이동 
→ 뒤로가기 → 메인 페이지 로딩 → 크레딧 1150 초기화
```

### 원인 분석

**가설 1: 뒤로가기 시 localStorage 초기값 로드**
```javascript
// App.tsx에서 지갑 연결 시
useEffect(() => {
  if (isConnected) {
    // localStorage에서 초기값을 읽는데, 
    // 화면 전환 중에 saveGameState가 호출되지 않았다면?
    // → KV에 미저장 상태로 뒤로가기
    // → GET /api/get-credit → KV에는 이전 값 (1150)
    // → UI 크레딧 1150 표시
  }
}, [isConnected]);
```

**가설 2: useEffect 타이밍 문제**
```typescript
// GameComplete.tsx에서 (현재 코드)
useEffect(() => {
  if (currentScreen !== 'main') {
    setTimeout(() => {
      saveGameState();
    }, 100);
  }
}, [currentScreen, userCredit, saveGameState]);
```

→ 100ms 딜레이 동안 뒤로가기 누르면 저장 전에 화면 전환 가능

### 해결책

**방법 A: useEffect 의존성 개선** (즉시)

```typescript
// GameComplete.tsx
useEffect(() => {
  // currentScreen 변경 직후 즉시 저장
  const saveImmediately = async () => {
    console.log('[GameComplete] 💾 화면 전환 감지, 즉시 저장:', currentScreen, userCredit);
    await saveGameState();
  };

  if (currentScreen !== 'main') {
    saveImmediately();
  }
}, [currentScreen]); // userCredit 제외 - userCredit 변경이 아닌 currentScreen 변경만 감지

// 또는 별도 useEffect로 크레딧 변경도 감지
useEffect(() => {
  if (currentScreen !== 'main' && userCredit > 0) {
    console.log('[GameComplete] 💾 크레딧 변경, 저장:', userCredit);
    const timer = setTimeout(() => {
      saveGameState();
    }, 50); // 더 짧은 딜레이
    
    return () => clearTimeout(timer);
  }
}, [userCredit, currentScreen]);
```

**방법 B: 브라우저 이벤트 추가** (권장)

```typescript
// GameComplete.tsx 또는 App.tsx
useEffect(() => {
  // 페이지 언로드 직전에 저장 (뒤로가기 포함)
  const handleBeforeUnload = () => {
    saveGameState(); // 동기 호출 불가능하므로 주의 필요
  };

  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [userCredit, currentScreen]);
```

---

## 📋 체크리스트

### 긴급 (지금 바로)

- [ ] **사용자 제공 필요:**
  ```
  1. GAME_WALLET_ADDRESS = ?
  2. CSPIN_TOKEN_ADDRESS = ?
  ```

- [ ] **수행할 작업:**
  1. wrangler.toml 커밋 및 git push
  2. Cloudflare 대시보드에서 환경변수 설정
  3. Pages 자동 재배포 대기 (1-2분)
  4. `/api/debug-withdrawal` 다시 호출 → gameWalletValid, cspinTokenValid 확인
  5. 인출 버튼 클릭 테스트

### 중요 (다음 단계)

- [ ] GameComplete.tsx의 saveGameState useEffect 개선
- [ ] 뒤로가기 시 크레딧 손실 재테스트
- [ ] 테스트 결과 리포트

---

## 💡 추가 정보

### 왜 wrangler.toml에 선언해야 하나?

```
로컬 개발: 로컬 환경변수 읽음
배포 시: wrangler.toml 파일 읽음
프로덕션: Cloudflare Secrets/Variables에서 읽음

${VARIABLE_NAME} 문법 = Cloudflare의 해당 환경변수로부터 값 대체
```

### 만약 GAME_WALLET_ADDRESS/CSPIN_TOKEN_ADDRESS를 잃어버렸다면?

```
1. 토큰 블록체인 탐색기 (tonviewer.com 등)에서 검색
2. TON 지갑에서 거래 내역 확인 (배포 시 보냈던 주소)
3. 백업 파일 확인 (wallet-tools/, PoC/ 디렉토리)
```

---

**다음 진행:**
1. GAME_WALLET_ADDRESS, CSPIN_TOKEN_ADDRESS 값 제공
2. Cloudflare 환경변수 설정
3. 테스트 및 재진단

