# 인출 기능 수정 - 환경정보 확인 완료 및 분석

**작성일**: 2025-10-25  
**상태**: 🟡 최종 진단 및 해결 단계

---

## ✅ 환경 정보 확인 완료

### 1️⃣ Ankr RPC 설정

**확인됨** ✅:
```
환경변수: ANKR_JSON_RPC_HTTPS_ENDPOINT
값: https://rpc.ankr.com/ton_api_v2/66910dc0e84dedd515d0d2346852949132d4ec25bce78734acfc6749fbe9a969
상태: 클라우드플레어에 설정됨 ✅
```

**분석**:
- ✅ Ankr RPC URL이 올바르게 설정됨
- ✅ API Key 포함 (길고 복잡한 문자열)
- ⚠️ 그런데 여전히 `-32079: Origin not allowed` 오류 발생

**추론**:
```
가능한 원인:
1. Ankr 대시보드에서 https://aiandyou.me/ Origin이 등록됨
2. 하지만 클라우드플레어의 실제 워커 도메인이 다름
   - 예: https://candlespinner.pages.dev (이전에 사용)
   - 예: 클라우드플레어 워커의 실제 도메인
3. 또는 프리페이트 URL이 다를 수 있음
```

---

### 2️⃣ 게임 지갑 설정

**확인됨** ✅:
```
GAME_WALLET_PRIVATE_KEY: 클라우드플레어에 설정됨 ✅
GAME_WALLET_ADDRESS: UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
```

**상태**: ✅ 정상 설정됨

---

### 3️⃣ 테스트 지갑 정보

**사용자 Jetton 지갑** ✅:
```
주소: UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_
잔액: 
  - CSPIN: 150 토큰
  - TON: 1 TON
상태: MVP 테스트용으로 사용 중
```

**네트워크**: 📍 메인넷 (실제 자산으로 테스트 중)

---

### 4️⃣ 배포 도메인

```
프로덕션: https://aiandyou.me/
Ankr Origin 등록: https://aiandyou.me/ ✅
```

---

## 🔍 현재 오류 상황 분석

### RPC CORS 오류 원인 분석

**오류**:
```
RPC Error -32079: Origin not allowed
```

**현재 파악**:
```
1. Ankr RPC 설정: ✅ 정상
2. Ankr Origin 등록: ✅ https://aiandyou.me/ 등록됨
3. 그런데 CORS 오류 계속 발생

문제점 찾기:
┌─────────────────────────────────────┐
│ 클라이언트 (브라우저)                 │
│ Origin: https://aiandyou.me/        │
└────────────┬──────────────────────┘
             │ API 호출
             ↓
┌─────────────────────────────────────┐
│ 클라우드플레어 워커                   │
│ (백엔드 함수)                        │
└────────────┬──────────────────────┘
             │ RPC 호출
             │ Origin: ???
             ↓
┌─────────────────────────────────────┐
│ Ankr RPC                            │
│ 등록된 Origin: https://aiandyou.me/ │
└─────────────────────────────────────┘
```

**가능한 원인들**:

#### 원인 1️⃣: 클라우드플레어 워커의 Origin이 다름
```
클라이언트: https://aiandyou.me/ (등록됨)
워커 -> Ankr 호출 시 Origin: ???

클라우드플레어 워커는 자신의 도메인을 Origin으로 사용할 수 있음
- 예: https://candlespinner.pages.dev (이전)
- 또는 커스텀 도메인 mapped origin
```

**해결책**: Ankr 대시보드에 **모든 가능한 Origin 등록**

#### 원인 2️⃣: Ankr API의 Origin 검증이 엄격함
```
- API Key 기반 검증이 아닌 Origin 기반 검증
- 또는 둘 다 필요
```

#### 원인 3️⃣: RPC 호출 시 Origin 헤더 누락
```
백엔드 fetch 호출에서 Origin 헤더가 없을 수 있음
```

---

## 🛠️ 해결책 (우선순위 순)

### 🔴 방안 1: Ankr 대시보드 확인 및 설정 (즉시)

**단계**:
1. https://www.ankr.com/rpc/projects/ 접속
2. TON Chain 선택
3. 현재 설정된 Origin 목록 확인
4. **필요시 Origin 추가**:
   ```
   - https://aiandyou.me/
   - https://aiandyou.me (www 없음)
   - https://*.aiandyou.me/ (서브도메인 포함)
   - 기타 가능한 도메인들
   ```

5. 변경 후 5-10분 대기 (캐시 갱신)
6. 테스트 재실행

**비용**: 무료 ✅

---

### 🟡 방안 2: 백엔드 프록시 구현 (대체)

**개념**:
```
클라이언트 -> https://aiandyou.me/api/rpc (프록시)
         -> Ankr RPC (Origin: 백엔드 워커)
```

**코드 예시**:
```typescript
// functions/api/rpc-proxy.ts (새로 만들기)
export async function onRequestPost(context: any) {
  const { method, params } = await context.request.json();
  
  const response = await fetch(env.ANKR_JSON_RPC_HTTPS_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ jsonrpc: '2.0', id: 1, method, params })
  });
  
  return new Response(await response.text(), { 
    status: response.status,
    headers: { 'Content-Type': 'application/json' }
  });
}
```

**비용**: 개발 시간 (30분 정도)

---

### 🟢 방안 3: 다른 RPC 제공자로 변경 (최후의 수단)

**대체 옵션들**:
```
1. Toncenter (무료)
   https://toncenter.com/api/v2/send
   
2. Getblock.io (유료지만 reliable)
   https://getblock.io/nodes/ton/
   
3. 기타 TON RPC
```

**비용**: 변경만으로 해결 가능

---

## 📊 문제 재정리

### 원인별 해결책 매칭

| 문제 | 원인 | 해결책 | 확률 |
|------|------|--------|-----|
| RPC CORS -32079 | Origin 미등록 | Ankr 대시보드 재확인 | 80% 🔴 |
| RPC CORS -32079 | 클라우드플레어 워커 Origin 다름 | 추가 Origin 등록 | 70% 🟡 |
| RPC CORS -32079 | 헤더 누락 | 백엔드 코드 수정 | 20% 🟢 |
| RPC CORS -32079 | Ankr 설정 복잡함 | 다른 RPC 사용 | 30% 🟢 |

---

## 🧪 다음 테스트 (즉시)

### 1단계: Ankr 대시보드 재확인 (5분)

```
1. https://www.ankr.com/rpc/projects/ 접속
2. TON 프로젝트 선택
3. Endpoints 탭 확인
4. Origin 또는 allowed domains 설정 재확인
5. 필요시 https://aiandyou.me/ 다시 추가
6. 클라우드플레어 도메인도 추가 시도
   - https://candlespinner.pages.dev/
   - 기타 클라우드플레어 도메인
```

---

### 2단계: 중앙화 방식 테스트 (재시도)

**지금 바로 가능**:
```
1. 게임 화면 진입
2. 크레딧 확인 (있어야 함)
3. [📤 인출] 클릭
4. Jetton 주소 입력:
   UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_
5. [👤 중앙화 방식] 선택
6. 1000 CSPIN 입력 (또는 가능한 금액)
7. [✓ 인출] 클릭
8. 디버그 로그 확인:
   ✅ 주소 변환 로그?
   ✅ BOC 생성 로그?
   ✅ TON Connect 팝업?
   ✅ 서명 완료?
```

**예상 결과**:
```
성공: ✅ CSPIN 인출 완료!
실패: ❌ 서명 오류 또는 API 오류 → 로그 분석
```

---

### 3단계: RPC 방식 테스트 (Ankr 설정 후)

```
1. Ankr 설정 완료 대기 (5-10분)
2. 같은 절차로 [⚡ RPC 방식] 선택
3. 디버그 로그 확인
```

---

## 📋 최종 체크리스트

```
✅ ANKR_JSON_RPC_HTTPS_ENDPOINT: 설정됨
✅ GAME_WALLET_PRIVATE_KEY: 설정됨
✅ 테스트 Jetton 지갑: UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_
✅ 배포 도메인: https://aiandyou.me/
✅ 네트워크: 메인넷

❓ Ankr 대시보드 Origin 등록 상태: 재확인 필요
❓ 클라우드플레어 워커 Origin: 파악 필요
```

---

## 🎯 다음 조치

### 즉시 (지금)

1. **Ankr 대시보드 재확인**
   ```
   1. https://www.ankr.com/rpc/projects/ 접속
   2. TON Origin 목록 확인
   3. 필요시 추가 등록
   4. 5분 대기
   ```

2. **중앙화 방식 재테스트**
   ```
   Jetton 주소: UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_
   테스트 진행
   ```

---

### 1시간 내

3. **RPC 테스트** (Ankr 설정 후)
   - 여전히 안 되면 백엔드 로그 분석
   - 또는 다른 RPC로 변경

---

## 💡 특별 주의사항

### 메인넷 테스트 중

⚠️ **중요**: 실제 CSPIN 토큰과 TON을 사용 중입니다!

```
현재 잔액:
- CSPIN: 150 토큰
- TON: 1 TON

테스트 시 주의:
- 가스비가 실제로 소모됨
- 테스트 금액을 작게 설정
- 성공 여부 확인 후 진행
```

---

## 📞 지금 필요한 것

1. **Ankr 대시보드 스크린샷**
   - Origin 등록 현황
   - 설정된 엔드포인트
   
2. **테스트 결과**
   - 중앙화 방식 테스트 결과
   - 디버그 로그
   - 성공/실패 메시지

---

**Ankr 대시보드 재확인 후 다시 알려주세요!** 🙏
