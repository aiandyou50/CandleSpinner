# 전면 리팩토링 대상 인벤토리 (2025-11-01)

본 문서는 CandleSpinner 프로젝트 전면 리팩토링을 위한 사전 조사 결과입니다. PoC 폴더는 **아카이브로 보존**하며 어떤 수정도 수행하지 않습니다.

## 1. 미사용/중복 코드 후보

| 구분 | 경로 | 비고 |
|------|------|------|
| Frontend | `archive/legacy-code/frontend/Deposit.old.tsx` | 구 버전 Deposit 구현 |
| Frontend | `archive/legacy-code/frontend/Deposit.v2.0.tsx.bak` | 백업본, 현재 미사용 |
| Frontend | `archive/legacy-code/frontend/Game.old.tsx` | 과거 게임 화면 구현 |
| Frontend | `PoC/src/**` | **보존 대상**, 이동 금지 |
| Backend | `archive/legacy-code/backend/initiate-withdrawal-v2-backup.ts` | 이전 RPC 구현 백업 |
| Backend | `archive/legacy-code/backend/initiate-withdrawal-v3.ts` | 중간 버전 백업 |
| Backend | `functions/api/debug-*.ts` (2건) | 운영 코드와 분리 필요 |
| Scripts | `scripts/*.mjs` | 사용 빈도 재평가 필요 (후속 단계) |

## 2. 문서 아카이빙 후보

| 분류 | 현재 위치 | 이동 제안 경로 |
|------|-----------|----------------|
| Instructions (2025-10-23 이전) | `docs/instructions/` 다수 | `docs/legacy_docs/instructions/` (신규) |
| Solutions (2025-10-24 이전) | `docs/solutions/` 다수 | `docs/legacy_docs/solutions/` (기존) |
| Reports (과거 분석 자료) | `docs/reports/` 일부 | `docs/legacy_docs/reports/` (기존) |
| Workflows 구버전 | `docs/workflows/` 내 이전 버전 | `docs/legacy_docs/workflows/` (기존) |

> **Note:** SSOT(`docs/ssot/`) 문서는 최신으로 유지하고 아카이빙하지 않습니다.

## 3. 디렉터리 재구성 제안 (초안)

### 3.1 프론트엔드 (`src/`)

```
src/
  app/              # 진입점 및 전역 설정 (App.tsx, main.tsx)
  features/
    game/
    wallet/
    analytics/
  shared/
    components/
    hooks/
    lib/            # API 래퍼, logger 등
    ui/             # 공용 UI (DebugPanel 포함)
```

- Legacy 컴포넌트는 `archive/legacy-code/frontend/`로 이동하여 README로 배경 기록.

### 3.2 백엔드 Functions (`functions/`)

```
functions/
  index.ts
  src/
    handlers/       # Cloudflare HTTP 핸들러 (initiate-withdrawal 등)
    services/       # 비즈니스 로직 (Ton RPC, credit 관리)
    lib/            # 공용 유틸 (mnemonic, rpc, rateLimit 등)
    types/
  archive/
    legacy/         # 과거 버전 핸들러/백업 코드
```

- 현재 `functions/api/*.ts` 구조를 단계적으로 위 구조로 이동.

### 3.3 아카이브/레거시 분리

```
archive/
  legacy-code/
    frontend/
    backend/
```

- PoC 폴더는 루트 그대로 **보존**.

## 4. RPC Seqno 오류 조사 로깅 계획

1. `SeqnoManager.getAndIncrementSeqno()`에서 TonCenter 응답, KV 값, 재시도 횟수를 상세 로깅.
2. `TonCenterV3Rpc.getSeqno()` 실패 시 `getAccountState` → `WalletContractV5R1` 로컬 계산으로 폴백 구현.
3. 재시도 실패 시 `resetSeqno()` 자동 호출로 KV 값 재동기화.
4. Cloudflare 로그에서 필터링하기 쉬운 `[SeqnoManager]`, `[TonCenter v3]` 프리픽스 사용.

## 5. 프론트엔드 디버그 UI 계획

- 전역 `ErrorBoundary` 확장: 사용자에게 친숙한 오류 화면 + Dev 상세 로그 토글 제공.
- `src/shared/lib/logger.ts` 추가: 프론트/API 호출에 공통 로거 도입, Dev 모드에서 콘솔 + UI에 표시.
- `DebugPanel` 컴포넌트: 최근 API 호출, 응답, 오류 스택을 표시하는 패널. 사용자 토글(`Ctrl+Shift+D`) 제공.

---

위 인벤토리를 기반으로 실제 이동/리팩토링 작업을 순차적으로 진행합니다. 추가 제외 대상이나 우선순위 변경 요청이 있으면 알려 주세요.
