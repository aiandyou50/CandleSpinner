# 🚨 인출 로직 개선 계획 (TON 수수료 문제)

**작성일:** 2025-10-23  
**문제:** 게임 지갑의 TON 부족으로 인한 인출 실패  

---

## 현재 구조의 문제

```
Step 8: 게임 지갑 → 게임 Jetton 지갑
        Value: 0.03 TON (이 비용은 누가 지불?)
        
← 문제: 게임 지갑이 TON을 가져야 하는데, 게임 지갑에 TON이 없을 수 있음!
```

---

## 해결 방안 (3가지)

### **방안 1: 사용자 지갑에서 직접 전송 (권장)**

```
사용자 지갑 ──(CSPIN 전송)──→ 사용자 지갑 (단계를 거치지 않음)

장점:
  ✅ 중간 단계 제거
  ✅ TON 수수료 전체 사용자 부담 (명확함)
  ✅ 게임 지갑의 TON 필요 없음
  
단점:
  ❌ 사용자가 Jetton 지갑을 가져야 함
  ❌ 사용자가 승인해야 할 수도 있음
```

### **방안 2: 게임 지갑에 충분한 TON 유지 (현재 구조)**

```
게임 서버 → 주기적으로 게임 지갑에 TON 입금
         (0.1 TON씩, 매주마다)

장점:
  ✅ 현재 로직 유지 (큰 변경 X)
  ✅ 사용자 승인 필요 X
  
단점:
  ❌ 별도의 TON 관리 필요
  ❌ 게임 지갑의 TON이 부족하면 인출 실패
```

### **방안 3: 토큰 뱅킹 (에스크로 방식)**

```
사용자가 입금 → 게임 서버 지갑에 CSPIN 보관
             → 사용자 인출 시 직접 전송 (게임 Jetton 지갑 거치지 않음)

장점:
  ✅ 중간 과정 간소화
  ✅ 신뢰성 높음
  
단점:
  ❌ 백엔드 데이터베이스 필요 (KV 구조 변경)
  ❌ 감시자 계약(监管人 contract) 필요할 수 있음
```

---

## 현재 코드에서 가능한 즉시 수정

### **1. TON 수수료 진단 추가**

```typescript
// functions/api/initiate-withdrawal.ts

async function checkGameWalletTonBalance(gameWalletAddress: string): Promise<bigint> {
  const url = 'https://tonapi.io/v2/accounts/getAccount';
  const response = await fetch(`${url}?account=${gameWalletAddress}`);
  const data = await response.json();
  return BigInt(data.account.balance);
}

// 인출 전 TON 잔액 확인
const gameWalletBalance = await checkGameWalletTonBalance(gameWalletAddress);
if (gameWalletBalance < toNano('0.1')) {
  return {
    success: false,
    error: `게임 서버의 TON 부족 (현재: ${fromNano(gameWalletBalance)} TON)`,
    requiredTon: '0.1 TON',
    currentTon: fromNano(gameWalletBalance)
  };
}
```

### **2. 스마트 컨트랙트 기반 해결 (향후)**

```solidity
// 게임 지갑의 TON이 부족하면
// 자동으로 사용자 지갑에서 TON을 차감하는 컨트랙트

// 이를 위해서는:
// - 사용자 지갑의 공개키 필요
// - 다중 서명 설정 필요
```

---

## 즉시 적용 방법

### **Step 1: 현재 상태 진단**

```bash
# 테스트용 인출 API 호출
curl -X POST https://aiandyou.me/api/debug-withdrawal \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "<사용자_지갑>",
    "withdrawalAmount": 100
  }'

# 응답에서:
# - "gameWalletBalance": TON 잔액 확인
# - "required_ton_for_withdrawal": 필요한 TON
# - "tonWalletIsSufficient": true/false
```

### **Step 2: 게임 지갑에 TON 입금**

```bash
# TON 지갑에서 게임 지갑으로 0.5 TON 전송
# 이 작업은 관리자가 수행
```

### **Step 3: 다시 테스트**

```bash
curl -X POST https://aiandyou.me/api/initiate-withdrawal \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "<사용자_지갑>",
    "withdrawalAmount": 100
  }'
```

---

## 권장 사항

**즉시 (MVP):**
- ✅ TON 수수료 진단 엔드포인트 추가
- ✅ 게임 지갑에 0.5 TON 입금 (관리자 작업)
- ✅ 다시 테스트

**단기 (1주일):**
- 인출 API에 잔액 확인 로직 추가
- 잔액 부족 시 명확한 에러 메시지 반환

**중기 (2-3주):**
- 방안 3 (토큰 뱅킹) 구현 검토
- 자동 TON 리필 시스템 구축

---

