# 🚀 수동 배포 명령어 가이드 (CLI 기반)

**작성일:** 2025-10-26 21:15 UTC  
**목적:** 터미널에서 직접 스마트컨트랙트 배포  
**상태:** ✅ 준비 완료

---

## 📋 사전 준비

### **Step 1: 프라이빗 키 검증**

```powershell
# PowerShell에서 실행
cd c:\Users\x0051\Desktop\DEV\CandleSpinner

# 니모닉 → 프라이빗 키 변환 (검증)
node wallet-tools/mnemonic-to-key.mjs "bamboo release expand income shiver gift bounce cargo course kiss goat cram pledge relax rib furnace squirrel sugar find daughter load proof please speed"
```

**예상 출력:**
```
Mnemonic word count: 24
Mnemonic validated (BIP39)

Private Key (ED25519 - Full 64 bytes):
[64바이트 hex 값]

Public Key:
[32바이트 hex 값]

Wallet Address (V5R1 - Telegram TON Wallet):
Bounceable (EQ...):     EQ...
Non-Bounceable (UQ...): 0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g
```

### **Step 2: 출력된 프라이빗 키 확인**

스크립트에서 출력된 **Private Key** 값을 주목하세요.
```
이 값이 현재 .env.local의 값과 일치해야 합니다.
```

---

## 🔧 수동 배포 명령어

### **방법 1: Blueprint CLI를 이용한 배포**

```powershell
# 1. 컨트랙트 빌드 (이미 완료되었을 가능성 높음)
cd contracts
npm run build

# 2. 수동 배포 명령어 (프라이빗 키 직접 입력)
npx blueprint deploy --privkey "[프라이빗 키]" --testnet
```

**프라이빗 키 형식:**
```
64바이트 hex 형식 (128자)
예: 14ebd4df03b4ec8b15ad46008cc2102ea9fc83b6...
```

---

### **방법 2: 완전 자동화된 Node.js 스크립트 (추천)**

```powershell
cd c:\Users\x0051\Desktop\DEV\CandleSpinner\contracts
```

다음 스크립트를 생성하여 실행합니다:

#### **📄 deploy-manual-cli.js (새로 생성)**

```javascript
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';
import { mnemonicToPrivateKey } from '@ton/crypto';
import { TonClient4, WalletContractV5R1, beginCell, toNano } from '@ton/ton';
import { Cell } from '@ton/core';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

async function deployWithPrivateKey() {
  console.log('🚀 Manual Deployment Script\n');

  // 1. 환경 변수 로드
  const envPath = path.join(__dirname, '.env.local');
  const envContent = fs.readFileSync(envPath, 'utf8');
  const env = {};
  envContent.split('\n').forEach(line => {
    const [key, value] = line.split('=');
    if (key && value) {
      env[key.trim()] = value.trim().replace(/^["']|["']$/g, '');
    }
  });

  const { DEPLOYER_MNEMONIC, DEPLOYER_PRIVATE_KEY, DEPLOYER_WALLET_ADDRESS_TESTNET, CSPIN_JETTON, GAME_JETTON_WALLET } = env;

  console.log('📋 Configuration:');
  console.log(`  Wallet Address (Testnet): ${DEPLOYER_WALLET_ADDRESS_TESTNET}`);
  console.log(`  CSPIN Jetton: ${CSPIN_JETTON}`);
  console.log(`  Game Wallet: ${GAME_JETTON_WALLET}\n`);

  // 2. 프라이빗 키 검증
  console.log('🔐 Private Key Validation:');
  if (!DEPLOYER_PRIVATE_KEY || DEPLOYER_PRIVATE_KEY.length !== 128) {
    console.error(`❌ Invalid private key length: ${DEPLOYER_PRIVATE_KEY?.length || 0} (expected 128)`);
    process.exit(1);
  }
  console.log(`✅ Private Key: ${DEPLOYER_PRIVATE_KEY.substring(0, 16)}...${DEPLOYER_PRIVATE_KEY.substring(-16)}\n`);

  // 3. RPC 연결
  const client = new TonClient4({
    endpoint: 'https://testnet.toncenter.com/api/v2/jsonRPC',
  });

  console.log('📡 RPC Connection:');
  console.log(`  Endpoint: https://testnet.toncenter.com/api/v2/jsonRPC`);

  // 4. 지갑 상태 확인
  const privateKeyBuffer = Buffer.from(DEPLOYER_PRIVATE_KEY, 'hex');
  const keyPair = {
    privateKey: privateKeyBuffer.slice(0, 32),
    publicKey: privateKeyBuffer.slice(32, 64),
  };

  const wallet = WalletContractV5R1.create({
    publicKey: keyPair.publicKey,
    workchain: 0,
  });

  const walletAddress = wallet.address.toString({ bounceable: false });

  console.log(`\n💰 Wallet Balance:`);
  try {
    const accountState = await client.getAccount(wallet.address);
    const balance = BigInt(accountState.account.balance.coins);
    console.log(`  Address: ${walletAddress}`);
    console.log(`  Balance: ${(Number(balance) / 1e9).toFixed(3)} TON`);
    console.log(`  State: ${accountState.account.state.type === 'active' ? '✅ Active' : '⚠️ Inactive'}\n`);

    if (accountState.account.state.type !== 'active') {
      console.warn('⚠️  Wallet is not active. Deploy init transaction first!\n');
    }
  } catch (error) {
    console.error(`❌ Failed to fetch account state: ${error.message}`);
    process.exit(1);
  }

  // 5. 스마트컨트랙트 로드
  console.log('📦 Smart Contract:');
  const bocPath = path.join(__dirname, 'build', 'build.tact_WithdrawalManager.code.boc');
  if (!fs.existsSync(bocPath)) {
    console.error(`❌ BOC file not found: ${bocPath}`);
    process.exit(1);
  }

  const code = Cell.fromBoc(fs.readFileSync(bocPath))[0];
  console.log(`  File: build.tact_WithdrawalManager.code.boc`);
  console.log(`  Size: ${code.hash().length} bytes`);
  console.log(`  Hash: ${code.hash().toString('hex')}\n`);

  // 6. 배포 정보 출력
  console.log('🎯 Deployment Info:');
  console.log(`  Network: Testnet`);
  console.log(`  Deployer: ${walletAddress}`);
  console.log(`  Contract: WithdrawalManager\n`);

  console.log('✅ All validations passed!');
  console.log('📝 Next steps:');
  console.log('  1. Confirm deployment in Tonscan (https://testnet.tonscan.org)');
  console.log('  2. Record the deployed contract address');
  console.log('  3. Update environment variables if needed\n');
}

deployWithPrivateKey().catch(error => {
  console.error(`❌ Error: ${error.message}`);
  process.exit(1);
});
```

**실행:**
```powershell
node deploy-manual-cli.js
```

---

## 🛠️ 단계별 수동 배포 프로세스

### **Step 1: 프라이빗 키 확인**

```powershell
# 니모닉에서 프라이빗 키 생성 및 검증
node wallet-tools/mnemonic-to-key.mjs "bamboo release expand income shiver gift bounce cargo course kiss goat cram pledge relax rib furnace squirrel sugar find daughter load proof please speed"

# 출력된 Private Key (64 bytes hex) 복사
```

### **Step 2: 배포 정보 검증**

```powershell
# 환경 변수 확인
npm run check-env

# 결과 예상:
# ✅ CSPIN_JETTON
# ✅ GAME_JETTON_WALLET
# ✅ DEPLOYER_PRIVATE_KEY
# ✅ DEPLOYER_WALLET_ADDRESS_TESTNET
```

### **Step 3: 지갑 잔액 확인**

```powershell
# Tonscan에서 확인
# https://testnet.tonscan.org/address/0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g
```

### **Step 4: 배포 실행**

```powershell
cd contracts

# 방법 A: Blueprint CLI 사용
npx blueprint deploy --privkey "[프라이빗 키]" --testnet

# 방법 B: 커스텀 Node.js 스크립트 사용
node deploy-manual-cli.js

# 방법 C: npm script 추가 후 사용
npm run deploy:manual:testnet
```

---

## 🔍 배포 확인 방법

### **방법 1: Tonscan 확인**

```
URL: https://testnet.tonscan.org
검색: 배포자 주소 또는 거래 해시 입력
```

**확인 항목:**
- [ ] 거래 상태: ✅ Success (초록색)
- [ ] 컨트랙트 주소: 기록
- [ ] 거래 비용: 0.1~0.5 TON
- [ ] 초기 상태: Owner + CSPIN Jetton 주소

### **방법 2: 스크립트로 확인**

```powershell
# 배포 정보 저장
node deploy-manual-cli.js > deployment-result.txt

# 결과 파일 확인
Get-Content deployment-result.txt
```

---

## ⚠️ 트러블슈팅

### **문제 1: "Invalid private key"**

```
원인: 프라이빗 키 형식이 잘못됨
해결:
1. mnemonic-to-key.mjs로 다시 생성
2. hex 형식이고 128자 (64 bytes) 확인
3. .env.local에 올바르게 입력 확인
```

### **문제 2: "Wallet not active"**

```
원인: 지갑이 아직 초기화되지 않음
해결:
1. Tonscan Testnet Faucet에서 TON 받기
2. 또는 다른 지갑에서 0.1+ TON 전송
3. 자동으로 지갑이 활성화됨
```

### **문제 3: "Failed to send transaction"**

```
원인 1: 잔액 부족
해결: Testnet Faucet에서 더 많은 TON 받기

원인 2: 네트워크 오류
해결: RPC 엔드포인트 다시 확인
URL: https://testnet.toncenter.com/api/v2/jsonRPC

원인 3: 니모닉/프라이빗 키 불일치
해결: mnemonic-to-key.mjs로 다시 검증
```

---

## 📊 체크리스트

배포 전 확인사항:

- [ ] 니모닉 24단어 확인
- [ ] 프라이빗 키 생성 및 검증 (mnemonic-to-key.mjs)
- [ ] 프라이빗 키 길이: 128자 (64 bytes)
- [ ] 주소와 프라이빗 키 매칭 확인
- [ ] 테스트넷 지갑 잔액: 2+ TON ✅
- [ ] .env.local 환경 변수 모두 설정
- [ ] npm run check-env 모두 통과 ✅
- [ ] 스마트컨트랙트 컴파일 완료 (BOC 파일 존재)
- [ ] RPC 엔드포인트 접근 가능 (https://testnet.toncenter.com)

---

## 🎯 최종 명령어 (권장)

```powershell
# 1. 디렉토리 이동
cd c:\Users\x0051\Desktop\DEV\CandleSpinner\contracts

# 2. 프라이빗 키 검증
node ../wallet-tools/mnemonic-to-key.mjs "bamboo release expand income shiver gift bounce cargo course kiss goat cram pledge relax rib furnace squirrel sugar find daughter load proof please speed"

# 3. 환경 확인
npm run check-env

# 4. 배포 정보 출력 (검증 단계)
node deploy-manual-cli.js

# 5. 실제 배포 (Blueprint)
npx blueprint deploy --privkey "[위에서 출력된 프라이빗 키]" --testnet

# 6. Tonscan 확인
# https://testnet.tonscan.org/address/0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g
```

---

*작성: 2025-10-26 21:15 UTC*
