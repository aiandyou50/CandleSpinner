# 배포 과정 분석: 지갑 주소 불일치 문제

**작성일:** 2025-10-26  
**분석:** Blueprint 배포 스크립트 실행 결과 검토

---

## 🔍 문제 분석

### **발견된 문제**

배포 스크립트가 표시한 배포자 지갑 주소와 제공된 주소가 다릅니다:

```
스크립트가 표시한 주소 (잘못됨):
EQB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vicyiv

제공된 올바른 주소:
테스트넷: 0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g
메인넷: UQC2DJ8yOisLaWh7J7xHAx6yppyZCoyf5cR5vbOVJcwVQZdC
```

### **차이점 분석**

| 항목 | 스크립트 출력 | 올바른 주소 | 상태 |
|-----|-----------|----------|------|
| 주소 형식 | `EQB_...` (메인넷 포맷) | `0QB_...` (테스트넷 포맷) | ❌ 포맷 틀림 |
| 주소 끝자리 | `vicyiv` | `vic87g` | ❌ 다름 |
| 프리픽스 | `EQ` | `0Q` | ❌ 메인넷 vs 테스트넷 |

---

## 📋 실제로 무슨 일이 일어났나?

### **1단계: 네트워크 선택**
```
? Which network do you want to use? testnet
✅ 올바른 선택
```

### **2단계: 지갑 선택**
```
? Which wallet are you using? Create a ton:// deep link
```

⚠️ **문제 발견!** 스크립트가 다음 3가지 옵션 중 하나를 선택해야 했는데:
- `TonConnect compatible mobile wallet (example: Tonkeeper)` ← 이것을 선택해야 함
- `Create a ton:// deep link` ← 이것을 선택함 (잘못됨)
- `Ledger` (하드웨어 지갑)

### **3단계: 배포 정보 표시**
```
배포자 지갑: EQB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vicyiv
```

❌ 잘못된 이유:
1. 메인넷 형식(`EQ...`)으로 표시됨 (테스트넷 `0Q...`이어야 함)
2. 주소의 체크섬/계산이 잘못됨
3. deployWithdrawalManager.ts 스크립트가 **테스트넷 주소 변환 실패**

---

## 🔧 근본 원인

### **deployWithdrawalManager.ts의 버그**

```typescript
// 현재 코드 (잘못된 부분)
const deployerWalletAddress = Address.parse(process.env.DEPLOYER_WALLET_ADDRESS_TESTNET!);

console.log(`배포자 지갑: ${deployerWalletAddress.toString()}`);
// ❌ testOnly 파라미터 없음 = 항상 메인넷 형식으로 출력
```

**수정되어야 할 코드:**
```typescript
console.log(`배포자 지갑 (테스트넷): ${deployerWalletAddress.toString({ testOnly: true })}`);
// ✅ testOnly: true = 테스트넷 형식으로 출력
```

---

## ⚠️ 영향 분석

### **실제 배포에 미치는 영향**

| 단계 | 영향 | 심각도 |
|-----|------|-------|
| 1. 정보 표시 | 주소가 틀리게 표시됨 | 🟡 중간 |
| 2. 지갑 연결 | 실제로는 올바른 주소 사용 | 🟢 영향 없음 |
| 3. 배포 실행 | **배포 자체는 진행되지 않음** | 🟢 안전함 |

**결론:** 정보 표시가 잘못되었지만, **실제 배포 진행까진 가지 않았음**

---

## 🔍 스크립트가 한 일

```
✅ 환경 변수 확인 (올바름)
✅ 스마트컨트랙트 빌드 확인 (올바름)
❌ 배포자 주소 표시 (잘못된 형식)

⚠️ 배포 중단 상태 - 사용자 입력 대기 중
   (실제 배포는 시작되지 않음)
```

---

## ✅ 올바른 절차

### **다시 배포하기 (올바른 순서)**

```bash
# 1. 배포 명령 실행
npm run deploy

# 2. 네트워크 선택
? Which network do you want to use? 
  → testnet ✅ 선택

# 3. 지갑 선택
? Which wallet are you using?
  → TON Connect compatible mobile wallet (example: Tonkeeper) ✅ 선택
  → (절대 "Create a ton:// deep link" 선택 금지)

# 4. 지갑 선택
? Choose your wallet
  → Tonkeeper ✅ 선택

# 5. QR 코드 스캔
  Scan the QR code in your wallet or open the link...
  → Tonkeeper 앱에서 스캔 및 승인
```

---

## 🔧 수정 방법

### **Option 1: 스크립트 수정 후 재배포**

```bash
# deployWithdrawalManager.ts 수정
# 라인 22-23:
console.log(`✅ 환경 변수 확인:
   CSPIN Jetton: ${CSPIN_JETTON.toString()}
   게임 지갑: ${GAME_JETTON_WALLET.toString()}
   배포자 지갑: ${deployerWalletAddress.toString({ testOnly: true })}`);
   //                                              ^^^^^^^^^^^^^^
   //                                     testOnly 파라미터 추가
```

### **Option 2: 다시 배포 (현재 상태)**

위의 "올바른 절차"를 따라 다시 실행하세요.

```bash
npm run deploy
```

**주의:** "Create a ton:// deep link" 대신 "TON Connect compatible mobile wallet" 선택

---

## 📊 현재 배포 상태

| 단계 | 상태 | 설명 |
|-----|------|------|
| 환경 설정 | ✅ 완료 | 모든 변수 올바름 |
| 스마트컨트랙트 컴파일 | ✅ 완료 | 769 bytes 준비됨 |
| **배포 실행** | ⏳ 대기 | TonConnect 지갑 연결 필요 |
| 거래 전송 | ⏳ 대기 | 배포 진행 필요 |
| 배포 완료 | ⏳ 대기 | 스마트컨트랙트 생성 대기 |

---

## 🎯 다음 단계

```bash
# 1. 다시 배포 시작
npm run deploy

# 2. 네트워크: testnet 선택
# 3. 지갑: TON Connect compatible mobile wallet (example: Tonkeeper) 선택
# 4. 지갑: Tonkeeper 선택
# 5. QR 코드 스캔 및 승인
```

---

## ✅ 요약

**문제:** 지갑 선택 옵션을 잘못 선택  
**원인:** "Create a ton:// deep link" 선택 (올바른: "TON Connect compatible mobile wallet")  
**영향:** 배포가 진행되지 않음 (정보 표시만 틀림)  
**해결:** 다시 배포하되, 올바른 옵션 선택  
**상태:** 🟡 **배포 재진행 필요** (큰 문제 없음)

---

*분석 완료: 2025-10-26 11:55 UTC*
