# 🚀 배포 실패 원인 및 수동 배포 명령어 가이드

**작성일:** 2025-10-26 21:20 UTC  
**상태:** 🔴 **중대 문제 발견 및 해결 방안 제시**

---

## 📊 배포 실패 원인 분석 결과

### **🔴 핵심 문제: 주소 불일치**

```
프라이빗 키 검증 결과:
✅ 프라이빗 키 형식: 유효함 (128자 hex)
✅ 니모닉 ↔ 프라이빗 키: 일치
❌ 프라이빗 키 ↔ 테스트넷 주소: 불일치

생성되는 주소:
- 메인넷: UQC2DJ8yOisLaWh7J7xHAx6yppyZCoyf5cR5vbOVJcwVQZdC ✅ 일치
- 테스트넷: 0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g ❌ 불일치
```

### **🔍 원인 분석**

| 항목 | 상황 | 의미 |
|-----|------|------|
| 현재 니모닉 | 메인넷 주소만 생성 | 제공된 니모닉은 메인넷용 |
| 테스트넷 주소 | 별도 니모닉에서 생성 | 다른 니모닉이 필요 |
| 테스트넷 잔액 | 2 TON 보유 | 배포는 가능하지만 서명 불가 |

---

## ✅ 해결 방법 (3가지 옵션)

### **✨ 옵션 A: 메인넷 주소로 배포 (권장 - 가장 빠름)**

**상황:**
- 현재 프라이빗 키 ✅ 메인넷 주소와 완벽하게 일치
- 메인넷에서 모든 검증 완료됨

**단계:**

```powershell
# 1. 메인넷 주소를 테스트넷 주소로 업데이트
# .env.local 파일 수정
# DEPLOYER_WALLET_ADDRESS_TESTNET=UQC2DJ8yOisLaWh7J7xHAx6yppyZCoyf5cR5vbOVJcwVQZdC

# 2. 검증
cd c:\Users\x0051\Desktop\DEV\CandleSpinner\contracts
npm run check-env

# 3. 배포 정보 확인
node deploy-cli.mjs "14ebd4df03b4ec8b15ad46008cc2102ea9fc83b6561c5e263f8822fd58ced5c64f917eef0fdd86900619af6183bb2e9bfc063f6ea082d00c86f046d7d434765b" testnet

# 4. Blueprint로 배포
npx blueprint deploy --privkey "14ebd4df03b4ec8b15ad46008cc2102ea9fc83b6561c5e263f8822fd58ced5c64f917eef0fdd86900619af6183bb2e9bfc063f6ea082d00c86f046d7d434765b" --testnet
```

**장점:**
- 즉시 배포 가능
- 검증된 프라이빗 키 사용
- 비용 최소화

**단점:**
- 테스트넷 주소 변경 필요

---

### **🔍 옵션 B: 테스트넷 주소의 올바른 프라이빗 키 찾기**

**필요한 정보:**
- 테스트넷 주소: `0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g`
- 이 주소의 **니모닉 또는 프라이빗 키**

**단계:**

```powershell
# 1. 지갑에서 니모닉 확인
# (Tonkeeper, TonHub 등에서 "0QB_..." 지갑의 니모닉 확인)

# 2. 니모닉이 있다면 프라이빗 키 생성
cd c:\Users\x0051\Desktop\DEV\CandleSpinner
node wallet-tools/mnemonic-to-key.mjs "[24단어 니모닉]"

# 3. 출력된 프라이빗 키 복사

# 4. .env.local 업데이트
# DEPLOYER_PRIVATE_KEY=[위에서 복사한 프라이빗 키]

# 5. 검증
cd contracts
npm run check-env

# 6. 배포
npx blueprint deploy --privkey "[프라이빗 키]" --testnet
```

**필요 정보:**
- 테스트넷 지갑의 니모닉 또는 프라이빗 키

---

### **💾 옵션 C: 지갑에서 직접 프라이빗 키 Export**

**단계 (Tonkeeper 기준):**

```
1. Tonkeeper 앱 열기
2. 지갑 선택: 0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g
3. 설정 (⚙️) → "Security"
4. "Show Secret" 또는 "Export Private Key"
5. 프라이빗 키 복사
6. .env.local DEPLOYER_PRIVATE_KEY에 입력
```

---

## 🚀 빠른 시작 - 지금 바로 실행 (옵션 A)

### **Step 1: 환경 변수 수정**

```powershell
# contracts\.env.local 열기
# 다음 줄을 찾아서:
# DEPLOYER_WALLET_ADDRESS_TESTNET=0QB_yGkOExm0kP1--22Kx7EwllpC67Fk2xpZcfjUt7vic87g

# 다음으로 변경:
# DEPLOYER_WALLET_ADDRESS_TESTNET=UQC2DJ8yOisLaWh7J7xHAx6yppyZCoyf5cR5vbOVJcwVQZdC
```

### **Step 2: 검증**

```powershell
cd c:\Users\x0051\Desktop\DEV\CandleSpinner\contracts
npm run check-env
```

**예상 출력:**
```
✅ CSPIN_JETTON
✅ GAME_JETTON_WALLET
✅ DEPLOYER_PRIVATE_KEY
✅ DEPLOYER_WALLET_ADDRESS_TESTNET
✅ DEPLOYER_WALLET_ADDRESS_MAINNET
✅ 모든 환경이 준비되었습니다!
```

### **Step 3: 배포 정보 확인**

```powershell
node deploy-cli.mjs "14ebd4df03b4ec8b15ad46008cc2102ea9fc83b6561c5e263f8822fd58ced5c64f917eef0fdd86900619af6183bb2e9bfc063f6ea082d00c86f046d7d434765b" testnet
```

**예상 출력:**
```
🚀 Manual Deployment Script

🔐 Private Key Validation:
  Key: 14ebd4df03b4ec8b...d7d434765b
  Length: 128 ✅

🔑 Key Derivation:
  Public Key: [16진수 값]

🏠 Wallet Generation:
  Address: UQC2DJ8yOisLaWh7J7xHAx6yppyZCoyf5cR5vbOVJcwVQZdC
  Version: WalletContractV5R1 (W5)

📡 RPC Connection:
  Network: TESTNET
  Endpoint: https://testnet.toncenter.com/api/v2/jsonRPC

💰 Wallet Balance:
  Balance: 1999999997.000 TON
  Status: ✅ Active

✅ All Validations Passed!
```

### **Step 4: 실제 배포**

```powershell
# Blueprint 사용
npx blueprint deploy --privkey "14ebd4df03b4ec8b15ad46008cc2102ea9fc83b6561c5e263f8822fd58ced5c64f917eef0fdd86900619af6183bb2e9bfc063f6ea082d00c86f046d7d434765b" --testnet
```

### **Step 5: Tonscan 확인**

배포 완료 후 확인:
```
https://testnet.tonscan.org/address/UQC2DJ8yOisLaWh7J7xHAx6yppyZCoyf5cR5vbOVJcwVQZdC
```

---

## 📋 프라이빗 키 값 (copy-paste용)

```
14ebd4df03b4ec8b15ad46008cc2102ea9fc83b6561c5e263f8822fd58ced5c64f917eef0fdd86900619af6183bb2e9bfc063f6ea082d00c86f046d7d434765b
```

**주의:** 이 값은 보안에 매우 중요합니다!
- ⚠️ 절대로 공개하지 마세요
- ⚠️ Git에 커밋하지 마세요
- ⚠️ .env.local은 항상 .gitignore에 포함

---

## 🔧 개발자용 고급 명령어

### **프라이빗 키 검증**

```powershell
cd c:\Users\x0051\Desktop\DEV\CandleSpinner
node scripts/validate-keys.mjs
```

### **주소 불일치 분석**

```powershell
node scripts/analyze-address-mismatch.mjs
```

### **니모닉 → 프라이빗 키 변환**

```powershell
node wallet-tools/mnemonic-to-key.mjs "[24단어 니모닉]"
```

---

## 📊 체크리스트

배포 전 최종 확인:

- [ ] 프라이빗 키: 검증됨 ✅ (128자 hex)
- [ ] 프라이빗 키 ↔ 주소: 매칭됨 ✅
- [ ] .env.local: 업데이트됨 ✅
- [ ] npm run check-env: 모두 통과 ✅
- [ ] 지갑 잔액: 충분함 ✅ (2 TON 이상)
- [ ] 스마트컨트랙트: 컴파일됨 ✅ (BOC 파일 존재)
- [ ] RPC 연결: 가능함 ✅

---

## 💡 다음 단계

### **배포 후 (즉시)**
1. ✅ Tonscan에서 거래 확인
2. ✅ 배포된 컨트랙트 주소 기록
3. ✅ deployment-testnet.json 업데이트

### **배포 검증 (1-5분)**
1. ✅ 컨트랙트 상태 확인 (Active)
2. ✅ 초기 데이터 검증
3. ✅ 거래 비용 확인

### **다음 작업 (검증 후)**
1. 📝 백엔드 API 구현
   - `/api/initiate-withdrawal`
   - `/api/confirm-withdrawal`

2. 🎨 프론트엔드 TonConnect 통합
   - WithdrawalManager 호출
   - Permit 메시지 서명

3. 🧪 엔드투엔드 테스트
   - 테스트넷에서 전체 플로우

4. 🚀 메인넷 배포
   - 동일한 프로세스로 메인넷 배포

---

## 📞 트러블슈팅

### **Q: "Private key must be 128 hex characters"**
**A:** 프라이빗 키가 너무 짧습니다. 64 bytes (128자) 형식인지 확인하세요.

### **Q: "Wallet is not active"**
**A:** 지갑에 TON을 받아야 합니다. Testnet Faucet 사용 또는 다른 지갑에서 전송.

### **Q: "BOC file not found"**
**A:** `npm run build` 실행 후 다시 시도하세요.

### **Q: 거래가 "Failed" 상태인 이유?**
**A:** 
1. 지갑이 Inactive 상태 → TON 받아서 활성화
2. 잔액 부족 → 더 많은 TON 필요
3. 서명 오류 → 프라이빗 키/주소 검증

---

**✅ 상세 분석 완료. 옵션 A (메인넷 주소 사용)가 가장 빠른 해결책입니다.**

*가이드: 2025-10-26 21:20 UTC*
