# 인출 기능 - 오류 해결 진행 상황

**작성일**: 2025-10-24  
**상태**: 🟡 진행 중 (1/2 해결됨)

---

## 🧪 테스트 결과 분석

### 테스트 환경
- **네트워크**: 메인넷
- **테스트 금액**: 1000 CSPIN
- **사용자 입력**: TON 월렛 주소 (Jetton 지갑 주소 대신)

---

## 1️⃣ 중앙화 방식 오류 ❌

### 오류 메시지
```
❌ 서명 오류: [TON_CONNECT_SDK_ERROR] B SendTransactionRequest 
validation failed: Wrong 'address' format in message at index 0
```

### 원인 분석
| 항목 | 내용 |
|------|------|
| 오류 타입 | TON Connect 검증 실패 |
| 원인 | `address` 필드 형식 오류 |
| 현재 형식 | `0:ac0491ea8b74...` (체크섬 형식) |
| 필요 형식 | `EQAswElei3Tdq...` (User-Friendly 형식) |

### 해결책 ✅
```typescript
// ✅ 수정됨: Address 형식 자동 변환
import { Address } from '@ton/ton';

const userFriendlyAddress = Address.parse(wallet.account.address).toString();
const tx = {
  messages: [{
    address: userFriendlyAddress,  // ← User-Friendly 형식 사용
    amount: result.tonAmount,
    payload: result.boc
  }]
};
```

### 상태
- ✅ **완료**: 프론트엔드 수정 완료
- ⏳ **다음**: 재테스트 필요

---

## 2️⃣ RPC 방식 오류 ❌

### 오류 메시지
```
API 응답 상태: 500
❌ 오류: RPC Error -32079: Origin not allowed
```

### 원인 분석
| 항목 | 내용 |
|------|------|
| 오류 코드 | -32079 |
| 오류 유형 | CORS/Origin 검증 |
| 위치 | 백엔드 (클라우드플레어 워커) |
| 원인 | Ankr RPC가 클라우드플레어 Origin 미등록 |

### 해결 방안

#### 방안 A: 환경 변수 확인 (현재)
```
ANKR_JSON_RPC_HTTPS_ENDPOINT 
설정 값 확인 필요
```

**확인 사항**:
- [ ] 올바른 Ankr RPC URL인가?
- [ ] Ankr 대시보드에서 Origin 등록되었나?
- [ ] 네트워크 연결 확인

#### 방안 B: 다른 RPC 제공자로 변경 (대체)
```typescript
// 예시 - 다른 RPC 제공자
const rpcUrl = 'https://toncenter.com/api/v2/jsonRPC';
// 또는
const rpcUrl = 'https://toncenterapi.com/api/v2/send';
```

**가능한 대체 RPC**:
- Toncenter (`https://toncenter.com`)
- Getblock.io
- QuickNode

#### 방안 C: 프록시 구현
```typescript
// 백엔드에서 프록시 엔드포인트 제공
// /api/rpc-proxy 생성
export async function onRequestPost(context) {
  // 프론트가 아닌 백엔드에서 RPC 호출
  const rpcResponse = await fetch(ANKR_URL, { ... });
  return rpcResponse;
}
```

### 현재 상태
- ⏳ **진행 중**: 환경 변수 확인 필요
- 📋 **대체안**: RPC 제공자 변경 준비

---

## 📊 우선순위

### 🔴 긴급 (지금 해결)
1. **중앙화 방식**: Address 형식 변환 
   - ✅ **완료**: 코드 수정됨
   - ⏳ **대기**: 재테스트

### 🟡 중요 (1시간 내)
2. **RPC 방식**: Origin 문제 해결
   - 📋 **옵션**: 환경변수 확인 또는 RPC 변경

---

## 🔧 이미 적용된 수정사항

### 프론트엔드 변경

#### 1. Address 형식 변환
```typescript
// ✅ 추가: User-Friendly 형식으로 자동 변환
let userFriendlyAddress = wallet.account.address;
if (wallet.account.address.includes(':')) {
  const { Address } = await import('@ton/ton');
  userFriendlyAddress = Address.parse(wallet.account.address).toString();
}
```

#### 2. 향상된 디버그 로그
```typescript
addDebugLog(`📍 주소 변환: ${wallet.account.address.substring(0, 20)}...`);
addDebugLog(`📨 TON Connect 트랜잭션 전송 (주소: ${userFriendlyAddress...})`);
```

#### 3. RPC 오류 처리
```typescript
// ✅ 추가: RPC CORS 오류 구체적 안내
if (errorMsg.includes('Origin not allowed')) {
  addDebugLog('💡 팁: RPC 엔드포인트가 현재 Origin을 허용하지 않습니다');
  addDebugLog('해결책: 환경 변수 ANKR_JSON_RPC_HTTPS_ENDPOINT 확인');
}
```

---

## 🧪 다음 테스트 절차

### 1단계: 중앙화 방식 재테스트 (즉시)
```
1. 인출 화면 접속
2. Jetton 지갑 주소 입력
3. [👤 중앙화 방식] 선택
4. 1000 CSPIN 입력
5. [✓ 중앙화 방식 인출] 클릭
6. 디버그 로그 확인:
   ✅ 주소 변환 메시지 나타나는가?
   ✅ TON Connect 팝업 나타나는가?
   ✅ 서명 후 완료되는가?
```

### 2단계: RPC 방식 테스트 (환경변수 확인 후)
```
1. 환경 변수 확인:
   ANKR_JSON_RPC_HTTPS_ENDPOINT = ?
2. Ankr 대시보드에서 Origin 확인
3. [⚡ RPC 방식] 선택
4. 인출 요청
5. 오류 메시지 확인
```

---

## 📋 다음 조치

### 즉시 (지금)
- [ ] 중앙화 방식 재테스트
- [ ] 디버그 로그 확인
- [ ] Address 변환 작동 여부 확인

### 1시간 내
- [ ] RPC 환경 변수 확인
- [ ] Ankr 대시보드 Origin 등록 상태 확인
- [ ] 필요시 RPC 제공자 변경

### 추가
- [ ] 양쪽 모드 모두 정상 작동 확인
- [ ] 메인넷/테스트넷 모두 테스트
- [ ] 프로덕션 배포

---

## 💡 유용한 팁

### 디버그 로그 활용
```
[▶️ 디버그 로그 보기] 클릭
↓
"주소 변환" 메시지 확인 → 프론트 수정 작동
"TON Connect 트랜잭션 전송" → 백엔드 응답 정상
"서명 오류" → TON Connect 문제
"Origin not allowed" → RPC 설정 문제
```

### 주소 형식 확인
```
체크섬 형식:  0:ac0491ea8b74eda8e16210fd9...
             ↓ 변환 ↓
User-Friendly: EQAswElei3TdqOFiEP2c68f10...
```

### RPC 오류 대응
```
-32079: Origin not allowed
→ Ankr 대시보드에서 Origin 등록
→ 또는 다른 RPC 제공자로 변경
```

---

## 📞 참고

### 관련 파일
- `src/components/GameComplete.tsx` (프론트엔드)
- `functions/api/initiate-withdrawal.ts` (백엔드)
- `wrangler.toml` (환경 변수)

### 관련 이슈
1. TON Connect Address 형식 검증
2. Ankr RPC CORS 정책
3. Jetton 지갑 주소 계산

---

**상태**: 중앙화 방식 1/2 완료, RPC 방식 진행 중 🟡
