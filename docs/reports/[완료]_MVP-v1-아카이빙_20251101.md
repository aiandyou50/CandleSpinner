# 아카이빙 완료 보고서

**작성일**: 2025-11-01  
**작업**: MVP v1 레거시 코드 아카이빙  
**백업 위치**: `archive/legacy-code/mvp-v1-backup-20251101/`

---

## 1. 작업 요약

### 배경
MVP v1 개발 과정에서 다음과 같은 문제점이 발견되었습니다:
- 여러 RPC 방식 혼재 (Ankr, TonCenter v2, v3)
- 스마트 컨트랙트 방식과 RPC 방식 공존
- 인출 기능 오류 (`LITE_SERVER_UNKNOWN: cannot apply external message`)
- 코드 복잡도 증가로 디버깅 어려움

### 결정
전체 코드베이스를 아카이빙하고 클린 아키텍처로 MVP v2를 재구축하기로 결정

---

## 2. 아카이빙된 파일 목록

### 백엔드 (Cloudflare Workers)
```
functions/
├── _bufferPolyfill.ts
├── _headers
├── _rateLimit.ts
├── README.md
├── api/
│   ├── check-jetton-balance.ts
│   ├── credit-to-cspin.ts
│   ├── cspin-to-credit.ts
│   ├── get-credit.ts
│   ├── get-jetton-wallet.ts
│   ├── initiate-withdrawal.ts
│   ├── save-credit.ts
│   └── spin.ts
└── src/
    ├── handlers/
    │   └── initiate-withdrawal.ts
    └── lib/
        ├── mnemonic-utils.ts
        └── rpc-utils.ts (AnkrRpc, TonCenterV2Rpc, TonCenterV3Rpc, SeqnoManager)
```

### 프론트엔드 (React)
```
src/
├── main.tsx
├── App.tsx
├── index.css
├── polyfills.ts
├── constants.ts
├── types.ts
├── app/
│   └── App.tsx
├── features/
│   ├── deposit/
│   ├── game/
│   └── wallet/
├── shared/
│   └── ui/
└── utils/
```

### 설정 파일
```
- package.json (의존성)
- package-lock.json
- tsconfig.json (TypeScript 설정)
- vite.config.ts (Vite 빌드 설정)
- vitest.config.ts (테스트 설정)
- tailwind.config.js (Tailwind CSS)
- postcss.config.js
- wrangler.toml (Cloudflare Workers 설정)
- index.html (엔트리 포인트)
```

### 유틸리티
```
scripts/
├── analyze-address-mismatch.mjs
├── convert-address.mjs
├── create-w5-wallet.mjs
├── derive_jetton_wallet.mjs
├── find-correct-privkey.mjs
├── parse_boc.mjs
├── README.md
└── validate-keys.mjs

wallet-tools/
├── generate-wallet.mjs
├── mnemonic-to-key.mjs
├── README.md
└── secure-mnemonic-to-key.mjs
```

### 정적 파일
```
public/
├── README.md
└── tonconnect-manifest.json
```

---

## 3. 보존된 파일 (아카이빙 제외)

### 문서
- `docs/` - 전체 프로젝트 문서 (SSOT, 지침서, 보고서 등)
- `README.md` - 프로젝트 개요
- `CHANGELOG.md` - 변경 이력
- `LICENSE` - 라이선스
- `kanban.md` - 작업 현황판

### 개발 환경
- `.git/` - Git 저장소
- `.gitignore` - Git 무시 파일
- `.env`, `.env.example`, `.env.local` - 환경 변수
- `.npmrc`, `.nvmrc` - 패키지 관리자 설정

### 기타
- `PoC/` - 개념 증명 코드
- `archive/` - 기존 아카이브 (이번 백업 포함)
- `ton-docs/` - TON 문서
- `node_modules/` - npm 패키지 (재설치 필요)
- `dist/` - 빌드 결과물

---

## 4. 주요 코드 특징 (참고용)

### 4.1 RPC 클라이언트 (혼재 문제)

**AnkrRpc** (`functions/src/lib/rpc-utils.ts`)
- Ankr JSON-RPC 사용
- `sendBoc()`, `getAccountState()`, `getSeqno()` 구현

**TonCenterV2Rpc** (`functions/src/lib/rpc-utils.ts`)
- TonCenter v2 API 사용
- `/api/v2/sendBoc` 엔드포인트
- 응답 형식: `{ ok: boolean, result: T }`

**TonCenterV3Rpc** (`functions/src/lib/rpc-utils.ts`)
- TonCenter v3 API 사용
- `/api/v3/message` 엔드포인트 시도 (실패)
- JSON-RPC 방식

**SeqnoManager** (`functions/src/lib/rpc-utils.ts`)
- seqno 원자성 보장 시도
- KV와 블록체인 seqno 동기화
- 재시도 로직 포함

### 4.2 인출 로직 (문제 발생 지점)

**withdrawViaRpc** (`functions/src/handlers/initiate-withdrawal.ts`)
```typescript
// 게임 지갑에서 사용자 Jetton 지갑으로 전송
// 문제: seqno 불일치, 서명 오류 등으로 실패
const transfer = gameWallet.createTransfer({
  seqno,
  secretKey: keyPair.secretKey,
  messages: [transferMessage],
  sendMode: SendMode.PAY_GAS_SEPARATELY | SendMode.IGNORE_ERRORS
});

const boc = transfer.toBoc().toString('base64');
const txHash = await rpc.sendBoc(boc);
```

**오류 메시지**:
```
LITE_SERVER_UNKNOWN: cannot apply external message to current state : failed to
```

**원인 추정**:
- seqno 불일치 (블록체인 vs KV)
- 지갑 초기화 문제
- 서명 오류
- 복잡한 RPC 클라이언트 전환

---

## 5. MVP v2 개선 방향

### 5.1 인출 방식 변경
- ❌ **기존**: 서버에서 게임 지갑으로 서명 → RPC 전송
- ✅ **신규**: 서버에서 트랜잭션 생성 → 사용자가 지갑에서 서명

### 5.2 RPC 클라이언트 단순화
- ❌ **기존**: 3개 RPC 클라이언트 혼재
- ✅ **신규**: TonCenter v2 단일 사용 (조회 목적만)

### 5.3 아키텍처 명확화
- ✅ TON Connect 중심
- ✅ 클라이언트 측 트랜잭션 서명
- ✅ 서버는 최소 역할 (크레딧 관리, 게임 로직)

---

## 6. 복원 방법 (필요 시)

만약 이전 코드가 필요하다면:

```powershell
# 백업 위치로 이동
cd archive\legacy-code\mvp-v1-backup-20251101

# 특정 파일 복사 (예: RPC 유틸리티)
Copy-Item -Path "functions\src\lib\rpc-utils.ts" -Destination "..\..\..\..\functions\src\lib\" -Force

# 전체 복원 (주의!)
Copy-Item -Path "*" -Destination "..\..\..\..\" -Recurse -Force
```

---

## 7. 다음 단계

- [x] 아카이빙 완료
- [x] MVP v2 재구축 계획 문서 작성
- [ ] 새 프로젝트 구조 생성
- [ ] package.json 초기화
- [ ] TON Connect 통합
- [ ] 핵심 기능 구현

---

**작업 완료 시간**: 2025-11-01 오후 8:13  
**작업자**: GitHub Copilot  
**승인자**: 사용자
