# 인출 기능 수정 - 최종 테스트 계획

**작성일**: 2025-10-25  
**상태**: 🟡 테스트 준비 완료

---

## ✅ 준비 완료된 것

### 1. 중앙화 방식 - 준비 완료 ✅

```
✅ Address 형식 변환: 0:... → EQ... (자동)
✅ Jetton 주소 입력 UI: 사용자가 입력 가능
✅ 테스트 Jetton 지갑: UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_
✅ 디버그 로그: 모든 단계 기록
✅ TON Connect: 서명 가능

상태: 🟢 즉시 테스트 가능
```

### 2. RPC 방식 - 진행 중 🟡

```
✅ Ankr RPC 설정: https://rpc.ankr.com/ton_api_v2/...
✅ 게임 지갑 설정: GAME_WALLET_PRIVATE_KEY 설정됨
✅ 상세 로그: RPC 호출 단계별 기록
❓ Origin 등록: https://aiandyou.me/ (재확인 필요)
❓ CORS 오류: -32079 (진행 중)

상태: 🟡 원인 분석 중, Ankr 설정 재확인 필요
```

---

## 🎯 지금 바로 할 것

### 1️⃣ 중앙화 방식 테스트 (즉시)

**테스트 절차**:
```
1. 게임 실행 → 크레딧 확인
2. [📤 인출] 클릭
3. Jetton 주소 입력:
   UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_
4. [👤 중앙화 방식] 선택
5. 인출액 입력 (예: 10 CSPIN)
6. [✓ 인출] 클릭
7. TON Connect에서 서명
8. 결과 확인
```

**예상 결과**:
```
성공: ✅ CSPIN 인출 완료!
실패: ❌ 서명 오류 또는 API 오류
```

**디버그 로그 확인 포인트**:
```
✅ "📍 주소 변환" 로그?
✅ "📨 BOC 받음" 로그?
✅ "TON Connect 트랜잭션 전송" 로그?
✅ "✅ 트랜잭션 완료" 로그?
```

---

### 2️⃣ Ankr 대시보드 재확인 (5분)

**확인 항목**:
```
1. https://www.ankr.com/rpc/projects/ 접속
2. TON 프로젝트 → Endpoints 탭
3. 현재 설정된 Origin 확인:
   - https://aiandyou.me/ ✅ (등록됨)
   - 클라우드플레어 워커 도메인? (확인 필요)
   - 기타 도메인?
4. 필요시 Origin 추가:
   - https://aiandyou.me/ 다시 확인
   - 클라우드플레어 도메인 추가
5. 변경 후 5분 대기 (캐시 갱신)
```

**결과 기록**:
```
현재 등록된 Origin:
- [ ] https://aiandyou.me/
- [ ] ___________________
- [ ] ___________________

클라우드플레어 워커 도메인 파악?
- [ ] Yes → ___________
- [ ] No  → 파악 필요
```

---

### 3️⃣ RPC 방식 테스트 (Ankr 확인 후)

**테스트 절차** (Ankr 설정 완료 후):
```
1. 중앙화 방식과 동일한 절차
2. [⚡ RPC 방식] 선택
3. 인출 요청
4. 디버그 로그 확인
```

**디버그 로그 포인트**:
```
✅ "[RPC] seqno 조회 완료" 로그?
✅ "[RPC] TON 잔액 확인 통과" 로그?
✅ "[RPC] BOC 생성 완료" 로그?
✅ "[RPC] RPC 서버로 BOC 전송 시작" 로그?
✅ "[RPC] ✅ BOC 전송 성공" 또는 "❌ BOC 전송 실패" 로그?
```

**오류 발생 시**:
```
"Origin not allowed" → Ankr 설정 문제
"RPC HTTP 403/401" → API Key 문제
기타 오류 → 로그에 상세 메시지
```

---

## 📊 상태 정리

### 환경 확인 완료 ✅

| 항목 | 상태 | 값 |
|------|------|-----|
| ANKR_RPC_ENDPOINT | ✅ | https://rpc.ankr.com/ton_api_v2/... |
| GAME_WALLET_PRIVATE_KEY | ✅ | 설정됨 |
| 배포 도메인 | ✅ | https://aiandyou.me/ |
| 테스트 Jetton 지갑 | ✅ | UQCsBJHqi3TtqOFiEP2caPEGQvMnpwz4sz6E760UjOQaKFD_ |
| Jetton 잔액 | ✅ | 150 CSPIN + 1 TON |
| 네트워크 | ✅ | 메인넷 |

### 코드 수정 완료 ✅

| 수정 사항 | 상태 |
|---------|------|
| Address 형식 변환 | ✅ |
| Jetton 주소 입력 UI | ✅ |
| 디버그 로그 (프론트) | ✅ |
| 디버그 로그 (백) | ✅ |
| 오류 처리 | ✅ |

### 테스트 준비 상태

| 테스트 | 상태 |
|--------|------|
| 중앙화 방식 | 🟢 준비 완료 |
| RPC 방식 | 🟡 Ankr 확인 후 |
| 양쪽 모드 통합 | ⏳ 대기 중 |

---

## 💡 주의사항

### 메인넷 테스트 중

⚠️ **실제 자산 사용 중**:
```
현재 잔액:
- CSPIN: 150 토큰
- TON: 1 TON

테스트 시 주의:
- 가스비가 실제로 소모됨
- 한 번에 작은 금액으로 테스트
- 성공 확인 후 진행
- 실패 시 로그 분석
```

### BOC 및 트랜잭션

```
중앙화 방식:
- BOC 생성됨
- 사용자가 TON Connect에서 서명
- 사용자가 네트워크에 제출

RPC 방식:
- 게임 지갑이 직접 서명
- 게임 지갑이 네트워크에 제출
- 즉시 완료
```

---

## 🚀 기대 결과

### 성공 시나리오

```
중앙화 방식 ✅:
1. 디버그 로그에서 모든 단계 진행 확인
2. TON Connect 팝업 나타남
3. 서명 후 "✅ CSPIN 인출 완료!" 메시지
4. 크레딧 차감 확인

RPC 방식 ✅:
1. "[RPC] ✅ BOC 전송 성공" 로그
2. "✅ CSPIN 인출 완료!" 메시지
3. txHash 확인
4. 크레딧 차감 확인
```

### 실패 시나리오

```
중앙화 방식 ❌:
- "Address 형식" 오류 → 이미 수정됨
- "BOC 생성" 오류 → 백엔드 로그 분석
- "TON Connect" 오류 → 지갑 상태 확인

RPC 방식 ❌:
- "Origin not allowed" → Ankr 설정 확인
- "API Key" 오류 → 환경변수 확인
- "RPC HTTP" 오류 → 네트워크 확인
- "seqno" 오류 → 게임 지갑 상태 확인
```

---

## 📋 다음 단계 (우선순위)

### 1️⃣ 지금 (5분)
- [ ] 중앙화 방식 테스트 실행
- [ ] 디버그 로그 기록
- [ ] 결과 보고

### 2️⃣ 동시 진행 (5분)
- [ ] Ankr 대시보드 재확인
- [ ] Origin 설정 상태 확인
- [ ] 필요시 추가 등록

### 3️⃣ 확인 후 (1시간 내)
- [ ] RPC 방식 테스트 실행
- [ ] 양쪽 모드 통합 테스트

### 4️⃣ 완료 후
- [ ] 프로덕션 배포
- [ ] 문서화
- [ ] 사용자 가이드 작성

---

## 📞 필요한 정보

### 테스트 완료 후 보고할 것

```
1. 중앙화 방식 테스트 결과:
   성공/실패: ___________
   디버그 로그: (하단 붙여넣기)
   
2. Ankr 대시보드 확인 결과:
   현재 등록된 Origin: ___________
   클라우드플레어 도메인: ___________
   
3. RPC 방식 테스트 결과:
   성공/실패: ___________
   디버그 로그: (하단 붙여넣기)
```

---

## ✅ 최종 체크리스트

```
준비 단계:
[ ] 게임 실행
[ ] 크레딧 확인
[ ] Ankr 대시보드 북마크

테스트 중앙화:
[ ] 중앙화 방식 테스트 실행
[ ] 디버그 로그 확인
[ ] 결과 기록

테스트 RPC:
[ ] Ankr 설정 재확인
[ ] 필요시 Origin 추가
[ ] 5분 대기
[ ] RPC 방식 테스트 실행
[ ] 디버그 로그 확인
[ ] 결과 기록

최종:
[ ] 양쪽 모드 결과 비교
[ ] 문제점 분석
[ ] 배포 준비
```

---

**모든 준비가 완료되었습니다. 테스트를 진행하세요!** 🚀
