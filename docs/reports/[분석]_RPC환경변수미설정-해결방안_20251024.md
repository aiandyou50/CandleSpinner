# 🔍 RPC 환경변수 분석 및 해결방안

**작성일:** 2025-10-24 16:10  
**상태:** TON_RPC_API_KEY 미설정 확인됨

---

## 📊 현재 상황 분석

### Cloudflare 배포 로그 분석

```
Build environment variables: 
  ✅ BACKEND_RPC_URL: https://rpc.ankr.com/ton_api_v2
  ✅ TON_RPC_HTTPS_ENDPOINT: https://rpc.ankr.com/ton_api_v2
  ❌ TON_RPC_API_KEY: [없음!]
```

### 현재 코드 (initiate-withdrawal.ts)

```typescript
// Line 193-200
const backendRpcUrl = env.BACKEND_RPC_URL || 'https://rpc.ankr.com/ton_api_v2';
const tonRpcApiKey = env.TON_RPC_API_KEY;  // ← undefined!
const rpcUrl = tonRpcApiKey 
  ? `${backendRpcUrl}/${tonRpcApiKey}`
  ? backendRpcUrl;

console.log(`[RPC] 사용 중인 URL: ${rpcUrl.replace(tonRpcApiKey || '', '***API_KEY***')}`);
```

### 결과

```
✅ BACKEND_RPC_URL: "https://rpc.ankr.com/ton_api_v2"
❌ TON_RPC_API_KEY: undefined
↓
🔴 최종 rpcUrl: "https://rpc.ankr.com/ton_api_v2" (API 키 없음!)
```

---

## 🚨 현재 문제

```
❌ 문제 1: TON_RPC_API_KEY가 Cloudflare 환경변수에 미설정
❌ 문제 2: API 키 없이 Ankr RPC 호출하면 제한/실패 가능
❌ 문제 3: 코드에서 API 키 없을 때 처리 미흡
```

---

## ✅ 해결 방안

### **Option A: Cloudflare 환경변수에 TON_RPC_API_KEY 추가 (권장)**

**현재 상황:**
- wrangler.toml에 정의됨 (로컬 개발용)
- Cloudflare 프로덕션에는 미설정

**해결:**
```
Cloudflare 대시보드
→ aiandyou.me (Pages)
→ Settings → Environment variables
→ Production
→ Add variables

Variable name: TON_RPC_API_KEY
Value: [당신의 Ankr API 키]
Type: Encrypted
```

**설정 후 코드:**
```typescript
// initiate-withdrawal.ts 현재 코드는 그대로 사용
const rpcUrl = `${backendRpcUrl}/${tonRpcApiKey}`;
// 결과: https://rpc.ankr.com/ton_api_v2/YOUR_API_KEY ✅
```

---

### **Option B: 코드 개선 (부가 작업)**

현재 코드의 문제점:
```typescript
const rpcUrl = tonRpcApiKey 
  ? `${backendRpcUrl}/${tonRpcApiKey}`
  ? backendRpcUrl;  // ❌ 문법 오류! (? 대신 :)
```

**수정 필요:**
```typescript
const rpcUrl = tonRpcApiKey 
  ? `${backendRpcUrl}/${tonRpcApiKey}`
  : backendRpcUrl;  // ✅ 삼항 연산자 수정
```

---

## 📋 당신이 해야 할 일

### **즉시 (1순위)**

```
1. Cloudflare 대시보드 접속
   https://dash.cloudflare.com/

2. Pages 프로젝트: aiandyou.me

3. Settings → Environment variables

4. Production 환경에 추가:
   ┌─────────────────────────────────┐
   │ Variable name: TON_RPC_API_KEY  │
   │ Value: [Ankr API 키]            │
   │ Type: Encrypted                 │
   └─────────────────────────────────┘

5. Save → 2-3분 대기 (재배포)
```

---

## 🔧 코드 수정 필요 여부

### 현재 코드 상태

```typescript
// functions/api/initiate-withdrawal.ts (Line 193-200)

const backendRpcUrl = env.BACKEND_RPC_URL || 'https://rpc.ankr.com/ton_api_v2';
const tonRpcApiKey = env.TON_RPC_API_KEY;
const rpcUrl = tonRpcApiKey 
  ? `${backendRpcUrl}/${tonRpcApiKey}`
  ? backendRpcUrl;  // ❌ 문법 오류!
```

### 필요한 수정

```typescript
// ✅ 수정됨
const rpcUrl = tonRpcApiKey 
  ? `${backendRpcUrl}/${tonRpcApiKey}`
  : backendRpcUrl;  // ? → :
```

**즉시 수정할 예정입니다!**

---

## 📊 최종 체크리스트

### 당신이 클라우드플레어에 설정할 환경변수 (Production)

```
[ ] 1. GAME_WALLET_PRIVATE_KEY
      Type: Encrypted
      Value: 4e6568d1990bff34...ef7978fc

[ ] 2. GAME_WALLET_ADDRESS ⚠️ 수정 필요
      Type: Secret  
      Value: UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8JaY

[ ] 3. TON_RPC_API_KEY ⚠️ 추가 필요!
      Type: Encrypted
      Value: [당신의 Ankr API 키]

[ ] 4. CSPIN_TOKEN_ADDRESS
      Type: Secret
      Value: EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV
```

---

## 🎯 다음 단계

### 즉시 (당신)
```
1. Cloudflare 환경변수 3개 설정/수정
   - GAME_WALLET_ADDRESS (수정)
   - TON_RPC_API_KEY (추가)
   - 기타 확인
```

### 그 다음 (AI)
```
1. initiate-withdrawal.ts 코드 수정
   - 삼항 연산자 ? → :
   - 기타 검토
```

### 최종 (당신)
```
1. 배포 대기 (2-3분)
2. debug API 테스트
3. 실제 인출 테스트
```

---

## 💡 보너스 정보

### Ankr RPC API 키 없을 때

```
GET https://rpc.ankr.com/ton_api_v2
↓
응답: 401 Unauthorized (또는 429 Rate Limited)
↓
원인: API 키 필수
```

### 올바른 형식

```
https://rpc.ankr.com/ton_api_v2/YOUR_API_KEY
     └─────────────────┬───────────────────┘
                 BACKEND_RPC_URL
                       │
                   + / 기호
                       │
                  + API_KEY
```

---

## 📝 정리

### 현재 문제
- ❌ TON_RPC_API_KEY 미설정
- ❌ initiate-withdrawal.ts 삼항 연산자 오류

### 해결 방법
- ✅ Cloudflare 환경변수 설정 (당신)
- ✅ 코드 수정 (AI)

### 예상 결과
```
TON_RPC_API_KEY 설정
    ↓
rpcUrl = "https://rpc.ankr.com/ton_api_v2/YOUR_API_KEY"
    ↓
Ankr RPC 정상 호출 ✅
```
