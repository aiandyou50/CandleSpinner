# ì¸ì¶œ ë¡œì§ êµ¬í˜„ ê³„íš - ì…ê¸ˆ ì„±ê³µ íŒ¨í„´ ê¸°ë°˜ (ì²˜ìŒë¶€í„° ìƒˆë¡œ êµ¬í˜„)

**ì‘ì„±ì¼**: 2025-11-02  
**ìƒíƒœ**: ğŸ”§ êµ¬í˜„ ëŒ€ê¸°  
**ì¤‘ìš”**: âš ï¸ MVP ì•„ì¹´ì´ë¸ŒëŠ” ì‹¤íŒ¨í•œ ì½”ë“œ! ì…ê¸ˆ ì„±ê³µ ê²½í—˜ì„ ê¸°ë°˜ìœ¼ë¡œ ì²˜ìŒë¶€í„° êµ¬í˜„

---

## ğŸ¯ ëª©í‘œ

**ì…ê¸ˆì˜ ì—­ë°©í–¥ êµ¬í˜„**
- ì…ê¸ˆ: ì‚¬ìš©ì â†’ ê²Œì„ (âœ… ì„±ê³µ)
- ì¸ì¶œ: ê²Œì„ â†’ ì‚¬ìš©ì (âŒ TODO)
- TEP-74 í‘œì¤€ ì •í™•íˆ ì ìš©
- RPC ë°©ì‹ìœ¼ë¡œ ê²Œì„ ì§€ê°‘ì´ ì„œëª…í•˜ì—¬ ì „ì†¡

---

## ğŸ“Š í˜„ì¬ ìƒíƒœ

### ì…ê¸ˆ (ì°¸ê³ ìš© - ì„±ê³µ) âœ…

**êµ¬ì¡°**:
```
ì‚¬ìš©ì Jetton Wallet (sendTransaction ì‹œì‘ì )
    â†“ Jetton Transfer ë©”ì‹œì§€
ê²Œì„ TON ì§€ê°‘ (destination)
    â†“ Jetton Wallet ìë™ ê³„ì‚°
ê²Œì„ Jetton Wallet (ì‹¤ì œ í† í° ìˆ˜ë ¹)
```

**í•µì‹¬ ì½”ë“œ** (`src/components/Deposit.tsx`):
```typescript
// 1. Jetton Transfer Payload (TEP-74)
function buildJettonTransferPayload(
  amount: bigint,
  destination: Address,  // â† ê²Œì„ TON ì§€ê°‘
  responseTo: Address
): string {
  return beginCell()
    .storeUint(0xf8a7ea5, 32)      // op: jetton transfer
    .storeUint(0, 64)              // query_id
    .storeCoins(amount)            // ì…ê¸ˆì•¡
    .storeAddress(destination)     // âœ… ê²Œì„ TON ì§€ê°‘
    .storeAddress(responseTo)      // ì‚¬ìš©ì ì§€ê°‘
    .storeBit(0)                   // custom_payload
    .storeCoins(BigInt(1))         // âœ… forward_ton_amount: 1 nanoton
    .storeBit(0)                   // forward_payload
    .endCell();
}

// 2. TON Connect íŠ¸ëœì­ì…˜
const transaction = {
  messages: [{
    address: userJettonWalletAddress,  // âœ… ì‚¬ìš©ì Jetton Wallet
    amount: toNano('0.2').toString(),   // ìˆ˜ìˆ˜ë£Œ
    payload: buildJettonTransferPayload(
      amount,
      GAME_WALLET_ADDRESS,  // âœ… destination: ê²Œì„ TON ì§€ê°‘
      userWalletAddress
    )
  }]
};

await tonConnectUI.sendTransaction(transaction);
```

### ì¸ì¶œ (TODO - êµ¬í˜„ í•„ìš”) âŒ

**ëª©í‘œ êµ¬ì¡°**:
```
ê²Œì„ Jetton Wallet (RPC ì‹œì‘ì )
    â†“ Jetton Transfer ë©”ì‹œì§€ (ê²Œì„ ì§€ê°‘ ì„œëª…)
ì‚¬ìš©ì TON ì§€ê°‘ (destination)
    â†“ Jetton Wallet ìë™ ê³„ì‚°
ì‚¬ìš©ì Jetton Wallet (ì‹¤ì œ í† í° ìˆ˜ë ¹)
```

**í˜„ì¬ ì½”ë“œ** (`src/index.ts`):
```typescript
// âŒ ì„ì‹œ êµ¬í˜„ (ë¬¸ì œ)
async function handleWithdraw(...) {
  // í¬ë ˆë”§ë§Œ ì°¨ê°
  const newCredit = current.credit - body.amount;
  await env.CREDIT_KV.put(key, ...);
  
  return {
    txHash: 'temp_tx_hash'  // â† ê°€ì§œ!
  };
}
```

---

## ğŸ”§ êµ¬í˜„ ê³„íš

### Phase 1: ë°±ì—”ë“œ - Jetton Transfer ë¡œì§ (ìš°ì„ ìˆœìœ„: ìµœìƒ)

#### 1.1 í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
```typescript
// functions/src/withdraw-handler.ts
import {
  WalletContractV5R1,
  internal,
  beginCell,
  toNano,
  Address,
  SendMode,
  Cell,
} from '@ton/ton';
import { mnemonicToPrivateKey } from '@ton/crypto';
```

#### 1.2 buildJettonTransferPayload() í•¨ìˆ˜
```typescript
/**
 * Jetton Transfer Payload ìƒì„± (TEP-74 í‘œì¤€)
 * ì…ê¸ˆê³¼ ë™ì¼í•œ êµ¬ì¡°, destinationë§Œ ë°˜ëŒ€
 */
function buildJettonTransferPayload(
  amount: bigint,
  destination: Address,  // â† ì‚¬ìš©ì TON ì§€ê°‘ (ì…ê¸ˆê³¼ ë°˜ëŒ€!)
  responseTo: Address,   // â† ê²Œì„ TON ì§€ê°‘
  forwardTonAmount: bigint = BigInt(1)  // âœ… 1 nanoton (ì…ê¸ˆê³¼ ë™ì¼)
): Cell {
  return beginCell()
    .storeUint(0xf8a7ea5, 32)      // op: jetton transfer
    .storeUint(0, 64)              // query_id
    .storeCoins(amount)            // ì¸ì¶œì•¡
    .storeAddress(destination)     // âœ… ì‚¬ìš©ì TON ì§€ê°‘
    .storeAddress(responseTo)      // ê²Œì„ TON ì§€ê°‘
    .storeBit(0)                   // custom_payload (none)
    .storeCoins(forwardTonAmount)  // âœ… 1 nanoton
    .storeBit(0)                   // forward_payload (none)
    .endCell();
}
```

#### 1.3 ê²Œì„ ì§€ê°‘ ìƒì„± (ë‹ˆëª¨ë‹‰ â†’ í‚¤)
```typescript
/**
 * ê²Œì„ ì§€ê°‘ ìƒì„± (ë‹ˆëª¨ë‹‰ì—ì„œ í‚¤ ìŒ ì¶”ì¶œ)
 */
async function getGameWallet(mnemonic: string): Promise<{
  wallet: WalletContractV5R1;
  keyPair: { publicKey: Buffer; secretKey: Buffer };
}> {
  // ë‹ˆëª¨ë‹‰ â†’ í‚¤ ìŒ
  const keyPair = await mnemonicToPrivateKey(mnemonic.split(' '));
  
  // WalletV5R1 ìƒì„±
  const wallet = WalletContractV5R1.create({
    publicKey: keyPair.publicKey,
    workchain: 0,
  });
  
  return { wallet, keyPair };
}
```

#### 1.4 seqno ê´€ë¦¬ (ì›ìì„±)
```typescript
/**
 * seqno ì¡°íšŒ ë° ì¦ê°€ (ì›ìì„± í™•ë³´)
 * KVì— ì €ì¥í•˜ì—¬ ë™ì‹œ ìš”ì²­ ì‹œ ì¶©ëŒ ë°©ì§€
 */
async function getAndIncrementSeqno(
  env: Env,
  gameWalletAddress: string
): Promise<number> {
  const key = `seqno:${gameWalletAddress}`;
  
  // KVì—ì„œ ì¡°íšŒ
  const stored = await env.CREDIT_KV.get(key, 'json') as { seqno: number } | null;
  
  if (!stored) {
    // ì²« ì‚¬ìš©: RPCì—ì„œ ì‹¤ì œ seqno ì¡°íšŒ
    const response = await fetch(
      `https://toncenter.com/api/v2/getAddressState?address=${gameWalletAddress}`,
      {
        headers: {
          'X-API-Key': env.TONCENTER_API_KEY,
        },
      }
    );
    const data = await response.json();
    const currentSeqno = data.result?.seqno || 0;
    
    // KVì— ì €ì¥
    await env.CREDIT_KV.put(key, JSON.stringify({ seqno: currentSeqno + 1 }));
    return currentSeqno;
  }
  
  // ì €ì¥ëœ seqno ì¦ê°€
  const nextSeqno = stored.seqno;
  await env.CREDIT_KV.put(key, JSON.stringify({ seqno: nextSeqno + 1 }));
  return nextSeqno;
}
```

#### 1.5 ê²Œì„ Jetton Wallet ì£¼ì†Œ ê³„ì‚°
```typescript
/**
 * ê²Œì„ì˜ Jetton Wallet ì£¼ì†Œ ê³„ì‚°
 * (ì…ê¸ˆì˜ userJettonWalletAddressì™€ ë™ì¼í•œ ë¡œì§)
 */
async function getGameJettonWalletAddress(
  env: Env
): Promise<string> {
  const response = await fetch(
    `https://toncenter.com/api/v2/runGetMethod`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': env.TONCENTER_API_KEY,
      },
      body: JSON.stringify({
        address: env.CSPIN_TOKEN_ADDRESS,  // Jetton Master
        method: 'get_wallet_address',
        stack: [
          ['tvm.Slice', Address.parse(env.GAME_WALLET_ADDRESS).toRawString()]
        ]
      })
    }
  );
  
  const data = await response.json();
  const cell = Cell.fromBase64(data.result.stack[0][1].bytes);
  const address = cell.beginParse().loadAddress();
  
  return address.toString({ urlSafe: true, bounceable: true });
}
```

#### 1.6 ë©”ì¸ ì¸ì¶œ í•¨ìˆ˜
```typescript
/**
 * ì¸ì¶œ ì²˜ë¦¬ (RPC ë°©ì‹)
 */
async function processWithdrawal(
  env: Env,
  userWalletAddress: string,
  withdrawAmount: number
): Promise<{ success: boolean; txHash: string }> {
  // 1. í™˜ê²½ë³€ìˆ˜ í™•ì¸
  const { GAME_WALLET_MNEMONIC, GAME_WALLET_ADDRESS, CSPIN_TOKEN_ADDRESS, TONCENTER_API_KEY } = env;
  
  if (!GAME_WALLET_MNEMONIC || !GAME_WALLET_ADDRESS || !CSPIN_TOKEN_ADDRESS || !TONCENTER_API_KEY) {
    throw new Error('í™˜ê²½ë³€ìˆ˜ ëˆ„ë½: GAME_WALLET_MNEMONIC, GAME_WALLET_ADDRESS, CSPIN_TOKEN_ADDRESS, TONCENTER_API_KEY');
  }
  
  // 2. ê²Œì„ ì§€ê°‘ ìƒì„±
  const { wallet: gameWallet, keyPair } = await getGameWallet(GAME_WALLET_MNEMONIC);
  console.log(`ê²Œì„ ì§€ê°‘: ${gameWallet.address.toString()}`);
  
  // 3. seqno ì¡°íšŒ (ì›ìì„±)
  const seqno = await getAndIncrementSeqno(env, gameWallet.address.toString());
  console.log(`seqno: ${seqno}`);
  
  // 4. ê²Œì„ Jetton Wallet ì£¼ì†Œ ê³„ì‚°
  const gameJettonWallet = await getGameJettonWalletAddress(env);
  console.log(`ê²Œì„ Jetton Wallet: ${gameJettonWallet}`);
  
  // 5. Jetton Transfer Payload ìƒì„±
  const amountNano = toNano(withdrawAmount.toString());
  const payload = buildJettonTransferPayload(
    amountNano,
    Address.parse(userWalletAddress),  // âœ… destination: ì‚¬ìš©ì TON ì§€ê°‘
    gameWallet.address                 // responseTo: ê²Œì„ TON ì§€ê°‘
  );
  
  // 6. ë‚´ë¶€ ë©”ì‹œì§€ ìƒì„±
  const internalMessage = internal({
    to: Address.parse(gameJettonWallet),  // âœ… ê²Œì„ Jetton Wallet (ë©”ì‹œì§€ ìˆ˜ì‹ ì)
    value: toNano('0.05'),                // ìˆ˜ìˆ˜ë£Œ (ì…ê¸ˆë³´ë‹¤ ì•½ê°„ ë†’ê²Œ)
    body: payload
  });
  
  // 7. íŠ¸ëœì­ì…˜ ìƒì„± (ê²Œì„ ì§€ê°‘ ì„œëª…)
  const transfer = gameWallet.createTransfer({
    seqno,
    secretKey: keyPair.secretKey,  // âœ… ê²Œì„ ì§€ê°‘ ê°œì¸í‚¤
    messages: [internalMessage],
    sendMode: SendMode.PAY_GAS_SEPARATELY | SendMode.IGNORE_ERRORS
  });
  
  // 8. BOC ìƒì„±
  const boc = transfer.toBoc().toString('base64');
  console.log(`BOC ê¸¸ì´: ${boc.length}`);
  
  // 9. TonCenter v2 sendBoc
  const sendResponse = await fetch(
    'https://toncenter.com/api/v2/sendBoc',
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': TONCENTER_API_KEY,
      },
      body: JSON.stringify({ boc })
    }
  );
  
  const sendData = await sendResponse.json();
  
  if (!sendResponse.ok || !sendData.ok) {
    throw new Error(`BOC ì „ì†¡ ì‹¤íŒ¨: ${sendData.error || 'Unknown error'}`);
  }
  
  const txHash = sendData.result.hash;
  console.log(`âœ… ì¸ì¶œ ì„±ê³µ: ${txHash}`);
  
  return {
    success: true,
    txHash
  };
}
```

#### 1.7 handleWithdraw() ìˆ˜ì •
```typescript
// src/index.ts
async function handleWithdraw(
  request: Request,
  env: Env,
  corsHeaders: Record<string, string>
): Promise<Response> {
  try {
    const body = await request.json() as {
      walletAddress: string;
      amount: number;
    };
    
    // 1. í¬ë ˆë”§ í™•ì¸
    const key = `credit:${body.walletAddress}`;
    const current = await env.CREDIT_KV.get(key, 'json') as { credit: number } | null;
    
    if (!current || current.credit < body.amount) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Insufficient credit'
      }), {
        status: 400,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
    
    // 2. ì¸ì¶œ ì²˜ë¦¬ (RPC)
    const result = await processWithdrawal(env, body.walletAddress, body.amount);
    
    // 3. í¬ë ˆë”§ ì°¨ê° (ì„±ê³µ í›„)
    const newCredit = current.credit - body.amount;
    await env.CREDIT_KV.put(key, JSON.stringify({
      credit: newCredit,
      lastUpdated: new Date().toISOString()
    }));
    
    return new Response(JSON.stringify({
      success: true,
      txHash: result.txHash,  // âœ… ì‹¤ì œ íŠ¸ëœì­ì…˜ í•´ì‹œ!
      amount: body.amount,
      credit: newCredit
    }), {
      status: 200,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
    
  } catch (error) {
    console.error('Withdraw error:', error);
    return new Response(JSON.stringify({
      success: false,
      error: error instanceof Error ? error.message : 'Withdrawal failed'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
}
```

---

### Phase 2: í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ìš°ì„ ìˆœìœ„: ìµœìƒ)

#### 2.1 í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜
```env
# .dev.vars (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
GAME_WALLET_MNEMONIC=word1 word2 word3 ... word24
GAME_WALLET_ADDRESS=UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
CSPIN_TOKEN_ADDRESS=EQD...
TONCENTER_API_KEY=your_api_key_here
```

#### 2.2 Cloudflare Dashboard ì„¤ì •
```
Workers & Pages â†’ CandleSpinner â†’ Settings â†’ Variables
â†’ ë™ì¼í•œ í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ (í”„ë¡œë•ì…˜)
```

---

### Phase 3: í…ŒìŠ¤íŠ¸ (ìš°ì„ ìˆœìœ„: ë†’ìŒ)

#### 3.1 ë¡œì»¬ í…ŒìŠ¤íŠ¸
```bash
# 1. í™˜ê²½ë³€ìˆ˜ í™•ì¸
cat .dev.vars

# 2. ê°œë°œ ì„œë²„ ì‹¤í–‰
npm run dev

# 3. ë¸Œë¼ìš°ì €ì—ì„œ ì¸ì¶œ í…ŒìŠ¤íŠ¸
- ê²Œì„ í™”ë©´ ì§„ì…
- í¬ë ˆë”§ í™•ì¸ (10 CSPIN ë³´ìœ )
- [ğŸ“¤ ì¸ì¶œ] ë²„íŠ¼ í´ë¦­
- ì¸ì¶œì•¡ ì…ë ¥: 1 CSPIN
- [Withdraw] ë²„íŠ¼ í´ë¦­
```

#### 3.2 ê²€ì¦
```
âœ… íŒì—…ì— ì‹¤ì œ íŠ¸ëœì­ì…˜ í•´ì‹œ í‘œì‹œ
âœ… ë¸”ë¡ì²´ì¸ ìµìŠ¤í”Œë¡œëŸ¬ì—ì„œ í™•ì¸
    https://tonviewer.com/<txHash>
âœ… ì‚¬ìš©ì ì§€ê°‘ì— CSPIN ë„ì°© í™•ì¸
âœ… í¬ë ˆë”§ ê°ì†Œ í™•ì¸
```

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. destinationì€ TON ì§€ê°‘!
```typescript
// âœ… ì˜¬ë°”ë¥¸ ë°©ì‹
destination: Address.parse(userWalletAddress)  // ì‚¬ìš©ì TON ì§€ê°‘

// âŒ ì˜ëª»ëœ ë°©ì‹
destination: Address.parse(userJettonWalletAddress)  // Jetton ì§€ê°‘ X
```

### 2. forward_ton_amountëŠ” 1 nanoton
```typescript
// âœ… ì…ê¸ˆê³¼ ë™ì¼
.storeCoins(BigInt(1))  // 1 nanoton

// âŒ ë¶ˆí•„ìš”í•˜ê²Œ ë†’ìŒ
.storeCoins(toNano('0.005'))  // 5,000,000 nanoton
```

### 3. seqno ì›ìì„± í™•ë³´
```typescript
// âœ… KV ì‚¬ìš© (ë™ì‹œ ìš”ì²­ ëŒ€ì‘)
const seqno = await getAndIncrementSeqno(env, gameWallet.address);

// âŒ RPC ì§ì ‘ ì¡°íšŒ (ê²½ìŸ ì¡°ê±´)
const seqno = await rpc.getSeqno(gameWallet.address);
```

### 4. í¬ë ˆë”§ ì°¨ê° íƒ€ì´ë°
```typescript
// âœ… íŠ¸ëœì­ì…˜ ì„±ê³µ í›„
const result = await processWithdrawal(...);
await env.CREDIT_KV.put(key, ...);  // í¬ë ˆë”§ ì°¨ê°

// âŒ íŠ¸ëœì­ì…˜ ì „ (ì‹¤íŒ¨ ì‹œ ë³µêµ¬ í•„ìš”)
await env.CREDIT_KV.put(key, ...);
const result = await processWithdrawal(...);
```

---

## ğŸ“ˆ ì˜ˆìƒ ì¼ì •

| Phase | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ | ìš°ì„ ìˆœìœ„ |
|-------|------|-----------|----------|
| 1 | ë°±ì—”ë“œ ë¡œì§ êµ¬í˜„ | 3-4ì‹œê°„ | ìµœìƒ |
| 2 | í™˜ê²½ë³€ìˆ˜ ì„¤ì • | 30ë¶„ | ìµœìƒ |
| 3 | í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹… | 1-2ì‹œê°„ | ë†’ìŒ |
| **ì´ê³„** | | **4-6ì‹œê°„** | |

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] buildJettonTransferPayload() êµ¬í˜„ (TEP-74)
- [ ] getGameWallet() êµ¬í˜„ (ë‹ˆëª¨ë‹‰ â†’ í‚¤)
- [ ] getAndIncrementSeqno() êµ¬í˜„ (ì›ìì„±)
- [ ] getGameJettonWalletAddress() êµ¬í˜„
- [ ] processWithdrawal() êµ¬í˜„ (ë©”ì¸ ë¡œì§)
- [ ] handleWithdraw() ìˆ˜ì • (temp_tx_hash ì œê±°)
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ë¡œì»¬ + Cloudflare)
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ í™•ì¸

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ì…ê¸ˆ ì„±ê³µ ì½”ë“œ
- `src/components/Deposit.tsx` (TEP-74 êµ¬í˜„ ì°¸ê³ )
- `docs/troubleshooting/ì…ê¸ˆì„±ê³µê²½í—˜_MVPë¶„ì„ìœ¼ë¡œí•´ê²°_20251102.md`

### TON ê³µì‹ ë¬¸ì„œ
- TEP-74: https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md
- TonCenter API: https://toncenter.com/api/v2/
- @ton/ton ë¼ì´ë¸ŒëŸ¬ë¦¬: https://github.com/ton-org/ton

### ê¸°ì¡´ ê³„íš ë¬¸ì„œ (ì°¸ê³ ìš©)
- `docs/instructions/Task2-ë³´ì•ˆì¸ì¶œë¡œì§-seqnoì›ìì„±_20251024_000000.md`
- âš ï¸ MVP ì•„ì¹´ì´ë¸ŒëŠ” ì‹¤íŒ¨ ì½”ë“œì´ë¯€ë¡œ ì°¸ê³ ë§Œ!

---

**í•µì‹¬ ì›ì¹™**: ì…ê¸ˆì˜ ì—­ë°©í–¥ + TEP-74 í‘œì¤€ ì¤€ìˆ˜
