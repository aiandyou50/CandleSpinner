# 🛠️ 스마트컨트랙트 구현 기술 가이드
## Tact 코드 + 배포 + 게임 통합 완전 교육서

**작성일**: 2025년 10월 25일  
**대상**: CandleSpinner 게임 팀  
**난이도**: 초급 ~ 중급

---

## 📑 목차

1. [환경 설정](#환경-설정)
2. [Tact 스마트컨트랙트 작성](#tact-스마트컨트랙트-작성)
3. [테스트 및 배포](#테스트-및-배포)
4. [게임 백엔드 통합](#게임-백엔드-통합)
5. [모니터링 및 유지보수](#모니터링-및-유지보수)

---

## 환경 설정

### 1️⃣ 필수 도구 설치

```bash
# Node.js 18+ 설치 확인
node --version  # v18.0.0 이상

# TON Blueprint 프로젝트 생성
npm create ton@latest contracts -- --type tact-contract
cd contracts

# 모든 의존성 설치
npm install

# 설치된 패키지 확인
npm ls
```

**설치될 주요 패키지:**
```json
{
  "@ton/ton": "^14.0.0",
  "@ton/core": "^0.55.0",
  "ton": "^13.0.0",
  "tact": "^4.0.0"
}
```

---

### 2️⃣ 프로젝트 구조

```
contracts/
├── sources/
│   ├── WithdrawalManager.tact       ← 우리가 작성할 스마트컨트랙트
│   └── stdlib/
├── wrappers/
│   └── WithdrawalManager.ts         ← 컨트랙트 래퍼 (자동 생성)
├── tests/
│   └── WithdrawalManager.spec.ts    ← 테스트 코드
├── scripts/
│   └── deployWithdrawalManager.ts   ← 배포 스크립트
├── build/                           ← 컴파일 결과
└── package.json
```

---

### 3️⃣ wrangler.toml 설정 (Cloudflare Workers)

**파일: `wrangler.toml` (루트 디렉토리)**

```toml
name = "candlespinner"
type = "javascript"
account_id = "YOUR_ACCOUNT_ID"
workers_dev = true

# 환경 변수
[env.production]
vars = {
  WITHDRAWAL_MANAGER = "EQD...",  # 배포 후 저장
  CSPIN_JETTON = "EQB...",        # CSPIN Jetton Master
  GAME_JETTON_WALLET = "EQC...",  # 게임의 CSPIN 지갑
  TON_NETWORK = "mainnet",
  RPC_ENDPOINT = "https://toncenter.com/api/v2/jsonRPC"
}

[env.testnet]
vars = {
  WITHDRAWAL_MANAGER = "EQD...",  # 테스트넷 배포 후
  CSPIN_JETTON = "EQB...",
  GAME_JETTON_WALLET = "EQC...",
  TON_NETWORK = "testnet",
  RPC_ENDPOINT = "https://testnet.toncenter.com/api/v2/jsonRPC"
}

# Cloudflare Pages 연결
[build]
command = "npm run build"
cwd = "./"

# KV 바인딩
[[kv_namespaces]]
binding = "CREDIT_KV"
id = "YOUR_KV_ID"
```

---

## Tact 스마트컨트랙트 작성

### 📝 Step 1: 기본 컨트랙트 구조

**파일: `contracts/sources/WithdrawalManager.tact`**

```tact
#pragma version >=0.2.0;

import "@stdlib/deploy";
import "@stdlib/ownable";
import "@stdlib/stoppable";

/**
 * Jetton 표준 상수 (TEP-74)
 * @see https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md
 */
const JETTON_TRANSFER: Int = 0xf8a7ea5;
const JETTON_TRANSFER_NOTIFICATION: Int = 0x7362d09c;
const JETTON_BURN_NOTIFICATION: Int = 0x7bdd97de;
const SEND_REMAINING_GAS: Int = 2;

/**
 * 게임 메시지 타입 (opcode)
 */
const OP_WITHDRAWAL_REQUEST: Int = 0x57495452;    // "WITR"
const OP_WITHDRAWAL_SUCCESS: Int = 0x57495453;    // "WITS"
const OP_WITHDRAWAL_FAILED: Int = 0x57495446;     // "WITF"
const OP_GAS_COLLECTION: Int = 0x47415344;        // "GASD"

/**
 * 사용자 지불형 CSPIN 인출 스마트컨트랙트
 * 
 * 주요 기능:
 * 1. 게임이 보유한 CSPIN 토큰 보관
 * 2. 사용자 인출 요청 처리
 * 3. 사용자 지갑에서 가스비 청구
 * 4. Jetton 표준 준수하여 토큰 전송
 */
contract WithdrawalManager with Deployable, Ownable {
    
    // ========== 상태 변수 ==========
    
    owner: Address;                      // 게임 관리자
    jettonMaster: Address;               // CSPIN Jetton 마스터
    gameJettonWallet: Address;           // 게임의 CSPIN 지갑
    
    // 모니터링 변수
    processedRequests: Int = 0;          // 처리된 요청 수
    totalWithdrawn: Int = 0;             // 총 출금액
    totalGasCollected: Int = 0;          // 징수한 총 가스비
    
    paused: Bool = false;                // 긴급 정지 플래그
    
    // ========== 메시지 타입 정의 ==========
    
    message WithdrawalRequest {
        queryId: UInt64;
        amount: Coins;                   // nanotons
        destination: Address;            // 수신자
    }
    
    message WithdrawGasCollection {
        queryId: UInt64;
    }
    
    // ========== 초기화 ==========
    
    init(jettonMaster: Address, gameJettonWallet: Address) {
        self.owner = sender();
        self.jettonMaster = jettonMaster;
        self.gameJettonWallet = gameJettonWallet;
    }
    
    // ========== 핵심 함수 ==========
    
    /**
     * 인출 요청 처리
     */
    receive(msg: WithdrawalRequest) {
        // 권한 검증
        self.requireOwner();
        require(!self.paused, "Contract is paused");
        
        // 입력값 검증
        require(msg.amount > 0, "Amount must be positive");
        require(msg.amount <= ton("1000000"), "Amount exceeds limit");
        
        // 가스비 정의
        let gasFee: Coins = ton("0.01");
        let forwardAmount: Coins = ton("0.001");
        let transactionFee: Coins = ton("0.05");
        
        // 게임 Jetton 지갑이 존재하는지 확인
        let jettonWalletAddress: Address = self.gameJettonWallet;
        
        // Jetton Transfer 메시지 구성 (TEP-74)
        let transferBody: Cell = beginCell()
            .storeUint(JETTON_TRANSFER, 32)
            .storeUint(msg.queryId, 64)
            .storeCoins(msg.amount)
            .storeAddress(msg.destination)  // 수신자
            .storeAddress(self.owner)       // 응답 주소
            .storeBit(0)                    // custom_payload (없음)
            .storeCoins(forwardAmount)      // forward_ton_amount
            .storeBit(0)                    // forward_payload (없음)
            .endCell();
        
        // 1️⃣ Jetton 전송
        send(SendParameters{
            to: jettonWalletAddress,
            amount: transactionFee,
            mode: SendPayGasSeparately,
            body: transferBody
        });
        
        // 2️⃣ 가스비 청구 (사용자 지갑으로)
        send(SendParameters{
            to: sender(),
            amount: gasFee,
            mode: SendIgnoreErrors,
            body: emptyCell()
        });
        
        // 3️⃣ 상태 업데이트
        self.processedRequests += 1;
        self.totalWithdrawn += msg.amount;
        self.totalGasCollected += gasFee;
    }
    
    /**
     * 긴급 정지 (선택사항)
     */
    receive("pause") {
        self.requireOwner();
        self.paused = true;
    }
    
    /**
     * 재개 (선택사항)
     */
    receive("resume") {
        self.requireOwner();
        self.paused = false;
    }
    
    /**
     * 징수한 가스비 회수 (선택사항)
     */
    receive(msg: WithdrawGasCollection) {
        self.requireOwner();
        
        if (self.totalGasCollected > 0) {
            let amount = self.totalGasCollected;
            self.totalGasCollected = 0;
            
            send(SendParameters{
                to: sender(),
                amount: amount,
                mode: SendIgnoreErrors,
                body: emptyCell()
            });
        }
    }
    
    // ========== Getter 함수 ==========
    
    get fun stats(): (Int, Int, Int, Bool) {
        return (self.processedRequests, self.totalWithdrawn, self.totalGasCollected, self.paused);
    }
    
    get fun isPaused(): Bool {
        return self.paused;
    }
    
    get fun owner(): Address {
        return self.owner;
    }
}
```

---

### 📝 Step 2: 테스트 코드 작성

**파일: `contracts/tests/WithdrawalManager.spec.ts`**

```typescript
import { Blockchain, SandboxContract, TreasuryContract } from '@ton/sandbox';
import { Cell, toNano, beginCell, Address } from '@ton/core';
import { WithdrawalManager } from '../wrappers/WithdrawalManager';
import { compile } from '@ton/blueprint';

describe('WithdrawalManager', () => {
    let blockchain: Blockchain;
    let withdrawalManager: SandboxContract<WithdrawalManager>;
    let owner: SandboxContract<TreasuryContract>;
    let jettonMaster: Address;
    let gameJettonWallet: Address;

    beforeEach(async () => {
        blockchain = await Blockchain.create();
        
        // 테스트 주소 생성
        owner = await blockchain.treasury('owner');
        jettonMaster = Address.parse('EQBvp...'); // 테스트 Jetton Master
        gameJettonWallet = Address.parse('EQCv...'); // 테스트 Jetton Wallet
        
        // 컨트랙트 배포
        const code = await compile('WithdrawalManager');
        withdrawalManager = blockchain.openContract(
            WithdrawalManager.createFromConfig({
                jettonMaster,
                gameJettonWallet,
                owner: owner.address,
            }, code)
        );
        
        // 초기화
        const deployResult = await withdrawalManager.sendDeploy(owner.getSender(), toNano('0.05'));
        expect(deployResult.transactions).toHaveTransaction({
            from: owner.address,
            to: withdrawalManager.address,
            deploy: true,
            success: true,
        });
    });

    it('should deploy correctly', async () => {
        const stats = await withdrawalManager.getStats();
        expect(stats.processedRequests).toEqual(0);
        expect(stats.totalWithdrawn).toEqual(0);
    });

    it('should handle withdrawal request', async () => {
        const userAddress = await blockchain.treasury('user');
        const amount = toNano('10');
        
        const result = await withdrawalManager.sendWithdrawalRequest(
            owner.getSender(),
            {
                amount: amount,
                destination: userAddress.address,
            }
        );
        
        expect(result.transactions).toHaveLength(2); // 요청 + Jetton 전송
    });

    it('should reject non-owner requests', async () => {
        const attacker = await blockchain.treasury('attacker');
        const user = await blockchain.treasury('user');
        
        const result = await withdrawalManager.sendWithdrawalRequest(
            attacker.getSender(),
            {
                amount: toNano('10'),
                destination: user.address,
            }
        );
        
        expect(result.transactions).toHaveTransaction({
            success: false,
        });
    });

    it('should pause and resume', async () => {
        await withdrawalManager.sendPause(owner.getSender());
        let stats = await withdrawalManager.getStats();
        expect(stats.paused).toBe(true);
        
        await withdrawalManager.sendResume(owner.getSender());
        stats = await withdrawalManager.getStats();
        expect(stats.paused).toBe(false);
    });
});
```

---

### 📝 Step 3: 배포 스크립트

**파일: `contracts/scripts/deployWithdrawalManager.ts`**

```typescript
import { Address, toNano } from '@ton/core';
import { WithdrawalManager } from '../wrappers/WithdrawalManager';
import { compile, NetworkProvider } from '@ton/blueprint';

export async function run(provider: NetworkProvider) {
    // ===== 설정 =====
    
    // 환경 변수에서 주소 읽기
    const CSPIN_JETTON = Address.parse(process.env.CSPIN_JETTON || '');
    const GAME_JETTON_WALLET = Address.parse(process.env.GAME_JETTON_WALLET || '');
    
    console.log(`
    🔧 WithdrawalManager 배포 준비
    
    CSPIN Jetton: ${CSPIN_JETTON}
    Game Jetton Wallet: ${GAME_JETTON_WALLET}
    `);
    
    // ===== 컴파일 =====
    
    console.log('📦 컨트랙트 컴파일 중...');
    const code = await compile('WithdrawalManager');
    
    // ===== 배포자 지갑 연결 =====
    
    const ui = provider.ui();
    const deployer = ui.write('Deployer address:'); // 사용자 입력
    const deployerAddress = Address.parse(deployer);
    
    // ===== 컨트랙트 배포 =====
    
    const withdrawal = provider.open(
        WithdrawalManager.createFromConfig({
            jettonMaster: CSPIN_JETTON,
            gameJettonWallet: GAME_JETTON_WALLET,
        }, code)
    );
    
    // 이미 배포된 경우 건너뛰기
    if (await provider.isContractDeployed(withdrawal.address)) {
        console.log(`✅ 컨트랙트가 이미 배포됨: ${withdrawal.address}`);
        return;
    }
    
    console.log(`📤 배포 중... (${withdrawal.address})`);
    
    // 배포 트랜잭션 전송
    await withdrawal.sendDeploy(
        provider.sender(),
        toNano('0.1')  // 배포 비용
    );
    
    // 배포 확인
    console.log('⏳ 배포 확인 중...');
    await provider.waitForDeploy(withdrawal.address);
    
    console.log(`
    ✅ 배포 완료!
    
    컨트랙트 주소: ${withdrawal.address}
    
    다음 단계:
    1. wrangler.toml에 주소 저장
    2. 게임 Jetton 지갑에 CSPIN 토큰 예치
    3. 백엔드에서 스마트컨트랙트 호출
    `);
}
```

---

## 테스트 및 배포

### 1️⃣ 로컬 테스트

```bash
# 테스트 실행
npm run test

# 결과:
# ✅ WithdrawalManager
#   ✓ should deploy correctly (234ms)
#   ✓ should handle withdrawal request (156ms)
#   ✓ should reject non-owner requests (89ms)
#   ✓ should pause and resume (123ms)
```

---

### 2️⃣ 테스트넷 배포

```bash
# 환경 변수 설정 (TON testnet)
export CSPIN_JETTON="EQBt5..."  # testnet CSPIN
export GAME_JETTON_WALLET="EQC..."

# 테스트넷 배포
npm run deploy -- --testnet

# 입력:
# Deployer address: <your_testnet_wallet>

# 결과:
# ✅ 배포 완료!
# 컨트랙트 주소: EQD... (저장하기!)
```

---

### 3️⃣ 메인넷 배포

```bash
# ⚠️ MAINNET 배포 (실제 비용 약 $6)

# 환경 변수 설정 (TON mainnet)
export CSPIN_JETTON="EQBvp..." # mainnet CSPIN
export GAME_JETTON_WALLET="EQCv..."
export NODE_ENV="mainnet"

# 메인넷 배포
npm run deploy -- --mainnet

# 입력:
# Deployer address: <your_mainnet_wallet>

# 결과:
# ✅ 배포 완료!
# 컨트랙트 주소: EQD...

# ⚠️ 주소를 안전한 곳에 저장!
```

**배포 후:**
```bash
# wrangler.toml 업데이트
[env.production]
vars = {
  WITHDRAWAL_MANAGER = "EQD...",  # ← 배포된 주소
  ...
}
```

---

## 게임 백엔드 통합

### 1️⃣ 타입 정의 추가

**파일: `functions/api/types.ts` (신규)**

```typescript
/**
 * 스마트컨트랙트 관련 타입 정의
 */

export interface SmartContractConfig {
  address: string;           // 컨트랙트 주소
  jettonMaster: string;      // CSPIN Jetton Master
  gameJettonWallet: string;  // 게임의 CSPIN 지갑
}

export interface WithdrawalRequest {
  queryId: bigint;
  amount: bigint;            // nanotons
  destination: string;       // 사용자 지갑
}

export interface WithdrawalResponse {
  success: boolean;
  txHash?: string;
  amount?: number;
  error?: string;
  status: 'pending' | 'confirmed' | 'failed';
}

export interface ContractStats {
  processedRequests: bigint;
  totalWithdrawn: bigint;
  totalGasCollected: bigint;
  isPaused: boolean;
}
```

---

### 2️⃣ 스마트컨트랙트 통합 모듈

**파일: `functions/api/smartcontract-utils.ts` (신규)**

```typescript
import { TonClient, Contract, ContractProvider, Sender } from '@ton/ton';
import { Address, toNano, Cell, beginCell } from '@ton/core';
import { SmartContractConfig, WithdrawalRequest, WithdrawalResponse, ContractStats } from './types';

/**
 * 스마트컨트랙트 유틸리티
 */
export class WithdrawalManagerClient {
  private client: TonClient;
  private config: SmartContractConfig;
  private contractAddress: Address;

  constructor(endpoint: string, config: SmartContractConfig) {
    this.client = new TonClient({ endpoint });
    this.config = config;
    this.contractAddress = Address.parse(config.address);
  }

  /**
   * 인출 요청 메시지 생성
   */
  async createWithdrawalMessage(request: WithdrawalRequest): Promise<Cell> {
    return beginCell()
      .storeUint(0x57495452, 32)         // OP_WITHDRAWAL_REQUEST
      .storeUint(request.queryId, 64)
      .storeCoins(request.amount)
      .storeAddress(Address.parse(request.destination))
      .endCell();
  }

  /**
   * 컨트랙트 상태 조회
   */
  async getStats(): Promise<ContractStats> {
    try {
      const data = await this.client.runMethod(
        this.contractAddress,
        'get_stats'
      );

      return {
        processedRequests: BigInt(data.stack[0].type === 'int' ? data.stack[0].value : 0),
        totalWithdrawn: BigInt(data.stack[1].type === 'int' ? data.stack[1].value : 0),
        totalGasCollected: BigInt(data.stack[2].type === 'int' ? data.stack[2].value : 0),
        isPaused: data.stack[3].type === 'int' ? data.stack[3].value !== 0 : false,
      };
    } catch (error) {
      console.error('Failed to get contract stats:', error);
      throw new Error('Cannot retrieve contract statistics');
    }
  }

  /**
   * 현재 가스비 조회
   */
  async getGasFee(): Promise<bigint> {
    return toNano('0.01');  // 고정 비용
  }
}

/**
 * 핸들러: 스마트컨트랙트 방식 인출
 */
export async function handleSmartContractWithdrawal(
  context: { env: any },
  userAddress: string,
  amount: number,
  queryId: bigint
): Promise<WithdrawalResponse> {
  const { env } = context;

  try {
    // 1️⃣ 클라이언트 초기화
    const client = new WithdrawalManagerClient(
      env.TON_RPC_ENDPOINT || 'https://toncenter.com/api/v2/jsonRPC',
      {
        address: env.WITHDRAWAL_MANAGER,
        jettonMaster: env.CSPIN_JETTON,
        gameJettonWallet: env.GAME_JETTON_WALLET,
      }
    );

    // 2️⃣ 인출 메시지 생성
    const message = await client.createWithdrawalMessage({
      queryId,
      amount: toNano(amount.toString()),
      destination: userAddress,
    });

    // 3️⃣ 트랜잭션 생성 (여기서는 데이터만 반환, 실제 전송은 프론트엔드에서)
    const transactionData = {
      to: env.WITHDRAWAL_MANAGER,
      value: toNano('0.05').toString(),
      payload: message.toBoc().toString('base64'),
    };

    // 4️⃣ 응답 반환
    return {
      success: true,
      amount,
      status: 'pending',
    };
  } catch (error) {
    console.error('[SmartContract Withdrawal] Error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
      status: 'failed',
    };
  }
}
```

---

### 3️⃣ 기존 인출 엔드포인트 수정

**파일: `functions/api/initiate-withdrawal.ts` (수정)**

```typescript
// ===== 기존 import + 추가 =====
import { handleSmartContractWithdrawal } from './smartcontract-utils';

// ===== 기존 코드 ... =====

/**
 * 인출 요청 처리 (메인 핸들러)
 */
export async function onRequestPost(context: any) {
  const { request, env } = context;

  try {
    const body = await request.json() as {
      method: 'rpc' | 'smartcontract';  // 새로 추가
      userAddress: string;
      amount: number;
    };

    const { method, userAddress, amount } = body;

    // 입력 검증
    if (!userAddress || !amount || amount <= 0) {
      return new Response(
        JSON.stringify({
          success: false,
          error: 'Invalid input'
        }),
        { status: 400 }
      );
    }

    // 🆕 메서드별 처리
    let result;

    if (method === 'smartcontract') {
      // 스마트컨트랙트 방식 (권장)
      const queryId = BigInt(Date.now());
      result = await handleSmartContractWithdrawal(
        context,
        userAddress,
        amount,
        queryId
      );
      
      if (result.success) {
        console.log(`[SC Withdrawal] ✅ ${userAddress}: ${amount} CSPIN`);
      }
    } else {
      // RPC 직접 방식 (레거시)
      result = await handleRPCWithdrawal(context, userAddress, amount);
    }

    return new Response(
      JSON.stringify(result),
      { 
        status: result.success ? 200 : 400,
        headers: { 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('[Withdrawal] Error:', error);
    return new Response(
      JSON.stringify({
        success: false,
        error: 'Internal server error'
      }),
      { status: 500 }
    );
  }
}
```

---

### 4️⃣ 프론트엔드 UI 수정

**파일: `src/components/GameComplete.tsx` (일부 수정)**

```tsx
// ===== 기존 코드에 추가 =====

/**
 * 인출 방식 선택 (사용자 안내)
 */
function renderWithdrawalMethodInfo() {
  return (
    <div className="bg-blue-50 border border-blue-300 rounded-lg p-4 mb-4">
      <p className="text-sm text-blue-900 mb-2">
        <strong>💡 스마트컨트랙트 인출 (권장)</strong>
      </p>
      <ul className="text-sm text-blue-800 space-y-1 ml-4">
        <li>✅ 가스비: 약 $0.01 (사용자 부담)</li>
        <li>✅ 속도: 매우 빠름 (블록체인 직접 처리)</li>
        <li>✅ 투명성: 모든 거래 온체인 기록</li>
      </ul>
    </div>
  );
}

/**
 * 기존 인출 함수 수정
 */
async function handleWithdrawal() {
  try {
    // 사용자에게 방식 선택
    const useSmartContract = confirm(
      '스마트컨트랙트 방식으로 인출하시겠습니까?\n' +
      '(가스비 약 $0.01)'
    );

    // 백엔드 호출
    const response = await fetch('/api/initiate-withdrawal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: useSmartContract ? 'smartcontract' : 'rpc',
        userAddress: wallet.address,
        amount: withdrawalAmount,
      }),
    });

    const result = await response.json();

    if (result.success) {
      showToast(`✅ 인출 요청 완료!`, 'success');
    } else {
      showToast(`❌ 인출 실패: ${result.error}`, 'error');
    }
  } catch (error) {
    showToast(`❌ 오류: ${error}`, 'error');
  }
}

return (
  <div>
    {renderWithdrawalMethodInfo()}
    {/* 기존 인출 버튼 ... */}
  </div>
);
```

---

## 모니터링 및 유지보수

### 1️⃣ 모니터링 대시보드

**파일: `functions/api/monitoring.ts` (신규)**

```typescript
/**
 * 스마트컨트랙트 모니터링
 */
export async function onRequestGet(context: any) {
  const { env } = context;

  try {
    // TonClient로 컨트랙트 상태 조회
    const client = new WithdrawalManagerClient(
      env.TON_RPC_ENDPOINT,
      {
        address: env.WITHDRAWAL_MANAGER,
        jettonMaster: env.CSPIN_JETTON,
        gameJettonWallet: env.GAME_JETTON_WALLET,
      }
    );

    const stats = await client.getStats();

    return new Response(
      JSON.stringify({
        status: 'healthy',
        contract: {
          address: env.WITHDRAWAL_MANAGER,
          stats: {
            processedRequests: stats.processedRequests.toString(),
            totalWithdrawn: fromNano(stats.totalWithdrawn).toString(),
            totalGasCollected: fromNano(stats.totalGasCollected).toString(),
            isPaused: stats.isPaused,
          },
        },
        timestamp: new Date().toISOString(),
      }),
      { headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    return new Response(
      JSON.stringify({
        status: 'error',
        error: error instanceof Error ? error.message : 'Unknown error',
      }),
      { status: 500 }
    );
  }
}
```

---

### 2️⃣ 알림 및 로깅

```typescript
/**
 * 에러 로깅
 */
async function logWithdrawalError(
  env: any,
  userAddress: string,
  amount: number,
  error: string
) {
  // Sentry, LogRocket 등에 전송
  console.error(`[Withdrawal Error] ${userAddress} - ${amount} CSPIN: ${error}`);
  
  // 선택사항: Discord/Slack 알림
  await notifyErrorChannel({
    title: 'Withdrawal Failed',
    message: `User: ${userAddress}\nAmount: ${amount}\nError: ${error}`,
  });
}

/**
 * 성공 로깅
 */
async function logWithdrawalSuccess(
  userAddress: string,
  amount: number,
  txHash: string
) {
  console.log(
    `[Withdrawal Success] ${userAddress}: ${amount} CSPIN (tx: ${txHash})`
  );
}
```

---

### 3️⃣ 비상 대응 절차

**문제 발생 시:**

```bash
# 1️⃣ 컨트랙트 일시 정지
curl -X POST https://api.example.com/api/contract-pause \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json"

# 2️⃣ 상태 확인
curl https://api.example.com/api/monitoring

# 3️⃣ 문제 해결 후 재개
curl -X POST https://api.example.com/api/contract-resume \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## 완성 체크리스트

```
개발 단계:
□ Tact 컨트랙트 코드 작성 완료
□ 테스트 코드 작성 완료 (모든 테스트 통과)
□ 배포 스크립트 준비 완료

테스트 단계:
□ 로컬 테스트 성공 (npm run test)
□ 테스트넷 배포 성공
□ 테스트넷에서 10회 인출 테스트 완료
□ 가스비 청구 확인됨
□ Jetton 전송 확인됨

통합 단계:
□ 백엔드 통합 코드 작성 완료
□ 프론트엔드 UI 수정 완료
□ 통합 테스트 성공

배포 단계:
□ 환경 변수 설정 완료 (wrangler.toml)
□ 메인넷 배포 성공 (~$6 비용)
□ 컨트랙트 주소 저장 완료
□ 게임 Jetton 지갑에 CSPIN 예치 완료

운영 단계:
□ 모니터링 대시보드 구성 완료
□ 알림 시스템 구성 완료
□ 1일간 모니터링 완료
□ 버그 수정 완료
□ 프로덕션 라이브 완료
```

---

## 지원 및 문제 해결

### 일반적인 문제

#### Q1: "Contract address not found" 오류
**원인:** 배포 후 컨트랙트가 아직 생성되지 않음  
**해결:** 30초 기다린 후 재시도

#### Q2: 가스비가 너무 높음
**원인:** 네트워크 혼잡  
**해결:** 피크 타임(오후 2-4시) 피하고 배포

#### Q3: Jetton 전송 실패
**원인:** 게임 지갑에 CSPIN 부족  
**해결:** 게임 지갑에 CSPIN 예치 확인

---

## 다음 단계

1. 이 가이드대로 스마트컨트랙트 배포
2. 테스트넷에서 충분히 테스트
3. 메인넷 배포 후 모니터링
4. 이슈 발생 시 즉시 연락

**축하합니다! 🎉 당신의 게임은 이제 완전히 분산형 인출 시스템을 갖추게 됩니다!**

