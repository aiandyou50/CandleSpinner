***REMOVED***ğŸ› ï¸ ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ êµ¬í˜„ ê¸°ìˆ  ê°€ì´ë“œ
#***REMOVED***Tact ì½”ë“œ + ë°°í¬ + ê²Œì„ í†µí•© ì™„ì „ êµìœ¡ì„œ

**ì‘ì„±ì¼**: 2025ë…„ 10ì›” 25ì¼  
**ëŒ€ìƒ**: CandleSpinner ê²Œì„ íŒ€  
**ë‚œì´ë„**: ì´ˆê¸‰ ~ ì¤‘ê¸‰

---

#***REMOVED***ğŸ“‘ ëª©ì°¨

1. [í™˜ê²½ ì„¤ì •](#í™˜ê²½-ì„¤ì •)
2. [Tact ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ì‘ì„±](#tact-ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸-ì‘ì„±)
3. [í…ŒìŠ¤íŠ¸ ë° ë°°í¬](#í…ŒìŠ¤íŠ¸-ë°-ë°°í¬)
4. [ê²Œì„ ë°±ì—”ë“œ í†µí•©](#ê²Œì„-ë°±ì—”ë“œ-í†µí•©)
5. [ëª¨ë‹ˆí„°ë§ ë° ìœ ì§€ë³´ìˆ˜](#ëª¨ë‹ˆí„°ë§-ë°-ìœ ì§€ë³´ìˆ˜)

---

#***REMOVED***í™˜ê²½ ì„¤ì •

##***REMOVED***1ï¸âƒ£ í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜

```bash
***REMOVED***Node.js 18+ ì„¤ì¹˜ í™•ì¸
node --version  ***REMOVED***v18.0.0 ì´ìƒ

***REMOVED***TON Blueprint í”„ë¡œì íŠ¸ ìƒì„±
npm create ton@latest contracts -- --type tact-contract
cd contracts

***REMOVED***ëª¨ë“  ì˜ì¡´ì„± ì„¤ì¹˜
npm install

***REMOVED***ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
npm ls
```

**ì„¤ì¹˜ë  ì£¼ìš” íŒ¨í‚¤ì§€:**
```json
{
  "@ton/ton": "^14.0.0",
  "@ton/core": "^0.55.0",
  "ton": "^13.0.0",
  "tact": "^4.0.0"
}
```

---

##***REMOVED***2ï¸âƒ£ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
contracts/
â”œâ”€â”€ sources/
â”‚   â”œâ”€â”€ WithdrawalManager.tact       â† ìš°ë¦¬ê°€ ì‘ì„±í•  ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸
â”‚   â””â”€â”€ stdlib/
â”œâ”€â”€ wrappers/
â”‚   â””â”€â”€ WithdrawalManager.ts         â† ì»¨íŠ¸ë™íŠ¸ ë˜í¼ (ìë™ ìƒì„±)
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ WithdrawalManager.spec.ts    â† í…ŒìŠ¤íŠ¸ ì½”ë“œ
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ deployWithdrawalManager.ts   â† ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ build/                           â† ì»´íŒŒì¼ ê²°ê³¼
â””â”€â”€ package.json
```

---

##***REMOVED***3ï¸âƒ£ wrangler.toml ì„¤ì • (Cloudflare Workers)

**íŒŒì¼: `wrangler.toml` (ë£¨íŠ¸ ë””ë ‰í† ë¦¬)**

```toml
name = "candlespinner"
type = "javascript"
account_id = "YOUR_ACCOUNT_ID"
workers_dev = true

***REMOVED***í™˜ê²½ ë³€ìˆ˜
[env.production]
vars = {
  WITHDRAWAL_MANAGER = "EQD...",  ***REMOVED***ë°°í¬ í›„ ì €ì¥
  CSPIN_JETTON = "EQB...",        ***REMOVED***CSPIN Jetton Master
  GAME_JETTON_WALLET = "EQC...",  ***REMOVED***ê²Œì„ì˜ CSPIN ì§€ê°‘
  TON_NETWORK = "mainnet",
  RPC_ENDPOINT = "https://toncenter.com/api/v2/jsonRPC"
}

[env.testnet]
vars = {
  WITHDRAWAL_MANAGER = "EQD...",  ***REMOVED***í…ŒìŠ¤íŠ¸ë„· ë°°í¬ í›„
  CSPIN_JETTON = "EQB...",
  GAME_JETTON_WALLET = "EQC...",
  TON_NETWORK = "testnet",
  RPC_ENDPOINT = "https://testnet.toncenter.com/api/v2/jsonRPC"
}

***REMOVED***Cloudflare Pages ì—°ê²°
[build]
command = "npm run build"
cwd = "./"

***REMOVED***KV ë°”ì¸ë”©
[[kv_namespaces]]
binding = "CREDIT_KV"
id = "YOUR_KV_ID"
```

---

#***REMOVED***Tact ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ì‘ì„±

##***REMOVED***ğŸ“ Step 1: ê¸°ë³¸ ì»¨íŠ¸ë™íŠ¸ êµ¬ì¡°

**íŒŒì¼: `contracts/sources/WithdrawalManager.tact`**

```tact
#pragma version >=0.2.0;

import "@stdlib/deploy";
import "@stdlib/ownable";
import "@stdlib/stoppable";

/**
 * Jetton í‘œì¤€ ìƒìˆ˜ (TEP-74)
 * @see https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md
 */
const JETTON_TRANSFER: Int = 0xf8a7ea5;
const JETTON_TRANSFER_NOTIFICATION: Int = 0x7362d09c;
const JETTON_BURN_NOTIFICATION: Int = 0x7bdd97de;
const SEND_REMAINING_GAS: Int = 2;

/**
 * ê²Œì„ ë©”ì‹œì§€ íƒ€ì… (opcode)
 */
const OP_WITHDRAWAL_REQUEST: Int = 0x57495452;    // "WITR"
const OP_WITHDRAWAL_SUCCESS: Int = 0x57495453;    // "WITS"
const OP_WITHDRAWAL_FAILED: Int = 0x57495446;     // "WITF"
const OP_GAS_COLLECTION: Int = 0x47415344;        // "GASD"

/**
 * ì‚¬ìš©ì ì§€ë¶ˆí˜• CSPIN ì¸ì¶œ ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ê²Œì„ì´ ë³´ìœ í•œ CSPIN í† í° ë³´ê´€
 * 2. ì‚¬ìš©ì ì¸ì¶œ ìš”ì²­ ì²˜ë¦¬
 * 3. ì‚¬ìš©ì ì§€ê°‘ì—ì„œ ê°€ìŠ¤ë¹„ ì²­êµ¬
 * 4. Jetton í‘œì¤€ ì¤€ìˆ˜í•˜ì—¬ í† í° ì „ì†¡
 */
contract WithdrawalManager with Deployable, Ownable {
    
    // ========== ìƒíƒœ ë³€ìˆ˜ ==========
    
    owner: Address;                      // ê²Œì„ ê´€ë¦¬ì
    jettonMaster: Address;               // CSPIN Jetton ë§ˆìŠ¤í„°
    gameJettonWallet: Address;           // ê²Œì„ì˜ CSPIN ì§€ê°‘
    
    // ëª¨ë‹ˆí„°ë§ ë³€ìˆ˜
    processedRequests: Int = 0;          // ì²˜ë¦¬ëœ ìš”ì²­ ìˆ˜
    totalWithdrawn: Int = 0;             // ì´ ì¶œê¸ˆì•¡
    totalGasCollected: Int = 0;          // ì§•ìˆ˜í•œ ì´ ê°€ìŠ¤ë¹„
    
    paused: Bool = false;                // ê¸´ê¸‰ ì •ì§€ í”Œë˜ê·¸
    
    // ========== ë©”ì‹œì§€ íƒ€ì… ì •ì˜ ==========
    
    message WithdrawalRequest {
        queryId: UInt64;
        amount: Coins;                   // nanotons
        destination: Address;            // ìˆ˜ì‹ ì
    }
    
    message WithdrawGasCollection {
        queryId: UInt64;
    }
    
    // ========== ì´ˆê¸°í™” ==========
    
    init(jettonMaster: Address, gameJettonWallet: Address) {
        self.owner = sender();
        self.jettonMaster = jettonMaster;
        self.gameJettonWallet = gameJettonWallet;
    }
    
    // ========== í•µì‹¬ í•¨ìˆ˜ ==========
    
    /**
     * ì¸ì¶œ ìš”ì²­ ì²˜ë¦¬
     */
    receive(msg: WithdrawalRequest) {
        // ê¶Œí•œ ê²€ì¦
        self.requireOwner();
        require(!self.paused, "Contract is paused");
        
        // ì…ë ¥ê°’ ê²€ì¦
        require(msg.amount > 0, "Amount must be positive");
        require(msg.amount <= ton("1000000"), "Amount exceeds limit");
        
        // ê°€ìŠ¤ë¹„ ì •ì˜
        let gasFee: Coins = ton("0.01");
        let forwardAmount: Coins = ton("0.001");
        let transactionFee: Coins = ton("0.05");
        
        // ê²Œì„ Jetton ì§€ê°‘ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        let jettonWalletAddress: Address = self.gameJettonWallet;
        
        // Jetton Transfer ë©”ì‹œì§€ êµ¬ì„± (TEP-74)
        let transferBody: Cell = beginCell()
            .storeUint(JETTON_TRANSFER, 32)
            .storeUint(msg.queryId, 64)
            .storeCoins(msg.amount)
            .storeAddress(msg.destination)  // ìˆ˜ì‹ ì
            .storeAddress(self.owner)       // ì‘ë‹µ ì£¼ì†Œ
            .storeBit(0)                    // custom_payload (ì—†ìŒ)
            .storeCoins(forwardAmount)      // forward_ton_amount
            .storeBit(0)                    // forward_payload (ì—†ìŒ)
            .endCell();
        
        // 1ï¸âƒ£ Jetton ì „ì†¡
        send(SendParameters{
            to: jettonWalletAddress,
            amount: transactionFee,
            mode: SendPayGasSeparately,
            body: transferBody
        });
        
        // 2ï¸âƒ£ ê°€ìŠ¤ë¹„ ì²­êµ¬ (ì‚¬ìš©ì ì§€ê°‘ìœ¼ë¡œ)
        send(SendParameters{
            to: sender(),
            amount: gasFee,
            mode: SendIgnoreErrors,
            body: emptyCell()
        });
        
        // 3ï¸âƒ£ ìƒíƒœ ì—…ë°ì´íŠ¸
        self.processedRequests += 1;
        self.totalWithdrawn += msg.amount;
        self.totalGasCollected += gasFee;
    }
    
    /**
     * ê¸´ê¸‰ ì •ì§€ (ì„ íƒì‚¬í•­)
     */
    receive("pause") {
        self.requireOwner();
        self.paused = true;
    }
    
    /**
     * ì¬ê°œ (ì„ íƒì‚¬í•­)
     */
    receive("resume") {
        self.requireOwner();
        self.paused = false;
    }
    
    /**
     * ì§•ìˆ˜í•œ ê°€ìŠ¤ë¹„ íšŒìˆ˜ (ì„ íƒì‚¬í•­)
     */
    receive(msg: WithdrawGasCollection) {
        self.requireOwner();
        
        if (self.totalGasCollected > 0) {
            let amount = self.totalGasCollected;
            self.totalGasCollected = 0;
            
            send(SendParameters{
                to: sender(),
                amount: amount,
                mode: SendIgnoreErrors,
                body: emptyCell()
            });
        }
    }
    
    // ========== Getter í•¨ìˆ˜ ==========
    
    get fun stats(): (Int, Int, Int, Bool) {
        return (self.processedRequests, self.totalWithdrawn, self.totalGasCollected, self.paused);
    }
    
    get fun isPaused(): Bool {
        return self.paused;
    }
    
    get fun owner(): Address {
        return self.owner;
    }
}
```

---

##***REMOVED***ğŸ“ Step 2: í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

**íŒŒì¼: `contracts/tests/WithdrawalManager.spec.ts`**

```typescript
import { Blockchain, SandboxContract, TreasuryContract } from '@ton/sandbox';
import { Cell, toNano, beginCell, Address } from '@ton/core';
import { WithdrawalManager } from '../wrappers/WithdrawalManager';
import { compile } from '@ton/blueprint';

describe('WithdrawalManager', () => {
    let blockchain: Blockchain;
    let withdrawalManager: SandboxContract<WithdrawalManager>;
    let owner: SandboxContract<TreasuryContract>;
    let jettonMaster: Address;
    let gameJettonWallet: Address;

    beforeEach(async () => {
        blockchain = await Blockchain.create();
        
        // í…ŒìŠ¤íŠ¸ ì£¼ì†Œ ìƒì„±
        owner = await blockchain.treasury('owner');
        jettonMaster = Address.parse('EQBvp...'); // í…ŒìŠ¤íŠ¸ Jetton Master
        gameJettonWallet = Address.parse('EQCv...'); // í…ŒìŠ¤íŠ¸ Jetton Wallet
        
        // ì»¨íŠ¸ë™íŠ¸ ë°°í¬
        const code = await compile('WithdrawalManager');
        withdrawalManager = blockchain.openContract(
            WithdrawalManager.createFromConfig({
                jettonMaster,
                gameJettonWallet,
                owner: owner.address,
            }, code)
        );
        
        // ì´ˆê¸°í™”
        const deployResult = await withdrawalManager.sendDeploy(owner.getSender(), toNano('0.05'));
        expect(deployResult.transactions).toHaveTransaction({
            from: owner.address,
            to: withdrawalManager.address,
            deploy: true,
            success: true,
        });
    });

    it('should deploy correctly', async () => {
        const stats = await withdrawalManager.getStats();
        expect(stats.processedRequests).toEqual(0);
        expect(stats.totalWithdrawn).toEqual(0);
    });

    it('should handle withdrawal request', async () => {
        const userAddress = await blockchain.treasury('user');
        const amount = toNano('10');
        
        const result = await withdrawalManager.sendWithdrawalRequest(
            owner.getSender(),
            {
                amount: amount,
                destination: userAddress.address,
            }
        );
        
        expect(result.transactions).toHaveLength(2); // ìš”ì²­ + Jetton ì „ì†¡
    });

    it('should reject non-owner requests', async () => {
        const attacker = await blockchain.treasury('attacker');
        const user = await blockchain.treasury('user');
        
        const result = await withdrawalManager.sendWithdrawalRequest(
            attacker.getSender(),
            {
                amount: toNano('10'),
                destination: user.address,
            }
        );
        
        expect(result.transactions).toHaveTransaction({
            success: false,
        });
    });

    it('should pause and resume', async () => {
        await withdrawalManager.sendPause(owner.getSender());
        let stats = await withdrawalManager.getStats();
        expect(stats.paused).toBe(true);
        
        await withdrawalManager.sendResume(owner.getSender());
        stats = await withdrawalManager.getStats();
        expect(stats.paused).toBe(false);
    });
});
```

---

##***REMOVED***ğŸ“ Step 3: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼: `contracts/scripts/deployWithdrawalManager.ts`**

```typescript
import { Address, toNano } from '@ton/core';
import { WithdrawalManager } from '../wrappers/WithdrawalManager';
import { compile, NetworkProvider } from '@ton/blueprint';

export async function run(provider: NetworkProvider) {
    // ===== ì„¤ì • =====
    
    // í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì£¼ì†Œ ì½ê¸°
    const CSPIN_JETTON = Address.parse(process.env.CSPIN_JETTON || '');
    const GAME_JETTON_WALLET = Address.parse(process.env.GAME_JETTON_WALLET || '');
    
    console.log(`
    ğŸ”§ WithdrawalManager ë°°í¬ ì¤€ë¹„
    
    CSPIN Jetton: ${CSPIN_JETTON}
    Game Jetton Wallet: ${GAME_JETTON_WALLET}
    `);
    
    // ===== ì»´íŒŒì¼ =====
    
    console.log('ğŸ“¦ ì»¨íŠ¸ë™íŠ¸ ì»´íŒŒì¼ ì¤‘...');
    const code = await compile('WithdrawalManager');
    
    // ===== ë°°í¬ì ì§€ê°‘ ì—°ê²° =====
    
    const ui = provider.ui();
    const deployer = ui.write('Deployer address:'); // ì‚¬ìš©ì ì…ë ¥
    const deployerAddress = Address.parse(deployer);
    
    // ===== ì»¨íŠ¸ë™íŠ¸ ë°°í¬ =====
    
    const withdrawal = provider.open(
        WithdrawalManager.createFromConfig({
            jettonMaster: CSPIN_JETTON,
            gameJettonWallet: GAME_JETTON_WALLET,
        }, code)
    );
    
    // ì´ë¯¸ ë°°í¬ëœ ê²½ìš° ê±´ë„ˆë›°ê¸°
    if (await provider.isContractDeployed(withdrawal.address)) {
        console.log(`âœ… ì»¨íŠ¸ë™íŠ¸ê°€ ì´ë¯¸ ë°°í¬ë¨: ${withdrawal.address}`);
        return;
    }
    
    console.log(`ğŸ“¤ ë°°í¬ ì¤‘... (${withdrawal.address})`);
    
    // ë°°í¬ íŠ¸ëœì­ì…˜ ì „ì†¡
    await withdrawal.sendDeploy(
        provider.sender(),
        toNano('0.1')  // ë°°í¬ ë¹„ìš©
    );
    
    // ë°°í¬ í™•ì¸
    console.log('â³ ë°°í¬ í™•ì¸ ì¤‘...');
    await provider.waitForDeploy(withdrawal.address);
    
    console.log(`
    âœ… ë°°í¬ ì™„ë£Œ!
    
    ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ: ${withdrawal.address}
    
    ë‹¤ìŒ ë‹¨ê³„:
    1. wrangler.tomlì— ì£¼ì†Œ ì €ì¥
    2. ê²Œì„ Jetton ì§€ê°‘ì— CSPIN í† í° ì˜ˆì¹˜
    3. ë°±ì—”ë“œì—ì„œ ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ í˜¸ì¶œ
    `);
}
```

---

#***REMOVED***í…ŒìŠ¤íŠ¸ ë° ë°°í¬

##***REMOVED***1ï¸âƒ£ ë¡œì»¬ í…ŒìŠ¤íŠ¸

```bash
***REMOVED***í…ŒìŠ¤íŠ¸ ì‹¤í–‰
npm run test

***REMOVED***ê²°ê³¼:
***REMOVED***âœ… WithdrawalManager
***REMOVED***  âœ“ should deploy correctly (234ms)
***REMOVED***  âœ“ should handle withdrawal request (156ms)
***REMOVED***  âœ“ should reject non-owner requests (89ms)
***REMOVED***  âœ“ should pause and resume (123ms)
```

---

##***REMOVED***2ï¸âƒ£ í…ŒìŠ¤íŠ¸ë„· ë°°í¬

```bash
***REMOVED***í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (TON testnet)
export CSPIN_JETTON="EQBt5..."  ***REMOVED***testnet CSPIN
export GAME_JETTON_WALLET="EQC..."

***REMOVED***í…ŒìŠ¤íŠ¸ë„· ë°°í¬
npm run deploy -- --testnet

***REMOVED***ì…ë ¥:
***REMOVED***Deployer address: <your_testnet_wallet>

***REMOVED***ê²°ê³¼:
***REMOVED***âœ… ë°°í¬ ì™„ë£Œ!
***REMOVED***ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ: EQD... (ì €ì¥í•˜ê¸°!)
```

---

##***REMOVED***3ï¸âƒ£ ë©”ì¸ë„· ë°°í¬

```bash
***REMOVED***âš ï¸ MAINNET ë°°í¬ (ì‹¤ì œ ë¹„ìš© ì•½ $6)

***REMOVED***í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (TON mainnet)
export CSPIN_JETTON="EQBvp..." ***REMOVED***mainnet CSPIN
export GAME_JETTON_WALLET="EQCv..."
export NODE_ENV="mainnet"

***REMOVED***ë©”ì¸ë„· ë°°í¬
npm run deploy -- --mainnet

***REMOVED***ì…ë ¥:
***REMOVED***Deployer address: <your_mainnet_wallet>

***REMOVED***ê²°ê³¼:
***REMOVED***âœ… ë°°í¬ ì™„ë£Œ!
***REMOVED***ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ: EQD...

***REMOVED***âš ï¸ ì£¼ì†Œë¥¼ ì•ˆì „í•œ ê³³ì— ì €ì¥!
```

**ë°°í¬ í›„:**
```bash
***REMOVED***wrangler.toml ì—…ë°ì´íŠ¸
[env.production]
vars = {
  WITHDRAWAL_MANAGER = "EQD...",  ***REMOVED***â† ë°°í¬ëœ ì£¼ì†Œ
  ...
}
```

---

#***REMOVED***ê²Œì„ ë°±ì—”ë“œ í†µí•©

##***REMOVED***1ï¸âƒ£ íƒ€ì… ì •ì˜ ì¶”ê°€

**íŒŒì¼: `functions/api/types.ts` (ì‹ ê·œ)**

```typescript
/**
 * ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ê´€ë ¨ íƒ€ì… ì •ì˜
 */

export interface SmartContractConfig {
  address: string;           // ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ
  jettonMaster: string;      // CSPIN Jetton Master
  gameJettonWallet: string;  // ê²Œì„ì˜ CSPIN ì§€ê°‘
}

export interface WithdrawalRequest {
  queryId: bigint;
  amount: bigint;            // nanotons
  destination: string;       // ì‚¬ìš©ì ì§€ê°‘
}

export interface WithdrawalResponse {
  success: boolean;
  txHash?: string;
  amount?: number;
  error?: string;
  status: 'pending' | 'confirmed' | 'failed';
}

export interface ContractStats {
  processedRequests: bigint;
  totalWithdrawn: bigint;
  totalGasCollected: bigint;
  isPaused: boolean;
}
```

---

##***REMOVED***2ï¸âƒ£ ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ í†µí•© ëª¨ë“ˆ

**íŒŒì¼: `functions/api/smartcontract-utils.ts` (ì‹ ê·œ)**

```typescript
import { TonClient, Contract, ContractProvider, Sender } from '@ton/ton';
import { Address, toNano, Cell, beginCell } from '@ton/core';
import { SmartContractConfig, WithdrawalRequest, WithdrawalResponse, ContractStats } from './types';

/**
 * ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ìœ í‹¸ë¦¬í‹°
 */
export class WithdrawalManagerClient {
  private client: TonClient;
  private config: SmartContractConfig;
  private contractAddress: Address;

  constructor(endpoint: string, config: SmartContractConfig) {
    this.client = new TonClient({ endpoint });
    this.config = config;
    this.contractAddress = Address.parse(config.address);
  }

  /**
   * ì¸ì¶œ ìš”ì²­ ë©”ì‹œì§€ ìƒì„±
   */
  async createWithdrawalMessage(request: WithdrawalRequest): Promise<Cell> {
    return beginCell()
      .storeUint(0x57495452, 32)         // OP_WITHDRAWAL_REQUEST
      .storeUint(request.queryId, 64)
      .storeCoins(request.amount)
      .storeAddress(Address.parse(request.destination))
      .endCell();
  }

  /**
   * ì»¨íŠ¸ë™íŠ¸ ìƒíƒœ ì¡°íšŒ
   */
  async getStats(): Promise<ContractStats> {
    try {
      const data = await this.client.runMethod(
        this.contractAddress,
        'get_stats'
      );

      return {
        processedRequests: BigInt(data.stack[0].type === 'int' ? data.stack[0].value : 0),
        totalWithdrawn: BigInt(data.stack[1].type === 'int' ? data.stack[1].value : 0),
        totalGasCollected: BigInt(data.stack[2].type === 'int' ? data.stack[2].value : 0),
        isPaused: data.stack[3].type === 'int' ? data.stack[3].value !== 0 : false,
      };
    } catch (error) {
      console.error('Failed to get contract stats:', error);
      throw new Error('Cannot retrieve contract statistics');
    }
  }

  /**
   * í˜„ì¬ ê°€ìŠ¤ë¹„ ì¡°íšŒ
   */
  async getGasFee(): Promise<bigint> {
    return toNano('0.01');  // ê³ ì • ë¹„ìš©
  }
}

/**
 * í•¸ë“¤ëŸ¬: ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ë°©ì‹ ì¸ì¶œ
 */
export async function handleSmartContractWithdrawal(
  context: { env: any },
  userAddress: string,
  amount: number,
  queryId: bigint
): Promise<WithdrawalResponse> {
  const { env } = context;

  try {
    // 1ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const client = new WithdrawalManagerClient(
      env.TON_RPC_ENDPOINT || 'https://toncenter.com/api/v2/jsonRPC',
      {
        address: env.WITHDRAWAL_MANAGER,
        jettonMaster: env.CSPIN_JETTON,
        gameJettonWallet: env.GAME_JETTON_WALLET,
      }
    );

    // 2ï¸âƒ£ ì¸ì¶œ ë©”ì‹œì§€ ìƒì„±
    const message = await client.createWithdrawalMessage({
      queryId,
      amount: toNano(amount.toString()),
      destination: userAddress,
    });

    // 3ï¸âƒ£ íŠ¸ëœì­ì…˜ ìƒì„± (ì—¬ê¸°ì„œëŠ” ë°ì´í„°ë§Œ ë°˜í™˜, ì‹¤ì œ ì „ì†¡ì€ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ)
    const transactionData = {
      to: env.WITHDRAWAL_MANAGER,
      value: toNano('0.05').toString(),
      payload: message.toBoc().toString('base64'),
    };

    // 4ï¸âƒ£ ì‘ë‹µ ë°˜í™˜
    return {
      success: true,
      amount,
      status: 'pending',
    };
  } catch (error) {
    console.error('[SmartContract Withdrawal] Error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
      status: 'failed',
    };
  }
}
```

---

##***REMOVED***3ï¸âƒ£ ê¸°ì¡´ ì¸ì¶œ ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •

**íŒŒì¼: `functions/api/initiate-withdrawal.ts` (ìˆ˜ì •)**

```typescript
// ===== ê¸°ì¡´ import + ì¶”ê°€ =====
import { handleSmartContractWithdrawal } from './smartcontract-utils';

// ===== ê¸°ì¡´ ì½”ë“œ ... =====

/**
 * ì¸ì¶œ ìš”ì²­ ì²˜ë¦¬ (ë©”ì¸ í•¸ë“¤ëŸ¬)
 */
export async function onRequestPost(context: any) {
  const { request, env } = context;

  try {
    const body = await request.json() as {
      method: 'rpc' | 'smartcontract';  // ìƒˆë¡œ ì¶”ê°€
      userAddress: string;
      amount: number;
    };

    const { method, userAddress, amount } = body;

    // ì…ë ¥ ê²€ì¦
    if (!userAddress || !amount || amount <= 0) {
      return new Response(
        JSON.stringify({
          success: false,
          error: 'Invalid input'
        }),
        { status: 400 }
      );
    }

    // ğŸ†• ë©”ì„œë“œë³„ ì²˜ë¦¬
    let result;

    if (method === 'smartcontract') {
      // ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ë°©ì‹ (ê¶Œì¥)
      const queryId = BigInt(Date.now());
      result = await handleSmartContractWithdrawal(
        context,
        userAddress,
        amount,
        queryId
      );
      
      if (result.success) {
        console.log(`[SC Withdrawal] âœ… ${userAddress}: ${amount} CSPIN`);
      }
    } else {
      // RPC ì§ì ‘ ë°©ì‹ (ë ˆê±°ì‹œ)
      result = await handleRPCWithdrawal(context, userAddress, amount);
    }

    return new Response(
      JSON.stringify(result),
      { 
        status: result.success ? 200 : 400,
        headers: { 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('[Withdrawal] Error:', error);
    return new Response(
      JSON.stringify({
        success: false,
        error: 'Internal server error'
      }),
      { status: 500 }
    );
  }
}
```

---

##***REMOVED***4ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œ UI ìˆ˜ì •

**íŒŒì¼: `src/components/GameComplete.tsx` (ì¼ë¶€ ìˆ˜ì •)**

```tsx
// ===== ê¸°ì¡´ ì½”ë“œì— ì¶”ê°€ =====

/**
 * ì¸ì¶œ ë°©ì‹ ì„ íƒ (ì‚¬ìš©ì ì•ˆë‚´)
 */
function renderWithdrawalMethodInfo() {
  return (
    <div className="bg-blue-50 border border-blue-300 rounded-lg p-4 mb-4">
      <p className="text-sm text-blue-900 mb-2">
        <strong>ğŸ’¡ ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ì¸ì¶œ (ê¶Œì¥)</strong>
      </p>
      <ul className="text-sm text-blue-800 space-y-1 ml-4">
        <li>âœ… ê°€ìŠ¤ë¹„: ì•½ $0.01 (ì‚¬ìš©ì ë¶€ë‹´)</li>
        <li>âœ… ì†ë„: ë§¤ìš° ë¹ ë¦„ (ë¸”ë¡ì²´ì¸ ì§ì ‘ ì²˜ë¦¬)</li>
        <li>âœ… íˆ¬ëª…ì„±: ëª¨ë“  ê±°ë˜ ì˜¨ì²´ì¸ ê¸°ë¡</li>
      </ul>
    </div>
  );
}

/**
 * ê¸°ì¡´ ì¸ì¶œ í•¨ìˆ˜ ìˆ˜ì •
 */
async function handleWithdrawal() {
  try {
    // ì‚¬ìš©ìì—ê²Œ ë°©ì‹ ì„ íƒ
    const useSmartContract = confirm(
      'ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ë°©ì‹ìœ¼ë¡œ ì¸ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n' +
      '(ê°€ìŠ¤ë¹„ ì•½ $0.01)'
    );

    // ë°±ì—”ë“œ í˜¸ì¶œ
    const response = await fetch('/api/initiate-withdrawal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: useSmartContract ? 'smartcontract' : 'rpc',
        userAddress: wallet.address,
        amount: withdrawalAmount,
      }),
    });

    const result = await response.json();

    if (result.success) {
      showToast(`âœ… ì¸ì¶œ ìš”ì²­ ì™„ë£Œ!`, 'success');
    } else {
      showToast(`âŒ ì¸ì¶œ ì‹¤íŒ¨: ${result.error}`, 'error');
    }
  } catch (error) {
    showToast(`âŒ ì˜¤ë¥˜: ${error}`, 'error');
  }
}

return (
  <div>
    {renderWithdrawalMethodInfo()}
    {/* ê¸°ì¡´ ì¸ì¶œ ë²„íŠ¼ ... */}
  </div>
);
```

---

#***REMOVED***ëª¨ë‹ˆí„°ë§ ë° ìœ ì§€ë³´ìˆ˜

##***REMOVED***1ï¸âƒ£ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

**íŒŒì¼: `functions/api/monitoring.ts` (ì‹ ê·œ)**

```typescript
/**
 * ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ëª¨ë‹ˆí„°ë§
 */
export async function onRequestGet(context: any) {
  const { env } = context;

  try {
    // TonClientë¡œ ì»¨íŠ¸ë™íŠ¸ ìƒíƒœ ì¡°íšŒ
    const client = new WithdrawalManagerClient(
      env.TON_RPC_ENDPOINT,
      {
        address: env.WITHDRAWAL_MANAGER,
        jettonMaster: env.CSPIN_JETTON,
        gameJettonWallet: env.GAME_JETTON_WALLET,
      }
    );

    const stats = await client.getStats();

    return new Response(
      JSON.stringify({
        status: 'healthy',
        contract: {
          address: env.WITHDRAWAL_MANAGER,
          stats: {
            processedRequests: stats.processedRequests.toString(),
            totalWithdrawn: fromNano(stats.totalWithdrawn).toString(),
            totalGasCollected: fromNano(stats.totalGasCollected).toString(),
            isPaused: stats.isPaused,
          },
        },
        timestamp: new Date().toISOString(),
      }),
      { headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    return new Response(
      JSON.stringify({
        status: 'error',
        error: error instanceof Error ? error.message : 'Unknown error',
      }),
      { status: 500 }
    );
  }
}
```

---

##***REMOVED***2ï¸âƒ£ ì•Œë¦¼ ë° ë¡œê¹…

```typescript
/**
 * ì—ëŸ¬ ë¡œê¹…
 */
async function logWithdrawalError(
  env: any,
  userAddress: string,
  amount: number,
  error: string
) {
  // Sentry, LogRocket ë“±ì— ì „ì†¡
  console.error(`[Withdrawal Error] ${userAddress} - ${amount} CSPIN: ${error}`);
  
  // ì„ íƒì‚¬í•­: Discord/Slack ì•Œë¦¼
  await notifyErrorChannel({
    title: 'Withdrawal Failed',
    message: `User: ${userAddress}\nAmount: ${amount}\nError: ${error}`,
  });
}

/**
 * ì„±ê³µ ë¡œê¹…
 */
async function logWithdrawalSuccess(
  userAddress: string,
  amount: number,
  txHash: string
) {
  console.log(
    `[Withdrawal Success] ${userAddress}: ${amount} CSPIN (tx: ${txHash})`
  );
}
```

---

##***REMOVED***3ï¸âƒ£ ë¹„ìƒ ëŒ€ì‘ ì ˆì°¨

**ë¬¸ì œ ë°œìƒ ì‹œ:**

```bash
***REMOVED***1ï¸âƒ£ ì»¨íŠ¸ë™íŠ¸ ì¼ì‹œ ì •ì§€
curl -X POST https://api.example.com/api/contract-pause \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json"

***REMOVED***2ï¸âƒ£ ìƒíƒœ í™•ì¸
curl https://api.example.com/api/monitoring

***REMOVED***3ï¸âƒ£ ë¬¸ì œ í•´ê²° í›„ ì¬ê°œ
curl -X POST https://api.example.com/api/contract-resume \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

#***REMOVED***ì™„ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

```
ê°œë°œ ë‹¨ê³„:
â–¡ Tact ì»¨íŠ¸ë™íŠ¸ ì½”ë“œ ì‘ì„± ì™„ë£Œ
â–¡ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ì™„ë£Œ (ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼)
â–¡ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„ ì™„ë£Œ

í…ŒìŠ¤íŠ¸ ë‹¨ê³„:
â–¡ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì„±ê³µ (npm run test)
â–¡ í…ŒìŠ¤íŠ¸ë„· ë°°í¬ ì„±ê³µ
â–¡ í…ŒìŠ¤íŠ¸ë„·ì—ì„œ 10íšŒ ì¸ì¶œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
â–¡ ê°€ìŠ¤ë¹„ ì²­êµ¬ í™•ì¸ë¨
â–¡ Jetton ì „ì†¡ í™•ì¸ë¨

í†µí•© ë‹¨ê³„:
â–¡ ë°±ì—”ë“œ í†µí•© ì½”ë“œ ì‘ì„± ì™„ë£Œ
â–¡ í”„ë¡ íŠ¸ì—”ë“œ UI ìˆ˜ì • ì™„ë£Œ
â–¡ í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ

ë°°í¬ ë‹¨ê³„:
â–¡ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ (wrangler.toml)
â–¡ ë©”ì¸ë„· ë°°í¬ ì„±ê³µ (~$6 ë¹„ìš©)
â–¡ ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ ì €ì¥ ì™„ë£Œ
â–¡ ê²Œì„ Jetton ì§€ê°‘ì— CSPIN ì˜ˆì¹˜ ì™„ë£Œ

ìš´ì˜ ë‹¨ê³„:
â–¡ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ êµ¬ì„± ì™„ë£Œ
â–¡ ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì„± ì™„ë£Œ
â–¡ 1ì¼ê°„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ
â–¡ ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ
â–¡ í”„ë¡œë•ì…˜ ë¼ì´ë¸Œ ì™„ë£Œ
```

---

#***REMOVED***ì§€ì› ë° ë¬¸ì œ í•´ê²°

##***REMOVED***ì¼ë°˜ì ì¸ ë¬¸ì œ

###***REMOVED***Q1: "Contract address not found" ì˜¤ë¥˜
**ì›ì¸:** ë°°í¬ í›„ ì»¨íŠ¸ë™íŠ¸ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ  
**í•´ê²°:** 30ì´ˆ ê¸°ë‹¤ë¦° í›„ ì¬ì‹œë„

###***REMOVED***Q2: ê°€ìŠ¤ë¹„ê°€ ë„ˆë¬´ ë†’ìŒ
**ì›ì¸:** ë„¤íŠ¸ì›Œí¬ í˜¼ì¡  
**í•´ê²°:** í”¼í¬ íƒ€ì„(ì˜¤í›„ 2-4ì‹œ) í”¼í•˜ê³  ë°°í¬

###***REMOVED***Q3: Jetton ì „ì†¡ ì‹¤íŒ¨
**ì›ì¸:** ê²Œì„ ì§€ê°‘ì— CSPIN ë¶€ì¡±  
**í•´ê²°:** ê²Œì„ ì§€ê°‘ì— CSPIN ì˜ˆì¹˜ í™•ì¸

---

#***REMOVED***ë‹¤ìŒ ë‹¨ê³„

1. ì´ ê°€ì´ë“œëŒ€ë¡œ ìŠ¤ë§ˆíŠ¸ì»¨íŠ¸ë™íŠ¸ ë°°í¬
2. í…ŒìŠ¤íŠ¸ë„·ì—ì„œ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸
3. ë©”ì¸ë„· ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
4. ì´ìŠˆ ë°œìƒ ì‹œ ì¦‰ì‹œ ì—°ë½

**ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰ ë‹¹ì‹ ì˜ ê²Œì„ì€ ì´ì œ ì™„ì „íˆ ë¶„ì‚°í˜• ì¸ì¶œ ì‹œìŠ¤í…œì„ ê°–ì¶”ê²Œ ë©ë‹ˆë‹¤!**

