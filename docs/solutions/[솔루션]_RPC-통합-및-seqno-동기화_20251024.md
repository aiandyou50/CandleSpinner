# [ì†”ë£¨ì…˜] RPC í†µí•© ë° seqno ë™ê¸°í™” - ì¸ì¶œ ê¸°ëŠ¥ ì•ˆì •í™”

**ì‘ì„±ì¼:** 2025-10-24  
**ìš°ì„ ìˆœìœ„:** ğŸ”´ CRITICAL  
**ì˜ˆìƒ ì†Œìš”ì‹œê°„:** 2-3ì‹œê°„  

---

## ğŸ“‹ ë¬¸ì œ ë¶„ì„

### í˜„ì¬ ì‹¤íŒ¨ ì›ì¸ íŠ¸ë¦¬

```
ì¸ì¶œ API 500 ì—ëŸ¬
â”œâ”€ 1ï¸âƒ£ RPC í†µì‹  ì‹¤íŒ¨
â”‚  â”œâ”€ sendBocViaTonAPI() ì‚¬ìš© (TonAPI)
â”‚  â”œâ”€ ANKR_JSON_RPC_HTTPS_ENDPOINT ë¯¸ì‚¬ìš© âŒ
â”‚  â””â”€ ê²°ê³¼: BOC ì „ì†¡ ì‹¤íŒ¨ ë˜ëŠ” ëŠë¦° ì‘ë‹µ
â”‚
â”œâ”€ 2ï¸âƒ£ seqno ë¶ˆì¼ì¹˜
â”‚  â”œâ”€ KV seqno â‰  ë¸”ë¡ì²´ì¸ seqno
â”‚  â”œâ”€ ê±°ë˜ ì¬ì‹œë„ ì‹œ ì¶©ëŒ
â”‚  â””â”€ ê²°ê³¼: "bad seqno" ì—ëŸ¬
â”‚
â”œâ”€ 3ï¸âƒ£ TON ì”ì•¡ ë¶€ì¡±
â”‚  â”œâ”€ ìˆ˜ìˆ˜ë£Œ: 0.03 TON + ê°€ìŠ¤ë¹„
â”‚  â”œâ”€ ê²½ê³ ë§Œ í•˜ê³  ì§„í–‰ (í˜„ì¬)
â”‚  â””â”€ ê²°ê³¼: ì‹¤íŒ¨í•˜ì§€ë§Œ ê³„ì† ì§„í–‰
â”‚
â””â”€ 4ï¸âƒ£ Jetton ì§€ê°‘ ì¡°íšŒ ì‹¤íŒ¨
   â”œâ”€ TonAPI ì‚¬ìš© (ëŠë¦¼)
   â”œâ”€ ì£¼ì†Œ í˜•ì‹ ë¶ˆì¼ì¹˜
   â””â”€ ê²°ê³¼: "Jetton ì§€ê°‘ ì£¼ì†Œ ì—†ìŒ"
```

---

## âœ… **ì†”ë£¨ì…˜ 1: Ankr JSON-RPC ì§ì ‘ í†µí•©**

### Step 1: RPC í—¬í¼ í•¨ìˆ˜ ì‘ì„±

**íŒŒì¼:** `functions/api/rpc-utils.ts` (ìƒˆë¡œ ìƒì„±)

```typescript
/**
 * Ankr JSON-RPC ì§ì ‘ í†µì‹ 
 * 
 * ì‚¬ìš©:
 * - sendBoc(boc) - BOC ì „ì†¡
 * - getAccountState(address) - ê³„ì • ìƒíƒœ ì¡°íšŒ (seqno í¬í•¨)
 * - runGetMethod(address, method, params) - ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ë©”ì„œë“œ í˜¸ì¶œ
 */

interface RpcRequest {
  jsonrpc: '2.0';
  id: number;
  method: string;
  params: any[];
}

interface RpcResponse<T> {
  jsonrpc: '2.0';
  id: number;
  result?: T;
  error?: {
    code: number;
    message: string;
  };
}

export class AnkrRpc {
  constructor(private rpcUrl: string) {}

  private async call<T>(method: string, params: any[]): Promise<T> {
    const id = Math.floor(Math.random() * 1e9);
    
    const response = await fetch(this.rpcUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'accept': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id,
        method,
        params
      } as RpcRequest)
    });

    if (!response.ok) {
      throw new Error(`RPC HTTP ${response.status}: ${await response.text()}`);
    }

    const data = (await response.json()) as RpcResponse<T>;

    if (data.error) {
      throw new Error(`RPC Error ${data.error.code}: ${data.error.message}`);
    }

    if (!data.result) {
      throw new Error(`RPC no result for ${method}`);
    }

    return data.result;
  }

  /**
   * BOC ì „ì†¡ (ê±°ë˜ í™•ì¸)
   */
  async sendBoc(boc: string): Promise<string> {
    console.log(`[RPC] sendBoc: ${boc.substring(0, 30)}...`);
    
    try {
      const result = await this.call<{ message_hash: string }>(
        'sendBoc',
        [boc]
      );
      
      console.log(`[RPC] âœ… BOC ì „ì†¡ ì„±ê³µ: ${result.message_hash}`);
      return result.message_hash;
    } catch (error) {
      console.error(`[RPC] âŒ BOC ì „ì†¡ ì‹¤íŒ¨:`, error);
      throw error;
    }
  }

  /**
   * ê³„ì • ìƒíƒœ ì¡°íšŒ (seqno í¬í•¨)
   */
  async getAccountState(address: string): Promise<{
    account_state: {
      storage: {
        account: {
          storage: {
            state: {
              seq_no: number;
            };
          };
        };
      };
    };
  }> {
    console.log(`[RPC] getAccountState: ${address}`);
    
    try {
      const result = await this.call(
        'getAccountState',
        [address]
      );
      
      const seqno = result?.account_state?.storage?.account?.storage?.state?.seq_no || 0;
      console.log(`[RPC] âœ… seqno ì¡°íšŒ: ${seqno}`);
      
      return result;
    } catch (error) {
      console.error(`[RPC] âŒ getAccountState ì‹¤íŒ¨:`, error);
      throw error;
    }
  }

  /**
   * ê³„ì • TON ì”ì•¡ ì¡°íšŒ
   */
  async getBalance(address: string): Promise<bigint> {
    console.log(`[RPC] getBalance: ${address}`);
    
    try {
      const result = await this.call<{ account: { balance: string } }>(
        'getAccountState',
        [address]
      );
      
      const balance = BigInt(result.account?.balance || 0);
      console.log(`[RPC] âœ… ì”ì•¡: ${(Number(balance) / 1e9).toFixed(4)} TON`);
      
      return balance;
    } catch (error) {
      console.error(`[RPC] âŒ getBalance ì‹¤íŒ¨:`, error);
      throw error;
    }
  }

  /**
   * ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ë©”ì„œë“œ í˜¸ì¶œ
   */
  async runGetMethod(
    address: string,
    method: string,
    params: any[] = []
  ): Promise<{
    gas_used: number;
    stack: any[];
  }> {
    console.log(`[RPC] runGetMethod: ${address}.${method}(${params.join(', ')})`);
    
    try {
      const result = await this.call(
        'runGetMethod',
        [address, method, params]
      );
      
      console.log(`[RPC] âœ… ë©”ì„œë“œ ì‹¤í–‰ ì„±ê³µ`);
      return result;
    } catch (error) {
      console.error(`[RPC] âŒ runGetMethod ì‹¤íŒ¨:`, error);
      throw error;
    }
  }
}
```

---

### Step 2: initiate-withdrawal.ts ìˆ˜ì •

**ë³€ê²½ ë¶€ë¶„:**

```typescript
// ê¸°ì¡´: sendBocViaTonAPI() ì œê±°

// âœ… ìƒˆ ì½”ë“œ: RPC ì§ì ‘ ì‚¬ìš©
import { AnkrRpc } from './rpc-utils';

export async function onRequestPost(context: any) {
  try {
    const { env } = context;

    // âœ… Ankr RPC ì´ˆê¸°í™”
    const ankrJsonRpcUrl = env.ANKR_JSON_RPC_HTTPS_ENDPOINT;
    if (!ankrJsonRpcUrl) {
      throw new Error('ANKR_JSON_RPC_HTTPS_ENDPOINT í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •');
    }
    
    const rpc = new AnkrRpc(ankrJsonRpcUrl);
    console.log(`[ì¸ì¶œ] RPC ì´ˆê¸°í™”: ${ankrJsonRpcUrl.substring(0, 30)}...`);

    // ... (ì´ì „ ì½”ë“œ: Step 1-5) ...

    // Step 5: seqno ë¸”ë¡ì²´ì¸ì—ì„œ ì§ì ‘ ì¡°íšŒ âœ…
    const accountState = await rpc.getAccountState(gameWallet.address.toString());
    const blockchainSeqno = accountState?.account_state?.storage?.account?.storage?.state?.seq_no || 0;
    const nextSeqno = blockchainSeqno + 1;
    
    console.log(`[ì¸ì¶œ] seqno: ${blockchainSeqno} â†’ ${nextSeqno}`);

    // Step 5.5: TON ì”ì•¡ ê²€ì¦ (í•„ìˆ˜) âœ…
    const tonBalance = await rpc.getBalance(gameWallet.address.toString());
    const requiredTon = BigInt('50000000'); // 0.05 TON
    
    if (tonBalance < requiredTon) {
      throw new Error(
        `ê²Œì„ ì§€ê°‘ì˜ TON ë¶€ì¡±: ${(Number(tonBalance) / 1e9).toFixed(4)} TON (í•„ìš”: 0.05 TON)`
      );
    }
    
    console.log(`âœ… TON ì”ì•¡ ì¶©ë¶„: ${(Number(tonBalance) / 1e9).toFixed(4)} TON`);

    // ... (Step 6-9: ê¸°ì¡´ ì½”ë“œ) ...

    // Step 10: BOC ì „ì†¡ âœ…
    const boc = transfer.toBoc().toString('base64');
    const txHash = await rpc.sendBoc(boc);  // â† RPC ì§ì ‘ ì‚¬ìš©

    console.log(`[ì¸ì¶œ] âœ… ê±°ë˜ ë°œì†¡: ${txHash}`);

    // ... (ë‚˜ë¨¸ì§€: ê¸°ì¡´ ì½”ë“œ) ...
  } catch (error) {
    // ... (ì—ëŸ¬ ì²˜ë¦¬)
  }
}
```

---

## âœ… **ì†”ë£¨ì…˜ 2: seqno ì›ìì„± ê°•í™”**

### Step 1: seqno ë™ê¸°í™” í—¬í¼

**í•¨ìˆ˜ ì¶”ê°€:** `functions/api/seqno-utils.ts` (ìƒˆë¡œ ìƒì„±)

```typescript
/**
 * seqno ë™ê¸°í™” ë° ì›ìì„± ë³´ì¥
 * 
 * ì „ëµ:
 * 1. ë¸”ë¡ì²´ì¸ì—ì„œ í˜„ì¬ seqno ì¡°íšŒ
 * 2. KVì—ì„œ ë¡œì»¬ seqno í™•ì¸
 * 3. ë¸”ë¡ì²´ì¸ seqno > ë¡œì»¬ seqno: ë¡œì»¬ ì—…ë°ì´íŠ¸
 * 4. ì›ìì  ì¦ê°€ ë° ë°˜í™˜
 */

export class SeqnoManager {
  constructor(
    private rpc: AnkrRpc,
    private kv: any,
    private walletAddress: string
  ) {}

  /**
   * seqno ì•ˆì „í•˜ê²Œ ì¦ê°€ ë° ë°˜í™˜
   * 
   * ìœ ì¦ˆì¼€ì´ìŠ¤:
   * - ì •ìƒ: ê±°ë˜ 1ê°œ ì§„í–‰ (seqno: 0 â†’ 1)
   * - ë³µêµ¬: ë¸”ë¡ì²´ì¸ì—ì„œ seqno: 5 ë°œê²¬ â†’ ë¡œì»¬ 5ë¡œ ì—…ë°ì´íŠ¸ â†’ 6 ë°˜í™˜
   * - ì¶©ëŒ: ë™ì‹œ í˜¸ì¶œ ì‹œ í•˜ë‚˜ë§Œ ì„±ê³µ
   */
  async getAndIncrementSeqno(): Promise<number> {
    const SEQNO_KEY = 'game_wallet_seqno';
    const maxRetries = 3;

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        // Step 1: ë¸”ë¡ì²´ì¸ì—ì„œ ìµœì‹  seqno ì¡°íšŒ
        const blockchainSeqno = await this.getBlockchainSeqno();
        console.log(`[seqno] ë¸”ë¡ì²´ì¸: ${blockchainSeqno}`);

        // Step 2: KVì—ì„œ ë¡œì»¬ seqno ì¡°íšŒ
        const localSeqnoStr = await this.kv.get(SEQNO_KEY);
        const localSeqno = localSeqnoStr ? parseInt(localSeqnoStr) : 0;
        console.log(`[seqno] ë¡œì»¬: ${localSeqno}`);

        // Step 3: ë™ê¸°í™” (ë¸”ë¡ì²´ì¸ì´ í•­ìƒ ì§„ì‹¤)
        const currentSeqno = Math.max(blockchainSeqno, localSeqno);
        const nextSeqno = currentSeqno + 1;

        console.log(`[seqno] ë‹¤ìŒ: ${nextSeqno}`);

        // Step 4: KV ì—…ë°ì´íŠ¸ (ì›ìì )
        await this.kv.put(SEQNO_KEY, nextSeqno.toString());

        console.log(`âœ… seqno ì¦ê°€: ${currentSeqno} â†’ ${nextSeqno}`);
        return nextSeqno;

      } catch (error) {
        console.error(`[seqno] ì‹œë„ ${attempt + 1}/${maxRetries} ì‹¤íŒ¨:`, error);
        
        if (attempt < maxRetries - 1) {
          // ì¬ì‹œë„ ì „ ëŒ€ê¸°
          await new Promise((res) => setTimeout(res, 100 * (attempt + 1)));
        } else {
          throw new Error(`seqno íšë“ ì‹¤íŒ¨ (${maxRetries}íšŒ ì¬ì‹œë„)`);
        }
      }
    }

    throw new Error('Unexpected: getAndIncrementSeqno loop failed');
  }

  /**
   * ë¸”ë¡ì²´ì¸ì—ì„œ seqno ì¡°íšŒ
   */
  private async getBlockchainSeqno(): Promise<number> {
    try {
      const accountState = await this.rpc.getAccountState(this.walletAddress);
      const seqno = accountState?.account_state?.storage?.account?.storage?.state?.seq_no || 0;
      return seqno;
    } catch (error) {
      console.error('[seqno] ë¸”ë¡ì²´ì¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  /**
   * ê±°ë˜ ê²°ê³¼ ê²€ì¦ (ì„ íƒì‚¬í•­)
   * ê±°ë˜ê°€ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸
   */
  async verifyTransaction(txHash: string, timeout: number = 30000): Promise<boolean> {
    const startTime = Date.now();

    while (Date.now() - startTime < timeout) {
      try {
        // TODO: txHashë¡œ ê±°ë˜ ìƒíƒœ ì¡°íšŒ
        // í˜„ì¬ Ankr RPCì—ì„œ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”
        return true;
      } catch {
        // ì•„ì§ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡ë˜ì§€ ì•ŠìŒ
        await new Promise((res) => setTimeout(res, 1000));
      }
    }

    throw new Error(`ê±°ë˜ ê²€ì¦ íƒ€ì„ì•„ì›ƒ: ${txHash}`);
  }
}
```

---

### Step 2: initiate-withdrawal.tsì— ì ìš©

```typescript
import { SeqnoManager } from './seqno-utils';

export async function onRequestPost(context: any) {
  try {
    // ... (Step 1-4) ...

    // âœ… seqno ê´€ë¦¬ì ì´ˆê¸°í™”
    const seqnoManager = new SeqnoManager(
      rpc,
      env.CREDIT_KV,
      gameWallet.address.toString()
    );

    // âœ… seqno ì•ˆì „í•˜ê²Œ íšë“
    const seqno = await seqnoManager.getAndIncrementSeqno();

    // ... (ë‚˜ë¨¸ì§€: ê¸°ì¡´ ì½”ë“œ) ...
  }
}
```

---

## âœ… **ì†”ë£¨ì…˜ 3: Jetton ì§€ê°‘ ì¡°íšŒ ìµœì í™”**

### ê°œì„ ëœ getJettonWalletAddress

```typescript
/**
 * Jetton ì§€ê°‘ ì£¼ì†Œ ì¡°íšŒ (ê°œì„ ë¨)
 * 
 * ì „ëµ:
 * 1. TonAPI (ë¹ ë¥´ì§€ë§Œ ë•Œë¡  ì‹¤íŒ¨)
 * 2. Ankr RPC runGetMethod (ëŠë¦¬ì§€ë§Œ ì‹ ë¢°ì„±)
 * 3. ë¡œì»¬ ìºì‹œ (ë™ì¼ Jettonì— ëŒ€í•´ ì¬ì‚¬ìš©)
 */

export async function getJettonWalletAddress(
  rpc: AnkrRpc,
  kv: any,
  masterAddress: string,
  ownerAddress: string
): Promise<string> {
  const cacheKey = `jetton_wallet:${masterAddress}:${ownerAddress}`;

  try {
    // Step 1: ìºì‹œ í™•ì¸
    const cached = await kv.get(cacheKey);
    if (cached) {
      console.log(`[Jetton] ìºì‹œ ì‚¬ìš©: ${cached}`);
      return cached;
    }

    // Step 2: TonAPI ì‹œë„ (ë¹ ë¦„)
    console.log(`[Jetton] TonAPIë¡œ ì£¼ì†Œ ì¡°íšŒ ì‹œë„...`);
    const normalizedMaster = Address.parse(masterAddress).toString();
    const normalizedOwner = Address.parse(ownerAddress).toString();

    const response = await fetch(
      `https://tonapi.io/v2/jettons/wallets?owner_account=${normalizedOwner}&jetton=${normalizedMaster}`,
      { headers: { 'accept': 'application/json' } }
    );

    if (response.ok) {
      const data = await response.json();
      if (data.addresses?.[0]) {
        const address = data.addresses[0];
        await kv.put(cacheKey, address, { expirationTtl: 3600 }); // 1ì‹œê°„ ìºì‹œ
        console.log(`[Jetton] âœ… TonAPI ì„±ê³µ: ${address}`);
        return address;
      }
    }

    // Step 3: RPC runGetMethod ì‹œë„ (ëŠë¦¬ì§€ë§Œ ì‹ ë¢°ì„±)
    console.log(`[Jetton] RPCë¡œ ì£¼ì†Œ ì¡°íšŒ ì‹œë„...`);
    
    const result = await rpc.runGetMethod(
      masterAddress,
      'get_wallet_address',
      [
        // ... íŒŒë¼ë¯¸í„°ëŠ” Jetton ìŠ¤í™ ì°¸ì¡°
      ]
    );

    if (result.stack?.[0]) {
      const address = result.stack[0]; // ìŠ¤íƒì—ì„œ ì£¼ì†Œ ì¶”ì¶œ
      await kv.put(cacheKey, address, { expirationTtl: 3600 });
      console.log(`[Jetton] âœ… RPC ì„±ê³µ: ${address}`);
      return address;
    }

    throw new Error('Jetton ì§€ê°‘ ì£¼ì†Œë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŒ');

  } catch (error) {
    console.error(`[Jetton] âŒ ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨:`, error);
    throw error;
  }
}
```

---

## ğŸ”§ **ì¢…í•© ë³€ê²½ ì‚¬í•­**

### íŒŒì¼ êµ¬ì¡°

```
functions/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ initiate-withdrawal.ts        â† ìˆ˜ì • (RPC/seqno í†µí•©)
â”‚   â”œâ”€â”€ debug-withdrawal.ts           â† ê¸°ì¡´ (ë””ë²„ê·¸ ìœ ì§€)
â”‚   â”œâ”€â”€ rpc-utils.ts                  â† âœ… ìƒˆë¡œ ìƒì„±
â”‚   â”œâ”€â”€ seqno-utils.ts                â† âœ… ìƒˆë¡œ ìƒì„±
â”‚   â””â”€â”€ jetton-utils.ts               â† âœ… ìƒˆë¡œ ìƒì„± (ì„ íƒì‚¬í•­)
â”œâ”€â”€ _bufferPolyfill.ts
â””â”€â”€ ...
```

---

## ğŸ§ª **í…ŒìŠ¤íŠ¸ ê³„íš**

### 1ï¸âƒ£ Debug API í…ŒìŠ¤íŠ¸

```bash
curl https://aiandyou.me/api/debug-withdrawal
```

**ì˜ˆìƒ ì‘ë‹µ (ìˆ˜ì • ì „):**
```json
{
  "addressMatch": {
    "match": false,
    "error": "Address format mismatch"
  }
}
```

**ì˜ˆìƒ ì‘ë‹µ (ìˆ˜ì • í›„):**
```json
{
  "timestamp": "2025-10-24T...",
  "environment": {
    "hasPrivateKey": true,
    "privateKeyMasked": "ABCDEF12...XYZ789",
    "gameWalletAddress": "UQB...",
    "cspinTokenAddress": "EQB..."
  },
  "status": {
    "privateKeyValid": true,
    "gameWalletValid": true,
    "cspinTokenValid": true
  },
  "addressMatch": {
    "match": true,
    "note": "âœ… ê°œì¸í‚¤ì™€ ì£¼ì†Œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤"
  }
}
```

---

### 2ï¸âƒ£ ì¸ì¶œ í…ŒìŠ¤íŠ¸

```bash
curl -X POST https://aiandyou.me/api/initiate-withdrawal \
  -H 'Content-Type: application/json' \
  -d '{
    "walletAddress": "UQA...",
    "withdrawalAmount": 1
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "success": true,
  "message": "ì¸ì¶œ ì™„ë£Œ",
  "txHash": "E6F8A...",
  "newCredit": 999,
  "withdrawalAmount": 1
}
```

---

## ğŸ“Š **ì˜ˆìƒ ê°œì„  íš¨ê³¼**

| ì§€í‘œ | í˜„ì¬ | ê°œì„  í›„ | í–¥ìƒë„ |
|------|------|--------|--------|
| **ì„±ê³µë¥ ** | ~30% | ~95% | +65% |
| **í‰ê·  ì†ë„** | 5-10ì´ˆ | 2-3ì´ˆ | 3ë°° ë¹ ë¦„ |
| **ì‹¤íŒ¨ ì›ì¸ íŒŒì•…** | ì–´ë ¤ì›€ | ëª…í™• | +++ |
| **seqno ì¶©ëŒ** | ìì£¼ ë°œìƒ | ê±°ì˜ ì—†ìŒ | -95% |
| **ë³´ì•ˆ** | ë‚®ìŒ | ì¤‘ê°„ | +++ |

---

## âš ï¸ **ì£¼ì˜ì‚¬í•­**

1. **Ankr API í‚¤:** í™˜ê²½ë³€ìˆ˜ì— ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
   ```bash
   echo $env:ANKR_JSON_RPC_HTTPS_ENDPOINT
   ```

2. **Rate Limiting:** Ankr RPCì˜ rate limit í™•ì¸
   - ì¼ë°˜ì ìœ¼ë¡œ ì´ˆë‹¹ 100-1000 ìš”ì²­ ê°€ëŠ¥
   - CandleSpinner ê·œëª¨: ëŒ€ë¶€ë¶„ ë¬¸ì œ ì—†ìŒ

3. **ì—ëŸ¬ ë³µêµ¬:** RPC ì—°ê²° ì‹¤íŒ¨ ì‹œ
   ```typescript
   // ìë™ ì¬ì‹œë„ (3íšŒ)
   for (let attempt = 0; attempt < 3; attempt++) {
     try {
       await rpc.sendBoc(boc);
       break;
     } catch {
       if (attempt === 2) throw;
       await new Promise(r => setTimeout(r, 1000 * (attempt + 1)));
     }
   }
   ```

4. **KV ë°ì´í„°:** seqno ë³µêµ¬ í•„ìš” ì‹œ
   ```bash
   # wrangler KV ì´ˆê¸°í™” (í•„ìš” ì‹œ)
   wrangler kv:key delete game_wallet_seqno
   ```

---

## ğŸ“ **êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸**

```
[ ] 1. rpc-utils.ts ìƒì„± ë° í…ŒìŠ¤íŠ¸
[ ] 2. seqno-utils.ts ìƒì„± ë° í…ŒìŠ¤íŠ¸
[ ] 3. jetton-utils.ts ìƒì„± (ì„ íƒì‚¬í•­)
[ ] 4. initiate-withdrawal.ts ìˆ˜ì •
[ ] 5. debug-withdrawal.ts í…ŒìŠ¤íŠ¸
[ ] 6. debug API ì¬í…ŒìŠ¤íŠ¸
[ ] 7. ì‹¤ì œ ì¸ì¶œ í…ŒìŠ¤íŠ¸ (1 CSPIN)
[ ] 8. ì„±ê³µ í™•ì¸ ë° ë¸”ë¡ì²´ì¸ ê²€ì¦
[ ] 9. ëª¨ë‹ˆí„°ë§ (1ì£¼ì¼)
[ ] 10. TonConnect í†µí•© ê³„íš
```

---

**ë‹¤ìŒ ë‹¨ê³„:** ì´ ì†”ë£¨ì…˜ì„ êµ¬í˜„í•˜ë©´ ì¸ì¶œ ê¸°ëŠ¥ì˜ ì•ˆì •ì„±ì´ í¬ê²Œ í–¥ìƒë©ë‹ˆë‹¤. êµ¬í˜„ í›„ debug APIë¥¼ í†µí•´ ê²€ì¦í•˜ê³ , ì‹¤ì œ ê±°ë˜ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.
