# 🎓 시각적 학습 가이드: ED25519 개인키의 구조

---

## 1. 니모닉 → 개인키 변환 과정 (플로우차트)

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│         니모닉 (24개 BIP39 단어)                            │
│  "tornado run casual carbon laptop crowd..."               │
│                                                             │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   │ mnemonicToPrivateKey() 함수
                   │ (@ton/crypto)
                   │
                   ↓
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│         KeyPair 객체 생성                                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  secretKey: Buffer (정확히 64바이트)                 │  │
│  │  publicKey: Buffer (32바이트)                        │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
└──────────────────┬──────────────────────────────────────────┘
                   │
        ┌──────────┴────────────┐
        │                       │
        ↓                       ↓
   ❌ 이전 방식            ✅ 현재 방식
   slice(0, 32)          toString('hex')
        │                       │
        ↓                       ↓
   32바이트 추출          64바이트 사용
   64자 hex               128자 hex
        │                       │
        ↓                       ↓
❌ 문제 발생!             ✅ 정상 작동!
"bad secret key size"   keyPairFromSecretKey()
                         ✓ 지갑 주소 생성
                         ✓ 트랜잭션 서명
```

---

## 2. 64바이트 Secret Key의 내부 구조

```
ED25519 Secret Key (64바이트 = 128자 16진수)
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│  Seed (32바이트)          │        Prefix (32바이트)          │
│  ──────────────────────   │   ──────────────────────────      │
│  [XXXXXXXXXXXXX...]       │   [YYYYYYYYYYYYY...]              │
│                           │                                   │
│  16진수 앞 64자            │   16진수 뒷 64자                  │
│  4e6568d1990bff34...      │   d3a59677f67586...               │
│                                                                │
└────────────────────────────────────────────────────────────────┘

실제 예시:
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│ 4e6568d1990bff34c3fc1e9243b8073262250bfab28d16a4d8c7ffd8 │ Seed
│                                                                │
│ 4479742d3a59677f67586df6a530023e054bfcd99e4cb2f7f134828 │ Prefix
│                                                                │
│ d45905ba1ef7978fc                                             │
│                                                                │
└────────────────────────────────────────────────────────────────┘
 ↑                                                              ↑
 2자                                                         128자
```

---

## 3. 바이트 ↔ 16진수 변환 공식 시각화

```
1 바이트 = 8비트 = 16진수 2자리

예시:

┌──────┬──────┬──────┬──────┐
│ 0xDE │ 0xAD │ 0xBE │ 0xEF │
└──────┴──────┴──────┴──────┘
  1바이트  1바이트  1바이트  1바이트
  2자리    2자리    2자리    2자리
  = 4바이트 = 8자리 16진수


CandleSpinner:

64자 16진수
= 32자 / 2
= 32바이트
= 불완전 (Seed만)
= ❌ keyPairFromSecretKey() 실패

128자 16진수
= 128자 / 2
= 64바이트
= 완전 (Seed + Prefix)
= ✅ keyPairFromSecretKey() 성공
```

---

## 4. 블록체인별 개인키 크기 비교

```
ECDSA (secp256k1) 방식:
┌─────────────────────────────┐
│ Bitcoin / Ethereum          │
├─────────────────────────────┤
│ Secret Key = 32바이트       │
│           = 64자 16진수     │
│                             │
│ 공개키 유도가 단순함        │
│ Seed만으로 충분             │
└─────────────────────────────┘


ED25519 (타원곡선) 방식:
┌─────────────────────────────┐
│ TON / Solana                │
├─────────────────────────────┤
│ Secret Key = 64바이트       │
│           = 128자 16진수    │
│                             │
│ 공개키 유도가 복잡함        │
│ Seed + Prefix 모두 필요     │
└─────────────────────────────┘
```

---

## 5. 오류 발생 단계별 분석

### ❌ 이전 (오류 발생)

```
단계 1: 니모닉 입력
"tornado run casual carbon laptop..."
        ↓
단계 2: mnemonicToPrivateKey() 실행
keyPair.secretKey = [64바이트 버퍼]
        ↓
단계 3: slice(0, 32) - 앞 32바이트만 추출
privateKeyHex = "4e6568d1990bff34...3262250bfab28d16a4d8c7ffd8"
                (64자)
        ↓
단계 4: initiate-withdrawal.ts에서 사용
keyPairFromSecretKey(Buffer.from(privateKeyHex, 'hex'))
                                  ↑
                                  64자를 Buffer로 변환
                                  = 32바이트
        ↓
❌ 오류!
에러 메시지: "bad secret key size"
@ton/crypto 요구사항: 64바이트 (128자)
실제 제공: 32바이트 (64자)
```

### ✅ 현재 (정상 작동)

```
단계 1: 니모닉 입력
"tornado run casual carbon laptop..."
        ↓
단계 2: mnemonicToPrivateKey() 실행
keyPair.secretKey = [64바이트 버퍼]
        ↓
단계 3: toString('hex') - 전체 64바이트 변환
privateKeyHex = "4e6568d1990bff34...ef7978fc"
                (128자)
        ↓
단계 4: initiate-withdrawal.ts에서 사용
keyPairFromSecretKey(Buffer.from(privateKeyHex, 'hex'))
                                  ↑
                                  128자를 Buffer로 변환
                                  = 64바이트
        ↓
✅ 성공!
공개키 생성 완료
지갑 주소 생성 완료
트랜잭션 서명 가능
```

---

## 6. CandleSpinner 코드 변경 비교

### ❌ 이전 코드

```typescript
// wallet-tools/mnemonic-to-key.mjs (수정 전)
const keyPair = await mnemonicToPrivateKey(mnemonic);

// secretKey 버퍼는 64바이트이지만...
console.log(keyPair.secretKey.length); // 64

// ❌ 32바이트만 추출!
const privateKeyHex = keyPair.secretKey.slice(0, 32).toString('hex');
console.log(privateKeyHex.length); // 64자

// 결과: 불완전한 개인키
```

### ✅ 현재 코드

```typescript
// wallet-tools/mnemonic-to-key.mjs (수정 후)
const keyPair = await mnemonicToPrivateKey(mnemonic);

// secretKey 버퍼 전체 사용
console.log(keyPair.secretKey.length); // 64

// ✅ 64바이트 모두 사용!
const privateKeyHex = keyPair.secretKey.toString('hex');
console.log(privateKeyHex.length); // 128자

// 결과: 완전한 개인키
```

---

## 7. @ton/crypto의 내부 동작 (개념도)

```typescript
// @ton/crypto의 keyPairFromSecretKey() 함수 (개념)

export function keyPairFromSecretKey(secretKey: Buffer): KeyPair {
  // 1단계: 입력 검증
  if (secretKey.length !== 64) {
    throw new Error('bad secret key size');
    // ↑ 반드시 64바이트여야 함!
  }

  // 2단계: Secret Key 분해
  const seed = secretKey.slice(0, 32);        // 앞 32바이트
  const prefix = secretKey.slice(32, 64);     // 뒷 32바이트

  // 3단계: ED25519 알고리즘
  const publicKey = ed25519.derivePublicKey(seed, prefix);
  //                         ↑ Seed와 Prefix 모두 필요!

  // 4단계: 반환
  return {
    secretKey: secretKey,      // 64바이트
    publicKey: publicKey       // 32바이트
  };
}
```

---

## 8. 트랜잭션 서명 과정

```
개인키(Secret Key) 사용 흐름:

트랜잭션 생성
    ↓
keyPairFromSecretKey(128자 개인키)
    ↓
┌─────────────────────┐
│ Seed (32바이트)     │
│ + Prefix (32바이트) │
└─────────────────────┘
    ↓
ED25519 서명 알고리즘
    ↓
서명 생성 (트랜잭션 해시)
    ↓
블록체인에 전송

⚠️ 주의: 이 과정에서 Seed와 Prefix 모두 필요!
         Seed만으로는 불가능!
```

---

## 9. 정리: 왜 128자인가?

```
Question: 왜 64자가 아니라 128자여야 하나요?

Answer: ED25519 표준 때문입니다!

┌──────────────────────────────────────────────────┐
│ ED25519 Secret Key = 64바이트 (불변)            │
│                   = Seed (32) + Prefix (32)     │
│                   = 128자 16진수                 │
│                                                  │
│ @ton/crypto의 keyPairFromSecretKey()는          │
│ 이 표준을 엄격하게 따릅니다.                    │
│                                                  │
│ 64바이트 미만 → 오류!                           │
│ 64바이트 정확히 → 성공!                         │
│ 64바이트 초과 → 오류!                           │
└──────────────────────────────────────────────────┘

CandleSpinner는 이 표준을 준수하도록 수정했습니다.
```

---

## 📚 핵심 요점 3가지

### 1️⃣ 단위 이해
```
1 바이트 = 2 자리 16진수
64 바이트 = 128 자리 16진수
```

### 2️⃣ ED25519 구조
```
Secret Key = Seed + Prefix = 64바이트
@ton/crypto는 정확히 이 크기를 요구
```

### 3️⃣ CandleSpinner 수정
```
❌ 64자 (32바이트) → "bad secret key size" 오류
✅ 128자 (64바이트) → 정상 작동
```

---

## ✅ 결론

**64자 vs 128자 개인키:**

| 구분 | 64자 | 128자 |
|------|------|-------|
| 바이트 크기 | 32 | 64 |
| 구성 | Seed만 | Seed + Prefix |
| ED25519 표준 | ❌ 불완전 | ✅ 완전 |
| @ton/crypto | ❌ 오류 | ✅ 정상 |
| CandleSpinner | ❌ 불가 | ✅ 필수 |

**따라서 128자를 사용해야 합니다!** 🔐
