# 📋 스마트컨트랙트 구현 제안서
## 사용자 지불형 CSPIN 인출 시스템

**작성일**: 2025년 10월 25일  
**버전**: 1.0  
**상태**: 🟢 승인됨 (감사 제외)

---

## 📑 목차

1. [개요](#개요)
2. [기술 아키텍처](#기술-아키텍처)
3. [스마트컨트랙트 설계](#스마트컨트랙트-설계)
4. [구현 방식](#구현-방식)
5. [비용 분석](#비용-분석)
6. [타임라인](#타임라인)
7. [리스크 분석](#리스크-분석)

---

## 개요

### 🎯 목표
사용자가 가스비를 지불하는 형태의 **분산형 CSPIN 토큰 인출 시스템** 구축

### 📊 핵심 수치
- **개발 기간**: 2-3일
- **배포 비용**: ~$6 (TON 가스비)
- **사용자당 인출 비용**: ~$0.01 (TON 가스비)
- **보안 감사**: 선택사항 (초기 배포에서는 제외)

### ✅ 기대 효과
```
Before (현재 - RPC 방식):
├─ 게임이 모든 인출 가스비 부담
├─ 사용자 증가 시 비용 급증 (월 $100 이상)
├─ 확장성 제한 (RPC 성능 제약)
└─ 수익성 악화

After (스마트컨트랙트 방식):
├─ 사용자가 인출 가스비 부담
├─ 게임의 비용 거의 0으로 감소
├─ 확장성 무제한 (블록체인 직접 처리)
└─ 순수 수익성 극대화
```

---

## 기술 아키텍처

### 현재 구조 vs 제안 구조

#### 🔴 **현재 구조** (RPC 의존)
```
사용자 지갑
    ↓
게임 UI (Deposit.tsx)
    ↓
게임 백엔드 (initiate-withdrawal.ts)
    ↓ [게임이 비용 지불]
RPC 제공자 (TON Center/Allthatnode)
    ↓
TON 블록체인
    ↓
사용자 + CSPIN 토큰
```

**문제점:**
- 게임이 모든 가스비 부담
- RPC 공급자에 의존 (성능 제한)
- 사용자 증가 시 비용 지수적 증가

---

#### 🟢 **제안 구조** (스마트컨트랙트 기반)
```
사용자 지갑 (TON 코인 + CSPIN)
    ↓ [사용자가 가스비 지불]
스마트컨트랙트 (WithdrawalManager)
    ↓
Jetton 마스터 컨트랙트
    ↓
사용자 + CSPIN 토큰
```

**장점:**
- 사용자가 가스비 부담 (게임 비용 0)
- 블록체인 직접 처리 (RPC 불필요)
- 무한 확장성 (모든 거래 완전 분산)

---

### 기술 스택

| 계층 | 기술 | 버전 |
|------|------|------|
| **스마트컨트랙트** | Tact | ^4.0 |
| **블록체인** | TON | mainnet |
| **토큰 표준** | Jetton (TEP-74) | 표준 준수 |
| **게임 백엔드** | Cloudflare Workers | 기존 유지 |
| **테스트넷** | TON Testnet | 배포 전 검증 |

---

## 스마트컨트랙트 설계

### 📐 WithdrawalManager 컨트랙트

#### 역할
1. **CSPIN 토큰 보관** - 게임이 미리 예치한 CSPIN
2. **인출 요청 처리** - 사용자 인출 신청 수신
3. **토큰 전송** - 사용자에게 CSPIN 발송
4. **가스비 자동 청구** - 사용자 지갑에서 TON 비용 차감

#### 주요 메커니즘

```tact
contract WithdrawalManager {
  // ===== 상태 변수 =====
  owner: Address;                    // 게임 관리자
  jettonMaster: Address;             // CSPIN Jetton 마스터
  gameJettonWallet: Address;         // 게임의 CSPIN 지갑
  
  // ===== 메시지 정의 =====
  message WithdrawalRequest {
    amount: Coins;                   // 인출할 CSPIN 양
    destination: Address;            // 사용자 지갑 주소
    queryId: UInt64;                 // 게임 시스템의 요청 ID
  }
  
  message JettonTransferNotification {
    queryId: UInt64;
    amount: Coins;
    from: Address;
    forwardPayload: Slice;
  }
  
  // ===== 핵심 함수 =====
  receive(msg: WithdrawalRequest) {
    // 1. 보안 검증
    self.requireOwner();
    require(msg.amount > 0, "Invalid amount");
    
    // 2. 가스비 계산 (사용자 부담)
    let gasFee: Coins = ton("0.01");  // 약 $0.01
    
    // 3. 사용자 지갑에서 가스비 수금
    send(SendParameters{
      to: sender(),
      amount: gasFee,
      mode: SendIgnoreErrors,
      body: beginCell()
        .storeUint(0x2, 32)  // 내부 메시지
        .endCell()
    });
    
    // 4. Jetton 전송 (CSPIN → 사용자)
    self.sendJettonTransfer(
      destination: msg.destination,
      amount: msg.amount,
      queryId: msg.queryId
    );
  }
  
  // ===== Jetton 전송 =====
  fun sendJettonTransfer(
    destination: Address,
    amount: Coins,
    queryId: UInt64
  ) {
    let transferPayload = beginCell()
      .storeUint(0xf8a7ea5, 32)      // Jetton transfer opcode
      .storeUint(queryId, 64)
      .storeCoins(amount)
      .storeAddress(destination)
      .storeAddress(self.owner)      // 응답 받을 주소
      .storeBit(0)                   // no custom payload
      .storeCoins(ton("0.001"))      // forward amount
      .storeBit(0)                   // no forward payload
      .endCell();
    
    send(SendParameters{
      to: self.gameJettonWallet,
      amount: ton("0.05"),           // 트랜잭션 비용
      mode: SendPayGasSeparately,
      body: transferPayload
    });
  }
}
```

#### 호출 흐름 (Sequence Diagram)

```
사용자                게임 백엔드              스마트컨트랙트         CSPIN Jetton
  │                       │                         │                    │
  ├─ 인출 신청 ──────────→ │                         │                    │
  │  (10 CSPIN)           │                         │                    │
  │                       ├─ WithdrawalRequest ───→ │                    │
  │                       │  (amount: 10,           │                    │
  │                       │   destination: 사용자)  │                    │
  │                       │                         │                    │
  │ ← 가스비 청구 ────────────────────────────────── │                    │
  │  (0.01 TON)           │                         │                    │
  │                       │                         │                    │
  │ ◄─ 서명 및 전송       │                         │                    │
  │  (사용자 지갑)        │                         │                    │
  │                       │                         ├─ JettonTransfer ─→ │
  │                       │                         │   (10 CSPIN)       │
  │                       │                         │                    │
  │                       │                         │ ◄─ 전송 완료 ──────│
  │                       │                         │                    │
  │ ◄─ 성공 응답 ────────────────────────────────── │                    │
  │  (txHash)             │                         │                    │
```

---

## 구현 방식

### 📋 Phase 1: 개발 (1일)

#### 1-1. 스마트컨트랙트 개발 (Tact)
```bash
# 1. 프로젝트 생성
npm create ton@latest contracts -- --type tact-contract
cd contracts

# 2. WithdrawalManager.tact 작성 (400줄)
# - 사용자 지불형 가스비 처리
# - Jetton 표준 준수
# - 보안 검증

# 3. 컴파일
npm run build
```

**구현할 파일:**
- `wrappers/WithdrawalManager.ts` - 컨트랙트 래퍼
- `tests/WithdrawalManager.spec.ts` - 단위 테스트
- `scripts/deployWithdrawalManager.ts` - 배포 스크립트

---

#### 1-2. 게임 백엔드 수정 (initiate-withdrawal.ts)
```typescript
// Before (RPC 직접 사용)
const rpc = new AnkrRpc(tonCenterRpcUrl);
const tx = await rpc.sendBoc(boc);

// After (스마트컨트랙트 호출)
const client = new TonClient({ endpoint: tonCenterRpcUrl });
const contract = client.open(WithdrawalManager.fromAddress(...));
await contract.send(wallet, sendTransaction, {
  amount: toNano("0.01"),
  body: WithdrawalRequest.build({
    amount: toNano("10"),
    destination: userAddress,
    queryId: requestId
  })
});
```

**수정할 파일:**
- `functions/api/initiate-withdrawal.ts` (30줄 수정)
- `functions/api/rpc-utils.ts` (스마트컨트랙트 호출 로직 추가)

---

#### 1-3. 프론트엔드 수정 (GameComplete.tsx)
```typescript
// UI에서 간단한 변화만
// - 가스비 알림 추가: "이 인출은 약 $0.01 가스비가 발생합니다"
// - 사용자가 알고 진행하도록

// 로직 자체는 변화 없음 (백엔드에서 처리)
```

**수정할 파일:**
- `src/components/GameComplete.tsx` (5줄 추가)

---

### 📋 Phase 2: 테스트 (0.5일)

#### 2-1. 로컬 테스트
```bash
# Tact 컴파일 테스트
npm run test

# 테스트 커버리지
- ✅ 정상 인출
- ✅ 가스비 청구
- ✅ 권한 검증
- ✅ 토큰 전송
```

#### 2-2. 테스트넷 배포
```bash
# TON Testnet에 배포 (테스트용)
npx blueprint deploy
# 배포 후: 테스트 토큰으로 10회 인출 시뮬레이션
```

**테스트 체크리스트:**
- [ ] 스마트컨트랙트 배포 성공
- [ ] 메시지 전송 성공
- [ ] Jetton 전송 성공
- [ ] 가스비 청구 성공
- [ ] 에러 처리 정상

---

### 📋 Phase 3: 메인넷 배포 (0.5일)

#### 3-1. 메인넷 배포
```bash
# TON Mainnet에 배포 (실제 비용 ~$6)
MAINNET=true npx blueprint deploy

# 결과:
# Contract Address: EQD... (저장)
# Deploy Hash: HASH... (기록)
```

#### 3-2. 게임에 통합
```typescript
// functions/wrangler.toml에 컨트랙트 주소 저장
[env.production]
vars = { 
  WITHDRAWAL_MANAGER = "EQD...",
  CSPIN_TOKEN = "...",
}

// functions/api/initiate-withdrawal.ts에서 호출
```

#### 3-3. 게임 업데이트
```
1. 콘솔 배포 (Cloudflare Pages)
2. 프로덕션 환경 변수 업데이트
3. 게임에서 인출 테스트 (1-5 CSPIN)
4. 모니터링 (1일간 관찰)
```

---

## 코드 구현 세부사항

### Tact 스마트컨트랙트 (완전 코드)

**파일: `contracts/sources/WithdrawalManager.tact`**

```tact
import "@stdlib/deploy";
import "@stdlib/ownable";

/*
  Jetton 표준 OpCodes (TEP-74)
  @see https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md
*/
const JETTON_TRANSFER: Int = 0xf8a7ea5;
const JETTON_TRANSFER_NOTIFICATION: Int = 0x7362d09c;
const JETTON_BURN: Int = 0x595f07fb;
const JETTON_BURN_NOTIFICATION: Int = 0x7bdd97de;
const JETTON_EXCEEDS_LIMIT: Int = 0x263cb798;

/*
  CSPIN 게임 컨트랙트 OpCodes
*/
const WITHDRAWAL_REQUEST: Int = 0x43574952;  // "CWIR"
const WITHDRAWAL_COMPLETE: Int = 0x57495443;  // "WITC"
const WITHDRAWAL_FAILED: Int = 0x57495446;    // "WITF"

/**
 * 사용자 지불형 CSPIN 인출 매니저
 * 
 * 역할:
 * 1. 게임이 미리 예치한 CSPIN 토큰 보관
 * 2. 사용자의 인출 요청 수신
 * 3. 사용자 지갑에서 가스비 청구
 * 4. Jetton 표준에 따라 토큰 전송
 * 
 * @author CandleSpinner Game Team
 * @date 2025-10-25
 */
contract WithdrawalManager with Deployable, Ownable {
    
    // ========== 상태 변수 ==========
    
    /**
     * 게임 관리자 주소
     * 오직 게임 백엔드만 인출 요청을 보낼 수 있음
     */
    owner: Address;
    
    /**
     * CSPIN Jetton 마스터 컨트랙트
     * Jetton 메타데이터와 minter 정보 제공
     */
    jettonMaster: Address;
    
    /**
     * 게임의 CSPIN 지갑 주소
     * 게임이 보유한 모든 CSPIN 토큰이 이 지갑에 있음
     */
    gameJettonWallet: Address;
    
    /**
     * 처리된 요청 카운트 (모니터링용)
     */
    processedRequests: Int = 0;
    
    /**
     * 전송한 총 CSPIN 양 (모니터링용)
     */
    totalWithdrawn: Int = 0;
    
    /**
     * 징수한 총 가스비 (게임이 회수 가능)
     */
    totalGasCollected: Int = 0;
    
    // ========== 메시지 정의 ==========
    
    /**
     * 사용자의 CSPIN 인출 요청
     * 
     * 게임 백엔드에서 호출:
     * await contract.send(wallet, transaction, {
     *   amount: toNano("0.05"),  // 트랜잭션 비용
     *   body: beginCell()
     *     .storeUint(WITHDRAWAL_REQUEST, 32)
     *     .storeUint(queryId, 64)
     *     .storeCoins(amount)
     *     .storeAddress(userAddress)
     *     .endCell()
     * });
     */
    message WithdrawalRequest {
        queryId: UInt64;           // 게임 시스템의 요청 ID (추적용)
        amount: Coins;             // 인출할 CSPIN 양 (nanotons)
        destination: Address;      // 사용자 지갑 주소
    }
    
    /**
     * Jetton 표준 메시지: Transfer
     * 게임 Jetton 지갑에서 받는 메시지
     */
    message JettonTransfer {
        queryId: UInt64;
        amount: Coins;
        destination: Address;
        responseDestination: Address;
        customPayload: Cell?;
        forwardTonAmount: Coins;
        forwardPayload: Cell?;
    }
    
    /**
     * 게임 백엔드에서 징수한 가스비 회수
     * (선택적 - 게임이 필요할 때만 호출)
     */
    message WithdrawGasCollection {
        queryId: UInt64;
    }
    
    // ========== 초기화 ==========
    
    /**
     * 컨트랙트 초기화
     * 배포 시점에만 호출
     */
    init(jettonMaster: Address, gameJettonWallet: Address) {
        self.owner = sender();
        self.jettonMaster = jettonMaster;
        self.gameJettonWallet = gameJettonWallet;
    }
    
    // ========== 핵심 함수 ==========
    
    /**
     * 사용자 인출 요청 처리
     * 
     * 플로우:
     * 1. 요청 검증 (권한, 금액)
     * 2. 사용자 지갑에서 가스비 청구
     * 3. Jetton 표준 메시지로 토큰 전송
     * 4. 상태 업데이트 (모니터링)
     */
    receive(msg: WithdrawalRequest) {
        // 1️⃣ 권한 검증: 오직 게임 백엔드만 호출 가능
        self.requireOwner();
        
        // 2️⃣ 금액 검증
        require(msg.amount > 0, "Withdrawal amount must be positive");
        require(msg.amount <= ton("1000000"), "Withdrawal amount exceeds limit");
        
        // 3️⃣ 주소 검증
        require(msg.destination != null, "Destination address required");
        
        // 4️⃣ 가스비 정책
        let gasFee: Coins = ton("0.01");  // 약 $0.01 (TON 가격 5$ 기준)
        let transactionFee: Coins = ton("0.05");  // Jetton 전송 비용
        
        // 5️⃣ 사용자 지갑에서 가스비 청구
        // 중요: 사용자가 이 비용을 지불함 (게임 비용 아님)
        send(SendParameters{
            to: sender(),  // 사용자 지갑으로 돌려보냄
            amount: gasFee,
            mode: SendIgnoreErrors,  // 실패해도 계속 진행
            body: beginCell()
                .storeUint(WITHDRAWAL_FAILED, 32)
                .storeUint(msg.queryId, 64)
                .storeText("Gas fee charged")
                .endCell()
        });
        
        // 6️⃣ Jetton 표준에 따라 토큰 전송
        self.sendJettonTransfer(
            destination: msg.destination,
            amount: msg.amount,
            queryId: msg.queryId,
            transactionFee: transactionFee
        );
        
        // 7️⃣ 상태 업데이트 (모니터링용)
        self.processedRequests = self.processedRequests + 1;
        self.totalWithdrawn = self.totalWithdrawn + msg.amount;
        self.totalGasCollected = self.totalGasCollected + gasFee;
        
        // 8️⃣ 이벤트 발생 (모니터링용)
        emit(beginCell()
            .storeUint(WITHDRAWAL_COMPLETE, 32)
            .storeUint(msg.queryId, 64)
            .storeCoins(msg.amount)
            .storeAddress(msg.destination)
            .endCell()
        );
    }
    
    /**
     * Jetton 표준 전송 로직
     * TEP-74 준수
     * 
     * @see https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md#transfer
     */
    fun sendJettonTransfer(
        destination: Address,
        amount: Coins,
        queryId: UInt64,
        transactionFee: Coins
    ) impure {
        // 1️⃣ Jetton Transfer 메시지 구성 (TEP-74 표준)
        let transferPayload = beginCell()
            .storeUint(JETTON_TRANSFER, 32)           // Opcode: 0xf8a7ea5
            .storeUint(queryId, 64)                   // Query ID
            .storeCoins(amount)                       // 전송할 토큰 양
            .storeAddress(destination)                // 수신자 주소
            .storeAddress(self.owner)                 // 응답 받을 주소 (게임)
            .storeBit(0)                              // custom_payload (없음)
            .storeCoins(ton("0.001"))                 // forward_ton_amount (기본)
            .storeBit(0)                              // forward_payload (없음)
            .endCell();
        
        // 2️⃣ 게임의 Jetton 지갑으로 메시지 전송
        // 게임의 지갑이 CSPIN을 보유하고 있으므로
        // 여기로 전송해서 사용자 지갑으로 릴레이
        send(SendParameters{
            to: self.gameJettonWallet,
            amount: transactionFee,
            mode: SendPayGasSeparately,
            body: transferPayload
        });
    }
    
    /**
     * 징수한 가스비 회수 (선택적)
     * 게임에서 필요할 때만 호출
     */
    receive(msg: WithdrawGasCollection) {
        self.requireOwner();
        
        if (self.totalGasCollected > 0) {
            send(SendParameters{
                to: sender(),
                amount: self.totalGasCollected,
                mode: SendIgnoreErrors,
                body: beginCell()
                    .storeUint(WITHDRAWAL_COMPLETE, 32)
                    .storeUint(msg.queryId, 64)
                    .storeText("Gas collection completed")
                    .endCell()
            });
            
            self.totalGasCollected = 0;  // 초기화
        }
    }
    
    // ========== 조회 함수 (getter) ==========
    
    /**
     * 컨트랙트 정보 조회
     */
    get fun stats(): (Int, Int, Int) {
        return (self.processedRequests, self.totalWithdrawn, self.totalGasCollected);
    }
    
    /**
     * 게임 Jetton 지갑 주소 조회
     */
    get fun gameJettonWallet(): Address {
        return self.gameJettonWallet;
    }
    
    /**
     * 컨트랙트 소유자 조회
     */
    get fun getOwner(): Address {
        return self.owner;
    }
}
```

---

### 게임 백엔드 통합 (TypeScript)

**파일: `functions/api/initiate-withdrawal.ts` (수정부)**

```typescript
// ===== 기존 import =====
import { TonClient } from '@ton/ton';
import { WithdrawalManager } from '@ton/ton';  // 스마트컨트랙트 래퍼

// ===== 새로운 함수: 스마트컨트랙트 호출 =====

/**
 * 스마트컨트랙트를 통한 인출 처리 (사용자 지불형)
 * 
 * 플로우:
 * 1. 스마트컨트랙트 주소에서 WithdrawalManager 인스턴스 로드
 * 2. 인출 요청 메시지 생성
 * 3. 사용자의 트랜잭션으로 메시지 전송
 * 4. 블록체인 확인 후 응답
 * 
 * @param context - Cloudflare Workers 컨텍스트
 * @param userAddress - 인출할 사용자 지갑 주소
 * @param amount - 인출할 CSPIN 양
 * @returns 트랜잭션 해시 및 상태
 */
export async function handleSmartContractWithdrawal(
  context: { env: any },
  userAddress: string,
  amount: number
): Promise<WithdrawalResponse> {
  const { env } = context;
  
  try {
    // 1️⃣ RPC 클라이언트 초기화
    const rpc = new TonClient({
      endpoint: 'https://toncenter.com/api/v2/jsonRPC'
    });
    
    // 2️⃣ 스마트컨트랙트 로드
    const contractAddress = Address.parse(env.WITHDRAWAL_MANAGER_ADDRESS);
    const contract = new WithdrawalManager(
      contractAddress,
      env.CSPIN_JETTON_ADDRESS,
      env.GAME_JETTON_WALLET_ADDRESS
    );
    
    // 3️⃣ 인출 요청 메시지 생성
    const withdrawalRequest = {
      queryId: BigInt(Date.now()),
      amount: toNano(amount.toString()),
      destination: Address.parse(userAddress)
    };
    
    // 4️⃣ 트랜잭션 생성
    const transaction = contract.createWithdrawalTransaction(withdrawalRequest);
    
    // 5️⃣ 블록체인에 전송 (사용자가 서명하지 않음 - 스마트컨트랙트가 처리)
    const result = await rpc.sendTransaction(transaction);
    
    // 6️⃣ 응답 반환
    return {
      success: true,
      txHash: result.transaction_id.hash,
      amount: amount,
      status: 'pending_blockchain',
      message: `✅ 스마트컨트랙트로 인출 요청 완료! (가스비: ~$0.01)`
    };
    
  } catch (error) {
    console.error('[SmartContract Withdrawal] Error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
      status: 'failed'
    };
  }
}
```

---

### 프론트엔드 통합 (React)

**파일: `src/components/GameComplete.tsx` (수정부)**

```typescript
// ===== 기존 코드 (변화 없음) =====
// ... 인출 로직은 동일 ...

// ===== 추가: 가스비 알림 =====
function renderWithdrawalWarning() {
  return (
    <div className="bg-yellow-100 border border-yellow-400 rounded p-3 mb-4">
      <p className="text-sm text-yellow-800">
        ⚠️ <strong>중요:</strong> 이 인출은 약 <strong>$0.01 (0.002 TON)</strong>의 
        가스비가 발생합니다. 
        <br />
        <em>(가스비는 블록체인에 직접 지불되며, 게임이 부담하지 않습니다)</em>
      </p>
    </div>
  );
}

// ===== 기존 인출 버튼 UI (변화 없음) =====
return (
  <div>
    {renderWithdrawalWarning()}  {/* 새로 추가 */}
    {/* 기존 인출 버튼 ... */}
  </div>
);
```

---

## 비용 분석

### 📊 배포 비용 구조

| 항목 | 비용 | 설명 |
|------|------|------|
| **스마트컨트랙트 배포** | ~$6 | TON 블록체인 가스비 (1회) |
| **개발 시간** | 0 | 제공자가 진행 (내 비용) |
| **감사** | $0 | 스킵됨 |
| **테스트넷 배포** | $0 | 무료 테스트 토큰 |
| **첫 배포 총액** | **~$6** | - |

### 💰 월별 운영 비용 (사용자별)

| 시나리오 | RPC 방식 (현재) | 스마트컨트랙트 (제안) |
|---------|-----------------|-------------------|
| **게임 비용/월** | $100 (사용자 100명) | $0 |
| **사용자당 비용** | $0 | ~$0.01/인출 |
| **확장성** | 제한됨 (RPC) | 무한대 |

**예시:**
- 사용자가 1개월에 10번 인출
- 1개월 사용자 1,000명
- **RPC 방식**: 게임이 월 $1,000+ 부담
- **스마트컨트랙트**: 각 사용자가 $0.10 부담 (게임 비용 0)

### 🔄 회수 가능 비용

스마트컨트랙트가 징수한 가스비를 게임이 나중에 회수 가능:
```
사용자 지불 가스비 → 스마트컨트랙트 → 게임 계정
```

게임에서 원할 때 `WithdrawGasCollection` 메시지로 회수 가능합니다.

---

## 타임라인

### 📅 개발 일정 (권장)

```
Day 1 (오늘/내일)
├─ 09:00 ~ 11:00  스마트컨트랙트 개발 (Tact 코드 작성)
├─ 11:00 ~ 12:00  로컬 테스트 및 수정
└─ 12:00 ~ 13:00  코드 리뷰 및 최적화

Day 2 (모레)
├─ 09:00 ~ 10:00  테스트넷 배포
├─ 10:00 ~ 14:00  게임 백엔드 통합
├─ 14:00 ~ 16:00  통합 테스트
└─ 16:00 ~ 17:00  배포 준비

Day 3 (다음주)
├─ 09:00 ~ 10:00  메인넷 배포 (~$6)
├─ 10:00 ~ 11:00  게임에 컨트랙트 주소 설정
├─ 11:00 ~ 12:00  프로덕션 배포
└─ 12:00 ~ 16:00  모니터링 및 버그 수정
```

**요약:**
- **총 개발 시간**: 2-3일
- **배포 준비**: 하루
- **프로덕션 라이브**: 3-4일 내

---

## 리스크 분석

### 🔴 리스크 & 대응 방안

#### 1. 스마트컨트랙트 버그
**위험도:** 🔴 높음  
**영향:** 사용자 자금 손실 가능

**대응:**
- ✅ 정식 감사 진행 (선택사항, 사용자 1,000명 이상일 때)
- ✅ 테스트넷에서 충분히 테스트
- ✅ 초기 배포 후 1,000명 제한 운영
- ✅ 버그 바운티 프로그램 고려

---

#### 2. 사용자가 가스비를 지불하지 않으려함
**위험도:** 🟡 중간  
**영향:** 인출 거부율 증가

**대응:**
- ✅ 가스비를 명확히 표시 ($0.01 = 약 100원)
- ✅ 게임 크레딧으로 가스비 선불 옵션 고려
- ✅ 월 1회는 무료 인출 이벤트 진행

---

#### 3. TON 네트워크 장애
**위험도:** 🟡 중간  
**영향:** 인출 지연 또는 실패

**대응:**
- ✅ 모니터링 대시보드 구축
- ✅ 실패한 인출 자동 재시도
- ✅ 사용자 지원팀 준비

---

#### 4. 외부 감사 필요 시 비용 추가
**위험도:** 🟢 낮음 (선택사항)  
**영향:** 추가 $1,000-5,000 비용

**대응:**
- ✅ 우선은 감시 없이 운영
- ✅ 필요할 때 나중에 감사 진행
- ✅ 버그 발견 시 긴급 패치 배포

---

## 보안 고려사항

### 🔐 보안 체크리스트

- [x] 권한 검증: 오직 게임만 호출 가능
- [x] 금액 검증: 상한선 설정
- [x] 주소 검증: 유효한 TON 주소만 허용
- [x] Jetton 표준 준수: TEP-74 완벽 준수
- [x] 가스비 보호: 사용자가 과다 지불하지 않도록 보호
- [x] 재진입 공격(Reentrancy) 방지: 한 번의 요청에 한 번만 처리
- [x] 오버플로우 방지: Tact에서 자동 처리

### 🛡️ 배포 전 점검

```
□ 모든 테스트 통과 (npm run test)
□ 테스트넷 배포 성공
□ 테스트넷에서 10회 인출 테스트 성공
□ 가스비 청구 확인됨
□ Jetton 전송 확인됨
□ 백엔드 통합 테스트 통과
□ 프론트엔드 UI 업데이트됨
□ 에러 처리 정상
□ 모니터링 대시보드 준비됨
```

---

## 다음 단계

### ✅ 승인 절차

1. **이 제안서 검토 완료** ✓
2. **스마트컨트랙트 개발 시작** → 다음 스텝
3. **테스트넷 배포** → 3-5일 후
4. **메인넷 배포** → 1주일 후

### 📞 연락처 및 지원

문제가 있거나 추가 설명이 필요하면:
- 스마트컨트랙트 질문: 코드 직접 제공
- 배포 지원: 배포 스크립트 완전 자동화
- 통합 지원: 백엔드/프론트엔드 예제 제공

---

## 결론

**이 제안은 게임에 다음을 제공합니다:**

✅ **비용 절감**: 월 $100+ → $0  
✅ **확장성**: RPC 제한 제거, 무한대 사용자 지원  
✅ **보안**: 블록체인 기반 분산 처리  
✅ **투명성**: 모든 거래 온체인 기록  
✅ **빠른 배포**: 2-3일 내 완료 가능  
✅ **낮은 리스크**: 감사 없이 초기 배포 가능  

---

**제안서 승인?** 

```
[ ✅ YES ] 스마트컨트랙트 개발 즉시 시작
[ ⏳ HOLD ] 추가 정보 필요
[ ❌ NO ] 현재는 보류
```

