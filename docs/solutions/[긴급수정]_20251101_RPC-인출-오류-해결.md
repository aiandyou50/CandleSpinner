# [긴급 수정] RPC 인출 오류 해결 - "bad secret key size" 수정

**작성일**: 2025-11-01  
**버전**: v2.5.1  
**작업자**: GitHub Copilot AI Agent

---

## 📋 문제 요약

### 증상
- RPC를 통한 젯톤 인출(withdrawal) 함수 실행 시 다음 오류 발생:
  ```
  ❌ 오류: bad secret key size (API Status 500)
  ```

### 근본 원인
- **GAME_WALLET_PRIVATE_KEY 환경변수의 형식 불일치**
  - 실제 저장된 값: **니모닉(24단어 mnemonic)**
  - 코드가 기대한 값: **64바이트 hex 문자열 (128자)**
  
- 코드가 니모닉을 hex로 파싱하려고 시도하여 "bad secret key size" 오류 발생

---

## 🔧 해결 방법

### 변경 사항

모든 API 엔드포인트에서 **니모닉 → 키페어 변환 로직** 수정:

#### 변경 전 (잘못된 코드)
```typescript
import { keyPairFromSecretKey } from '@ton/crypto';

const gameWalletPrivateKey = env.GAME_WALLET_PRIVATE_KEY;
const keyPair = keyPairFromSecretKey(Buffer.from(gameWalletPrivateKey, 'hex'));
```

#### 변경 후 (수정된 코드)
```typescript
import { mnemonicToPrivateKey, mnemonicValidate } from '@ton/crypto';

const gameWalletMnemonic = env.GAME_WALLET_PRIVATE_KEY;
const mnemonic = gameWalletMnemonic.trim().split(/\s+/);

// BIP39 유효성 검증
const isValid = await mnemonicValidate(mnemonic);
if (!isValid) {
  throw new Error('유효하지 않은 니모닉: BIP39 검증 실패');
}

// 니모닉을 키페어로 변환
const keyPair = await mnemonicToPrivateKey(mnemonic);
```

---

## 📁 수정된 파일 목록

### 1. **인출(Withdrawal) API** (3개 파일)
- `functions/api/initiate-withdrawal.ts` ✅ (메인 버전)
- `functions/api/initiate-withdrawal-v3.ts` ✅ (대체 버전)
- `functions/api/initiate-withdrawal-v2-backup.ts` ✅ (백업 버전)

### 2. **입금(Deposit) API** (1개 파일)
- `functions/api/initiate-deposit.ts` ✅

### 3. **디버그/진단 API** (2개 파일)
- `functions/api/debug-withdrawal.ts` ✅
  - 니모닉 단어 수 표시
  - 처음 3단어만 마스킹하여 표시
  
- `functions/api/debug-private-key.ts` ✅
  - BIP39 검증 로직 추가
  - 니모닉 형식 확인

---

## ✅ 검증 결과

### 빌드 테스트
```bash
✅ npm run typecheck  # TypeScript 컴파일 통과
✅ npm run build      # Vite 빌드 성공
```

### 보안 검증
- ✅ 니모닉은 절대 로그에 출력되지 않음
- ✅ 환경변수에서만 읽어옴
- ✅ 메모리에서만 처리되고 저장되지 않음
- ✅ BIP39 검증을 통해 유효성 확인

---

## 🚀 배포 가이드

### 1. Cloudflare Pages 환경변수 확인

**중요**: `GAME_WALLET_PRIVATE_KEY`가 **니모닉 형식**(24단어)으로 저장되어 있어야 합니다.

```
형식: word1 word2 word3 ... word24
예시: abandon ability able about above absent ... (24개 단어)
```

#### 환경변수 설정 위치
- URL: https://dash.cloudflare.com/[account]/pages/candlespinner/settings/environment-variables
- 변수명: `GAME_WALLET_PRIVATE_KEY`
- 값: 24단어 니모닉 (공백으로 구분)

### 2. 배포 후 테스트

#### A. 디버그 엔드포인트로 검증
```bash
# 1. 니모닉 형식 확인
curl https://aiandyou.me/api/debug-private-key

# 예상 응답:
{
  "status": "✅ 모든 검증 통과!",
  "mnemonicValid": true,
  "mnemonicWordCount": 24,
  "addressMatches": true,
  "verification": "✅ 니모닉과 지갑 주소가 일치합니다! (V5R1 - Telegram TON Wallet)"
}
```

```bash
# 2. 인출 API 상태 확인
curl https://aiandyou.me/api/debug-withdrawal

# 예상 응답:
{
  "status": {
    "mnemonicValid": true,
    "gameWalletValid": true,
    "cspinTokenValid": true
  },
  "addressMatch": {
    "match": true,
    "note": "✅ 니모닉과 주소가 일치합니다 (형식 무관)"
  }
}
```

#### B. 실제 인출 테스트
```bash
curl -X POST https://aiandyou.me/api/initiate-withdrawal \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "UQB...",
    "withdrawalAmount": 1,
    "userJettonWalletAddress": "EQA..."
  }'

# 예상 응답:
{
  "success": true,
  "txHash": "abc123...",
  "message": "RPC 방식 인출 완료: 1 CSPIN"
}
```

---

## 📝 추가 노트

### 니모닉 vs 개인키 (Private Key)

| 형식 | 예시 | 길이 | 사용 목적 |
|------|------|------|----------|
| **니모닉** | `abandon ability able...` | 24단어 | 사람이 기억하기 쉬운 형태 |
| **개인키 (hex)** | `4e6568d1990bff34...` | 128자 (64바이트) | 프로그램이 직접 사용 |

- 현재 프로젝트는 **니모닉** 형식 사용
- TON의 `mnemonicToPrivateKey()` 함수가 변환 처리

### 보안 권장사항

1. ✅ **니모닉은 절대 로그에 출력하지 마세요**
   - 현재 코드는 안전: `console.log('[RPC] 키 쌍 변환 완료')` (니모닉 미출력)

2. ✅ **니모닉은 환경변수에만 저장**
   - Cloudflare Pages 환경변수 사용 중
   - Git에는 절대 커밋하지 않음 (`.gitignore` 적용)

3. ✅ **BIP39 검증 필수**
   - 현재 코드는 `mnemonicValidate()` 사용

---

## 🔗 관련 문서

- [TON 공식 문서 - Mnemonic](https://docs.ton.org/develop/wallets/mnemonic)
- [@ton/crypto API](https://github.com/ton-org/ton-crypto)
- [BIP39 Mnemonic Standard](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki)

---

## 🎯 결론

이번 수정으로 다음 문제들이 해결되었습니다:

1. ✅ "bad secret key size" 오류 해결
2. ✅ 니모닉 → 키페어 변환 로직 수정
3. ✅ BIP39 유효성 검증 추가
4. ✅ 모든 인출/입금 API 일관성 유지
5. ✅ 디버그 엔드포인트 개선

**다음 단계**: 프로덕션 배포 후 실제 인출 테스트 수행

---

**수정 완료일**: 2025-11-01  
**검증 상태**: ✅ 로컬 빌드 테스트 통과  
**배포 대기**: 사용자 확인 필요
