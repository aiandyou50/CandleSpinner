# 🔐 보안 설정 가이드

## 📋 개요
이 문서는 CandleSpinner의 민감한 환경변수(개인키 등)를 안전하게 관리하는 방법을 설명합니다.

---

## ⚠️ 중요: 개인키는 절대 하드코딩하지 마세요

### ❌ 위험한 방법 (금지)
```toml
# wrangler.toml - DO NOT DO THIS!
[vars]
GAME_WALLET_PRIVATE_KEY = "4e6568d1..." # ❌ 절대 금지!
```

### ✅ 안전한 방법
Cloudflare Pages의 **환경 변수 설정**을 사용합니다.

---

## 🔧 Cloudflare Pages 환경변수 설정 방법

### Step 1: Cloudflare 대시보드 접속
1. https://dash.cloudflare.com 로그인
2. **Pages** → `candlespinner` 프로젝트 선택

### Step 2: 환경변수 추가
1. **Settings** → **Environment variables** 클릭
2. **Add variable** 버튼

### Step 3: Production 환경에 변수 추가

**변수명:**
```
GAME_WALLET_PRIVATE_KEY
```

**값:**
```
[wallet-tools/mnemonic-to-key.mjs에서 생성한 privateKey]
```

**바인딩:** Production

⚠️ **절대 금지:** 이 문서나 코드에 실제 개인키 작성

### Step 4: 배포 후 확인
```bash
curl https://aiandyou.me/api/debug-private-key
# 응답:
# {
#   "hasPrivateKey": true,
#   "addressMatches": true,
#   "verification": "✅ 개인키와 지갑 주소가 일치합니다!"
# }
```

---

## 🛡️ 보안 체크리스트

### ✅ 배포 전 확인사항
- [ ] `wrangler.toml`에 개인키 없음 (주석만 있음)
- [ ] `.gitignore`에 민감한 파일 추가됨
- [ ] Cloudflare 환경변수에 `GAME_WALLET_PRIVATE_KEY` 설정됨
- [ ] GitHub에는 공개키 정보만 있음

### ✅ 개발 로컬 환경 설정
```bash
# .env.local (절대 Git에 커밋하지 마세요)
# wallet-tools/mnemonic-to-key.mjs에서 생성한 privateKey 값
GAME_WALLET_PRIVATE_KEY=[128자-hex-값]
GAME_WALLET_ADDRESS=UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
```

---

## 📝 변수 설명

| 변수 | 설정위치 | 공개? | 설명 |
|------|---------|-------|------|
| `GAME_WALLET_ADDRESS` | wrangler.toml | ✅ 공개 | 게임 지갑 주소 (공개 정보) |
| `GAME_WALLET_PRIVATE_KEY` | Cloudflare 환경 | 🔐 비공개 | 개인키 (절대 노출 금지) |
| `CSPIN_TOKEN_ADDRESS` | wrangler.toml | ✅ 공개 | CSPIN 토큰 주소 |
| `TON_RPC_API_KEY` | Cloudflare 환경 | 🔐 비공개 | TON RPC 인증 키 |

---

## 🚨 주의: 개인키 절대 기록 금지

**이 문서에는 실제 개인키가 포함되지 않습니다.**
- 모든 개인키 값은 Cloudflare 대시보드에서만 관리
- 로컬 개발: `.env.local` (`.gitignore` 포함)
- 터미널: 절대 개인키 출력 금지

---

## 📚 Best Practices

### 1️⃣ 개인키 생성 및 저장
```bash
# mnemonic-to-key.mjs로 개인키 생성 (로컬에서만)
node wallet-tools/mnemonic-to-key.mjs "your 24-word mnemonic"

# 출력된 privateKey를 복사만 함 (파일에 저장 금지)
# Cloudflare에만 입력
# 로컬 히스토리 삭제:
Clear-History  # PowerShell
```

### 2️⃣ 코드에서 개인키 접근
```typescript
// ✅ 올바른 방법
const gameWalletPrivateKey = env.GAME_WALLET_PRIVATE_KEY;

// ❌ 절대 금지
const gameWalletPrivateKey = "4e6568d1..."; // 하드코딩 금지!
```

### 3️⃣ 로컬 개발 환경
```bash
# .env.local 파일 생성 (절대 Git 커밋 금지)
echo "GAME_WALLET_PRIVATE_KEY=..." > .env.local

# .gitignore에 추가
echo ".env.local" >> .gitignore

# 로컬 개발 시작
npm run dev
```

---

## 🔍 감사 및 모니터링

### Tonscan에서 지갑 활동 모니터링
- URL: `https://tonscan.org/address/{GAME_WALLET_ADDRESS}`
- 이상한 거래 발생 시 즉시 조치

### 터미널 히스토리 정리
```bash
# PowerShell: 현재 세션 히스토리 제거
Remove-Item (Get-PSReadlineOption).HistorySavePath

# Bash: 현재 세션 히스토리 제거
history -c
```

---

## 📞 문제 발생 시

### 개인키 노출된 경우
1. **긴급 대응:** 지갑의 모든 자산을 새 지갑으로 이전
2. **Git 정리:** `git rm --cached` 또는 `git-filter-branch`로 히스토리 제거
3. **Cloudflare 업데이트:** 새 개인키로 환경변수 교체

### Cloudflare 환경변수 확인 실패
1. Pages 프로젝트 Settings 재확인
2. 변수명/값 정확히 입력되었는지 검증
3. 배포 후 최소 1-2분 대기 후 재시도

---

## 📌 참고 문서

- [Cloudflare Pages - Environment Variables](https://developers.cloudflare.com/pages/platform/functions/environment-variables/)
- [TON Wallet Security](https://ton.org/docs/#/security)
- [Git Secrets Prevention](https://github.com/awslabs/git-secrets)

