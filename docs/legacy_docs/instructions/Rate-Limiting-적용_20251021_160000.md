# Rate Limiting 적용 지시서
## 목표: API 엔드포인트 보호 및 DDoS 방지
### 완료 날짜: 2025-10-21

---

## 📋 작업 개요

**목적**: Cloudflare Workers + KV를 활용한 효율적인 Rate Limiting 시스템 구축

**적용 범위**:
- CSPIN Jetton 전송 (매우 제한적: 10 req/min)
- 일반 API (표준: 100 req/min)
- 게임 API (중간: 50 req/min)
- 긴급 모드 (DDoS 방어: 1 req/10s)

---

## 🛠 구현 내용

### 1. Rate Limit Middleware 생성
**파일**: `functions/_rateLimit.ts`

**주요 함수**:
- `getClientIP()`: Cloudflare 헤더에서 실제 클라이언트 IP 추출
- `generateRateLimitKey()`: KV 저장소용 키 생성
- `checkRateLimit()`: Rate limit 확인 및 카운터 업데이트
- `createRateLimitResponse()`: 429 응답 생성

**설정 구조**:
```typescript
interface RateLimitConfig {
  limit: number;        // 최대 요청 수
  window: number;       // 시간 윈도우 (초)
  keyPrefix?: string;   // KV 키 프리픽스
}
```

### 2. Rate Limit Presets
```typescript
CSPIN_TRANSFER: { limit: 10, window: 60 }      // 1분당 10 요청
GENERAL_API:    { limit: 100, window: 60 }     // 1분당 100 요청
GAME_API:       { limit: 50, window: 60 }      // 1분당 50 요청
EMERGENCY:      { limit: 1, window: 10 }       // 10초당 1 요청
```

### 3. API 엔드포인트 통합
**예시** (functions/api/deposit.ts에 적용):
```typescript
const clientIP = getClientIP(request);
const rateLimitResult = await checkRateLimit(
  kv,
  clientIP,
  '/api/deposit',
  RATE_LIMIT_PRESETS.CSPIN_TRANSFER
);

if (!rateLimitResult.allowed) {
  return createRateLimitResponse(
    rateLimitResult.remaining,
    rateLimitResult.resetIn
  );
}
```

---

## ✅ 검증 체크리스트

### 코드 품질
- ✅ TypeScript 타입 안정성
- ✅ KV 저장소 TTL 설정
- ✅ 에러 핸들링 구현
- ✅ 클라이언트 IP 추출 로직

### 기능 검증
- [ ] Deposit 엔드포인트 통합
- [ ] Withdraw 엔드포인트 통합
- [ ] Game API 통합
- [ ] Rate limit 위반 시나리오 테스트

### 배포 준비
- [ ] Sentry에 rate limit 위반 로깅
- [ ] 모니터링 대시보드 설정
- [ ] 알림 규칙 구성
- [ ] KV 저장소 용량 모니터링

---

## 📊 기대 효과

### 보안 개선
- **봇 공격 차단**: 비정상 패턴 감지
- **토큰 도용 방지**: 짧은 시간 내 대량 거래 차단
- **DDoS 완화**: 비상 모드로 서버 보호

### 운영 안정성
- **비용 절감**: 불필요한 요청 차단
- **성능 개선**: 과부하 방지
- **예측 가능한 용량**: 리소스 사용량 제어

### 사용자 경험
- **명확한 오류 메시지**: Rate limit 안내
- **Retry-After 헤더**: 클라이언트 재시도 지원
- **투명한 정책**: 제한 사항 명시

---

## 🔑 구현 상태

| 항목 | 상태 | 비고 |
|------|------|------|
| Middleware 작성 | ✅ | functions/_rateLimit.ts |
| 함수 구현 | ✅ | getClientIP, checkRateLimit 등 |
| Preset 정의 | ✅ | 4가지 정책 수준 |
| TypeScript 타입 | ✅ | RateLimitConfig interface |
| KV TTL 관리 | ✅ | 자동 만료 설정 |
| 가이드 문서 | ✅ | RATE_LIMITING_GUIDE.md |

---

## 🚀 다음 단계

### 즉시 작업 (Phase 1-3)
- [ ] Deposit API에 Rate Limiting 적용
- [ ] Withdraw API에 Rate Limiting 적용
- [ ] Game API에 Rate Limiting 적용

### 모니터링 (Phase 1-4)
- [ ] Sentry에 rate limit 위반 추적
- [ ] KV 저장소 사용량 모니터링
- [ ] 상위 차단된 IP 추적

### 최적화 (Phase 2)
- [ ] 동적 Rate Limit 조정
- [ ] IP 화이트리스트/블랙리스트
- [ ] 사용자 티어별 차등 제한

---

## 📝 커밋 정보

**파일 생성**:
- `functions/_rateLimit.ts` (Rate limit middleware)
- `functions/api/RATE_LIMITING_GUIDE.md` (구현 가이드)

**총 변경**:
- 1개 파일 수정
- 2개 파일 생성
- ~200줄 코드 추가

---

## 🔗 참고 자료

- [Cloudflare Workers KV](https://developers.cloudflare.com/workers/runtime-apis/kv/)
- [HTTP 429 Too Many Requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429)
- [Rate Limiting Best Practices](https://cloud.google.com/solutions/rate-limiting-strategies-techniques)

---

## ⚠️ 주의사항

1. **IP 추출**: CF-Connecting-IP 헤더는 Cloudflare를 통할 때만 신뢰성 높음
2. **KV 비용**: Rate limit 데이터로 KV 쓰기 비용 발생 (모니터링 필요)
3. **시간 동기화**: 서버 시간과 클라이언트 시간 차이 고려
4. **테스트**: 실 배포 전 스테이징 환경에서 충분히 테스트

---

**Status**: ✅ Phase 1-3 완료 (Vitest ✅, Sentry ✅, Rate Limiting ✅)  
**다음 작업**: 환경변수 확대 (Phase 1-4)
