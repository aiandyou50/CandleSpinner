# 명령 지시서: MVP 전체 리팩토링 및 재구축

## 요청 내용
테스트 전체 실패로 인한 MVP 전체 코드 리팩토링 및 처음부터 재구축

## 현황 분석
1. **테스트 결과**: 모두 실패 ❌
   - 웹브라우저: CSPIN 토큰 입금 불가능
   - TMA: 시뮬레이션만 동작, 실제 트랜잭션 불가능
   - 근본 원인: 백엔드 RPC 호출 기반 아키텍처 문제

2. **아키텍처 재평가**:
   - 이전: Cloudflare Functions에서 RPC 호출 → 너무 복잡하고 비용 높음
   - **신규**: TonConnect 클라이언트 서명만 사용 → 간단하고 무료

3. **환경 변수 추가**:
   - Cloudflare Pages에 `BOT_TOKEN` 환경 변수 추가됨 ✓

## 요구사항

### Phase 1: 무료 RPC API 선정 및 Ankr 통합 ✅
- **선정 API**: Ankr RPC (무료, HTTPS 지원)
- HTTPS 엔드포인트: https://rpc.ankr.com/ton_api_v2/...
- SDK: @ankr.com/ankr.js npm 패키지

### Phase 2: A + B 방식 모두 구현
**A방식 (TonConnect만)**: 
- 프론트엔드: TonConnect로 사용자가 지갑에서 CSPIN 직접 전송
- 백엔드: 입금 감지 후 KV 크레딧만 업데이트
- 장점: 백엔드 간단, 무료, 빠름

**B방식 (Ankr RPC 기반)**:
- 프론트엔드: 입금액만 입력, 백엔드에 요청
- 백엔드: Ankr RPC로 게임 지갑에서 CSPIN 자동 전송
- 장점: 사용자 편의성, 자동화

### Phase 3: 코드 전체 리팩토링
**백엔드**:
- `/api/deposit-direct`: A방식 (단순 KV 업데이트)
- `/api/deposit-auto`: B방식 (Ankr RPC 호출 + KV 업데이트)
- Ankr SDK 통합 및 오류 처리
- 환경 변수: `ANKR_RPC_URL`, `GAME_WALLET_PRIVATE_KEY`

**프론트엔드**:
- `DepositDirect.tsx`: A방식 UI (TonConnect 버튼)
- `DepositAuto.tsx`: B방식 UI (백엔드 호출)
- 두 방식 선택 가능한 메인 Deposit 페이지

### Phase 4: 문서 동기화
- [산출물2]: Ankr RPC 및 이중 입금 방식 아키텍처 추가
- [산출물3]: A/B 의사코드 모두 기록

### Phase 5: 테스트 & 배포
- A방식 테스트 (가장 안정적)
- B방식 테스트 (Ankr RPC 연결 확인)

## 작업 우선순위
1. 무료 RPC API 검색 및 선정
2. 현재 코드 전체 분석 & 문제점 기록
3. TonConnect 기반 새로운 아키텍처 설계
4. MVP 코드 재작성

## 타임스탬프
2025-10-21_000000

## AI 워크플로우 준수
- [Step 1]: 이 명령 지시서 작성 중
- [Step 2]: 이 파일 저장 (완료 예정)
- [Step 3]: 코드 분석 & 문서 재설계
- [Step 4]: 버전 업데이트 (v1.4.0 → v1.5.0 이상)
- [Step 5]: 해결 기록 작성
- [Step 6]: 칸반 보드 업데이트
