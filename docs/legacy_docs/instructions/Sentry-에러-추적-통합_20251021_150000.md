# Sentry 에러 추적 통합 지시서
## 목표: 프로덕션 에러 모니터링 시스템 구축
### 완료 날짜: 2025-10-21

---

## 📋 작업 개요

**목적**: Sentry를 통한 실시간 에러 추적 및 모니터링 인프라 구축

**적용 범위**: 
- 전역 에러 바운더리 (ErrorBoundary)
- Sentry SDK 초기화
- 환경별 설정 (개발/프로덕션)

---

## 🛠 구현 내용

### 1. Sentry SDK 설치
```bash
npm install --save @sentry/react @sentry/tracing
```

### 2. 주요 코드 변경사항

#### `src/main.tsx` - Sentry 초기화
```typescript
import * as Sentry from '@sentry/react';

if (typeof window !== 'undefined') {
  const SENTRY_DSN = import.meta.env.VITE_SENTRY_DSN || 'https://placeholder@sentry.io/123456';
  const environment = import.meta.env.MODE === 'production' ? 'production' : 'development';

  Sentry.init({
    dsn: SENTRY_DSN,
    environment: environment,
    tracesSampleRate: environment === 'production' ? 0.1 : 1.0,
  });
}
```

#### `src/components/ErrorBoundary.tsx` - 새로 생성
```typescript
class ErrorBoundary extends Component<Props, State> {
  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {
    Sentry.captureException(error, {
      contexts: {
        react: {
          componentStack: errorInfo.componentStack,
        },
      },
    });
  }
}
```

#### `src/App.tsx` - ErrorBoundary 적용
```typescript
<ErrorBoundary>
  <TonConnectUIProvider manifestUrl={TON_CONNECT_MANIFEST_URL}>
    {/* 앱 콘텐츠 */}
  </TonConnectUIProvider>
</ErrorBoundary>
```

### 3. 환경변수 설정

#### `.env` (기본값)
```
VITE_SENTRY_DSN=https://placeholder@sentry.io/123456
VITE_TON_RPC_URL=https://toncenter.com/api/v2/jsonRPC
```

#### `.env.example` (템플릿)
```
VITE_SENTRY_DSN=https://your_sentry_key@o123456.ingest.sentry.io/123456
VITE_TON_RPC_URL=https://toncenter.com/api/v2/jsonRPC
```

### 4. TypeScript 타입 선언
`src/vite-env.d.ts`에 ImportMeta 타입 추가:
```typescript
interface ImportMeta {
  readonly env: {
    readonly VITE_SENTRY_DSN?: string;
    readonly VITE_TON_RPC_URL?: string;
    readonly MODE: 'development' | 'production';
  };
}
```

---

## 🔑 주요 기능

### ErrorBoundary의 역할
1. **전역 에러 캡처**: React 컴포넌트의 모든 에러 감지
2. **Sentry 자동 보고**: 에러 발생 시 자동으로 Sentry로 전송
3. **사용자 친화적 UI**: 에러 발생 시 깔끔한 오류 화면 표시
4. **상세 정보 제공**: 에러 세부정보 및 컴포넌트 스택 포함

### Sentry 초기화 설정
- **DSN**: 환경변수로 관리 (테스트/프로덕션 구분)
- **Environment**: MODE에 따라 자동 설정
- **Sample Rate**: 프로덕션에서 10%, 개발에서 100%

---

## ✅ 검증 방법

### 테스트 실행
```bash
npm test -- --run
```
**결과**: ✅ 12/12 tests passed

### 타입 체크
```bash
npm run typecheck
```
**결과**: ✅ No errors

### 빌드 확인
```bash
npm run build
```

---

## 📊 구현 상태

| 항목 | 상태 | 비고 |
|------|------|------|
| Sentry SDK 설치 | ✅ | @sentry/react 패키지 |
| main.tsx 초기화 | ✅ | 환경별 DSN 설정 |
| ErrorBoundary 구현 | ✅ | 전역 에러 캡처 |
| App.tsx 적용 | ✅ | Provider 래핑 |
| 환경변수 설정 | ✅ | .env, .env.example |
| TypeScript 타입 | ✅ | ImportMeta 선언 |
| 테스트 통과 | ✅ | 12/12 tests passed |

---

## 🚀 다음 단계 (Phase 1 계속)

### 3️⃣ Rate Limiting 적용
- Cloudflare Workers에서 Rate Limiting 구현
- API 엔드포인트별 요청 제한 설정

### 4️⃣ 환경변수 확대
- CSPIN_JETTON_WALLET 등 주소를 환경변수화
- 메인넷/테스트넷 분리 설정

---

## 📝 커밋 정보

**Commit Hash**: fa0303f  
**메시지**: feat: Sentry 에러 추적 통합 + Error Boundary 추가

```
9 files changed, 326 insertions(+), 3 deletions(-)
- 설치: @sentry/react, @sentry/tracing
- 생성: src/components/ErrorBoundary.tsx
- 수정: src/main.tsx, src/App.tsx, src/vite-env.d.ts
- 생성: .env, .env.example
```

---

## 🔗 참고 자료

- [Sentry React 문서](https://docs.sentry.io/platforms/javascript/guides/react/)
- [React Error Boundary](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)
- [환경변수 관리 (Vite)](https://vitejs.dev/guide/env-and-mode.html)

---

## ⚠️ 주의사항

1. **프로덕션 DSN 설정 필수**: 
   - `.env.production.local`에 실제 Sentry DSN 설정
   - 현재 placeholder DSN은 테스트 목적

2. **민감한 정보 보호**:
   - `.env.local`, `.env.production.local`은 Git에 커밋하지 말 것
   - `.gitignore`에 이미 추가됨

3. **Error Boundary의 한계**:
   - 비동기 에러는 catch하지 못함 (try-catch 사용 필요)
   - 이벤트 리스너의 에러는 catch하지 못함

---

**Status**: ✅ Phase 1-2 완료 (Vitest ✅, Sentry ✅)  
**다음 작업**: Rate Limiting 적용 (Phase 1-3)
