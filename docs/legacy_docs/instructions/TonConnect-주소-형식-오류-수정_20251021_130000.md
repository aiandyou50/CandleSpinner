# 지시서: TonConnect 입금 주소 형식 오류 수정

**지시서 ID:** DEPOSIT-ADDRESS-FORMAT-FIX-001  
**작성일:** 2025년 10월 21일  
**요청자:** 사용자 (테스트 중 오류 발견)

---

## 요청 사항

### 오류 증상
- **에러 메시지**: `[TON_CONNECT_SDK_ERROR] SendTransactionRequest validation failed: Wrong 'address' format in message at index 0`
- **발생 시점**: TonConnect 입금 버튼 클릭 시
- **원인**: CSPIN_JETTON_WALLET 주소 형식이 TonConnect SDK에서 요구하는 형식이 아님

### 필요한 수정
1. CSPIN Jetton Wallet 주소를 `Address.parse()`로 파싱
2. `toString()` 메서드로 정식 형식으로 변환
3. 타임스탐프 계산 오류 해결 (validUntil 재확인)

---

## 기술 분석

### PoC 코드의 올바른 구조
```typescript
const payload = buildJettonTransferPayload(amount, destination, responseTo);
const hex = payload.toBoc().toString('hex');
const tx = { 
  to: jettonWallet,  // ← 정식 Address 객체의 toString()
  value: ensureMessageAmount(BigInt(0), useDiagnosticLowFee).toString(),
  data: hex 
};
```

### 현재 코드의 문제점
```typescript
address: CSPIN_JETTON_WALLET,  // ← 문자열 상수 사용 (잘못됨)
amount: '200000000',
payload: payload
```

---

## 수정 계획

1. **Deposit.tsx**: TonConnect 트랜잭션 구조 수정
   - CSPIN_JETTON_WALLET 문자열을 Address 객체로 파싱
   - toString()으로 정식 형식 변환
   - messages 구조 재검토

2. **타임스탐프 재계산**
   - validUntil 값 확인
   - 시스템 시간 오차 처리

3. **테스트**
   - 빌드 성공 확인
   - TonConnect 입금 재테스트

---

## 우선순위
🔴 **높음** - 입금 기능 완전 차단 중
