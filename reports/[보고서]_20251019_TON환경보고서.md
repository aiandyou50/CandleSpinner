# [보고서] TON 블록체인 개발 환경 분석

**작성일:** 2025-10-19  
**프로젝트:** CandleSpinner  
**버전:** v1.0.1  
**보고서 유형:** 기술 환경 분석

---

## 📋 요약 (Executive Summary)

CandleSpinner 프로젝트는 TON 블록체인과의 통합을 위해 공식 TON Connect 프로토콜 및 관련 라이브러리를 사용하고 있습니다. 프론트엔드에서는 React 기반의 TON Connect UI를 통해 지갑 연결을 처리하며, 백엔드는 Cloudflare Pages Functions를 통해 TON RPC API와 통신합니다.

---

## 1. TON 관련 라이브러리 목록

### 1.1 프론트엔드 (Frontend) 라이브러리

| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| `@tonconnect/ui-react` | ^2.3.1 | TON Connect 지갑 연결 UI 컴포넌트 제공 |
| `@ton/core` | ^0.62.0 | TON 블록체인 핵심 데이터 구조 및 트랜잭션 생성 |
| `@ton/crypto` | ^3.3.0 | TON 블록체인 암호화 유틸리티 (키 생성, 서명 등) |
| `@ton/ton` | ^16.0.0 | TON 블록체인 고수준 API |
| `ton-core` | ^0.53.0 | 레거시 TON Core 라이브러리 (호환성 유지용) |
| `tonweb` | ^0.0.66 | TON 웹 라이브러리 (일부 레거시 기능용) |

### 1.2 백엔드 (Functions) 라이브러리

백엔드(Cloudflare Pages Functions)는 현재 직접적인 TON 라이브러리를 사용하지 않으며, 오프체인 게임 로직만 처리합니다. TON 블록체인과의 실제 상호작용은 모두 프론트엔드에서 발생합니다.

---

## 2. 지갑 연결 아키텍처

### 2.1 TON Connect 프로토콜

**위치:** `src/hooks/useTonConnect.ts`

**핵심 기능:**
- `@tonconnect/ui-react`의 `useTonWallet`과 `useTonConnectUI` 훅 사용
- 사용자의 텔레그램 Wallet 또는 기타 TON 지갑 연결
- 지갑 연결 상태 관리 및 모니터링

**주요 코드 구조:**
```typescript
const connectedWallet = useTonWallet();
const [tonConnectUI] = useTonConnectUI();
```

### 2.2 Jetton Wallet 주소 파생

**문제:** 사용자가 CSPIN 토큰(Jetton)을 전송하려면 자신의 Jetton Wallet 주소를 알아야 합니다.

**해결 방법 (다층 Fallback 전략):**

1. **1차 시도: `ton-core` 라이브러리**
   - `getJettonWalletAddress()` 함수 호출 시도
   - 성공 시 즉시 주소 반환

2. **2차 시도: TON RPC API**
   - `ton-core` 실패 시 `/api/rpc` 엔드포인트를 통해 RPC 호출
   - `runGetMethod` 메서드로 `get_wallet_address` 스마트 컨트랙트 함수 실행
   - 성공 시 파생된 Jetton Wallet 주소 반환

3. **3차 폴백: 수동 입력**
   - 모든 자동 파생 실패 시 사용자에게 수동 입력 요청

**코드 위치:** `src/hooks/useTonConnect.ts`, 함수: `getJettonWalletAddressRpc()`

---

## 3. RPC 통신 아키텍처

### 3.1 RPC Wrapper 함수

**위치:** `src/hooks/useRpc.ts`

**기능:**
- TON RPC API와의 통신을 위한 공통 함수 제공
- API 키 자동 주입 (환경 변수 `VITE_FUNCTION_API_KEY` 사용)
- 재시도 로직 및 폴백 메커니즘 구현

**주요 메서드:**
1. `rpcFetch()`: Fetch API 래퍼로 헤더 및 API 키 자동 설정
2. `performPing()`: RPC 서버 연결 상태 확인 (최대 2회 재시도)
3. `getJettonWalletAddress()`: Jetton Wallet 주소 조회

### 3.2 RPC 엔드포인트

**엔드포인트:** `/api/rpc`  
**메서드:** `POST`  
**요청 형식:**
```json
{
  "rpcBody": {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "runGetMethod",
    "params": {
      "address": "CSPIN_TOKEN_MASTER_ADDRESS",
      "method": "get_wallet_address",
      "stack": [["tvm.Slice", "USER_WALLET_ADDRESS"]]
    }
  }
}
```

**응답 처리:**
- 스택 기반 응답 파싱: `response.result.stack[0][1]`
- 오류 시 `null` 반환 및 콘솔 경고

---

## 4. 트랜잭션 생성 방식

### 4.1 프론트엔드 트랜잭션 생성

**사용 라이브러리:**
- `ton-core`: `Address`, `toNano`, `beginCell` 등의 유틸리티 사용
- `@ton/core`: 최신 TON Core API 활용

**트랜잭션 흐름 (예: CSPIN 입금):**
1. 사용자가 입금 금액 입력
2. `beginCell()`로 Jetton 전송 메시지 페이로드 생성
3. TON Connect UI를 통해 사용자 지갑에 서명 요청
4. 트랜잭션 전송 후 결과 확인
5. 성공 시 `/api/credit-deposit` 호출하여 오프체인 크레딧 충전

### 4.2 백엔드 로직

**핵심:** 백엔드는 TON 블록체인과 직접 통신하지 않습니다.  
**역할:** 오프체인 게임 로직(스핀, 더블업 등)만 처리하며 Cloudflare KV에 상태 저장

**온체인 ↔ 오프체인 분리:**
- **온체인:** 입금(Deposit), 인출(Withdraw)
- **오프체인:** 게임 플레이, 크레딧 관리

---

## 5. 주요 상수 및 설정

**위치:** `src/constants.ts` (추정)

- `CSPIN_TOKEN_ADDRESS`: CSPIN Jetton Master 컨트랙트 주소
- `GAME_WALLET_ADDRESS`: 게임 지갑(Owner) 주소

**Cloudflare 설정:**
- `wrangler.toml`: KV 바인딩 `CREDIT_KV` 설정
- 호환성 플래그: `nodejs_compat` (Buffer 폴리필용)

---

## 6. 보안 고려사항

### 6.1 Private Key 관리

- 프론트엔드: Private Key를 절대 저장하거나 노출하지 않음
- 모든 트랜잭션은 사용자의 지갑 앱에서 서명
- 백엔드: Private Key 없음 (오프체인 로직만 처리)

### 6.2 API Key 보호

- 환경 변수를 통해 API 키 주입
- 프론트엔드 코드에 하드코딩되지 않음

### 6.3 인출(Withdrawal) 처리

**현재 상태:** 인출 처리기(Processor)는 별도 구현 필요  
**의사코드:** `[산출물3]`의 C 섹션에 정의됨  
**권장:** AWS Lambda + Secrets Manager 또는 별도 보안 서버에서 처리

---

## 7. 개발 환경 설정

### 7.1 필수 환경 변수

```bash
VITE_FUNCTION_API_KEY=your_api_key_here
```

### 7.2 로컬 개발

```bash
npm run dev  # Vite 개발 서버 시작
```

### 7.3 프로덕션 배포

- **플랫폼:** Cloudflare Pages
- **자동 배포:** GitHub Push 시 자동 빌드 및 배포
- **설정 파일:** `wrangler.toml`

---

## 8. 개선 제안

### 8.1 라이브러리 중복 제거

**현재 문제:** `ton-core` (v0.53.0)와 `@ton/core` (v0.62.0) 중복 사용

**제안:**
- 레거시 `ton-core` 제거 검토
- 모든 코드를 최신 `@ton/*` 패키지로 마이그레이션

### 8.2 RPC 폴백 체인 개선

**제안:**
- RPC 엔드포인트 상태 모니터링 추가
- 여러 RPC 공급자 설정 (Primary/Fallback)

### 8.3 트랜잭션 상태 추적

**제안:**
- 온체인 트랜잭션 확인 로직 강화
- 사용자에게 실시간 상태 업데이트 제공

---

## 9. 참고 자료

- [TON Connect 공식 문서](https://docs.ton.org/develop/dapps/ton-connect/overview)
- [TON Core 라이브러리](https://github.com/ton-org/ton-core)
- [Cloudflare Pages Functions](https://developers.cloudflare.com/pages/platform/functions/)

---

**보고서 종료**
