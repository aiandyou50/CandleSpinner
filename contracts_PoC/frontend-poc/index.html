<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSPIN í† í° ì¸ì¶œ PoC</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
            font-weight: 500;
        }

        .status-value {
            color: #333;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-connect {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-claim {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-claim:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-claim:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .debug-output {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .debug-output .log {
            color: #d4d4d4;
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .debug-output .log.success {
            color: #4ec9b0;
        }

        .debug-output .log.error {
            color: #f48771;
        }

        .debug-output .log.info {
            color: #569cd6;
        }

        .connected-badge {
            display: inline-block;
            background: #4ade80;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .disconnected-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° CSPIN í† í° ì¸ì¶œ</h1>
        <p class="subtitle" id="networkBadge">í…ŒìŠ¤íŠ¸ë„· PoC ë²„ì „</p>

        <div class="status">
            <div class="status-item">
                <span class="status-label">ì§€ê°‘ ìƒíƒœ:</span>
                <span class="status-value" id="walletStatus">
                    <span class="disconnected-badge">ë¯¸ì—°ê²°</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">ë„¤íŠ¸ì›Œí¬:</span>
                <span class="status-value" id="network">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">ì§€ê°‘ ì£¼ì†Œ:</span>
                <span class="status-value" id="walletAddress">-</span>
            </div>
        </div>

        <button class="btn-connect" id="connectBtn" onclick="connectWallet()">
            ğŸ”— TON ì§€ê°‘ ì—°ê²°
        </button>

        <button class="btn-connect" id="disconnectBtn" onclick="disconnectWallet()" style="display:none; background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);">
            ğŸ”Œ ì§€ê°‘ ì—°ê²° ëŠê¸°
        </button>

        <div class="input-group">
            <label for="amountInput">ì¸ì¶œí•  CSPIN í† í° ê°œìˆ˜</label>
            <input type="number" id="amountInput" value="100" min="1" max="10000" placeholder="í† í° ê°œìˆ˜ ì…ë ¥">
        </div>

        <button class="btn-claim" id="claimBtn" onclick="claimTokens()" disabled>
            ğŸ’ CSPIN ì¸ì¶œí•˜ê¸°
        </button>

        <div class="debug-output" id="debugOutput">
            <div class="log info">ğŸš€ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ</div>
            <div class="log info">ğŸ“ ì§€ê°‘ì„ ì—°ê²°í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</div>
        </div>
    </div>

    <script>
        // ============================================
        // ë„¤íŠ¸ì›Œí¬ ì„¤ì • (ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”!)
        // ============================================
        const NETWORK = 'mainnet'; // 'testnet' ë˜ëŠ” 'mainnet'
        
        // ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ ì„¤ì •
        const CONTRACT_ADDRESSES = {
            testnet: 'EQAIlrbypzom9HibUyYxosqmYnIRjFWAhFs5E1ybnKY2XtQg',
            mainnet: 'MAINNET_CONTRACT_ADDRESS_HERE' // ë©”ì¸ë„· ë°°í¬ í›„ ì—¬ê¸°ì— ì…ë ¥
        };
        
        const CONTRACT_ADDRESS = CONTRACT_ADDRESSES[NETWORK];
        const IS_TESTNET = NETWORK === 'testnet';

        let tonConnectUI;
        let userAddress;

        // TonConnect ì´ˆê¸°í™”
        async function initTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://raw.githubusercontent.com/ton-org/blueprint/main/tonconnect/manifest.json',
                    buttonRootId: null
                });

                // ì—°ê²° ìƒíƒœ ê°ì§€
                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        handleWalletConnected(wallet);
                    } else {
                        handleWalletDisconnected();
                    }
                });

                addLog('âœ… TonConnect ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            } catch (error) {
                addLog(`âŒ TonConnect ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì§€ê°‘ ì—°ê²°
        async function connectWallet() {
            try {
                addLog('ğŸ”„ ì§€ê°‘ ì—°ê²° ì‹œë„ ì¤‘...', 'info');
                await tonConnectUI.openModal();
            } catch (error) {
                addLog(`âŒ ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì§€ê°‘ ì—°ê²° ëŠê¸°
        async function disconnectWallet() {
            try {
                addLog('ğŸ”„ ì§€ê°‘ ì—°ê²° í•´ì œ ì¤‘...', 'info');
                await tonConnectUI.disconnect();
                addLog('âœ… ì§€ê°‘ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                addLog(`âŒ ì—°ê²° í•´ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì§€ê°‘ ì—°ê²° ì™„ë£Œ
        function handleWalletConnected(wallet) {
            userAddress = wallet.account.address;
            
            // TonConnectëŠ” raw address (0:hash)ë¥¼ ë°˜í™˜
            const rawAddress = userAddress;
            const shortAddr = rawAddress.substring(0, 15);
            
            // Chain IDë¡œ ë„¤íŠ¸ì›Œí¬ ê°ì§€ (TonkeeperëŠ” ë°˜ëŒ€ë¡œ ë³´ê³ í•¨)
            const chainId = wallet.account.chain;
            let detectedNetwork = 'Unknown';
            let isTestnet = false;
            
            // Tonkeeper Chain ID: -3 = Testnet, -239 = Mainnet (ì—­ìœ¼ë¡œ ë³´ê³ ë¨)
            if (chainId === '-3') {
                detectedNetwork = 'Testnet';
                isTestnet = true;
            } else if (chainId === '-239') {
                detectedNetwork = 'Mainnet';
                isTestnet = false;
            } else {
                // Chain IDë¡œ íŒë‹¨ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
                detectedNetwork = 'Unknown';
                isTestnet = false;
            }
            
            document.getElementById('walletStatus').innerHTML = '<span class="connected-badge">ì—°ê²°ë¨</span>';
            document.getElementById('network').textContent = detectedNetwork;
            document.getElementById('walletAddress').textContent = formatAddress(userAddress);
            document.getElementById('claimBtn').disabled = false;
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = 'block';
            
            addLog(`âœ… ì§€ê°‘ ì—°ê²° ì„±ê³µ`, 'success');
            addLog(`ğŸ“ ë„¤íŠ¸ì›Œí¬: ${detectedNetwork}`, 'info');
            addLog(`ğŸ” ì£¼ì†Œ: ${shortAddr}...${rawAddress.slice(-6)}`, 'info');
            
            // ë„¤íŠ¸ì›Œí¬ ë¯¸ìŠ¤ë§¤ì¹˜ ê²½ê³ 
            if (detectedNetwork === 'Unknown') {
                addLog(`âš ï¸ ê²½ê³ : ë„¤íŠ¸ì›Œí¬ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`, 'error');
                addLog(`ğŸ“‹ Chain ID: ${chainId}`, 'error');
                addLog(`ğŸ“‹ ì—°ê²°ëœ ì£¼ì†Œ: ${rawAddress}`, 'info');
            } else if (IS_TESTNET && !isTestnet) {
                addLog(`âš ï¸ ê²½ê³ : Mainnet ì§€ê°‘ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'error');
                addLog(`âš ï¸ í˜„ì¬ ì„¤ì •ì€ Testnetì…ë‹ˆë‹¤`, 'error');
                addLog(`ğŸ’¡ Testnet ì§€ê°‘ìœ¼ë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì½”ë“œì—ì„œ NETWORK='mainnet' ì„¤ì •`, 'info');
            } else if (!IS_TESTNET && isTestnet) {
                addLog(`âš ï¸ ê²½ê³ : Testnet ì§€ê°‘ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'error');
                addLog(`âš ï¸ í˜„ì¬ ì„¤ì •ì€ Mainnetì…ë‹ˆë‹¤`, 'error');
                addLog(`ğŸ’¡ Mainnet ì§€ê°‘ìœ¼ë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì½”ë“œì—ì„œ NETWORK='testnet' ì„¤ì •`, 'info');
            } else {
                addLog(`âœ… ${detectedNetwork} ì§€ê°‘ ì—°ê²° ì™„ë£Œ - ì¸ì¶œ ê°€ëŠ¥!`, 'success');
            }
        }

        // ì§€ê°‘ ì—°ê²° í•´ì œ
        function handleWalletDisconnected() {
            userAddress = null;
            document.getElementById('walletStatus').innerHTML = '<span class="disconnected-badge">ë¯¸ì—°ê²°</span>';
            document.getElementById('network').textContent = '-';
            document.getElementById('walletAddress').textContent = '-';
            document.getElementById('claimBtn').disabled = true;
            document.getElementById('connectBtn').style.display = 'block';
            document.getElementById('disconnectBtn').style.display = 'none';
            
            addLog('âš ï¸ ì§€ê°‘ ì—°ê²° í•´ì œë¨', 'info');
        }

        // í† í° ì¸ì¶œ
        async function claimTokens() {
            if (!userAddress) {
                addLog('âŒ ì§€ê°‘ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const amount = document.getElementById('amountInput').value;
            if (!amount || amount <= 0) {
                addLog('âŒ ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            try {
                addLog(`ğŸ”„ ${amount} CSPIN ì¸ì¶œ ì‹œì‘...`, 'info');
                document.getElementById('claimBtn').innerHTML = '<span class="spinner"></span>ì²˜ë¦¬ ì¤‘...';
                document.getElementById('claimBtn').disabled = true;

                // ton ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (TonWeb)
                const { Cell } = TonWeb.boc;
                
                // ClaimRequest ë©”ì‹œì§€ ìƒì„±
                const cell = new Cell();
                cell.bits.writeUint(0x2, 32);  // op: ClaimRequest
                cell.bits.writeUint(Date.now(), 64);  // queryId
                
                const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60,
                    messages: [
                        {
                            address: CONTRACT_ADDRESS,
                            amount: '150000000', // 0.15 TON (ê°€ìŠ¤ë¹„)
                            payload: payload
                        }
                    ]
                };

                addLog('ğŸ“¤ íŠ¸ëœì­ì…˜ ì „ì†¡ ì¤‘...', 'info');
                const result = await tonConnectUI.sendTransaction(transaction);
                
                addLog(`âœ… íŠ¸ëœì­ì…˜ ì „ì†¡ ì„±ê³µ!`, 'success');
                addLog(`ğŸ“‹ BOC: ${result.boc.substring(0, 32)}...`, 'info');
                addLog(`ğŸ‰ ${amount} CSPIN ì¸ì¶œ ìš”ì²­ ì™„ë£Œ!`, 'success');
                
                if (IS_TESTNET) {
                    addLog(`âš ï¸ ì°¸ê³ : í…ŒìŠ¤íŠ¸ë„·ì—ì„œëŠ” ì‹¤ì œ CSPINì´ ì „ì†¡ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`, 'info');
                } else {
                    addLog(`ğŸ’ ë©”ì¸ë„·: ì‹¤ì œ CSPIN í† í°ì´ ì „ì†¡ë©ë‹ˆë‹¤`, 'success');
                }

            } catch (error) {
                addLog(`âŒ ì¸ì¶œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                document.getElementById('claimBtn').innerHTML = 'ğŸ’ CSPIN ì¸ì¶œí•˜ê¸°';
                document.getElementById('claimBtn').disabled = false;
            }
        }

        // ì£¼ì†Œ í¬ë§·íŒ…
        function formatAddress(address) {
            if (!address) return '-';
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }

        // ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'log') {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `[${timestamp}] ${message}`;
            debugOutput.appendChild(log);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            // ë„¤íŠ¸ì›Œí¬ ë°°ì§€ ì—…ë°ì´íŠ¸
            const badge = document.getElementById('networkBadge');
            badge.textContent = IS_TESTNET ? 'í…ŒìŠ¤íŠ¸ë„· PoC ë²„ì „' : 'ë©”ì¸ë„· ë²„ì „';
            badge.style.color = IS_TESTNET ? '#666' : '#dc2626';
            badge.style.fontWeight = IS_TESTNET ? 'normal' : 'bold';
            
            initTonConnect();
        });
    </script>
</body>
</html>
