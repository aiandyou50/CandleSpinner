# ì¸ì¶œ ê¸°ëŠ¥ êµ¬í˜„ ê°€ì´ë“œ

**ëª©í‘œ**: ê²Œì„ í¬ë ˆë”§ì„ CSPIN í† í°ìœ¼ë¡œ ë³€í™˜

---

## âŒ ì™œ ìë™ ì¸ì¶œì´ ë¶ˆê°€ëŠ¥í•œê°€?

### ê·¼ë³¸ ë¬¸ì œ

```
Jetton TransferëŠ” ì„œëª…ìì˜ í† í°ë§Œ ì „ì†¡ ê°€ëŠ¥ (TEP-74 í‘œì¤€)

ì…ê¸ˆ: ì‚¬ìš©ì ì„œëª… â†’ ì‚¬ìš©ì í† í° ì „ì†¡ â†’ âœ… ê°€ëŠ¥
ì¸ì¶œ: ê²Œì„ ì„œëª… í•„ìš” â†’ ê²Œì„ í† í° ì „ì†¡ â†’ âŒ Cloudflare Workersì—ì„œ ë¶ˆê°€ëŠ¥
```

### ì‹œë„í•œ ë°©ë²•ë“¤

#### 1. ë°±ì—”ë“œ RPC ë°©ì‹ âŒ
```typescript
// src/index.ts
import { mnemonicToPrivateKey } from '@ton/crypto';

const keyPair = await mnemonicToPrivateKey(mnemonic.split(' '));
// âŒ Error: "window is not defined"
```

**ì‹¤íŒ¨ ì´ìœ **: @ton/ton ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¸Œë¼ìš°ì € í™˜ê²½ ê°€ì •

#### 2. í”„ë¡ íŠ¸ì—”ë“œ TON Connect ë°©ì‹ âŒ
```typescript
// Withdraw.tsx
await tonConnectUI.sendTransaction({
  messages: [{
    address: GAME_JETTON_WALLET,
    payload: createTransfer(userAddress, amount)  // ì‚¬ìš©ìì—ê²Œ ì „ì†¡
  }]
});
// âŒ ì‚¬ìš©ìê°€ ì„œëª… â†’ ì‚¬ìš©ìâ†’ê²Œì„ (ë°˜ëŒ€ ë°©í–¥!)
```

**ì‹¤íŒ¨ ì´ìœ **: ì‚¬ìš©ìê°€ ì„œëª…í•˜ë©´ ì‚¬ìš©ìì˜ í† í° ì „ì†¡ (ì…ê¸ˆê³¼ ë™ì¼)

#### 3. ìˆ˜ë™ ì²˜ë¦¬ ë°©ì‹ âœ…
```
[ì‚¬ìš©ì] ì¸ì¶œ ìš”ì²­
    â†“
[ë°±ì—”ë“œ] í¬ë ˆë”§ ì°¨ê° + ëŒ€ê¸°ì—´ ì¶”ê°€
    â†“
[ê´€ë¦¬ì] ìˆ˜ë™ìœ¼ë¡œ í† í° ì „ì†¡ (TON Connect)
    â†“
[ì‚¬ìš©ì] í† í° ìˆ˜ë ¹
```

**ì„±ê³µ ì´ìœ **: ê´€ë¦¬ìê°€ ê²Œì„ ì§€ê°‘ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ ì„œëª…

---

## âœ… ìˆ˜ë™ ì¸ì¶œ ì‹œìŠ¤í…œ êµ¬í˜„

### 1ë‹¨ê³„: ì¸ì¶œ ìš”ì²­ (í”„ë¡ íŠ¸ì—”ë“œ)

**íŒŒì¼**: `src/components/Withdraw.tsx`

```typescript
async function handleWithdraw(amount: number) {
  // âœ… ë³´ì•ˆ í† í° ìƒì„±
  const timestamp = Date.now();
  const nonce = crypto.randomUUID();
  
  const withdrawRequest = {
    action: 'withdraw',
    amount,
    userAddress: walletAddress,
    timestamp,
    nonce
  };
  
  // âœ… ë°±ì—”ë“œì— ìš”ì²­
  const response = await fetch('/api/withdraw-request', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(withdrawRequest)
  });
  
  if (response.ok) {
    alert('ì¸ì¶œ ìš”ì²­ ì™„ë£Œ! (12~24ì‹œê°„ ì²˜ë¦¬)');
  }
}
```

### 2ë‹¨ê³„: í¬ë ˆë”§ ì°¨ê° + ëŒ€ê¸°ì—´ (ë°±ì—”ë“œ)

**íŒŒì¼**: `src/index.ts` - handleWithdrawRequest

```typescript
async function handleWithdrawRequest(request: Request, env: Env) {
  const body = await request.json();
  
  // âœ… 1. ë³´ì•ˆ ê²€ì¦
  // íƒ€ì„ìŠ¤íƒ¬í”„ (5ë¶„ ì´ë‚´)
  const age = Date.now() - body.timestamp;
  if (age > 300000 || age < 0) {
    return error('Request expired');
  }
  
  // ë…¼ìŠ¤ ì¤‘ë³µ í™•ì¸ (ë¦¬í”Œë ˆì´ ê³µê²© ë°©ì§€)
  const nonceKey = `nonce:${body.nonce}`;
  const existing = await env.CREDIT_KV.get(nonceKey);
  if (existing) {
    return error('Duplicate request');
  }
  
  // ë…¼ìŠ¤ ì €ì¥ (10ë¶„ TTL)
  await env.CREDIT_KV.put(nonceKey, 'used', { expirationTtl: 600 });
  
  // âœ… 2. í¬ë ˆë”§ í™•ì¸
  const creditKey = `credit:${body.userAddress}`;
  const current = await env.CREDIT_KV.get(creditKey, 'json');
  
  if (!current || current.credit < body.amount) {
    return error('Insufficient credit');
  }
  
  // âœ… 3. í¬ë ˆë”§ ì°¨ê°
  const newCredit = current.credit - body.amount;
  await env.CREDIT_KV.put(creditKey, JSON.stringify({
    credit: newCredit,
    lastUpdated: new Date().toISOString()
  }));
  
  // âœ… 4. ëŒ€ê¸°ì—´ ì¶”ê°€
  const withdrawalId = `withdraw_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  await env.CREDIT_KV.put(`withdrawal:${withdrawalId}`, JSON.stringify({
    id: withdrawalId,
    walletAddress: body.userAddress,
    amount: body.amount,
    nonce: body.nonce,
    status: 'pending',
    requestedAt: new Date().toISOString()
  }));
  
  // ëŒ€ê¸°ì—´ ëª©ë¡ì— ì¶”ê°€
  const queueKey = 'withdrawals:pending';
  const queue = await env.CREDIT_KV.get(queueKey, 'json') || [];
  await env.CREDIT_KV.put(queueKey, JSON.stringify([...queue, withdrawalId]));
  
  return success({ 
    withdrawalId,
    estimatedProcessTime: '12~24ì‹œê°„ ì´ë‚´'
  });
}
```

### 3ë‹¨ê³„: ê´€ë¦¬ì ì²˜ë¦¬ (í”„ë¡ íŠ¸ì—”ë“œ)

**íŒŒì¼**: `src/components/AdminWithdrawals.tsx`

```typescript
function AdminWithdrawals() {
  const { isConnected, walletAddress } = useTonConnect();
  const [tonConnectUI] = useTonConnectUI();
  const [withdrawals, setWithdrawals] = useState([]);
  
  // âœ… 1. ê²Œì„ ìš´ì˜ì ì¸ì¦
  const isAdmin = isConnected && 
    walletAddress?.toLowerCase() === GAME_WALLET_ADDRESS.toLowerCase();
  
  if (!isAdmin) {
    return <div>âŒ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</div>;
  }
  
  // âœ… 2. ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ
  async function loadWithdrawals() {
    const response = await fetch('/api/admin/pending-withdrawals');
    const data = await response.json();
    setWithdrawals(data.withdrawals);
  }
  
  // âœ… 3. í† í° ì „ì†¡ (ìˆ˜ë™)
  async function processWithdrawal(withdrawal) {
    // Jetton Transfer ìƒì„±
    const transaction = {
      validUntil: Math.floor(Date.now() / 1000) + 600,
      messages: [{
        address: GAME_JETTON_WALLET,
        amount: '200000000',  // 0.2 TON
        payload: createJettonTransferPayload({
          jettonAmount: withdrawal.amount,
          destination: withdrawal.walletAddress,  // ì‚¬ìš©ìì—ê²Œ ì „ì†¡
          responseDestination: GAME_WALLET_ADDRESS
        })
      }]
    };
    
    // ê´€ë¦¬ì(ê²Œì„ ì§€ê°‘)ê°€ ì„œëª…
    await tonConnectUI.sendTransaction(transaction);
    
    // âœ… 4. ì²˜ë¦¬ ì™„ë£Œ í‘œì‹œ
    await fetch('/api/admin/mark-processed', {
      method: 'POST',
      body: JSON.stringify({ withdrawalId: withdrawal.id })
    });
    
    loadWithdrawals();  // ëª©ë¡ ê°±ì‹ 
  }
  
  return (
    <div>
      <h2>ëŒ€ê¸° ì¤‘ì¸ ì¸ì¶œ ({withdrawals.length}ê±´)</h2>
      {withdrawals.map(w => (
        <div key={w.id}>
          <p>{w.walletAddress}</p>
          <p>{w.amount} CSPIN</p>
          <button onClick={() => processWithdrawal(w)}>
            âœ… ì²˜ë¦¬
          </button>
        </div>
      ))}
    </div>
  );
}
```

---

## ğŸ” ë³´ì•ˆ: ë¦¬í”Œë ˆì´ ê³µê²© ë°©ì§€

### ë¬¸ì œ

```
ê³µê²©ìê°€ ë™ì¼í•œ ì¸ì¶œ ìš”ì²­ì„ ì—¬ëŸ¬ ë²ˆ ì „ì†¡
â†’ í¬ë ˆë”§ì´ ì—¬ëŸ¬ ë²ˆ ì°¨ê°ë¨!
```

### í•´ê²°: íƒ€ì„ìŠ¤íƒ¬í”„ + ë…¼ìŠ¤

```typescript
// í”„ë¡ íŠ¸ì—”ë“œ
const timestamp = Date.now();
const nonce = crypto.randomUUID();

// ë°±ì—”ë“œ ê²€ì¦
// 1. íƒ€ì„ìŠ¤íƒ¬í”„ (5ë¶„ ì´ë‚´)
const age = Date.now() - body.timestamp;
if (age > 300000) {
  return error('Request expired');
}

// 2. ë…¼ìŠ¤ ì¤‘ë³µ í™•ì¸
const nonceKey = `nonce:${body.nonce}`;
const existing = await env.CREDIT_KV.get(nonceKey);
if (existing) {
  return error('Duplicate request');
}

// 3. ë…¼ìŠ¤ ì €ì¥ (10ë¶„ TTL)
await env.CREDIT_KV.put(nonceKey, 'used', { expirationTtl: 600 });
```

---

## ğŸ“Š ì „ì²´ íë¦„

```
[ì‚¬ìš©ì] ì¸ì¶œ ë²„íŠ¼ (50 CSPIN)
    â†“
[Withdraw.tsx]
    â†“ timestamp + nonce ìƒì„±
    â†“ POST /api/withdraw-request
[Cloudflare Workers]
    â†“ íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (5ë¶„)
    â†“ ë…¼ìŠ¤ ì¤‘ë³µ í™•ì¸
    â†“ í¬ë ˆë”§ í™•ì¸ (â‰¥50?)
    â†“ í¬ë ˆë”§ ì°¨ê° (100â†’50)
    â†“ ëŒ€ê¸°ì—´ ì¶”ê°€
    â†“ ë…¼ìŠ¤ ì €ì¥ (TTL 10ë¶„)
[ì‚¬ìš©ì]
    â†“ "12~24ì‹œê°„ ì²˜ë¦¬" ì•ˆë‚´
    
--- ê´€ë¦¬ì ì²˜ë¦¬ ---

[ê´€ë¦¬ì] /admin ì ‘ì†
    â†“ ê²Œì„ ìš´ì˜ì ì§€ê°‘ ì—°ê²°
[AdminWithdrawals.tsx]
    â†“ GET /api/admin/pending-withdrawals
    â†“ ëŒ€ê¸° ëª©ë¡ í‘œì‹œ
[ê´€ë¦¬ì] [âœ… ì²˜ë¦¬] í´ë¦­
    â†“ TON Connectë¡œ íŠ¸ëœì­ì…˜
    â†“ ê²Œì„ ì§€ê°‘ ì„œëª…
[TON ë¸”ë¡ì²´ì¸]
    â†“ ê²Œì„ Jetton Wallet â†’ ì‚¬ìš©ì Jetton Wallet
[ê´€ë¦¬ì] 
    â†“ POST /api/admin/mark-processed
[Cloudflare Workers]
    â†“ status = "completed"
[ì‚¬ìš©ì]
    âœ… í† í° ìˆ˜ë ¹!
```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„: ìë™í™”

### Option A: Node.js ì„œë²„
```
[Cloudflare Workers] â†’ [Node.js Server] â†’ [TON ë¸”ë¡ì²´ì¸]
- Node.jsì—ì„œ @ton/ton ì‚¬ìš© ê°€ëŠ¥
- ë¹„ìš©: $20~50/ì›”
```

### Option B: ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸
```
[ì‚¬ìš©ì] â†’ [ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸] â†’ [ìë™ ì „ì†¡]
- ì˜¨ì²´ì¸ ê²€ì¦
- ë°°í¬ ë¹„ìš©: ~5 TON
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (5ë¶„)
- [ ] ë…¼ìŠ¤ ìƒì„± (UUID)
- [ ] ë…¼ìŠ¤ ì¤‘ë³µ í™•ì¸
- [ ] ë…¼ìŠ¤ ì €ì¥ (10ë¶„ TTL)
- [ ] í¬ë ˆë”§ í™•ì¸
- [ ] í¬ë ˆë”§ ì°¨ê°
- [ ] ëŒ€ê¸°ì—´ ì¶”ê°€
- [ ] ê´€ë¦¬ì ì¸ì¦ (ê²Œì„ ìš´ì˜ì ì§€ê°‘)
- [ ] ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ API
- [ ] ì²˜ë¦¬ ì™„ë£Œ API
- [ ] TON Connect íŠ¸ëœì­ì…˜

---

**í•µì‹¬**: ìˆ˜ë™ ì²˜ë¦¬ê°€ MVP ìµœì í•´! ğŸ¯
