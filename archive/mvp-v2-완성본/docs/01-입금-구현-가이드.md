# ì…ê¸ˆ ê¸°ëŠ¥ êµ¬í˜„ ê°€ì´ë“œ

**ëª©í‘œ**: CSPIN í† í°ì„ ê²Œì„ í¬ë ˆë”§ìœ¼ë¡œ ì „í™˜

---

## ğŸ“‹ í•µì‹¬ ê°œë…

### TEP-74 Jetton Transfer ì´í•´

**ê°€ì¥ ì¤‘ìš”í•œ ê·œì¹™**:
```
Jetton TransferëŠ” ì„œëª…ìì˜ í† í°ë§Œ ì „ì†¡ ê°€ëŠ¥!

ì‚¬ìš©ìê°€ ì„œëª… â†’ ì‚¬ìš©ìì˜ í† í° ì „ì†¡ âœ…
ê²Œì„ì´ ì„œëª… â†’ ê²Œì„ì˜ í† í° ì „ì†¡ âœ…
ì‚¬ìš©ìê°€ ì„œëª… â†’ ê²Œì„ì˜ í† í° ì „ì†¡ âŒ ë¶ˆê°€ëŠ¥!
```

### Jetton Wallet vs ì¼ë°˜ Wallet

```
ì¼ë°˜ Wallet (TON Wallet):
- ì£¼ì†Œ: UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd
- TON ì½”ì¸ ë³´ìœ 
- íŠ¸ëœì­ì…˜ ì„œëª…

Jetton Wallet:
- ì£¼ì†Œ: EQD6zAw4rXWKLdYDgT4ITvW1FaNuNAE8pFST_h0OjBpXALjY
- CSPIN í† í° ë³´ìœ 
- ê° í† í°ë§ˆë‹¤ ë³„ë„ Jetton Wallet
```

**ê´€ê³„**:
```
ê²Œì„ ì¼ë°˜ Wallet (UQBFPDd...)
    â†“ ì†Œìœ 
ê²Œì„ CSPIN Jetton Wallet (EQD6zAw...)
    â†“ ë³´ìœ 
10ì–µ CSPIN í† í°
```

---

## ğŸ¯ êµ¬í˜„ ì „ëµ

### 1ë‹¨ê³„: íŠ¸ëœì­ì…˜ ìƒì„± (í”„ë¡ íŠ¸ì—”ë“œ)

**íŒŒì¼**: `src/components/Deposit.tsx`

```typescript
import { useTonConnectUI } from '@tonconnect/ui-react';
import { Address, beginCell, toNano } from '@ton/ton';
import { GAME_JETTON_WALLET, GAME_WALLET_ADDRESS } from '@/constants';

async function handleDeposit(depositAmount: number) {
  const [tonConnectUI] = useTonConnectUI();
  
  // âœ… 1. Jetton Transfer Payload ìƒì„±
  const payload = beginCell()
    .storeUint(0xf8a7ea5, 32)  // op::transfer (Jetton í‘œì¤€)
    .storeUint(0, 64)  // query_id
    .storeCoins(depositAmount)  // Jetton amount (CSPIN)
    .storeAddress(Address.parse(GAME_JETTON_WALLET))  // âš ï¸ Jetton Wallet!
    .storeAddress(Address.parse(walletAddress))  // response_destination
    .storeBit(0)  // custom_payload (null)
    .storeCoins(toNano('0.05'))  // forward_ton_amount
    .storeBit(0)  // forward_payload (empty)
    .endCell()
    .toBoc()
    .toString('base64');
  
  // âœ… 2. íŠ¸ëœì­ì…˜ ìƒì„±
  const transaction = {
    validUntil: Math.floor(Date.now() / 1000) + 600,  // 10ë¶„ ìœ íš¨
    messages: [{
      address: GAME_JETTON_WALLET,  // âš ï¸ Jetton Walletë¡œ ì „ì†¡!
      amount: '200000000',  // 0.2 TON (gas fee)
      payload
    }]
  };
  
  // âœ… 3. ì‚¬ìš©ì ì§€ê°‘ì—ì„œ ì„œëª… ë° ì „ì†¡
  const result = await tonConnectUI.sendTransaction(transaction);
  
  return result.boc;  // íŠ¸ëœì­ì…˜ í•´ì‹œ ë°˜í™˜
}
```

### ì£¼ìš” í¬ì¸íŠ¸

#### âš ï¸ ê°€ì¥ í”í•œ ì‹¤ìˆ˜
```typescript
// âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ!
.storeAddress(Address.parse(GAME_WALLET_ADDRESS))  // ì¼ë°˜ ì§€ê°‘ ì£¼ì†Œ

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
.storeAddress(Address.parse(GAME_JETTON_WALLET))  // Jetton ì§€ê°‘ ì£¼ì†Œ
```

**ì´ìœ **:
- GAME_WALLET_ADDRESSë¡œ ë³´ë‚´ë©´ í† í°ì´ **ì˜êµ¬ ì†ì‹¤**
- ë³µêµ¬ ë¶ˆê°€ëŠ¥!

#### forward_ton_amountì˜ ì—­í• 
```typescript
.storeCoins(toNano('0.05'))  // forward_ton_amount
```

**ëª©ì **: ìˆ˜ì‹ ì(ê²Œì„ Jetton Wallet)ì—ê²Œ ì•Œë¦¼
**ê°’**: 0.05 TON (5ì²œë§Œ ë‚˜ë…¸í†¤)
**í•„ìˆ˜**: ì—†ìœ¼ë©´ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨

---

## ğŸ” 2ë‹¨ê³„: íŠ¸ëœì­ì…˜ ê²€ì¦ (ë°±ì—”ë“œ)

**íŒŒì¼**: `src/index.ts` - handleVerifyDeposit

```typescript
async function handleVerifyDeposit(request: Request, env: Env) {
  const { txHash, expectedAmount } = await request.json();
  
  // âœ… 1. TON Center APIë¡œ íŠ¸ëœì­ì…˜ ì¡°íšŒ
  const response = await fetch(
    `https://toncenter.com/api/v3/transactions?hash=${txHash}`,
    {
      headers: {
        'X-API-Key': env.TONCENTER_API_KEY || ''
      }
    }
  );
  
  const data = await response.json();
  
  if (!data.transactions || data.transactions.length === 0) {
    return error('Transaction not found');
  }
  
  const tx = data.transactions[0];
  
  // âœ… 2. ë°œì‹ ì í™•ì¸
  const sender = tx.in_msg?.source;
  if (sender !== walletAddress) {
    return error('Wrong sender');
  }
  
  // âœ… 3. ìˆ˜ì‹ ì í™•ì¸ (ê²Œì„ Jetton Wallet)
  const destination = tx.in_msg?.destination;
  if (destination !== env.CSPIN_JETTON_WALLET) {
    return error('Wrong destination');
  }
  
  // âœ… 4. Jetton ê¸ˆì•¡ íŒŒì‹±
  const body = tx.in_msg?.body;
  const jettonAmount = parseJettonTransfer(body);
  
  if (jettonAmount < expectedAmount) {
    return error('Insufficient amount');
  }
  
  // âœ… 5. í¬ë ˆë”§ ì¶”ê°€
  const creditKey = `credit:${walletAddress}`;
  const current = await env.CREDIT_KV.get(creditKey, 'json') as { credit: number } | null;
  
  const newCredit = (current?.credit || 0) + jettonAmount;
  
  await env.CREDIT_KV.put(creditKey, JSON.stringify({
    credit: newCredit,
    lastUpdated: new Date().toISOString()
  }));
  
  return success({ credit: newCredit });
}
```

### Jetton Transfer Payload íŒŒì‹±

```typescript
function parseJettonTransfer(bodyBoc: string): number {
  try {
    const body = Cell.fromBase64(bodyBoc);
    const slice = body.beginParse();
    
    const op = slice.loadUint(32);
    if (op !== 0xf8a7ea5) {  // op::transfer
      throw new Error('Not a Jetton transfer');
    }
    
    slice.loadUint(64);  // query_id
    const amount = slice.loadCoins();  // Jetton amount
    
    return Number(amount);
  } catch (error) {
    console.error('Parse error:', error);
    return 0;
  }
}
```

---

## ğŸ› ì‹œí–‰ì°©ì˜¤ ë° í•´ê²°

### ë¬¸ì œ 1: destination ì˜¤ë¥˜

**ì¦ìƒ**: ì…ê¸ˆí–ˆëŠ”ë° í¬ë ˆë”§ ì¦ê°€ ì•ˆ ë¨, í† í° ì‚¬ë¼ì§

**ì›ì¸**:
```typescript
// âŒ ì˜ëª»ëœ ì½”ë“œ
.storeAddress(Address.parse(GAME_WALLET_ADDRESS))
```

**í•´ê²°**:
```typescript
// âœ… ì˜¬ë°”ë¥¸ ì½”ë“œ
.storeAddress(Address.parse(GAME_JETTON_WALLET))
```

**êµí›ˆ**: 
- Jetton Transferì˜ destinationì€ **Jetton Wallet ì£¼ì†Œ**
- ì¼ë°˜ ì§€ê°‘ ì£¼ì†Œ ì‚¬ìš© ì‹œ í† í° ì˜êµ¬ ì†ì‹¤

### ë¬¸ì œ 2: forward_ton_amount ë¶€ì¡±

**ì¦ìƒ**: íŠ¸ëœì­ì…˜ ì‹¤íŒ¨

**ì›ì¸**:
```typescript
.storeCoins(toNano('0.01'))  // ë„ˆë¬´ ì ìŒ
```

**í•´ê²°**:
```typescript
.storeCoins(toNano('0.05'))  // ì¶©ë¶„í•œ ê¸ˆì•¡
```

**êµí›ˆ**: ìµœì†Œ 0.05 TON ê¶Œì¥

### ë¬¸ì œ 3: ê²€ì¦ íƒ€ì´ë°

**ì¦ìƒ**: "Transaction not found"

**ì›ì¸**: ë¸”ë¡ì²´ì¸ ì „íŒŒ ì‹œê°„ (5-10ì´ˆ)

**í•´ê²°**:
```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ 5ì´ˆ ëŒ€ê¸° í›„ ê²€ì¦
await tonConnectUI.sendTransaction(transaction);
await new Promise(resolve => setTimeout(resolve, 5000));
await verifyDeposit(txHash);
```

---

## ğŸ“ ì „ì²´ íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```
[ì‚¬ìš©ì]
  â†“ ì…ê¸ˆ ë²„íŠ¼ í´ë¦­
[Deposit.tsx]
  â†“ Jetton Transfer Payload ìƒì„±
  â†“ destination = GAME_JETTON_WALLET âš ï¸
  â†“ forward_ton_amount = 0.05 TON
[TON Connect]
  â†“ ì‚¬ìš©ì ì§€ê°‘ì—ì„œ ì„œëª…
[TON ë¸”ë¡ì²´ì¸]
  â†“ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ (5-10ì´ˆ)
  â†“ ì‚¬ìš©ì Jetton Wallet â†’ ê²Œì„ Jetton Wallet
[í”„ë¡ íŠ¸ì—”ë“œ]
  â†“ 5ì´ˆ ëŒ€ê¸°
  â†“ POST /api/verify-deposit
[Cloudflare Workers]
  â†“ TON Center API ì¡°íšŒ
  â†“ ë°œì‹ ì/ìˆ˜ì‹ ì/ê¸ˆì•¡ ê²€ì¦
  â†“ Jetton amount íŒŒì‹±
  â†“ KV: credit:${address} += amount
[í”„ë¡ íŠ¸ì—”ë“œ]
  â†“ í¬ë ˆë”§ ê°±ì‹  í‘œì‹œ
[ì‚¬ìš©ì]
  âœ… í¬ë ˆë”§ ì¦ê°€ í™•ì¸!
```

---

## ğŸ¯ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì •ìƒ ì…ê¸ˆ

```
ì…ë ¥: 100 CSPIN
ê¸°ëŒ€:
  âœ… íŠ¸ëœì­ì…˜ ì„±ê³µ
  âœ… í¬ë ˆë”§ +100
  âœ… í† í° ì”ì•¡ -100
```

### 2. ê¸ˆì•¡ ë¶€ì¡±

```
ì…ë ¥: 1000 CSPIN (ë³´ìœ : 100)
ê¸°ëŒ€:
  âŒ ì§€ê°‘ì—ì„œ íŠ¸ëœì­ì…˜ ê±°ë¶€
  âŒ "Insufficient balance"
```

### 3. ìµœì†Œ ê¸ˆì•¡ ë¯¸ë§Œ

```
ì…ë ¥: 0.5 CSPIN
ê¸°ëŒ€:
  âŒ "Minimum deposit: 1 CSPIN"
```

### 4. ì˜ëª»ëœ destination

```
ì½”ë“œ: .storeAddress(GAME_WALLET_ADDRESS)
ê²°ê³¼:
  âš ï¸ íŠ¸ëœì­ì…˜ ì„±ê³µí•˜ì§€ë§Œ í† í° ì†ì‹¤
  âŒ ë³µêµ¬ ë¶ˆê°€ëŠ¥!
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

êµ¬í˜„ ì‹œ í™•ì¸ ì‚¬í•­:

- [ ] destination = GAME_JETTON_WALLET (Jetton ì§€ê°‘)
- [ ] op = 0xf8a7ea5 (transfer ì—°ì‚°)
- [ ] forward_ton_amount >= 0.05 TON
- [ ] íŠ¸ëœì­ì…˜ ì „ì†¡ í›„ 5ì´ˆ ëŒ€ê¸°
- [ ] TON Center API í‚¤ ì„¤ì •
- [ ] ë°œì‹ ì ì£¼ì†Œ ê²€ì¦
- [ ] ìˆ˜ì‹ ì ì£¼ì†Œ ê²€ì¦ (Jetton Wallet)
- [ ] Jetton ê¸ˆì•¡ íŒŒì‹±
- [ ] KV í¬ë ˆë”§ ì—…ë°ì´íŠ¸
- [ ] ì—ëŸ¬ ì²˜ë¦¬ (ë„¤íŠ¸ì›Œí¬, ê²€ì¦ ì‹¤íŒ¨)

---

## ğŸ“š ì°¸ê³  ìë£Œ

### TEP-74 í‘œì¤€
- https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md

### TON Center API
- https://toncenter.com/api/v3/

### @ton/ton ë¼ì´ë¸ŒëŸ¬ë¦¬
- https://github.com/ton-org/ton

---

## ğŸ‰ ì™„ë£Œ!

ì´ ê°€ì´ë“œë§Œ ë”°ë¼í•˜ë©´ ì…ê¸ˆ ê¸°ëŠ¥ì„ **ì‹œí–‰ì°©ì˜¤ ì—†ì´** êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ìš”ì•½**:
1. destinationì€ **Jetton Wallet ì£¼ì†Œ** (ê°€ì¥ ì¤‘ìš”!)
2. forward_ton_amountëŠ” **0.05 TON** ì´ìƒ
3. íŠ¸ëœì­ì…˜ í›„ **5ì´ˆ ëŒ€ê¸°** í•„ìš”
4. ë°±ì—”ë“œì—ì„œ **3ì¤‘ ê²€ì¦** (ë°œì‹ ì/ìˆ˜ì‹ ì/ê¸ˆì•¡)
