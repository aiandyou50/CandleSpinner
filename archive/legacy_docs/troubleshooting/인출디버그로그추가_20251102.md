# 인출 디버그 로그 기능 추가 완료

**작성일**: 2025-11-02  
**목적**: 인출 실패 원인 파악을 위한 상세 디버그 로그 추가

---

## 🎉 완료된 작업

### 1. Withdraw 컴포넌트 수정 ✅
**파일**: `src/components/Withdraw.tsx`

**추가된 기능**:
- ✅ 디버그 로그 버튼 추가
- ✅ 입금과 동일한 DebugLogModal 사용
- ✅ 상세 로그 기록 (시작, 검증, API 호출, 결과)

**로그 내용**:
```typescript
logger.info('=== 인출 시작 ===');
logger.info(`사용자 지갑: ${walletAddress}`);
logger.info(`현재 크레딧: ${currentCredit} CSPIN`);
logger.info(`인출 금액: ${withdrawAmount} CSPIN`);
logger.info('📤 백엔드 API 호출 시작...');
logger.debug('요청 페이로드:', { walletAddress, amount: withdrawAmount });
logger.info('✅ 백엔드 응답 수신:', result);
logger.info(`트랜잭션 해시: ${result.txHash}`);
logger.info('=== 인출 완료 ===');
```

### 2. API 클라이언트 수정 ✅
**파일**: `src/api/client.ts`

**추가된 로그**:
```typescript
logger.info('📡 API 요청 시작:', `${API_BASE_URL}/api/withdraw`);
logger.debug('요청 헤더:', { 'Content-Type': 'application/json' });
logger.debug('요청 본문:', data);
logger.info(`API 응답 상태: ${response.status} ${response.statusText}`);
logger.error('❌ API 오류 응답:', errorText);
logger.info('✅ API 응답 성공:', result);
```

**개선된 오류 처리**:
- API 오류 응답 파싱
- 네트워크 오류 명확한 메시지
- 오류 스택 트레이스 기록

---

## 🐛 디버그 로그 사용 방법

### 1단계: 인출 시도
1. 게임 화면 진입
2. 인출 금액 입력 (예: 1 CSPIN)
3. **[인출하기]** 버튼 클릭
4. 오류 발생 확인

### 2단계: 디버그 로그 확인
1. **[🐛 디버그 로그 보기]** 버튼 클릭
2. 모달에서 전체 로그 확인
3. **[📋 로그 복사]** 버튼으로 복사

### 3단계: 로그 분석

**정상 흐름**:
```
[2025-11-02 10:30:15] INFO: === 인출 시작 ===
[2025-11-02 10:30:15] INFO: 사용자 지갑: UQA...
[2025-11-02 10:30:15] INFO: 현재 크레딧: 10 CSPIN
[2025-11-02 10:30:15] INFO: 인출 금액: 1 CSPIN
[2025-11-02 10:30:15] INFO: 📤 백엔드 API 호출 시작...
[2025-11-02 10:30:15] DEBUG: 요청 페이로드: {walletAddress: "UQA...", amount: 1}
[2025-11-02 10:30:15] INFO: 📡 API 요청 시작: https://aiandyou.me/api/withdraw
[2025-11-02 10:30:16] INFO: API 응답 상태: 200 OK
[2025-11-02 10:30:16] INFO: ✅ API 응답 성공: {success: true, txHash: "abc..."}
[2025-11-02 10:30:16] INFO: ✅ 백엔드 응답 수신: {success: true, txHash: "abc..."}
[2025-11-02 10:30:16] INFO: 트랜잭션 해시: abc...
[2025-11-02 10:30:16] INFO: === 인출 완료 ===
```

**현재 오류 흐름 (500 에러)**:
```
[2025-11-02 10:30:15] INFO: === 인출 시작 ===
[2025-11-02 10:30:15] INFO: 사용자 지갑: UQA...
[2025-11-02 10:30:15] INFO: 인출 금액: 1 CSPIN
[2025-11-02 10:30:15] INFO: 📤 백엔드 API 호출 시작...
[2025-11-02 10:30:15] INFO: 📡 API 요청 시작: https://aiandyou.me/api/withdraw
[2025-11-02 10:30:16] INFO: API 응답 상태: 500 Internal Server Error  ← 여기 주목!
[2025-11-02 10:30:16] ERROR: ❌ API 오류 응답: {"error": "..."}  ← 오류 내용 확인!
[2025-11-02 10:30:16] ERROR: ❌ 인출 실패: Error: Failed to withdraw
```

---

## 🔍 500 오류 원인 파악 가이드

### 예상 원인 1: 환경변수 누락
**로그에서 확인**:
```
ERROR: 환경변수 누락: GAME_WALLET_MNEMONIC
```

**해결**:
```bash
# Cloudflare Dashboard → Variables 확인
GAME_WALLET_MNEMONIC=word1 word2 ...
GAME_WALLET_ADDRESS=UQB...
CSPIN_JETTON_MASTER=EQD...
TONCENTER_API_KEY=...
```

### 예상 원인 2: Import 오류
**로그에서 확인**:
```
ERROR: Cannot find module '../functions/src/withdraw-handler'
```

**해결**:
```bash
# 파일 경로 확인
ls functions/src/withdraw-handler.ts

# 빌드 재실행
npm run build
npm run deploy
```

### 예상 원인 3: 니모닉 파싱 오류
**로그에서 확인**:
```
ERROR: mnemonicToPrivateKey failed
```

**해결**:
- 니모닉이 24단어인지 확인
- 공백으로 구분되어 있는지 확인

### 예상 원인 4: TonCenter API 오류
**로그에서 확인**:
```
ERROR: seqno 조회 실패
ERROR: Jetton Wallet 주소 계산 실패
ERROR: BOC 전송 실패
```

**해결**:
- `/api/check-api-key` 호출하여 API 키 확인
- TonCenter API 상태 확인

---

## 📋 체크리스트

### 프론트엔드 확인
- [x] Withdraw.tsx 디버그 로그 추가
- [x] DebugLogModal 연동
- [x] 로그 복사/지우기 기능

### 백엔드 확인 (다음 단계)
- [ ] Cloudflare Workers 로그 확인
  - Dashboard → Workers & Pages → CandleSpinner → Logs
- [ ] 환경변수 확인
  - Dashboard → Settings → Variables
- [ ] withdraw-handler.ts 배포 확인
  - `npm run build` 성공 여부
  - `npm run deploy` 성공 여부

---

## 🚀 다음 단계

### 1. 로컬에서 디버그 로그 확인
```bash
# 개발 서버 실행
npm run dev

# 브라우저에서:
# 1. 인출 시도
# 2. [🐛 디버그 로그 보기] 클릭
# 3. 로그 확인
```

### 2. Cloudflare Workers 로그 확인
```bash
# Dashboard 접속
https://dash.cloudflare.com

# Workers & Pages → CandleSpinner → Logs
# 실시간 로그에서 [Withdraw] 관련 로그 찾기
```

**예상 로그 (백엔드)**:
```
[Withdraw] 인출 요청 시작
[Withdraw] 사용자: UQA...
[Withdraw] 금액: 1 CSPIN
[환경변수] 확인 완료
[getGameWallet] 니모닉 → 키 쌍 변환 시작
[seqno] KV 조회 시작...
...
```

### 3. 오류 발생 시
**디버그 로그를 복사하여 분석**:
```
[📋 로그 복사] → 텍스트 파일 저장 → 오류 라인 확인
```

**Cloudflare Workers 로그 확인**:
```
Dashboard → Logs → 오류 메시지 확인
```

---

## 💡 예상 시나리오

### 시나리오 1: Import 오류 (가장 가능성 높음)
```typescript
// src/index.ts
import { processWithdrawal } from '../functions/src/withdraw-handler';
```

**문제**: Cloudflare Workers에서 상대 경로 import 실패

**해결**:
1. `wrangler.toml` 확인
2. 빌드 설정 확인
3. 또는 `withdraw-handler.ts`를 `src/` 폴더로 이동

### 시나리오 2: 환경변수 누락
```
Error: 환경변수 누락: GAME_WALLET_MNEMONIC
```

**해결**: Cloudflare Dashboard에서 환경변수 추가

### 시나리오 3: @ton/crypto 라이브러리 오류
```
Error: mnemonicToPrivateKey is not a function
```

**해결**:
```bash
npm install @ton/crypto
npm run build
npm run deploy
```

---

## 📊 결과 보고

**디버그 로그를 통해 확인할 내용**:
1. ✅ 프론트엔드 로그 정상 출력
2. ❓ API 응답 상태 (500)
3. ❓ API 오류 메시지 내용
4. ❓ Cloudflare Workers 백엔드 로그

**다음 단계**: 디버그 로그 확인 후 오류 메시지 분석

---

**구현 완료**: 프론트엔드 디버그 로그 ✅  
**대기 중**: 실제 오류 로그 수집 및 분석
