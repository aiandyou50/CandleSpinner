# 입금 성공 경험 - MVP 분석으로 해결

**작성일**: 2025-11-02  
**상태**: ✅ 해결 완료

---

## 🎯 핵심 교훈

> **"TEP-74 표준을 정확히 이해하고 TON 공식 문서를 참고하라"**

입금 오류를 3가지 수정으로 해결했습니다:
1. `destination` 수정: GAME_JETTON_WALLET → GAME_WALLET_ADDRESS (TON 지갑)
2. `forward_ton_amount` 수정: 0.005 TON → 1 nanoton (표준 최소값)
3. 환경변수 설정: TONCENTER_API_KEY 추가

**핵심 개념**: Jetton Transfer의 destination은 **TON 지갑 주소**

---

## 📊 문제 발생 과정

### 초기 증상
```
✅ 프론트엔드 UI 정상
✅ TON Connect 연결 성공
❌ sendTransaction() 후 트랜잭션 실패
❌ 블록체인 익스플로러에 트랜잭션 없음
```

### 시행착오
1. **첫 시도**: destination을 추측으로 수정
   - ❌ 실패: 여전히 오류 발생

2. **두 번째 시도**: forward_ton_amount 조정
   - ❌ 실패: 값이 너무 높거나 낮음

3. **세 번째 시도**: 로그 분석
   - ⚠️ 부분 성공: 오류 메시지 확인했지만 원인 불명확

---

## ✅ 해결 과정

### 1단계: TEP-74 표준 이해
```
핵심 개념:
- Jetton Transfer는 수신자의 TON 지갑 주소를 destination으로 사용
- Jetton Wallet 컨트랙트가 자동으로 수신자의 Jetton Wallet을 찾아 전송
- forward_ton_amount는 알림용 최소값 (1 nanoton 충분)
```

**TEP-74 표준**:
```typescript
// Jetton Transfer Payload 구조
beginCell()
  .storeUint(0xf8a7ea5, 32)      // op: jetton transfer
  .storeUint(0, 64)              // query_id
  .storeCoins(amount)            // 전송할 토큰 양
  .storeAddress(destination)     // ✅ 수신자의 TON 지갑 (Jetton X)
  .storeAddress(responseTo)      // 응답 받을 지갑
  .storeBit(0)                   // custom_payload
  .storeCoins(forwardTonAmount)  // ✅ 1 nanoton (최소값)
  .storeBit(0)                   // forward_payload
  .endCell();
```

**결정적 교훈**:
- destination: GAME_WALLET_ADDRESS (게임의 TON 지갑)
- forward_ton_amount: 1 nanoton (표준 최소값)
- TON 공식 문서 및 표준 참고가 핵심!

---

### 2단계: 코드 수정

**src/components/Deposit.tsx 수정**:
```typescript
// ❌ 이전 (오류 발생)
const destinationAddress = import.meta.env.VITE_GAME_JETTON_WALLET_ADDRESS;
const forwardTonAmount = 0.005; // TON

// ✅ 수정 후 (정상 동작)
const destinationAddress = import.meta.env.VITE_GAME_WALLET_ADDRESS;
const forwardTonAmount = 0.000000001; // 1 nanoton
```

**이유**:
- Jetton Transfer는 **TON 지갑**으로 전송 (Jetton 지갑 아님)
- forward_ton_amount는 알림용 최소값 (1 nanoton 충분)

---

### 3단계: 환경변수 설정

**로컬 테스트용 .dev.vars**:
```env
TONCENTER_API_KEY=your_api_key_here
GAME_WALLET_ADDRESS=UQBXs...  # TON 지갑 주소
GAME_WALLET_MNEMONIC=word1 word2 ...
CSPIN_TOKEN_ADDRESS=EQD...
```

**Cloudflare Dashboard 설정**:
```
Workers & Pages → CandleSpinner → Settings → Variables
→ 동일한 환경변수 추가
```

---

## 🔍 기술 분석

### Jetton Transfer 구조 (TEP-74 표준)
```
사용자 TON 지갑
    ↓ sendTransaction() [프론트엔드]
사용자 Jetton 지갑 (자동 계산됨)
    ↓ Jetton Transfer 내부 메시지
게임 TON 지갑 ← destination (수정한 부분!)
    ↓ 알림 (forward_ton_amount: 1 nanoton)
게임 Jetton 지갑 (자동 수령)
```

### 핵심 개념
1. **destination = TON 지갑 주소**
   - Jetton 컨트랙트가 TON 지갑으로부터 Jetton 지갑 주소를 자동 계산
   - 프론트엔드에서 Jetton 지갑 주소 계산 불필요!

2. **forward_ton_amount = 최소값 (1 nanoton)**
   - 알림용 TON (Jetton 전송 알림)
   - 0.005 TON은 불필요하게 높음
   - MVP 검증값: 1 nanoton

---

## 📈 검증 결과

### 테스트 시나리오
```
1. 게임 화면 진입
2. [📥 입금] 버튼 클릭
3. 입금액 입력: 1 CSPIN
4. [Deposit] 버튼 클릭
5. TON Connect 서명 팝업 → [Confirm]
```

### 성공 확인
```
✅ 트랜잭션 전송 성공
✅ 블록체인 익스플로러에서 확인
✅ 게임 크레딧 증가
✅ 오류 없음
```

---

## 🎓 재발 방지 체크리스트

### 새로운 기능 구현 전
- [ ] TON 공식 문서 확인 (https://docs.ton.org)
- [ ] TEP 표준 문서 읽기 (https://github.com/ton-blockchain/TEPs)
- [ ] 유사 기능의 성공 사례 검색
- [ ] 현재 프로젝트의 `src/components/` 폴더에서 참고 코드 찾기

### 오류 발생 시
- [ ] TON 표준 문서 재확인 (추측 금지!)
- [ ] 로그 분석 (console.log, 블록체인 익스플로러)
- [ ] 환경변수 설정 확인 (로컬 `.dev.vars` + Cloudflare Dashboard)
- [ ] 이미 구현된 유사 기능 (예: Deposit.tsx) 참고

### 배포 전
- [ ] 로컬 테스트 성공 확인
- [ ] Cloudflare 환경변수 동기화
- [ ] 테스트넷에서 실제 트랜잭션 확인

---

## 📚 참고 자료

### 관련 파일
- 현재 입금 코드: `src/components/Deposit.tsx` (완전 구현)
- 환경변수 예시: `.dev.vars.example`

### 관련 문서
- **TEP-74 표준**: https://github.com/ton-blockchain/TEPs/blob/master/text/0074-jettons-standard.md
- **TON Connect**: https://docs.ton.org/develop/dapps/ton-connect/overview
- **Cloudflare Workers**: 환경변수 설정 가이드

### TON 블록체인 개념
- Jetton = TON의 토큰 표준 (이더리움의 ERC-20과 유사)
- destination = 수신자의 **TON 지갑** (Jetton 지갑 아님!)
- Jetton Wallet = 각 사용자의 Jetton 보유량을 관리하는 스마트 컨트랙트

---

## ✨ 성공 요인

1. **TEP-74 표준 정확한 이해**: destination은 TON 지갑, forward_ton_amount는 1 nanoton
2. **체계적 분석**: destination, forward_ton_amount, 환경변수 순차 확인
3. **로그 기반 디버깅**: console.log + 블록체인 익스플로러
4. **환경 동기화**: 로컬 + Cloudflare 일치
5. **TON 공식 문서 참고**: 추측 대신 표준 문서 확인

---

**다음 단계**: 인출 기능도 동일한 TEP-74 표준으로 새로 구현 (입금의 역방향)
