# ì¸ì¶œ êµ¬í˜„ ê°€ì´ë“œ - í”„ë¡ íŠ¸ì—”ë“œ ë°©ì‹ (ì‚¬ìš©ì Fee ë¶€ë‹´)

**ì‘ì„±ì¼**: 2025-11-02  
**ë°©ì‹**: Option A - í”„ë¡ íŠ¸ì—”ë“œ TON Connect  
**íŠ¹ì§•**: ì‚¬ìš©ì Fee ë¶€ë‹´, ê²Œì„ ë¹„ìš© 0ì›

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­ í™•ì¸

### ì¶©ì¡± ì—¬ë¶€
- âœ… ê²Œì„ ìœ ì €ê°€ ë„¤íŠ¸ì›Œí¬ Fee ë¶€ë‹´
- âœ… ê²Œì„ ìš´ì˜ ë¹„ìš© 0ì›
- âœ… ì•ˆì •ì ì¸ ì¸ì¶œ ì²˜ë¦¬
- âœ… ì…ê¸ˆê³¼ ì¼ê´€ëœ UX

---

## ğŸ“‹ êµ¬í˜„ ë‹¨ê³„

### Step 1: Withdraw.tsx ì™„ì„± (1ì‹œê°„)

**í˜„ì¬ ìƒíƒœ**: TODO ì½”ë“œ ì£¼ì„ ì²˜ë¦¬ë¨

**í™œì„±í™”í•  ì½”ë“œ**:
```typescript
// src/components/Withdraw.tsx

export function Withdraw({ walletAddress, currentCredit, onSuccess }: WithdrawProps) {
  const [tonConnectUI] = useTonConnectUI();
  // ... ê¸°ì¡´ ì½”ë“œ ...

  const handleWithdraw = async () => {
    try {
      setIsLoading(true);
      setError(null);

      const withdrawAmount = parseFloat(amount);
      
      // ì…ë ¥ ê²€ì¦
      if (isNaN(withdrawAmount) || withdrawAmount <= 0) {
        throw new Error('ì˜ëª»ëœ ê¸ˆì•¡ì…ë‹ˆë‹¤');
      }
      
      if (withdrawAmount > currentCredit) {
        throw new Error('í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');
      }

      logger.info('=== ì¸ì¶œ ì‹œì‘ ===');
      logger.info(`ì¸ì¶œ ê¸ˆì•¡: ${withdrawAmount} CSPIN`);

      // 1. ì‚¬ìš©ì Jetton Wallet ì£¼ì†Œ ê³„ì‚°
      logger.info('ì‚¬ìš©ì Jetton Wallet ê³„ì‚° ì¤‘...');
      
      const tonClient = new TonClient({
        endpoint: 'https://toncenter.com/api/v2/jsonRPC',
      });

      const userAddress = Address.parse(walletAddress);
      const masterAddress = Address.parse(CSPIN_TOKEN_ADDRESS);
      const jettonMaster = tonClient.open(JettonMaster.create(masterAddress));
      
      const userJettonWalletAddress = await jettonMaster.getWalletAddress(userAddress);
      const userJettonWalletRaw = userJettonWalletAddress.toString({ 
        urlSafe: true, 
        bounceable: true
      });

      logger.info(`âœ… ì‚¬ìš©ì Jetton Wallet: ${userJettonWalletRaw}`);

      // 2. ê¸ˆì•¡ ë³€í™˜ (nano ë‹¨ìœ„)
      const amountNano = BigInt(Math.floor(withdrawAmount * 1_000_000_000));
      logger.debug(`nano ë‹¨ìœ„: ${amountNano}`);

      // 3. Jetton Transfer Payload ìƒì„±
      const gameWalletAddress = Address.parse(GAME_WALLET_ADDRESS);
      const responseAddress = Address.parse(walletAddress);

      const payloadBase64 = buildJettonTransferPayload(
        amountNano,
        gameWalletAddress,  // âœ… ê²Œì„ TON ì§€ê°‘ (ì¸ì¶œ ëª©ì ì§€)
        responseAddress
      );

      logger.debug('Payload ìƒì„± ì™„ë£Œ');

      // 4. TON Connect íŠ¸ëœì­ì…˜
      const transaction = {
        validUntil: Math.floor(Date.now() / 1000) + 300,  // 5ë¶„
        messages: [
          {
            address: userJettonWalletRaw,  // ì‚¬ìš©ì Jetton Wallet
            amount: toNano('0.2').toString(),  // âœ… ì‚¬ìš©ì Fee ë¶€ë‹´
            payload: payloadBase64,
          },
        ],
      };

      logger.info('íŠ¸ëœì­ì…˜ ì „ì†¡ ì¤‘...');
      logger.debug('Transaction:', transaction);

      const result = await tonConnectUI.sendTransaction(transaction);
      logger.info('âœ… íŠ¸ëœì­ì…˜ ì„±ê³µ:', result);
      
      const txHash = result.boc;
      logger.info(`íŠ¸ëœì­ì…˜ í•´ì‹œ: ${txHash}`);

      // 5. ë°±ì—”ë“œì— í¬ë ˆë”§ ì°¨ê° ìš”ì²­
      logger.info('ë°±ì—”ë“œ í¬ë ˆë”§ ì°¨ê° ìš”ì²­...');
      const response = await fetch('/api/withdraw-confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          walletAddress, 
          amount: withdrawAmount, 
          txHash 
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'í¬ë ˆë”§ ì°¨ê° ì‹¤íŒ¨');
      }

      logger.info('=== ì¸ì¶œ ì™„ë£Œ ===');
      alert(`${withdrawAmount} CSPIN ì¸ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
      setAmount('');
      onSuccess();

    } catch (err) {
      logger.error('âŒ ì¸ì¶œ ì‹¤íŒ¨:', err);
      
      if (err instanceof Error) {
        logger.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', err.message);
        
        // ì‚¬ìš©ì ì¹œí™”ì  ì˜¤ë¥˜ ë©”ì‹œì§€
        if (err.message.includes('User rejected')) {
          setError('íŠ¸ëœì­ì…˜ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
          setError(err.message);
        }
      } else {
        setError('ì¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
      
      console.error('Withdraw failed:', err);
    } finally {
      setIsLoading(false);
    }
  };

  // ... UI ì½”ë“œ ë™ì¼ ...
}
```

### Step 2: ë°±ì—”ë“œ API ì¶”ê°€ (30ë¶„)

**ìƒˆ ì—”ë“œí¬ì¸íŠ¸**: `/api/withdraw-confirm`

```typescript
// src/index.ts

// ë¼ìš°íŒ… ì¶”ê°€
if (url.pathname === '/api/withdraw-confirm' && request.method === 'POST') {
  return handleWithdrawConfirm(request, env, corsHeaders);
}

// í•¸ë“¤ëŸ¬ êµ¬í˜„
async function handleWithdrawConfirm(
  request: Request,
  env: Env,
  corsHeaders: Record<string, string>
): Promise<Response> {
  try {
    const body = await request.json() as {
      walletAddress: string;
      amount: number;
      txHash: string;
    };
    
    console.log('[WithdrawConfirm] ìš”ì²­:', body);
    
    // í¬ë ˆë”§ í™•ì¸
    const key = `credit:${body.walletAddress}`;
    const current = await env.CREDIT_KV.get(key, 'json') as { credit: number } | null;
    
    if (!current || current.credit < body.amount) {
      console.error('[WithdrawConfirm] í¬ë ˆë”§ ë¶€ì¡±');
      return new Response(JSON.stringify({
        success: false,
        error: 'Insufficient credit'
      }), {
        status: 400,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
    
    // í¬ë ˆë”§ ì°¨ê°
    const newCredit = current.credit - body.amount;
    await env.CREDIT_KV.put(key, JSON.stringify({
      credit: newCredit,
      lastUpdated: new Date().toISOString(),
      lastWithdraw: {
        amount: body.amount,
        txHash: body.txHash,
        timestamp: new Date().toISOString()
      }
    }));
    
    console.log(`[WithdrawConfirm] í¬ë ˆë”§ ì°¨ê° ì™„ë£Œ: ${current.credit} â†’ ${newCredit}`);
    
    return new Response(JSON.stringify({
      success: true,
      credit: newCredit,
      message: 'ì¸ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'
    }), {
      status: 200,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
    
  } catch (error) {
    console.error('[WithdrawConfirm] ì˜¤ë¥˜:', error);
    return new Response(JSON.stringify({
      success: false,
      error: error instanceof Error ? error.message : 'Internal server error'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
}
```

### Step 3: ì‚¬ìš©ì ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ (10ë¶„)

**UI ê°œì„ **:
```tsx
// Withdraw.tsx

return (
  <div className="backdrop-blur-lg bg-white/10 rounded-2xl p-6 border border-white/20 shadow-2xl">
    <h3 className="text-2xl font-bold text-white mb-4">ğŸ’¸ CSPIN ì¸ì¶œ</h3>
    
    {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
    <div className="mb-4 p-3 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
      <p className="text-sm text-yellow-200">
        â„¹ï¸ ì¸ì¶œ ì‹œ ë„¤íŠ¸ì›Œí¬ ìˆ˜ìˆ˜ë£Œ <strong>0.2 TON</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.
      </p>
      <p className="text-xs text-yellow-300 mt-1">
        ì§€ê°‘ì— ì¶©ë¶„í•œ TONì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
      </p>
    </div>
    
    {/* ê¸°ì¡´ ì…ë ¥ í•„ë“œ */}
    <div className="space-y-4">
      {/* ... */}
    </div>
  </div>
);
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì¤€ë¹„ë¬¼
- âœ… TON Connect ì§€ê°‘ ì—°ê²°
- âœ… ì§€ê°‘ì— TON ë³´ìœ  (ìµœì†Œ 0.3 TON ê¶Œì¥)
- âœ… í¬ë ˆë”§ ë³´ìœ  (ìµœì†Œ 1 CSPIN)

### í…ŒìŠ¤íŠ¸ 1: ì •ìƒ ì¸ì¶œ
```
1. ê²Œì„ í™”ë©´ â†’ [ì¸ì¶œ] íƒ­
2. ê¸ˆì•¡ ì…ë ¥: 1 CSPIN
3. [ì¸ì¶œí•˜ê¸°] í´ë¦­
4. TON Connect íŒì—… í™•ì¸:
   - "0.2 TON ìˆ˜ìˆ˜ë£Œ ì§€ë¶ˆ"
   - "1 CSPIN ì „ì†¡"
5. [í™•ì¸] í´ë¦­
6. ì„±ê³µ ë©”ì‹œì§€ í™•ì¸
7. í¬ë ˆë”§ ê°ì†Œ í™•ì¸ (10 â†’ 9)
8. ë¸”ë¡ì²´ì¸ ìµìŠ¤í”Œë¡œëŸ¬ í™•ì¸
```

### í…ŒìŠ¤íŠ¸ 2: TON ë¶€ì¡±
```
1. ì§€ê°‘ TON < 0.2 TON
2. ì¸ì¶œ ì‹œë„
3. TON Connect ì˜¤ë¥˜:
   "Insufficient TON balance"
4. ì‚¬ìš©ì ì•ˆë‚´: "TONì„ ì¶©ì „í•´ì£¼ì„¸ìš”"
```

### í…ŒìŠ¤íŠ¸ 3: í¬ë ˆë”§ ë¶€ì¡±
```
1. í¬ë ˆë”§ < ì¸ì¶œì•¡
2. ì¸ì¶œ ì‹œë„
3. ì˜¤ë¥˜ ë©”ì‹œì§€: "í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤"
```

### í…ŒìŠ¤íŠ¸ 4: ì‚¬ìš©ì ì·¨ì†Œ
```
1. ì¸ì¶œ ì‹œë„
2. TON Connect íŒì—…ì—ì„œ [ì·¨ì†Œ]
3. ë©”ì‹œì§€: "íŠ¸ëœì­ì…˜ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤"
4. í¬ë ˆë”§ ë³€í™” ì—†ìŒ
```

---

## ğŸ“Š ë¹„ìš© ë¶„ì„

### ì‚¬ìš©ì ê´€ì 
```
ì¸ì¶œ 1íšŒë‹¹ ë¹„ìš©:
- CSPIN ìˆ˜ë ¹: +1 CSPIN (í¬ë ˆë”§ ì°¨ê°)
- TON ì§€ì¶œ: -0.2 TON (ë„¤íŠ¸ì›Œí¬ Fee)

ì˜ˆì‹œ:
- 1 CSPIN = $0.10 (ê°€ì •)
- 0.2 TON = $0.50 (TON ê°€ê²© ë³€ë™)
- ìˆœì´ìµ: $0.10 - $0.50 = -$0.40 (ì†í•´)

âš ï¸ ì£¼ì˜: TON ê°€ê²© < $0.50 ì¼ ë•Œë§Œ ìˆ˜ìµ
```

### ê²Œì„ ìš´ì˜ì ê´€ì 
```
ì¸ì¶œ ì²˜ë¦¬ ë¹„ìš©: 0 TON âœ…
í¬ë ˆë”§ ì°¨ê°ë§Œ ìˆ˜í–‰
```

### ê°œì„  ë°©ì•ˆ
```
Option 1: ìµœì†Œ ì¸ì¶œ ê¸ˆì•¡ ì„¤ì •
- ì˜ˆ: ìµœì†Œ 10 CSPIN
- ìˆ˜ìˆ˜ë£Œ ë¹„ìœ¨ ê°ì†Œ

Option 2: ì¸ì¶œ ìˆ˜ìˆ˜ë£Œ ì¶”ê°€
- í¬ë ˆë”§ ì°¨ê°: 11 CSPIN
- ì‚¬ìš©ì ìˆ˜ë ¹: 10 CSPIN
- ê²Œì„ ìˆ˜ìˆ˜ë£Œ: 1 CSPIN

Option 3: ë°°ì¹˜ ì¸ì¶œ
- í•˜ë£¨ 1íšŒ ì¼ê´„ ì²˜ë¦¬
- ìˆ˜ìˆ˜ë£Œ ì ˆê°
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. TON ì”ì•¡ í™•ì¸
```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ TON ì”ì•¡ í™•ì¸ (ì„ íƒ)
const tonBalance = await tonConnectUI.account?.balance;
if (tonBalance < toNano('0.3')) {
  alert('TON ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 0.3 TONì´ í•„ìš”í•©ë‹ˆë‹¤.');
  return;
}
```

### 2. íŠ¸ëœì­ì…˜ ê²€ì¦ (ì„ íƒ)
```typescript
// ë°±ì—”ë“œì—ì„œ txHash ê²€ì¦ (í”„ë¡œë•ì…˜ ê¶Œì¥)
async function verifyTransaction(txHash: string): Promise<boolean> {
  const response = await fetch(
    `https://toncenter.com/api/v2/getTransactions?address=${GAME_WALLET_ADDRESS}&limit=1`,
    {
      headers: { 'X-API-Key': env.TONCENTER_API_KEY }
    }
  );
  // íŠ¸ëœì­ì…˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
}
```

### 3. ì¤‘ë³µ ë°©ì§€
```typescript
// KVì— ì²˜ë¦¬ëœ txHash ì €ì¥
const txKey = `tx:${txHash}`;
const exists = await env.CREDIT_KV.get(txKey);
if (exists) {
  throw new Error('ì´ë¯¸ ì²˜ë¦¬ëœ íŠ¸ëœì­ì…˜ì…ë‹ˆë‹¤');
}
await env.CREDIT_KV.put(txKey, 'processed', { expirationTtl: 86400 * 7 });
```

---

## ğŸ¯ ì˜ˆìƒ ì¼ì •

| ë‹¨ê³„ | ì‘ì—… | ì‹œê°„ |
|------|------|------|
| 1 | Withdraw.tsx TODO í™œì„±í™” | 1ì‹œê°„ |
| 2 | /api/withdraw-confirm ì¶”ê°€ | 30ë¶„ |
| 3 | UI ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ | 10ë¶„ |
| 4 | ë¡œì»¬ í…ŒìŠ¤íŠ¸ | 30ë¶„ |
| 5 | ë°°í¬ ë° ê²€ì¦ | 30ë¶„ |
| **ì´ê³„** | | **2.5ì‹œê°„** |

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Withdraw.tsx TODO ì½”ë“œ í™œì„±í™”
- [ ] buildJettonTransferPayload() ì •ìƒ ë™ì‘
- [ ] TON Connect íŠ¸ëœì­ì…˜ ì „ì†¡ ì„±ê³µ
- [ ] /api/withdraw-confirm êµ¬í˜„
- [ ] í¬ë ˆë”§ ì°¨ê° ì •ìƒ ë™ì‘
- [ ] ì‚¬ìš©ì ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ í™•ì¸
- [ ] ë°°í¬ ë° í”„ë¡œë•ì…˜ ê²€ì¦

---

## ğŸ“ ìµœì¢… í™•ì¸

### ìš”êµ¬ì‚¬í•­ ì¶©ì¡± ì—¬ë¶€
- âœ… ê²Œì„ ìœ ì €ê°€ ë„¤íŠ¸ì›Œí¬ Fee ë¶€ë‹´ (0.2 TON)
- âœ… ê²Œì„ ìš´ì˜ ë¹„ìš© 0ì›
- âœ… ì•ˆì •ì ì¸ ì¸ì¶œ ì²˜ë¦¬ (TON Connect)
- âœ… ì…ê¸ˆê³¼ ì¼ê´€ëœ UX

### ê²Œì„ ë‹ˆëª¨ë‹‰ ì‚¬ìš© ì—¬ë¶€
- âŒ ë¶ˆí•„ìš” (í”„ë¡ íŠ¸ì—”ë“œ ë°©ì‹)
- âœ… ë³´ì•ˆ í–¥ìƒ (Cloudflare Workersì— ë¯¼ê° ì •ë³´ ì—†ìŒ)

### ë¸”ë¡ì²´ì¸ ë™ì‘
```
1. ì‚¬ìš©ìê°€ ìì‹ ì˜ Jetton Walletì—ê²Œ ëª…ë ¹
2. "ê²Œì„ TON ì§€ê°‘ì—ê²Œ CSPIN ë³´ë‚´ì¤˜"
3. Jetton Walletì´ ìë™ìœ¼ë¡œ ê²Œì„ Jetton Wallet ì°¾ì•„ì„œ ì „ì†¡
4. ê²Œì„ì€ ìë™ ìˆ˜ë ¹ (ì„œëª… ë¶ˆí•„ìš”)
```

---

**ë‹¤ìŒ ë‹¨ê³„**: Withdraw.tsx TODO ì½”ë“œ í™œì„±í™”
