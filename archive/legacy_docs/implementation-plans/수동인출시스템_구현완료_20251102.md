# 수동 인출 시스템 구현 완료

**작성일**: 2025-11-02  
**구현 방식**: 수동 인출 (크레딧 차감 + 대기열 + 관리자 처리)  
**상태**: ✅ 구현 완료

---

## 📋 구현 내용

### 1. Withdraw.tsx 수정
- ❌ 기존: 입금과 동일한 방식 (사용자→게임)
- ✅ 수정: 크레딧 차감 + 대기열 추가
- 사용자에게 "12~24시간 이내 처리" 안내
- 네트워크 수수료 게임 부담 (무료)

### 2. 백엔드 API (src/index.ts)

#### /api/withdraw-request (POST)
```typescript
// 기능:
// 1. 크레딧 확인 및 차감
// 2. 대기열에 인출 요청 추가
// 3. withdrawal ID 생성 및 반환

// 요청:
{
  walletAddress: string,
  amount: number
}

// 응답:
{
  success: true,
  credit: number,        // 차감 후 크레딧
  withdrawalId: string,  // 요청 ID
  estimatedProcessTime: "12~24시간 이내"
}
```

#### /api/admin/pending-withdrawals (GET)
```typescript
// 기능: 대기 중인 인출 목록 조회

// 응답:
{
  success: true,
  withdrawals: [
    {
      id: string,
      walletAddress: string,
      amount: number,
      status: "pending",
      requestedAt: string,
      estimatedProcessTime: string
    }
  ],
  count: number
}
```

#### /api/admin/mark-processed (POST)
```typescript
// 기능: 인출 처리 완료 표시

// 요청:
{
  withdrawalId: string,
  txHash?: string
}

// 응답:
{
  success: true,
  message: "인출 처리가 완료되었습니다",
  withdrawal: { ... }
}
```

### 3. 관리자 대시보드 (AdminWithdrawals.tsx)
- 대기 중인 인출 목록 실시간 표시
- 통계: 대기 건수, 총 금액, 예상 비용
- 개별 처리: 각 인출 건별로 처리
- 일괄 처리: 모든 인출 한번에 처리
- TON Connect로 게임 지갑 서명
- 자동 새로고침 (30초마다)

### 4. KV 데이터 구조

```json
// 크레딧 정보
"credit:{walletAddress}": {
  "credit": 10,
  "lastUpdated": "2025-11-02T12:00:00Z"
}

// 개별 인출 건
"withdrawal:{withdrawalId}": {
  "id": "withdraw_1730552400000_abc123",
  "walletAddress": "UQC...",
  "amount": 5,
  "status": "pending",
  "requestedAt": "2025-11-02T12:00:00Z",
  "estimatedProcessTime": "12~24시간 이내"
}

// 대기열 목록
"withdrawals:pending": [
  "withdraw_1730552400000_abc123",
  "withdraw_1730552500000_def456"
]

// 처리 완료 목록
"withdrawals:processed": [
  "withdraw_1730552300000_xyz789"
]
```

---

## 🚀 사용 방법

### 사용자 관점

1. **인출 요청**
   - 게임 화면 → [인출] 탭
   - 금액 입력 (보유 크레딧 내)
   - [인출하기] 클릭
   - 즉시 크레딧 차감
   - "12~24시간 이내 처리" 안내

2. **처리 대기**
   - 요청 ID 확인 가능
   - 크레딧은 이미 차감됨
   - 관리자 처리 대기

3. **완료**
   - 지갑으로 CSPIN 수신
   - 네트워크 수수료 무료 (게임 부담)

### 관리자 관점

1. **대시보드 접속**
   ```
   http://localhost:3000/admin
   또는
   https://aiandyou.me/admin
   ```

2. **목록 확인**
   - 대기 중인 인출 목록
   - 각 요청의 상세 정보
   - 총 금액 및 예상 비용

3. **처리 방법**

   **개별 처리:**
   ```
   1. 각 인출 건의 [✅ 처리] 버튼 클릭
   2. TON Connect 팝업 확인
   3. 0.2 TON 수수료 지불 승인
   4. 자동으로 게임 Jetton Wallet → 사용자 전송
   5. 처리 완료 표시
   ```

   **일괄 처리:**
   ```
   1. [🚀 모두 처리] 버튼 클릭
   2. 확인 팝업 → [확인]
   3. 순차적으로 모든 인출 처리
   4. 각 트랜잭션 사이 1초 대기
   5. 완료 후 목록 새로고침
   ```

4. **처리 로직**
   ```
   관리자 TON Connect 지갑
     ↓ (서명: 관리자 = 게임 운영자)
   게임 Jetton Wallet
     ↓ "사용자에게 X CSPIN 보내라"
   사용자 Jetton Wallet
     ↓ (자동 수령)
   사용자
   ```

---

## 📊 비용 분석

### 사용자
```
인출 요청: 무료 (크레딧만 차감)
네트워크 수수료: 무료 (게임 부담)
처리 시간: 12~24시간
```

### 게임 운영자
```
인출 1건당: 0.2 TON
일 10건: 2 TON
월 300건: 60 TON
```

### 비용 절감 방법
1. **배치 처리**: 하루 1회 일괄 처리
2. **최소 인출액**: 10 CSPIN 이상만 허용
3. **인출 수수료**: 1 CSPIN 차감 (선택)

---

## ⚠️ 주의사항

### 관리자
1. **TON Connect 지갑 연결 필수**
   - 게임 운영자 지갑 (니모닉 보유)
   - 충분한 TON 잔액 필요

2. **처리 순서**
   - FIFO (First In First Out) 권장
   - 오래된 요청부터 처리

3. **오류 처리**
   - 트랜잭션 실패 시 재시도
   - 실패 건은 대기열에 유지

### 사용자
1. **크레딧 즉시 차감**
   - 요청 취소 불가
   - 관리자 처리 대기

2. **처리 시간 변동**
   - 평균 12시간
   - 최대 24시간
   - 주말/공휴일 지연 가능

---

## 🔧 향후 개선사항

### Phase 2: 자동화 (3개월)
- Node.js 서버 구축
- 자동 인출 처리
- 니모닉 안전 저장
- 예상 비용: $50/월

### Phase 3: 스마트 컨트랙트 (6개월)
- 완전 탈중앙화
- 즉시 처리
- 컨트랙트 감사
- 예상 비용: ~5 TON (배포)

### 추가 기능
- [ ] 이메일 알림 (처리 완료 시)
- [ ] 인출 이력 조회
- [ ] 처리 시간 통계
- [ ] 인출 취소 기능 (처리 전)
- [ ] 최소/최대 인출액 설정

---

## 🧪 테스트 시나리오

### 사용자 테스트

1. **정상 인출**
   ```
   1. 크레딧 10 CSPIN 보유
   2. 5 CSPIN 인출 요청
   3. ✅ 크레딧 즉시 5로 감소
   4. ✅ 대기열 추가 확인
   5. ✅ 요청 ID 표시
   ```

2. **크레딧 부족**
   ```
   1. 크레딧 3 CSPIN 보유
   2. 5 CSPIN 인출 요청
   3. ❌ 오류: "크레딧이 부족합니다"
   ```

3. **잘못된 금액**
   ```
   1. 0 CSPIN 인출 요청
   2. ❌ 오류: "잘못된 금액입니다"
   ```

### 관리자 테스트

1. **목록 조회**
   ```
   1. /admin 접속
   2. ✅ 대기 중인 인출 표시
   3. ✅ 통계 정보 확인
   ```

2. **개별 처리**
   ```
   1. [✅ 처리] 클릭
   2. TON Connect 팝업
   3. 0.2 TON 수수료 확인
   4. [확인] 클릭
   5. ✅ 블록체인 트랜잭션 생성
   6. ✅ 대기열에서 제거
   ```

3. **일괄 처리**
   ```
   1. 3건 대기 중
   2. [🚀 모두 처리] 클릭
   3. 확인 팝업
   4. ✅ 3건 순차 처리
   5. ✅ 목록 비워짐
   ```

---

## ✅ 완료 체크리스트

- [x] Withdraw.tsx 수동 방식으로 수정
- [x] /api/withdraw-request 구현
- [x] /api/admin/pending-withdrawals 구현
- [x] /api/admin/mark-processed 구현
- [x] AdminWithdrawals 컴포넌트 생성
- [x] KV 데이터 구조 설계
- [x] TypeScript 오류 없음
- [x] 문서화 완료

---

## 📝 API 테스트

### 로컬 테스트
```bash
# 1. 개발 서버 실행
npm run dev

# 2. 사용자 인출 요청
curl -X POST http://localhost:3000/api/withdraw-request \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "UQC...",
    "amount": 5
  }'

# 3. 대기열 조회
curl http://localhost:3000/api/admin/pending-withdrawals

# 4. 처리 완료 표시
curl -X POST http://localhost:3000/api/admin/mark-processed \
  -H "Content-Type: application/json" \
  -d '{
    "withdrawalId": "withdraw_...",
    "txHash": "te6cc..."
  }'
```

---

**다음 단계**: 로컬 테스트 및 프로덕션 배포
