# 관리자 페이지 구현 완료 및 배포 가이드

**작성일**: 2025-11-02  
**문제**: https://aiandyou.me/admin 접속 불가 (Error 1101)  
**해결**: ✅ React Router + SPA 리디렉션 + 게임 운영자 인증 추가

---

## 🔧 수정 사항

### 1. React Router 추가
```bash
npm install react-router-dom
```

### 2. App.tsx 라우팅 구조
```typescript
function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<GamePage />} />
        <Route path="/admin" element={<AdminWithdrawals />} />
      </Routes>
    </BrowserRouter>
  );
}
```

### 3. Cloudflare Workers SPA 리디렉션
```typescript
// src/index.ts
if (!url.pathname.startsWith('/api')) {
  const indexRequest = new Request(new URL('/', url), request);
  return env.ASSETS.fetch(indexRequest);
}
```

### 4. _routes.json 생성
```json
{
  "version": 1,
  "include": ["/*"],
  "exclude": ["/assets/*"]
}
```

이 파일은 Cloudflare Workers가 모든 경로를 Worker로 라우팅하도록 지시합니다.

### 5. 관리자 인증 추가 (AdminWithdrawals.tsx)
```typescript
const { isConnected, walletAddress } = useTonConnect();

// 게임 운영자 지갑 확인
const isAdminWallet = isConnected && 
  walletAddress?.toLowerCase() === GAME_WALLET_ADDRESS.toLowerCase();

// 3단계 접근 제어:
// 1. 지갑 미연결 → "관리자 인증 필요"
// 2. 다른 지갑 연결 → "접근 권한 없음"
// 3. 게임 운영자 지갑 → 관리자 기능 표시
```

---

## 📦 배포 단계

### 1. 빌드
```bash
npm run build
```

**결과**:
- ✅ `dist/index.html`
- ✅ `dist/_routes.json` (생성됨)
- ✅ `dist/assets/...`

### 2. Git 커밋 & 푸시
```bash
git add .
git commit -m "feat: 관리자 페이지 + 게임 운영자 인증 추가"
git push origin main
```

### 3. Cloudflare 자동 배포 확인
```
Cloudflare Dashboard → Workers & Pages → candlespinner-workers
→ Deployments → 최신 배포 상태 확인
```

### 4. 배포 완료 확인
```bash
# 메인 페이지
curl https://aiandyou.me/

# 관리자 페이지 (HTML 반환되어야 함)
curl https://aiandyou.me/admin

# API (정상 동작)
curl https://aiandyou.me/api/admin/pending-withdrawals
```

---

## 🎯 사용 방법

### 관리자 페이지 접속

1. **브라우저에서 접속**
   ```
   https://aiandyou.me/admin
   ```

2. **TON Connect 지갑 연결**
   - 화면 상단 [Connect Wallet] 클릭
   - 게임 운영자 지갑으로 연결

3. **인증 확인**
   
   **Case 1: 지갑 미연결**
   ```
   🔐 관리자 인증 필요
   게임 운영자 지갑을 연결해주세요
   
   게임 운영자 지갑 주소:
   UQB7lnIYw3F...
   ```

   **Case 2: 다른 지갑 연결**
   ```
   ❌ 접근 권한 없음
   이 지갑은 게임 운영자 지갑이 아닙니다
   
   현재 연결된 지갑:
   UQCsBJHqi3T...
   
   필요한 지갑:
   UQB7lnIYw3F...
   ```

   **Case 3: 게임 운영자 지갑 연결 (✅)**
   ```
   🏦 인출 관리 대시보드
   
   [통계]
   대기 중: 3건
   총 금액: 15 CSPIN
   예상 비용: 0.6 TON
   
   [🚀 모두 처리] [🔄 새로고침]
   
   [인출 목록]
   ...
   ```

---

## 🔐 보안 구조

### 클라이언트 사이드 인증
```typescript
// AdminWithdrawals.tsx
const isAdminWallet = 
  walletAddress?.toLowerCase() === GAME_WALLET_ADDRESS.toLowerCase();

if (!isConnected) {
  return <div>관리자 인증 필요</div>;
}

if (!isAdminWallet) {
  return <div>접근 권한 없음</div>;
}

// ✅ 관리자 기능 표시
```

**장점**:
- ✅ 간단한 구현
- ✅ 즉시 적용 가능
- ✅ UX 개선 (명확한 안내)

**한계**:
- ⚠️ API는 여전히 공개 (누구나 호출 가능)
- ⚠️ 클라이언트 사이드만 체크

### 백엔드 인증 추가 (선택사항)

더 강력한 보안이 필요하면:

```typescript
// src/index.ts
async function handleGetPendingWithdrawals(...) {
  // ✅ 관리자 검증 추가
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !verifyAdminToken(authHeader)) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Unauthorized'
    }), { status: 401, headers: corsHeaders });
  }
  
  // 기존 로직
  // ...
}
```

**MVP에서는 클라이언트 사이드만으로 충분**합니다:
- 사용자 수 적음
- 내부 관리 도구
- API 호출해도 처리는 불가능 (TON Connect 서명 필요)

---

## 🧪 테스트 시나리오

### 테스트 1: 지갑 미연결
```
1. https://aiandyou.me/admin 접속
2. ✅ "관리자 인증 필요" 표시
3. ✅ 게임 운영자 지갑 주소 표시
4. ✅ TON Connect 버튼 표시
```

### 테스트 2: 다른 지갑 연결
```
1. 일반 사용자 지갑 연결
2. ✅ "접근 권한 없음" 표시
3. ✅ 현재 지갑 vs 필요 지갑 비교 표시
4. ✅ 통계/목록 숨김
```

### 테스트 3: 게임 운영자 지갑 연결
```
1. 게임 운영자 지갑 연결
2. ✅ 통계 표시 (대기 중, 총 금액, 예상 비용)
3. ✅ [🚀 모두 처리] 버튼 표시
4. ✅ 인출 목록 표시
5. ✅ [✅ 처리] 버튼 각각 표시
```

### 테스트 4: 인출 처리
```
1. [✅ 처리] 클릭
2. ✅ TON Connect 팝업
3. ✅ 0.2 TON 수수료 확인
4. ✅ [확인] → 트랜잭션 전송
5. ✅ 목록에서 제거
6. ✅ 통계 업데이트
```

---

## 🐛 문제 해결

### 문제 1: Error 1101 (여전히 발생)
**원인**: Cloudflare가 `_routes.json`을 인식 못함

**해결**:
```bash
# 1. dist/_routes.json 확인
cat dist/_routes.json

# 2. 재빌드
npm run build

# 3. 재배포
git add dist/_routes.json
git commit -m "fix: _routes.json 추가"
git push

# 4. 또는 수동 배포
npx wrangler deploy
```

### 문제 2: 빈 화면 (React Router 오류)
**원인**: 브라우저가 오래된 캐시 사용

**해결**:
```
1. 브라우저에서 Ctrl + Shift + R (강력 새로고침)
2. 또는 개발자 도구 → Network → "Disable cache" 체크
```

### 문제 3: API 호출 실패
**원인**: CORS 또는 엔드포인트 오류

**해결**:
```bash
# API 직접 테스트
curl https://aiandyou.me/api/admin/pending-withdrawals

# 응답 확인:
# ✅ 정상: {"success":true,"withdrawals":[],"count":0}
# ❌ 오류: Error 1101 또는 404
```

---

## 📊 현재 상태

### ✅ 완료된 기능
- [x] React Router 설치
- [x] /admin 라우팅 추가
- [x] SPA 리디렉션 (src/index.ts)
- [x] _routes.json 생성
- [x] 게임 운영자 인증 (클라이언트 사이드)
- [x] 3단계 접근 제어 UI
- [x] 통계 표시
- [x] 인출 목록 표시
- [x] 개별/일괄 처리 버튼
- [x] 빌드 성공
- [x] 배포 가이드 작성

### ⏳ 선택적 개선사항
- [ ] 백엔드 API 인증 (JWT 또는 API Key)
- [ ] 관리자 활동 로그
- [ ] 이메일 알림 (처리 완료 시)
- [ ] 인출 이력 조회
- [ ] 통계 대시보드 (일별/주별)

---

## 🚀 다음 단계

### 즉시 (배포 후)
1. **https://aiandyou.me/admin 접속 테스트**
   - Error 1101 해결 확인
   - React Router 정상 동작 확인

2. **게임 운영자 지갑 연결**
   - TON Connect 연결
   - 인증 통과 확인
   - 관리자 기능 표시 확인

3. **실제 인출 처리 테스트**
   - 사용자가 인출 요청
   - 관리자 대시보드에서 확인
   - [✅ 처리] 클릭
   - 블록체인 트랜잭션 확인

### 단기 (1주일)
- 사용자 피드백 수집
- 처리 시간 모니터링
- 오류 로그 확인

### 장기 (1개월+)
- Node.js 자동 인출 검토
- 또는 스마트 컨트랙트 검토
- 비용/편의성 비교

---

## 📝 체크리스트

배포 전 확인:
- [x] `npm run build` 성공
- [x] `dist/_routes.json` 존재
- [x] TypeScript 오류 없음
- [x] Git 커밋 & 푸시
- [ ] Cloudflare 배포 확인
- [ ] https://aiandyou.me/admin 접속 테스트
- [ ] 게임 운영자 지갑 연결 테스트
- [ ] 인증 UI 확인
- [ ] 인출 처리 테스트

---

**현재 상태**: ✅ 코드 작성 완료, 배포 대기 중

**배포 명령어**:
```bash
# 방법 1: Git (자동 배포)
git add .
git commit -m "feat: 관리자 페이지 + 인증 추가"
git push origin main

# 방법 2: 수동 배포
npx wrangler deploy
```

배포 후 테스트하시면 됩니다! 🎉
