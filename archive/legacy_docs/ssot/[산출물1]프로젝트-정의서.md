# [산출물 1] 프로젝트 정의서 (2025-11-02)

## 1. 개요

- **프로젝트명:** CandleSpinner  
- **제품 단계:** MVP v2 (수동 인출 큐 + TonConnect 입금)  
- **목표 고객:** Telegram Wallet 및 TON 생태계에 익숙한 캐주얼 게이머  
- **핵심 가치:** 빠르고 손쉬운 온보딩, 공정한 슬롯 경험, 운영자 중심의 리스크 제어(수동 인출)

## 2. 문제 정의

| Pain Point | 해결 방향 |
|-------------|-----------|
| Web3 슬롯은 초보자에게 접근성이 낮음 | TonConnect 버튼 하나로 연결, 다국어 도움말 제공 |
| 온체인 수수료와 속도 문제 | 게임 로직은 Cloudflare Worker에서 오프체인 처리, 온체인은 입금과 수수료 확인만 사용 |
| 운영 리스크(봇, 대규모 인출) | 인출 수수료 + 수동 대기열로 재무 및 보안 통제 강화 |
| 투명성 부족 | Provably Fair 구조와 RTP 통계 제공, 잭팟/당첨 로그 저장 |

## 3. 제품 목표

1. **신뢰성:** TonCenter RPC와 Cloudflare Workers를 이용해 안정적인 입금/크레딧 동기화 제공.  
2. **공정성:** Provably Fair 해시, 난수 생성, RTP 통계로 게임 품질 보증.  
3. **운영 효율:** 관리자가 `/admin` 대시보드 한 곳에서 인출을 검토하고 처리할 수 있도록 지원.  
4. **글로벌 대응:** 9개 언어 번역, 모바일/태블릿 대응 UI, 다크 테마 기본 적용.  
5. **확장성:** Cloudflare 기반으로 글로벌 CDN, 서버리스 리소스 사용.

## 4. 핵심 기능 요약

| 기능 | 설명 | 참고 파일 |
|------|------|-----------|
| 지갑 연결 | TonConnect UI 버튼으로 빠른 연결 | `src/App.tsx`, `src/hooks/useTonConnect.ts` |
| 입금 (Deposit) | CSPIN Jetton Transfer(TonConnect) + `POST /api/verify-deposit` | `src/components/Deposit.tsx` |
| 슬롯 스핀 | Provably Fair, 잭팟(100배) 포함, 베팅 10~1000 | `functions/src/slot/spin-handler.ts` |
| 더블업 | 승리 라운드 한정 50% 도박, 크레딧 즉시 반영 | `functions/src/slot/doubleup-handler.ts` |
| 인출 요청 | 0.2 TON 수수료 확인 + 크레딧 차감 + 대기열 저장 | `src/components/Withdraw.tsx`, `src/index.ts` |
| 관리자 큐 | 대기 인출 조회/처리, txHash 기록 | `src/app/AdminWithdrawals.tsx` |
| 다국어 / 도움말 | 9개 언어, 도움말 다이얼로그, 지원 링크 | `src/components/HelpDialog.tsx`, `src/utils/language.ts` |

## 5. 비기능 요구사항

- **성능:** 슬롯 스핀 API 응답 200ms 이내(Cloudflare Worker 기준) 목표.  
- **가용성:** Cloudflare Pages + Workers SLA 활용, 별도 서버 없음.  
- **보안:** nonce, timestamp로 인출 요청 리플레이 방지. Mnemonic은 Worker 환경 변수에만 저장.  
- **감사:** 게임/인출 결과를 KV에 30일 이상 보존, 운영자 수동 로그 병행.

## 6. 성공 지표 (KPI)

1. **지갑 연결 전환율** (방문 대비 연결 완료 비율)  
2. **첫 입금 소요 시간** (연결 후 첫 입금 완료까지 평균)  
3. **슬롯 재방문율** (하루 내 2회 이상 플레이 사용자 비율)  
4. **인출 처리 SLA 준수율** (12~24시간 내 처리된 비율)  
5. **다국어 사용 비율** (영어 외 언어 선택 비율)

## 7. 범위 밖 (Out of Scope)

- 스마트컨트랙트 기반 자동 인출(차기 단계).  
- Telegram Mini App 전용 UI 및 SDK 통합.  
- 실시간 멀티플레이, 리더보드, 소셜 기능.  
- 온체인 Provably Fair 증명(현재는 오프체인 해시 검증만 제공).

## 8. 향후 과제

1. Worker에서 인출 수수료 BOC 검증 자동화.  
2. 관리자 대시보드에 필터/검색/엑셀 다운로드 추가.  
3. 슬롯 기록을 기반으로 커뮤니티 공유용 리플레이 생성.  
4. TMA(텔레그램 미니앱) 재도입 여부 평가 및 UX 실험.  
5. 모바일 언어 선택 드롭다운 z-index 조정 완료 후 QA.

---

**최종 업데이트:** 2025-11-02 / 문서 책임자: @aiandyou50
#***REMOVED*****[산출물 1] 프로젝트 정의서 (Project Definition Document) (v2.0 최종)**

* **프로젝트명:** CandleSpinner
* **버전:** 2.0 (Phase 2 완료 및 현재 코드 반영)
* **작성일:** 2025년 10월 18일
* **최종 업데이트:** 2025년 10월 21일
* **상태:** ✅ 현재 코드 완전 반영

> **📌 참고**: 이 문서는 `/docs/ssot/README.md`의 "1. 프로젝트 정의" 섹션과 중복됩니다.  
> 최신 정보는 `README.md`를 참고하세요.

##***REMOVED*****1. 프로젝트 개요 (Project Overview)** 🚀

* **한 줄 요약:** 텔레그램 Wallet 사용자를 위한 TON 블록체인 기반의 WEB3 우주 테마 슬롯머신 게임.
* **핵심 타겟 사용자:** TON 생태계에 관심이 많고, 간편한 Web3 게임을 즐기고자 하는 암호화폐 유저.
* **핵심 목표:** 깃허브 코파일럿과 서버리스 아키텍처를 활용하여 신속하게 MVP를 개발하고, TON 생태계 내에서 재미있고 공정한 Web3 엔터테인먼트 경험을 제공한다.

##***REMOVED*****2. 기술 스택 및 아키텍처 (Tech Stack & Architecture)** 🛠️

* **블록체인:** TON (The Open Network)
* **핵심 주소 정보 (TON Blockchain):**
    * **게임 토큰 (CSPIN)의 메인 컨트랙트 (Jetton Master):**
        * `EQBZ6nHfmT2wct9d4MoOdNPzhtUGXOds1y3NTmYUFHAA3uvV`
        * *(용도: 사용자가 토큰 입금 시 트랜잭션을 보낼 대상)*
    * **게임 지갑 (소유자/Owner 주소):**
        * `UQBFPDdSlPgqPrn2XwhpVq0KQExN2kv83_batQ-dptaR8Mtd`
        * *(용도: 입금된 CSPIN 토큰의 최종 수신자로 지정될 주소. 별칭: `moneybookcodex.ton`)*
    * **게임 지갑의 CSPIN 토큰 지갑 (Owner's Jetton Wallet):**
        * `EQAjtIvLT_y9GNBAikrD7ThH3f4BI-h_l_mz-Bhuc4_c7wOs`
        * *(용도: 게임 지갑(Owner)이 실제로 CSPIN을 보관하는 내부 지갑. PoC 입금 로직에는 직접 사용되지 않음)*
* **개발 프레임워크:** React 또는 Vue.js (프론트엔드), PixiJS 또는 Three.js (그래픽/애니메이션)
* **배포 환경:** Cloudflare Pages (서버리스)
* **버전 관리 및 CI/CD:** GitHub (Commit & Push 시 자동 배포)
* **지갑 연동:** **TON Connect** 프로토콜을 사용하여 텔레그램 Wallet 연동.
* **게임 로직 처리:**
    * **온체인 (On-chain):** 사용자의 `CSPIN` 입금(Deposit) 및 인출(Withdraw) 트랜잭션.
    * **오프체인 (Off-chain):** 게임 플레이(스핀, 베팅, 당첨 결과) 로직은 서버(Cloudflare Worker)에서 처리하여 수수료 없는 빠른 경험 제공.

##***REMOVED*****3. 핵심 기능 명세 (Core Feature Specification)** 🎰

###***REMOVED*****3.1. 게임 플레이 흐름 (Game Flow) (변경됨)**

1.  **지갑 연결:** 사용자는 메인 페이지에서 'Wallet 연결' 버튼을 통해 자신의 텔레그램 Wallet을 웹사이트에 연결한다.
2.  **CSPIN 입금 (On-chain):** 게임 페이지에서 원하는 수량의 `CSPIN`을 **게임 지갑(Owner 주소)**으로 전송(입금)한다. 이 금액이 게임 내 크레딧이 된다.
3.  **슬롯머신 플레이 (Off-chain):** 입금된 크레딧을 사용하여 베팅하고 스핀을 실행한다. 모든 당첨금은 게임 내 크레딧에 즉시 합산된다.
4.  **상금 인출 (On-chain, 사용자 주도 - 변경됨):** 
   사용자가 '인출' 버튼을 누르면 다음 프로세스가 진행된다:
   - **Step 1**: 백엔드에서 서명된 허가증(Signed Permit) 생성
   - **Step 2**: 사용자가 TonConnect를 통해 Withdrawal Smart Contract 호출
   - **Step 3**: 스마트컨트랙트가 CSPIN 토큰을 사용자 지갑으로 직접 전송
   - **Step 4**: 백엔드가 블록체인 확인 후 게임 내 크레딧 차감
   
   **사용자 비용**: 가스비 약 0.05 TON (~$0.00015)
   - 가스비는 사용자가 부담하며, 이는 TON 블록체인의 표준 요금입니다
   - 인출되는 CSPIN은 100% 전송됩니다 (손실 없음)

###***REMOVED*****3.2. 슬롯머신 규칙**

* **릴(Reel) 구성:** 3-Reel 슬롯머신.
* **심볼(Symbols):** 이미지 파일 대신 아래의 **이모지(Emoji)**를 사용한다.

| 심볼 (Symbol) | 명칭 | 희귀도 | 배당률 (Multiplier) | 확률 (개별 릴) |
| :---: | :--- | :---: | :---: | :---: |
| ⭐ | 별 | Common | `x0.5` | 35% |
| 🪐 | 행성 | Common | `x1` | 25% |
| ☄️ | 혜성 | Uncommon | `x2` | 15% |
| 🚀 | 로켓 | Uncommon | `x3` | 10% |
| 👽 | 외계인 | Rare | `x5` | 7% |
| 💎 | 다이아몬드| Rare | `x10` | 5% |
| 👑 | 왕관 | Legend | `x20` | 3% |

* **당첨금 계산 방식 (독창적 규칙):**
    * 당첨금은 당첨된 각 릴의 상금을 개별적으로 계산하여 **모두 합산**한다.
    * **예시:** 베팅액 100 CSPIN, 2개 릴에서 '로켓(x3)' 당첨 시, 상금 = `(100 * 3) + (100 * 3) = 600 CSPIN`.
* **잭팟(Jackpot) 규칙:**
    * 3개 릴에 **모두 동일한 심볼**이 나올 경우 잭팟이 발동된다.
    * **잭팟 상금 = (3개 릴의 개별 당첨금 총합) x 100**.
    * **예시:** 베팅액 100 CSPIN, 3개 릴 '로켓(x3)' 잭팟 시, 상금 = `((100*3) + (100*3) + (100*3)) * 100 = 90,000 CSPIN`.
* **공정성:** 서버에서 결과를 결정하며, **Provably Fair** 알고리즘을 도입하여 결과의 투명성과 신뢰성을 보장한다.

###***REMOVED*****3.3. 베팅 시스템**

* **초기 기본 베팅액:** 100 CSPIN.
* **베팅 조절:**
    * 숫자 입력 필드를 통해 직접 베팅액 입력 가능.
    * `+`, `-` 버튼으로 베팅액 조절. 증감 단위는 **10 CSPIN**.

###***REMOVED*****3.4. 미니게임 (더블업)**

* **발동 조건:** 슬롯머신 스핀에서 1회라도 당첨금이 발생하면 항상 등장.
* **게임 방식:** 빨간색 버튼과 파란색 버튼 중 하나를 선택. 50% 확률로 성공 또는 실패.
    * **성공 시:** 현재 당첨금의 2배를 획득.
    * **실패 시:** 현재 당첨금을 모두 잃음.
* **플레이 제한:** 슬롯머신 스핀 1회 당 **단 한 번의 더블업 기회**만 주어진다. (연속 성공 불가)

##***REMOVED*****4. 사용자 경험 (User Experience - UX/UI)** ✨

* **디자인 테마:** 우주 (Cosmic). 반짝이는 은하수, 별자리 등을 배경으로 활용.
* **UI 스타일:** **네온사인 스타일**의 버튼 및 주요 UI 요소.
* **애니메이션:**
    * 슬롯머신 릴이 부드럽게 회전하고 멈추는 물리 엔진 기반 애니메이션 적용.
    * 당첨 시 당첨 라인과 심볼에 시각적 효과 적용.
* **사운드:**
    * 기본 배경음악(BGM), 스핀 사운드, 당첨 효과음 적용.
    * **잭팟 발동 시:** 사운드를 Mute하고, 로컬 `root` 경로에 저장된 **10초 분량의 잭팟 전용 비디오를 전체 화면으로 재생**한다.
* **다국어 지원 (Localization):**
    * **지원 언어:** 한국어(ko), 영어(en), 일본어(ja), 중국어 간체(zh-CN), 중국어 번체(zh-TW), 러시아어(ru), 아랍어(ar).
    * **자동 언어 감지:** 사용자의 브라우저 기본 언어를 감지하여 자동으로 해당 언어로 변경.
    * **기본값:** 언어 감지 실패 시 **영어(en)**를 기본 언어로 설정.

##***REMOVED*****5. 토큰 경제 모델 (Tokenomics)** 💰

* **RTP (Return to Player):** **95%**.
    * 전체 사용자 베팅액의 95%가 장기적으로 상금 풀(Pool)로 사용자에게 반환되도록 심볼 확률 및 배당률을 설계함 (위 3.2 표 참고).
* **하우스 엣지 (House Edge):** **5%**.
    * 프로젝트의 지속적인 운영, 개발, 마케팅을 위한 수익 모델로 활용.

##***REMOVED*****6. 개발 로드맵 (Development Roadmap)** 🗺️

* **Phase 0: PoC (Proof of Concept) - Testnet**
    * **목표:** 핵심 기술 리스크 해소.
    * **과업:** 웹 페이지에서 TON Connect를 사용하여 지갑을 연동하고, 지정된 수량의 `CSPIN` 토큰을 게임 지갑으로 전송하는 기능 구현 및 테스트.
* **Phase 1: MVP 개발 (Minimum Vtable Product) - Testnet**
    * **목표:** 본 정의서에 명시된 모든 핵심 기능 구현.
    * **과업:** UI/UX 디자인 적용, 슬롯머신 로직 및 애니메이션 개발, 더블업 미니게임 개발, 다국어 지원, Provably Fair 로직 구현, 전체 기능 통합 테스트.
* **Phase 2: 최종 검증 - Mainnet**
    * **목표:** 실제 운영 환경에서의 안정성 검증.
    * **과업:** Testnet에서 검증된 버전을 Mainnet에 배포하고, 내부 팀 또는 소수 그룹이 실제 `CSPIN`과 `TON`을 사용하여 최종 테스트 진행.
* **Phase 3: 공식 런칭**
    * **목표:** 일반 대중에게 서비스 공개.
    * **과업:** 마케팅 활동 시작 및 공식 웹사이트 오픈.